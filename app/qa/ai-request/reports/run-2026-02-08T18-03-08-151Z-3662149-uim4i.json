{
  "meta": {
    "scenarioMeta": {
      "version": "1.0",
      "generatedAt": "2026-02-08T18:05:00Z",
      "source": "manual-regression",
      "description": "Regression for topic switchback: keep correction context, but allow explicit new topic switch"
    },
    "options": {
      "baseUrl": "http://127.0.0.1:8131",
      "email": "qa.ai.runner@example.com",
      "preparePaid": true,
      "paidLimit": 1500,
      "maxScenarios": null,
      "onlyTags": [],
      "maxRateLimitRetries": 4,
      "maxStubRetries": 2,
      "minTurnDelayMs": 120,
      "stubOutageThreshold": 12,
      "targetPassCount": null,
      "targetPassRate": null
    }
  },
  "summary": {
    "runId": "run-2026-02-08T18-03-08-151Z-3662149-uim4i",
    "startedAt": "2026-02-08T18:03:08.151Z",
    "endedAt": "2026-02-08T18:03:45.726Z",
    "durationMs": 37575,
    "baseUrl": "http://127.0.0.1:8131",
    "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.switchback-topic.json",
    "totalScenarios": 1,
    "passedScenarios": 1,
    "failedScenarios": 0,
    "passRate": 1,
    "totalChecks": 11,
    "passedChecks": 11,
    "failedChecks": 0,
    "checkPassRate": 1,
    "targetPassCount": 1,
    "targetPassRate": 0.8,
    "targetReached": true,
    "authUser": {
      "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
      "email": "qa.ai.runner@example.com",
      "name": "AI QA Runner",
      "role": "user",
      "plan": "paid"
    },
    "stoppedEarly": false,
    "stopReason": null
  },
  "runStop": null,
  "topFailurePatterns": [],
  "scenarios": [
    {
      "id": "TS001",
      "title": "Жалоба на нерелевант -> явный switch на новую тему -> возврат к исходной теме",
      "tags": [
        "regression",
        "topic_switch",
        "switchback",
        "cross_domain",
        "multi_turn"
      ],
      "personaGoal": "Проверить, что ассистент не залипает на старой теме и не срывается при коррекции",
      "totalTurns": 4,
      "completedTurns": 4,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где купить тонну молока в Бресте?",
          "requestBody": {
            "message": "Где купить тонну молока в Бресте?",
            "history": []
          },
          "latencyMs": 14404,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "aa064ae8-4349-40ba-af0e-a398d54189df",
          "isStub": false,
          "reply": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из доступного списка:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (сметана, творог, сыры и др.), то есть профиль молочной переработки. Можно уточнить возможность оптовой продажи сырого/питьевого молока или поставки через их каналы.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясо-молочной промышленности**, в составе есть предприятия по переработке молока. Вероятно, смогут направить на нужный завод/поставщика под объём 1 т.\n\n**Важно:** в текущей выдаче нет большого числа прямых продавцов “молоко 1 т” в Бресте, поэтому лучше идти через эти 2 контакта и сразу запрашивать:\n- тип молока (сырое/пастеризованное, жирность),\n- объём: **1000 кг**,\n- формат тары (налив/еврокуб/бидоны),\n- условия доставки по Бресту и сроки.\n\nЕсли хотите, подготовлю короткий текст запроса (звонок/Email/WhatsApp), чтобы быстрее получить коммерческие предложения.",
          "checks": [
            {
              "id": "TS001.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T1.C2",
              "type": "includes_any",
              "description": "Должен держать молочную тему и Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Указана компания которая продает запчасти в Минске опять!!!",
          "requestBody": {
            "message": "Указана компания которая продает запчасти в Минске опять!!!",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из доступного списка:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (сметана, творог, сыры и др.), то есть профиль молочной переработки. Можно уточнить возможность оптовой продажи сырого/питьевого молока или поставки через их каналы.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясо-молочной промышленности**, в составе есть предприятия по переработке молока. Вероятно, смогут направить на нужный завод/поставщика под объём 1 т.\n\n**Важно:** в текущей выдаче нет большого числа прямых продавцов “молоко 1 т” в Бресте, поэтому лучше идти через эти 2 контакта и сразу запрашивать:\n- тип молока (сырое/пастеризованное, жирность),\n- объём: **1000 кг**,\n- формат тары (налив/еврокуб/бидоны),\n- условия доставки по Бресту и сроки.\n\nЕсли хотите, подготовлю короткий текст запроса (звонок/Email/WhatsApp), чтобы быстрее получить коммерческие предложения."
              }
            ]
          },
          "latencyMs": 5048,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "f6132617-7fff-4529-a275-1e7eb12c3b3e",
          "isStub": false,
          "reply": "Вы правы — это ошибка в подборе, извините.\n\nПо вашему запросу **“тонна молока в Бресте”** нужно оставлять только молочную отрасль Бреста и исключать запчасти/Минск.\n\nЧто делать в каталоге, чтобы не смешивало:\n1. Рубрика: **Молочная промышленность** (не авто/запчасти).  \n2. Город/регион: **Брест / Брестская область**.  \n3. Минус-слова в поиске: **запчасти, спецтехника, автосервис**.  \n4. Запрос лучше так: **“молоко оптом 1 т Брест”** или **“поставка молока Брест”**.\n\nМогу сразу дать вам короткий **чек-лист отбора поставщика на 1 т** (цена за кг, жирность, тара, доставка, срок, документы), чтобы быстро прозвонить компании.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T2.C2",
              "type": "includes_any",
              "description": "Должен удержать коррекцию по исходной локации/контексту",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "локаци"
                ],
                "hits": [
                  "брест"
                ]
              }
            },
            {
              "id": "TS001.T2.C3",
              "type": "includes_any",
              "description": "Должен вернуть фокус на исходную товарную тему",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "релевант"
                ],
                "hits": [
                  "молок",
                  "релевант"
                ]
              }
            },
            {
              "id": "TS001.T2.C4",
              "type": "excludes_all",
              "description": "Не должен снова скатываться в выдачу запчастей на шаге коррекции",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "фокус:\\s*\\*\\*запчаст",
                  "/company/avto",
                  "/company/up-18",
                  "/company/avtostim"
                ],
                "hits": []
              }
            }
          ]
        },
        {
          "turn": 3,
          "user": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
          "requestBody": {
            "message": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из доступного списка:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (сметана, творог, сыры и др.), то есть профиль молочной переработки. Можно уточнить возможность оптовой продажи сырого/питьевого молока или поставки через их каналы.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясо-молочной промышленности**, в составе есть предприятия по переработке молока. Вероятно, смогут направить на нужный завод/поставщика под объём 1 т.\n\n**Важно:** в текущей выдаче нет большого числа прямых продавцов “молоко 1 т” в Бресте, поэтому лучше идти через эти 2 контакта и сразу запрашивать:\n- тип молока (сырое/пастеризованное, жирность),\n- объём: **1000 кг**,\n- формат тары (налив/еврокуб/бидоны),\n- условия доставки по Бресту и сроки.\n\nЕсли хотите, подготовлю короткий текст запроса (звонок/Email/WhatsApp), чтобы быстрее получить коммерческие предложения."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Вы правы — это ошибка в подборе, извините.\n\nПо вашему запросу **“тонна молока в Бресте”** нужно оставлять только молочную отрасль Бреста и исключать запчасти/Минск.\n\nЧто делать в каталоге, чтобы не смешивало:\n1. Рубрика: **Молочная промышленность** (не авто/запчасти).  \n2. Город/регион: **Брест / Брестская область**.  \n3. Минус-слова в поиске: **запчасти, спецтехника, автосервис**.  \n4. Запрос лучше так: **“молоко оптом 1 т Брест”** или **“поставка молока Брест”**.\n\nМогу сразу дать вам короткий **чек-лист отбора поставщика на 1 т** (цена за кг, жирность, тара, доставка, срок, документы), чтобы быстро прозвонить компании.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              }
            ]
          },
          "latencyMs": 7348,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "ca1ab8bd-9311-411e-ba8e-49cea0edb682",
          "isStub": false,
          "reply": "Принято. По текущему списку есть только **1 явно релевантный кандидат** для “автозапчасти в Минске оптом”:\n\n   Причина исключения: в карточке указана категория **косметика и парфюмерия**, не автозапчасти.  \n\nЧтобы быстро найти релевантных в каталоге, используйте:\n1. Рубрика: **Автомобильная техника, услуги, транспорт → Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. Если нужны именно для коммерческого транспорта:  \n   **… → Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n3. Фильтр города: **Минск**\n4. Ключевые запросы:  \n   - “автозапчасти оптом Минск”  \n   - “склад автозапчастей Минск”  \n   - “поставщик автозапчастей Минск”  \n   - “запчасти для грузовой техники оптом Минск”\n\nЕсли хотите, сразу подготовлю готовый RFQ-шаблон (email + WhatsApp) для рассылки поставщикам с полями: по вашему ТЗ, по вашему ТЗ, объем, срок поставки, по вашему ТЗ.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T3.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T3.C2",
              "type": "includes_any",
              "description": "Должен переключиться на новую тему (автозапчасти)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "автозапчаст",
                  "запчаст"
                ],
                "hits": [
                  "автозапчаст",
                  "запчаст"
                ]
              }
            },
            {
              "id": "TS001.T3.C3",
              "type": "includes_any",
              "description": "Должен учитывать новый город (Минск)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "минск",
                  "minsk"
                ],
                "hits": [
                  "минск",
                  "minsk"
                ]
              }
            }
          ]
        },
        {
          "turn": 4,
          "user": "Ок, возвращаемся к молоку в Бресте",
          "requestBody": {
            "message": "Ок, возвращаемся к молоку в Бресте",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из доступного списка:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (сметана, творог, сыры и др.), то есть профиль молочной переработки. Можно уточнить возможность оптовой продажи сырого/питьевого молока или поставки через их каналы.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясо-молочной промышленности**, в составе есть предприятия по переработке молока. Вероятно, смогут направить на нужный завод/поставщика под объём 1 т.\n\n**Важно:** в текущей выдаче нет большого числа прямых продавцов “молоко 1 т” в Бресте, поэтому лучше идти через эти 2 контакта и сразу запрашивать:\n- тип молока (сырое/пастеризованное, жирность),\n- объём: **1000 кг**,\n- формат тары (налив/еврокуб/бидоны),\n- условия доставки по Бресту и сроки.\n\nЕсли хотите, подготовлю короткий текст запроса (звонок/Email/WhatsApp), чтобы быстрее получить коммерческие предложения."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Вы правы — это ошибка в подборе, извините.\n\nПо вашему запросу **“тонна молока в Бресте”** нужно оставлять только молочную отрасль Бреста и исключать запчасти/Минск.\n\nЧто делать в каталоге, чтобы не смешивало:\n1. Рубрика: **Молочная промышленность** (не авто/запчасти).  \n2. Город/регион: **Брест / Брестская область**.  \n3. Минус-слова в поиске: **запчасти, спецтехника, автосервис**.  \n4. Запрос лучше так: **“молоко оптом 1 т Брест”** или **“поставка молока Брест”**.\n\nМогу сразу дать вам короткий **чек-лист отбора поставщика на 1 т** (цена за кг, жирность, тара, доставка, срок, документы), чтобы быстро прозвонить компании.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              },
              {
                "role": "user",
                "content": "Ладно, теперь реально нужны автозапчасти в Минске оптом"
              },
              {
                "role": "assistant",
                "content": "Принято. По текущему списку есть только **1 явно релевантный кандидат** для “автозапчасти в Минске оптом”:\n\n   Причина исключения: в карточке указана категория **косметика и парфюмерия**, не автозапчасти.  \n\nЧтобы быстро найти релевантных в каталоге, используйте:\n1. Рубрика: **Автомобильная техника, услуги, транспорт → Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. Если нужны именно для коммерческого транспорта:  \n   **… → Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n3. Фильтр города: **Минск**\n4. Ключевые запросы:  \n   - “автозапчасти оптом Минск”  \n   - “склад автозапчастей Минск”  \n   - “поставщик автозапчастей Минск”  \n   - “запчасти для грузовой техники оптом Минск”\n\nЕсли хотите, сразу подготовлю готовый RFQ-шаблон (email + WhatsApp) для рассылки поставщикам с полями: по вашему ТЗ, по вашему ТЗ, объем, срок поставки, по вашему ТЗ.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)"
              }
            ]
          },
          "latencyMs": 10358,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "d5bd4a19-2c4e-4462-ab40-cb56223cd8c5",
          "isStub": false,
          "reply": "Отлично, возвращаемся к молоку в Бресте.\n\nСейчас самый практичный старт — 2 контакта, которые уже есть:\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`\n2. **Концерн Брестмясомолпром** — `/company/brestmmp` (попросить направить на завод/филиал, кто отгружает молоко оптом)\n\nКак искать в каталоге точнее:\n1. Рубрика: **Пищевая промышленность → Молочная промышленность**  \n2. Гео-фильтр: **Брест / Брестская область**  \n3. Запросы:  \n   - “молоко оптом Брест”  \n   - “поставка молока 1 т Брест”  \n   - “молочная продукция опт Брест”  \n\nЧто сразу уточнять у поставщика (чтобы не терять время):\n1. Тип: сырое/пастеризованное  \n2. Жирность и белок  \n3. Объём: **1000 кг** (разово или регулярно)  \n4. Тара: налив/бидоны/еврокуб  \n5. Доставка по Бресту и срок  \n6. Документы: вет/качество, ТТН, EDI (если нужно)\n\nЕсли хотите, сделаю вам готовый короткий текст запроса для звонка и переписки.",
          "checks": [
            {
              "id": "TS001.T4.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T4.C2",
              "type": "includes_any",
              "description": "Должен вернуться к исходной теме (молоко в Бресте)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        }
      ],
      "durationMs": 37161
    }
  ]
}
