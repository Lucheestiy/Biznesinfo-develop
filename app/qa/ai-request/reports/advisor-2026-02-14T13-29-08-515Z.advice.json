{
  "runId": "advisor-2026-02-14T13-29-08-515Z",
  "generatedAt": "2026-02-14T13:34:11.499Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "UV017",
      "title": "Свекла 500 кг в Минске: защита от нерелевантных \"не-поставщиков\"",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "beet",
        "vegetables",
        "anti_noise",
        "supplier_quality"
      ],
      "strictPass": false,
      "strictFailedCheckCount": 1,
      "avgUsefulness": 2,
      "usefulRate": 0,
      "hardError": null,
      "failedChecks": [
        {
          "id": "UV017.T2.C2",
          "type": "any_of",
          "description": "Либо shortlist компаний, либо честный fallback с альтернативами",
          "reason": "No sub-check passed"
        }
      ],
      "judgeIssueHints": [
        "Turn 2 — полный сброс контекста: пользователь просил shortlist 3 поставщиков, а ассистент запросил критерии выбора как в первом обращении",
        "Нарушена continuity: после конкретных кандидатов в Turn 1, в Turn 2 ассистент ведет себя как будто разговор только начался",
        "Generic fallback после того как пользователь дал конкретные ограничения (объем 500 кг, Минск, срок 3 дня)",
        "Generic fallback after user gives concrete format request (shortlist + alternatives)"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: дал 4 релевантных поставщика овощей, но без подтверждения наличия конкретно красного буряка",
            "Turn 2: критический fallback — вместо shortlist из 3 поставщиков выдал generic запрос критериев, полностью игнорируя контекст"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 2: Assistant ignored specific shortlist request and gave generic rubric response",
            "Turn 2: User explicitly asked for alternatives if no matches, got irrelevant question instead"
          ]
        }
      ],
      "lastReply": "Subject: Запрос на поставку красного буряка — 500 кг, Минск, до 3 дней Body: Добрый день! Ищем поставщика красного буряка в Минске. Нужен объем 500 кг с поставкой в течение 3 календарных дней. Просьба сообщить: 1) цену за 1 кг (с НДС/без НДС); 2) наличие на складе и возможную дату отгрузки; 3) условия доставки по Минску (стоимость, сроки); 4) характеристики товара (калибр, фасовка, мытый/немытый, страна/хозяйство происхождения); 5) пакет документов (накладные, сертификаты/декларации при наличии); 6) условия оплаты…",
      "lastUser": "Сформируй сообщение поставщику в блоках Subject/Body/WhatsApp: объем 500 кг, Минск, поставка в течение 3 дней."
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "UV017 fails due to context reset in Turn 2: assistant triggers generic 'criteria question' fallback despite having complete context (beet/vegetables, 500kg, Minsk, 3 days) from Turn 1. The hard-formatted reply logic doesn't check history continuity before emitting rubric questions.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix context reset in buildTopCompaniesCriteriaQuestionReply",
          "why": "Critical continuity failure: user provided full constraints in Turn 1 (product, volume, location, deadline), but Turn 2 response asks for criteria as if conversation just started. This destroys user trust.",
          "expectedImpact": "Eliminates generic fallback on shortlist requests when history contains sourcing context. Improves usefulness score from 2 to 4+ for multi-turn sourcing flows.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P1",
          "title": "Add history-aware guard to looksLikeTopCompaniesRequestWithoutCriteria",
          "why": "Current regex-only detection doesn't consider conversation state. A request for 'shortlist 3 suppliers' with empty criteria in current message should check if criteria exist in history.",
          "expectedImpact": "Prevents false-positive criteria questions when user already provided constraints in previous turns.",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV014"
          ]
        },
        {
          "priority": "P1",
          "title": "Strengthen getLastUserSourcingMessage extraction for volume+deadline constraints",
          "why": "Turn 1 contained '500 кг' and '3 дней' but these constraints weren't carried into Turn 2's shortlist logic.",
          "expectedImpact": "Ensures numeric constraints (volume, deadline) propagate across turns for ranking/scoring.",
          "validationScenarios": [
            "UV017",
            "UV006",
            "UV016"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "prompt",
          "title": "Add history context check in buildHardFormattedReply before emitting criteria question",
          "action": "Modify buildHardFormattedReply (line ~575) to check if history contains sourcing context before returning buildTopCompaniesCriteriaQuestionReply. If getLastUserSourcingMessage(history) returns non-empty text, skip the hard-formatted criteria question and let normal flow handle it with context.",
          "implementationHint": "app/src/app/api/ai/request/route.ts:575-581. Add condition: if (looksLikeTopCompaniesRequestWithoutCriteria(message) && !getLastUserSourcingMessage(history)) return buildTopCompaniesCriteriaQuestionReply();",
          "expectedImpact": "Prevents context reset on shortlist requests when conversation already has product/location/deadline constraints.",
          "risk": "Low - only affects edge case where user truly wants criteria rubric without any prior context.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Extract and preserve volume/deadline constraints from history in ranking context",
          "action": "Enhance extractTemplateFillHints or create extractConstraintHintsFromHistory to pull volume (\\d+\\s*(кг|тонн|шт)), deadline (\\d+\\s*дн(я|ей)), and location from history. Inject these into rankingSeedText when building ranking fallback.",
          "implementationHint": "app/src/app/api/ai/request/route.ts:1384-1435. Extend extractTemplateFillHints to scan history messages (not just latest) for qty/deadline/city patterns. Use in buildRankingFallbackAppendix at line ~671.",
          "expectedImpact": "Shortlist ranking will respect volume/deadline constraints from previous turns even if not restated.",
          "risk": "Low - additive enhancement to existing hint extraction.",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV006"
          ]
        },
        {
          "id": "R3",
          "area": "guardrails",
          "title": "Add continuity validation in postProcessAssistantReply for ranking mode",
          "action": "Add check: if mode.rankingRequested and history has sourcing context but reply lacks company links AND contains generic criteria question, override with rankingFallback using history context.",
          "implementationHint": "app/src/app/api/ai/request/route.ts:3509-3660 rankingRequested block. Add detection for generic fallback pattern and force rankingFallbackWithCandidates when continuityCandidates exist.",
          "expectedImpact": "Safety net catches any remaining context reset cases before response sent.",
          "risk": "Low - only activates when ranking mode + history candidates + weak reply detected.",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV014"
          ]
        },
        {
          "id": "R4",
          "area": "retrieval",
          "title": "Improve commodity tag detection for 'буряк/свекла' with color modifier",
          "action": "Current detectCoreCommodityTag may not handle 'красный буряк' correctly. Add explicit pattern for 'красн\\p{L}*\\s*буряк' and 'буряк\\p{L}*' to map to beet commodity tag.",
          "implementationHint": "app/src/lib/biznesinfo/keywords.ts or inline in route.ts detectCoreCommodityTag. Add case-insensitive regex for буряк variants.",
          "expectedImpact": "Better commodity filtering for beet suppliers, reduces false positives from generic vegetable sellers.",
          "risk": "Minimal - pattern addition to existing tagger.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R5",
          "area": "template",
          "title": "Ensure template mode activation for 'Subject/Body/WhatsApp' requests",
          "action": "Turn 3 check UV017.T3.C2 expects template blocks. Verify looksLikeTemplateRequest correctly matches 'Сформируй сообщение поставщику в блоках Subject/Body/WhatsApp'.",
          "implementationHint": "app/src/app/api/ai/request/route.ts:240-246. Test regex against 'блоках Subject/Body/WhatsApp' pattern - may need to add 'блоках' as template cue.",
          "expectedImpact": "Ensures template formatting triggers correctly in Turn 3.",
          "risk": "Low - regex extension.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json"
        ],
        "successMetrics": [
          "UV017.T2.C2 strict check passes (shortlist or honest fallback with alternatives)",
          "Usefulness score >= 4 for UV017 (currently 2)",
          "No generic criteria questions when history contains sourcing context",
          "Continuity: Turn 2 response references constraints from Turn 1 (500kg, Minsk, 3 days)"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "UV017 failed due to complete context reset between Turn 1 (supplier search) and Turn 2 (shortlist request). The assistant asked for selection criteria as if conversation just started, destroying trust. Root cause: `looksLikeCandidateListFollowUp` detection + fallback logic doesn't properly handle continuity when fresh vendor candidates are insufficient. Fix: strengthen context preservation in fallback paths and auto-shortlist from history when user requests shortlist in multi-turn conversation.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix multi-turn shortlist continuity: use history candidates when fresh search returns insufficient results",
          "why": "UV017.T2 failed because assistant asked for criteria again instead of using Turn 1 results. User explicitly requested shortlist, got generic rubric response. This destroys trust and is the highest-impact fix for multi-turn scenarios.",
          "expectedImpact": "Fixes UV017, UV014, UV015, and similar multi-turn supplier scenarios where Turn N asks for shortlist/ranking after Turn N-1 provided candidates.",
          "validationScenarios": [
            "UV017.T2",
            "UV014.T2",
            "UV015.T2",
            "UV016.T2"
          ]
        },
        {
          "priority": "P1",
          "title": "Strengthen `looksLikeCandidateListFollowUp` to detect shortlist/ranking requests regardless of explicit keywords",
          "why": "Current regex-based detection misses implicit shortlist requests like 'сделай shortlist' when context already has candidates. Detection should trigger more aggressively in sourcing continuation flows.",
          "expectedImpact": "Prevents generic rubric fallback when user continues sourcing conversation with implicit follow-up intent.",
          "validationScenarios": [
            "UV017.T2",
            "UV013.T2",
            "UV001.T3"
          ]
        },
        {
          "priority": "P1",
          "title": "Add explicit context-injection in fallback prompt when history has sourcing seed",
          "why": "The LLM prompt doesn't sufficiently emphasize using conversation history. When fallback triggers, it should explicitly see 'Previous turn found X suppliers for Y request' to maintain continuity.",
          "expectedImpact": "Reduces context resets by 40-60% in multi-turn sourcing conversations.",
          "validationScenarios": [
            "UV017.T2",
            "UV013.T3",
            "UV014.T3"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "retrieval",
          "title": "Auto-shortlist from history when user requests shortlist in Turn N>1",
          "action": "In `route.ts`, add logic: when `looksLikeCandidateListFollowUp` or explicit shortlist request detected AND `historySourcingSeed` exists AND fresh candidates < requested count → format existing candidates from Turn 1 as shortlist with /company/ links instead of fallback.",
          "implementationHint": "File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `handleAssistantRequest`. Add check after vendor lookup: if `followUpNeedsConcreteShortlist` && `historySourcingSeed` && `freshCandidates.…",
          "expectedImpact": "UV017.T2 passes: shortlist appears instead of criteria request. Continuity preserved.",
          "risk": "Low - only affects fallback scenarios, adds shortlist option not previously available",
          "effort": "M",
          "validationScenarios": [
            "UV017.T2"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Inject sourcing context into fallback prompt to prevent 'conversation reset' behavior",
          "action": "Modify the fallback prompt builder to include: 'User previously requested suppliers for [commodity] in [city]. Previous turn found [X] candidates. Do not ask for criteria again—either shortlist from history or provide alternative queries.'",
          "implementationHint": "File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `buildGenericNoResultsCriteriaGuidance` or `buildRankingFallbackAppendix`. Add `historySourcingSeed` and `historyCandidateCount` parameter…",
          "expectedImpact": "LLM maintains continuity awareness, reduces generic rubric responses by ~50%.",
          "risk": "Low - improves context awareness, no behavioral changes to valid paths",
          "effort": "S",
          "validationScenarios": [
            "UV017.T2",
            "UV013.T3"
          ]
        },
        {
          "id": "R3",
          "area": "retrieval",
          "title": "Enhance `looksLikeCandidateListFollowUp` detection for implicit shortlist requests",
          "action": "Add patterns for: 'сделай shortlist', 'дали.*кандидат', 'первый.*из.*списка', 'выбранн.*поставщик' combined with sourcing history presence. Also add `history` parameter to function for context-aware detection.",
          "implementationHint": "File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `looksLikeCandidateListFollowUp`. Change signature to accept `history` array and check if any previous user message had vendor candidates.",
          "expectedImpact": "Detection triggers correctly for UV017.T2 'Сделай shortlist 3 релевантных поставщиков'.",
          "risk": "Low - more permissive detection, may trigger in edge cases but preferable to missing continuity",
          "effort": "S",
          "validationScenarios": [
            "UV017.T2"
          ]
        },
        {
          "id": "R4",
          "area": "template",
          "title": "Add template-generation continuity: use Turn 1-2 candidates as supplier context for Turn 3 template",
          "action": "When Turn N requests template ('сформируй сообщение поставщику') AND history has candidate shortlist → template should reference 'один из найденных поставщиков' or ask user to choose from previous shortlist instead of generic template.",
          "implementationHint": "File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `looksLikeTemplateRequest`. Add check: if `hasTemplateHistory` or `hasShortlistInHistory` → template should be personalized to context.",
          "expectedImpact": "UV017.T3 and similar scenarios produce context-aware templates instead of generic ones.",
          "risk": "Low - improves template relevance, no regressions expected",
          "effort": "M",
          "validationScenarios": [
            "UV017.T3",
            "UV001.T4",
            "UV016.T3"
          ]
        },
        {
          "id": "R5",
          "area": "guardrails",
          "title": "Prevent generic criteria-asking fallback when user explicitly said 'don't ask for criteria'",
          "action": "Add detection for 'don't ask again', 'без уточнений', 'без критериев' patterns. When user explicitly rejects criteria request, fallback must provide alternatives or shortlist from history—no criteria-asking allowed.",
          "implementationHint": "File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `buildHardFormattedReply` or `buildRankingFallbackAppendix`. Add: if message has `antiCriteriaRequestPattern` → skip criteria question fal…",
          "expectedImpact": "Respects user intent, prevents trust-destroying 'ask for criteria' responses.",
          "risk": "Low - aligns behavior with explicit user instructions",
          "effort": "S",
          "validationScenarios": [
            "UV017.T2",
            "UV014.T3"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017.T2",
          "UV014.T2",
          "UV015.T2",
          "UV013.T2"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.regressions.user-ideas-multistep-variants.json",
          "app/qa/ai-request/scenarios.regressions.beet-anti-noise.json",
          "app/qa/ai-request/scenarios.regressions.multi-turn-continuity.json"
        ],
        "successMetrics": [
          "Multi-turn continuity pass rate > 80% (currently 0% for UV017)",
          "UV017 usefulRate > 50% (currently 0%)",
          "No 'criteria request' fallback after explicit shortlist request in multi-turn",
          "Template generation includes context from previous turns when available"
        ]
      }
    }
  ],
  "advisorWarnings": [],
  "consensus": {
    "topAreas": [
      {
        "area": "prompt",
        "count": 3
      },
      {
        "area": "retrieval",
        "count": 3
      },
      {
        "area": "guardrails",
        "count": 2
      },
      {
        "area": "template",
        "count": 2
      }
    ],
    "recurringTitles": [
      {
        "title": "add history context check in buildhardformattedreply before emitting criteria question",
        "count": 1
      },
      {
        "title": "extract and preserve volume/deadline constraints from history in ranking context",
        "count": 1
      },
      {
        "title": "add continuity validation in postprocessassistantreply for ranking mode",
        "count": 1
      },
      {
        "title": "improve commodity tag detection for 'буряк/свекла' with color modifier",
        "count": 1
      },
      {
        "title": "ensure template mode activation for 'subject/body/whatsapp' requests",
        "count": 1
      },
      {
        "title": "auto-shortlist from history when user requests shortlist in turn n>1",
        "count": 1
      },
      {
        "title": "inject sourcing context into fallback prompt to prevent 'conversation reset' behavior",
        "count": 1
      },
      {
        "title": "enhance `lookslikecandidatelistfollowup` detection for implicit shortlist requests",
        "count": 1
      },
      {
        "title": "add template-generation continuity: use turn 1-2 candidates as supplier context for turn 3 template",
        "count": 1
      },
      {
        "title": "prevent generic criteria-asking fallback when user explicitly said 'don't ask for criteria'",
        "count": 1
      }
    ]
  }
}
