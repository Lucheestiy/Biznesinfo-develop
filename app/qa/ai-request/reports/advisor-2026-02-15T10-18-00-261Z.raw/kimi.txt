Now I have all the information needed to provide concrete engineering advice. Based on my analysis:

**Key Issues Identified:**
1. **Context Loss (UV019-UV022)**: Assistant loses company context ("Ирис Интер групп") between turns and returns random unrelated companies
2. **Template Placeholder Pollution (UV001, UV004, UV006, UV007, UV016, UV017)**: RFQ/outreach templates filled with "уточняется" placeholders instead of real data
3. **Repetition Without Expansion (UV001)**: Repeating the same single company instead of finding 3-5 candidates
4. **Hallucinated Search Results (UV012)**: Returning hospitals/polyclinics for footwear manufacturer queries
5. **Format Mismatch (UV002)**: Requested checklist returns ranking instead
6. **No-Results Fallback Failure (UV011)**: Generic rubric advice instead of honest no-results handling

```json
{
  "advisor": "kimi",
  "executiveSummary": "Critical systemic failures in context persistence, template population, and retrieval relevance. 8/22 scenarios fail strict checks, 0% usefulness rate on company-specific news lookups. Root causes: (1) fragile entity tracking across turns, (2) template generation without context validation, (3) missing reranking filter for institutional noise. Prioritize P0 fixes for context continuity and template guards.",
  "priorityPlan": [
    {
      "priority": "P0",
      "title": "Fix entity tracking continuity for company context",
      "why": "UV019-UV022 all fail due to context loss: 'Ирис Интер групп' vanishes between turns. Assistant returns random companies (САВАНА, Минсельхоз) instead of maintaining the active entity. This breaks trust in multi-turn workflows.",
      "expectedImpact": "Eliminates 4 critical failures (UV019-UV022), improves avgUsefulness from 0 to 3+ on company-specific flows",
      "validationScenarios": ["UV019", "UV020", "UV021", "UV022"]
    },
    {
      "priority": "P0",
      "title": "Add template population validation guard",
      "why": "Templates (RFQ, outreach) contain placeholder garbage 'уточняется' 6+ times instead of real values. No validation that placeholders were replaced before returning to user.",
      "expectedImpact": "Eliminates placeholder pollution in UV001, UV004, UV006, UV007, UV016, UV017. Forces honest 'insufficient data' response instead of broken template.",
      "validationScenarios": ["UV001", "UV004", "UV006", "UV007", "UV016", "UV017"]
    },
    {
      "priority": "P1",
      "title": "Enforce candidate diversity in shortlist generation",
      "why": "UV001 repeats same company 3x instead of finding 3-5 distinct candidates. No mechanism to deduplicate or expand search when insufficient unique results found.",
      "expectedImpact": "Shortlists contain genuinely distinct candidates; triggers honest fallback when catalog coverage is sparse",
      "validationScenarios": ["UV001", "UV008", "UV015"]
    },
    {
      "priority": "P1",
      "title": "Strengthen anti-noise reranking for supplier queries",
      "why": "UV012 returns hospitals/polyclinics for footwear manufacturers. Current rubric-based filter insufficient; need semantic relevance scoring.",
      "expectedImpact": "Eliminates hallucinated results in UV012, UV017; improves precision on supplier searches by 30%+",
      "validationScenarios": ["UV012", "UV017", "UV007"]
    },
    {
      "priority": "P2",
      "title": "Add response format compliance checker",
      "why": "UV002.T4 requested checklist, received ranking. No validation that output format matches user request type.",
      "expectedImpact": "Reduces format mismatch errors; improves strict pass rate on template/checklist requests",
      "validationScenarios": ["UV002", "UV009"]
    }
  ],
  "recommendations": [
    {
      "id": "R1",
      "area": "prompt",
      "title": "Inject explicit entity tracking instruction in system prompt",
      "action": "Add to system prompt: 'ACTIVE_ENTITY: When user refers to a company by name, maintain that company as the active subject across all subsequent turns. Before responding, verify: does my answer relate to ACTIVE_ENTITY? If unclear, confirm entity rather than switching to random results.'",
      "implementationHint": "File: server-side prompt assembly in /api/ai/request route. Add entity tracking section after company context injection.",
      "expectedImpact": "Prevents context loss in UV019-UV022; maintains continuity when user says 'найди на карточке компании'",
      "risk": "Low - additive instruction only",
      "effort": "S",
      "validationScenarios": ["UV019", "UV020", "UV021", "UV022"]
    },
    {
      "id": "R2",
      "area": "guardrails",
      "title": "Add template placeholder detection post-processor",
      "action": "Before returning any response containing 'Subject/Body/WhatsApp' blocks, scan for placeholder patterns ('уточняется', 'срок: к', 'не указано'). If >2 placeholders found, replace entire template with honest fallback: 'Недостаточно данных для заполнения шаблона. Уточните: [список недостающих полей]'",
      "implementationHint": "File: /api/ai/request route, add validateTemplatePopulated() function called on responses with template_blocks flag. Pattern: /уточняется|срок:\s*к\s*\w+|не\s*указано/gi",
      "expectedImpact": "Eliminates placeholder pollution; forces data collection before template generation",
      "risk": "Low - post-processing filter only",
      "effort": "S",
      "validationScenarios": ["UV001", "UV004", "UV006", "UV007", "UV016", "UV017"]
    },
    {
      "id": "R3",
      "area": "retrieval",
      "title": "Implement candidate deduplication and expansion logic",
      "action": "In shortlist generation: (1) deduplicate by companyId, keeping highest relevance score; (2) if unique candidates < requested count, trigger expansion query with relaxed filters (broader region, synonym rubrics); (3) if still insufficient, return honest 'Найдено X из Y, вот как расширить поиск' instead of repeating same company",
      "implementationHint": "File: server-side search orchestration. Add dedupe step after Meilisearch results, before response formatting. Expansion query: remove strict filters, keep core intent.",
      "expectedImpact": "UV001 will show distinct candidates or honest fallback instead of repetition",
      "risk": "Medium - changes search behavior",
      "effort": "M",
      "validationScenarios": ["UV001", "UV008", "UV015"]
    },
    {
      "id": "R4",
      "area": "ranking",
      "title": "Add semantic relevance threshold for supplier queries",
      "action": "When query contains supplier/manufacturer intent anchors ('производители', 'поставщики', 'закупка'), apply secondary filter: reject results where rubric contains institutional patterns ('поликлиника', 'больница', 'колледж', 'университет') OR where company description lacks supplier signals ('производство', 'опт', 'поставка', 'продажа'). Threshold: require at least 1 supplier signal OR explicit user intent match.",
      "implementationHint": "File: /lib/meilisearch/search.ts or post-processing layer. Add supplierIntentFilter flag when query matches /производител|поставщик|закупка/i. Rejection patterns in config.",
      "expectedImpact": "Eliminates UV012 hospital pollution, UV017 educational entity leakage",
      "risk": "Low - additive filtering layer",
      "effort": "M",
      "validationScenarios": ["UV012", "UV017", "UV007"]
    },
    {
      "id": "R5",
      "area": "prompt",
      "title": "Add format compliance instruction for structured outputs",
      "action": "When user requests specific format (чеклист, numbered list, comparison table), add to prompt: 'OUTPUT_FORMAT: User explicitly requested [format]. Your response MUST follow this format. Do not substitute with ranking or general advice. If unable to produce requested format, state why clearly.'",
      "implementationHint": "File: prompt assembly. Detect format request patterns (/чеклист|список|сравнение|таблица/i), inject format constraint instruction.",
      "expectedImpact": "UV002.T4 will return checklist not ranking; UV009.T3 will return 7-item list",
      "risk": "Low - conditional prompt enhancement",
      "effort": "S",
      "validationScenarios": ["UV002", "UV009", "UV015"]
    },
    {
      "id": "R6",
      "area": "retrieval",
      "title": "Implement company website cache for news lookups",
      "action": "When company card is first accessed, eagerly fetch and cache website content (homepage + /news + /press). Store in request context for subsequent turns. On 'новости' query, use cached content instead of re-searching catalog.",
      "implementationHint": "File: /api/ai/request context hydration. Add websiteCache object to conversation state. TTL: 5 minutes. Key: companyId.",
      "expectedImpact": "UV019-UV022 news queries will use actual website content, not random catalog results",
      "risk": "Medium - adds external fetch latency",
      "effort": "M",
      "validationScenarios": ["UV019", "UV020", "UV021", "UV022"]
    },
    {
      "id": "R7",
      "area": "guardrails",
      "title": "Add no-results honesty threshold",
      "action": "When search returns <3 results OR all results have relevance score <0.6, trigger honest no-results path: 'По текущему запросу найдено мало результатов. Рекомендации: [3 specific query variants to try]'. Do NOT return generic rubric browsing.",
      "implementationHint": "File: response formatter. Check result count + scores before formatting. Pre-defined expansion suggestions based on query category.",
      "expectedImpact": "UV011 will give honest no-results with alternatives instead of irrelevant 'Прима Порта'",
      "risk": "Low - changes fallback behavior only",
      "effort": "S",
      "validationScenarios": ["UV011", "UV003"]
    }
  ],
  "testPlan": {
    "mustPassScenarios": ["UV019", "UV020", "UV021", "UV022", "UV001", "UV012"],
    "regressionSuites": [
      "scenarios.regressions.user-ideas-multistep-variants.json",
      "scenarios.regressions.geo-ambiguity.json",
      "scenarios.regressions.multi-step-journeys.json"
    ],
    "successMetrics": [
      "strictPassRate >= 0.80 (target 18/22 scenarios)",
      "avgUsefulness >= 2.5 (current 1.66)",
      "usefulRate >= 0.50 (current 0.18)",
      "zero placeholder pollution in template outputs",
      "zero context loss on company news lookups"
    ]
  }
}
```
