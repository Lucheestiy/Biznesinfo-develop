{
  "runId": "advisor-2026-02-14T18-39-00-930Z",
  "generatedAt": "2026-02-14T18:42:02.716Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "UV017",
      "title": "Свекла 500 кг в Минске: защита от нерелевантных \"не-поставщиков\"",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "beet",
        "vegetables",
        "anti_noise",
        "supplier_quality"
      ],
      "strictPass": false,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 1,
      "usefulRate": 0,
      "hardError": {
        "status": 502,
        "error": "HTTPError",
        "message": "<html> <head><title>502 Bad Gateway</title></head> <body> <center><h1>502 Bad Gateway</h1></center> <hr><center>nginx</center> </body> </html>"
      },
      "failedChecks": [],
      "judgeIssueHints": [
        "Отсутствует ответ ассистента в предоставленном транскрипте",
        "Невозможно проверить защиту от нерелевантных 'не-поставщиков' без фактического ответа",
        "Complete context loss in Turn 2 - asked for product/city despite having complete context (beet, 500kg, Minsk) from Turn 1"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 0,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: Ассистент не дал ответа (пустой ответ)",
            "Невозможно оценить полезность без ответа ассистента"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 2 context reset: assistant asked for criteria instead of shortlisting from Turn 1 results",
            "Generic fallback behavior after user gave concrete request"
          ]
        }
      ],
      "lastReply": "",
      "lastUser": "Где в Минске купить 500 кг красного буряка оптом?"
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "UV017 failed due to 502 Bad Gateway error causing empty assistant response (usefulness=0) and context loss in Turn 2 where assistant asked for product/city despite having complete context (beet, 500kg, Minsk) from Turn 1. The root causes are: (1) Infrastructure instability - nginx/backend communication failure; (2) Session persistence bug - `looksLikeTopCompaniesRequestWithoutCriteria()` fails to detect existing sourcing context when explicit shortlist is requested; (3) Missing robust fallback when LLM provider returns empty/502 response.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix 502 Bad Gateway infrastructure issue",
          "why": "502 errors cause complete response failure (empty assistant replies), making all other fixes irrelevant. The nginx→app container communication is unstable under load.",
          "expectedImpact": "Eliminates 0-usefulness responses due to infrastructure errors. Enables reliable QA testing.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P0",
          "title": "Fix context loss in multi-turn shortlist requests",
          "why": "The `looksLikeTopCompaniesRequestWithoutCriteria()` function incorrectly returns `buildTopCompaniesCriteriaQuestionReply()` even when history contains complete sourcing context. The explicit shortlist detection logic has a bug where it checks `hasHistoryWithA…",
          "expectedImpact": "UV017 Turn 2 will correctly use Turn 1 context (beet, 500kg, Minsk) instead of asking for criteria again. Fixes 'Complete context loss' issue reported by minimax judge.",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV014"
          ]
        },
        {
          "priority": "P1",
          "title": "Add empty response fallback handler",
          "why": "When LLM returns empty/502, the system should fall back to local resilient reply using available context instead of returning empty string to user.",
          "expectedImpact": "Even during infrastructure issues, users get useful fallback responses based on catalog data.",
          "validationScenarios": [
            "UV017",
            "UV011"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "guardrails",
          "title": "Add empty response detection and fallback in POST handler",
          "action": "In app/src/app/api/ai/request/route.ts, before returning final response, check if assistantMessage is empty after provider call. If empty AND vendorCandidates exist, return buildLocalResilientFallbackReply() instead of empty string.",
          "implementationHint": "Around line 4200-4300 where finalizeAssistantSessionTurn is called. Add: if (!assistantMessage.trim() && vendorCandidates.length > 0) { assistantMessage = buildLocalResilientFallbackReply({...}) }",
          "expectedImpact": "Prevents empty responses reaching users during 502 errors. Uses catalog data as fallback.",
          "risk": "Low - only activates when response would be empty anyway",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Fix looksLikeTopCompaniesRequestWithoutCriteria logic bug",
          "action": "The function at line 496-560 has flawed logic: when explicitShortlistRequest is true and hasHistoryWithAnyContent is true, it returns false (correct), but the calling code in buildHardFormattedReply then returns null, allowing the LLM to generate a criteria question. Add early return with forced shortlist when history has sourcing context.",
          "implementationHint": "Modify buildHardFormattedReply (line 679-692) to check: if (looksLikeTopCompaniesRequestWithoutCriteria(message, options) && options?.history?.length > 0 && getLastUserSourcingMessage(options.history)) { return buildForcedShortlistAppendix…",
          "expectedImpact": "Multi-turn scenarios with existing context bypass criteria questions and go straight to shortlist generation.",
          "risk": "Low - only affects cases where user explicitly asks for shortlist with history",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV001-T3",
            "UV014-T2"
          ]
        },
        {
          "id": "R3",
          "area": "retrieval",
          "title": "Persist vendorCandidates in session for continuity",
          "action": "The continuityCandidates logic (lines 3392-3415) relies on historyVendorCandidates from previous turns, but these aren't reliably persisted. Ensure vendor_candidate_ids are saved to ai_assistant_turns table and retrieved in getAssistantSessionHistory.",
          "implementationHint": "In app/src/lib/ai/conversations.ts getAssistantSessionHistory(), also return vendor_candidate_ids. In route.ts, pass these as historyVendorCandidates to postProcessAssistantReply.",
          "expectedImpact": "Turn 2+ reliably has access to Turn 1's candidate companies even if fresh search fails.",
          "risk": "Medium - requires DB schema awareness",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV012",
            "UV013"
          ]
        },
        {
          "id": "R4",
          "area": "guardrails",
          "title": "Add context-carry enforcement for sourcing turns",
          "action": "In postProcessAssistantReply, detect when output asks for criteria (contains 'уточните' + 'товар/услуга' + 'город') but history contains sourcing context. Replace with forced shortlist from history candidates.",
          "implementationHint": "Add regex check: if (/уточните.*что.*именно.*нужно.*найти.*товар.*услуга.*город/ui.test(out) && historyOnlyCandidates.length > 0) { out = buildForcedShortlistAppendix({candidates: historyOnlyCandidates, message}); }",
          "expectedImpact": "Safety net catches any remaining context loss cases.",
          "risk": "Low - defensive pattern match",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R5",
          "area": "ranking",
          "title": "Improve beet/vegetable commodity detection for UV017",
          "action": "The query 'красного буряка' should map to 'beet' commodity tag. Current detectCoreCommodityTag may not catch 'буряк' synonym. Add explicit synonym mapping.",
          "implementationHint": "In commodity detection logic (around line 2390), ensure /буряк/u maps to 'beet' tag same as /свекл/u.",
          "expectedImpact": "Better search results for 'буряк' queries, improving candidate quality.",
          "risk": "None",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json - UV001 through UV022",
          "app/qa/ai-request/scenarios.regressions.user-ideas-multistep-variants.json"
        ],
        "successMetrics": [
          "UV017 strictPass: true (was false)",
          "UV017 avgUsefulness: >=3 (was 1)",
          "Zero 502 errors in 10 consecutive runs",
          "Context retention rate: >90% for multi-turn scenarios"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "The UV017 run failed entirely due to a 502 Bad Gateway from nginx before any checks could run. This is an infrastructure issue (missing proxy_read_timeout for the long AI request), not a prompt issue. The judge notes from a prior run also reveal a persistent context-loss bug in multi-turn shortlist flows. Two root causes need fixing: (1) nginx proxy timeout too low for the AI endpoint, and (2) the context-carry logic in looksLikeTopCompaniesRequestWithoutCriteria still falls through when the user's Turn 2 message is phrased as a shortlist request without explicit shortlist keywords.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix nginx 502 timeout on /api/ai/request",
          "why": "The entire QA run scores 0% because nginx returns 502 before the upstream Next.js route responds. The default proxy_read_timeout is 60s; the AI route regularly takes 14s+ and can spike to 60s+ on cold LLM calls or multi-tool chains (website scan, internet sea…",
          "expectedImpact": "Eliminates 100% of hard-error 502 failures; all scenario turns become evaluable.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P0",
          "title": "Fix Turn-2 context loss on shortlist requests without explicit shortlist keywords",
          "why": "The minimax judge flagged 'complete context loss in turn 2 — asked for product/city despite having complete context (beet, 500kg, Minsk) from turn 1'. The UV017.T2 user message ('Сделай shortlist 3 релевантных поставщиков. Если точных совпадений нет — честно…",
          "expectedImpact": "Fixes context continuity for UV017 and similar multi-turn shortlist-after-sourcing scenarios. Expected to raise usefulness from 1→4+ for this pattern.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P1",
          "title": "Add proxy_read_timeout / proxy_send_timeout for all AI-heavy endpoints",
          "why": "Even after the basic timeout fix, website-scan and internet-search chains can take 30-90s. A blanket 120s timeout on the AI location block prevents intermittent 502s during heavy multi-tool turns.",
          "expectedImpact": "Reduces intermittent 502 rate across all multi-turn scenarios to near zero.",
          "validationScenarios": [
            "UV012",
            "UV013",
            "UV019",
            "UV022"
          ]
        },
        {
          "priority": "P2",
          "title": "Add QA-runner retry on 502 with exponential backoff",
          "why": "Even with nginx timeout fixes, transient 502s (container restart, OOM kill) can poison an entire run. The QA runner already has busyRetry and rateLimitRetry logic but no 502-specific retry path.",
          "expectedImpact": "Reduces false-negative QA runs from infra blips; improves signal-to-noise of pass rate metric.",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "retrieval",
          "title": "Add proxy_read_timeout 120s to nginx AI endpoint location",
          "action": "In nginx/conf.d/default.conf, add a dedicated `location /api/ai/` block (or add directives to the existing `location /`) with `proxy_read_timeout 120s; proxy_connect_timeout 10s; proxy_send_timeout 120s;`. This prevents 502s on long AI calls.",
          "implementationHint": "nginx/conf.d/default.conf — add `proxy_read_timeout 120s;` inside the `location /` block, or better yet create `location /api/ai/ { ... }` with these settings.",
          "expectedImpact": "Eliminates 502 hard-errors; unblocks all scenario evaluation.",
          "risk": "Low — only affects timeout thresholds; no functional change to app.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Harden vendorLookupContext to carry forward product+geo from history on shortlist turns",
          "action": "In the `buildVendorLookupContext` function (route.ts ~line 300-400), when the current message matches shortlist intent AND history contains a sourcing message with product+geo, force `shouldLookup=true`, `searchText` from history's product, and `city`/`region` from history's geo — even if the current message itself has no product/geo tokens. Currently the code only does this for `explicitShortlistRequest` inside `lo…",
          "implementationHint": "route.ts — find `buildVendorLookupContext` function. Add early-return path: if `isShortlistIntent(message) && getLastUserSourcingMessage(history)` → derive searchText/city/region from that history message and return `{shouldLookup:true, de…",
          "expectedImpact": "Fixes UV017 Turn 2 context loss; expected to fix similar patterns in UV001.T3, UV004.T3, UV008.T3.",
          "risk": "Medium — over-aggressive carry-forward could produce stale lookups if user changes topic. Mitigate by checking that no explicit topic-change markers exist in the current message.",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV004",
            "UV008"
          ]
        },
        {
          "id": "R3",
          "area": "qa",
          "title": "Add 502/503 retry logic to QA runner",
          "action": "In the QA runner's turn execution loop, treat HTTP 502/503 as retryable (similar to existing busyRetry logic). Add up to 2 retries with 3s/6s backoff before marking the turn as a hard error.",
          "implementationHint": "app/qa/ai-request/ — find the turn execution function that handles `apiError`. Add a retry branch for status 502/503 before recording hardError.",
          "expectedImpact": "Prevents transient infra blips from failing entire scenarios; improves QA signal reliability.",
          "risk": "Low — worst case is slightly longer QA runs on genuine downtime.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R4",
          "area": "guardrails",
          "title": "Strengthen anti-noise filter for educational institutions in commodity sourcing",
          "action": "The UV017 scenario specifically checks that educational institutions (колледж, университет, институт, лицей, школа) are not returned as suppliers. The minimax judge noted Turn 1 was clean in a prior run. Ensure the post-retrieval filter in `filterNoisyCandidates` or equivalent explicitly excludes companies whose rubric/name matches educational-institution patterns when the query is commodity-sourcing.",
          "implementationHint": "route.ts — find candidate filtering near `formatVendorShortlistRows`. Add exclusion regex: `/колледж|университет|институт|лицей|школа|академи/iu` on company name and rubric fields.",
          "expectedImpact": "Ensures UV017.T1.C3 (excludes_all educational institutions) passes consistently.",
          "risk": "Low — false positives (legitimate companies with 'институт' in name) are rare in commodity sourcing context.",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R5",
          "area": "prompt",
          "title": "Add explicit 'no-criteria-question' instruction when history contains full sourcing context",
          "action": "In the system prompt builder, when history already contains product + city + volume, add a directive: 'Пользователь уже указал товар, объем и город в предыдущих сообщениях. НЕ СПРАШИВАЙ повторно эти параметры. Используй контекст из истории.' This prevents the LLM from generating a criteria-question even if the code path doesn't trigger the shortlist bypass.",
          "implementationHint": "route.ts — in the system prompt assembly section (search for 'GUARDRAILS' or system message construction). Add conditional instruction when `vendorLookupContext.derivedFromHistory === true`.",
          "expectedImpact": "Belt-and-suspenders fix for context loss. Even if the code path incorrectly asks for criteria, the prompt-level instruction prevents the LLM from doing so.",
          "risk": "Low — instruction is conditional and only fires when history context is confirmed.",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV005"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json"
        ],
        "successMetrics": [
          "UV017 all 3 turns complete without hard-error (no 502)",
          "UV017 strict pass = true",
          "UV017 average usefulness ≥ 3.5 across both judges",
          "UV017.T1.C3 excludes_all educational institutions = pass",
          "UV017.T2 shortlist or honest fallback with alternatives = pass",
          "Overall pass rate across full regression suite ≥ 0.8",
          "genericFallbackRate ≤ 0.35 for both judges",
          "averageUserSatisfaction ≥ 0.72 for both judges"
        ]
      }
    }
  ],
  "advisorWarnings": [],
  "consensus": {
    "topAreas": [
      {
        "area": "guardrails",
        "count": 3
      },
      {
        "area": "prompt",
        "count": 3
      },
      {
        "area": "retrieval",
        "count": 2
      },
      {
        "area": "ranking",
        "count": 1
      },
      {
        "area": "qa",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "add empty response detection and fallback in post handler",
        "count": 1
      },
      {
        "title": "fix looksliketopcompaniesrequestwithoutcriteria logic bug",
        "count": 1
      },
      {
        "title": "persist vendorcandidates in session for continuity",
        "count": 1
      },
      {
        "title": "add context-carry enforcement for sourcing turns",
        "count": 1
      },
      {
        "title": "improve beet/vegetable commodity detection for uv017",
        "count": 1
      },
      {
        "title": "add proxy_read_timeout 120s to nginx ai endpoint location",
        "count": 1
      },
      {
        "title": "harden vendorlookupcontext to carry forward product+geo from history on shortlist turns",
        "count": 1
      },
      {
        "title": "add 502/503 retry logic to qa runner",
        "count": 1
      },
      {
        "title": "strengthen anti-noise filter for educational institutions in commodity sourcing",
        "count": 1
      },
      {
        "title": "add explicit 'no-criteria-question' instruction when history contains full sourcing context",
        "count": 1
      }
    ]
  }
}
