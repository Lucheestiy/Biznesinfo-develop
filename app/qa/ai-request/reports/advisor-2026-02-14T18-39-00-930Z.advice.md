# Advisor Report — advisor-2026-02-14T18-39-00-930Z

- Generated: 2026-02-14T18:42:02.716Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 1
- Advisors: kimi, minimax

## Focus Scenarios

- UV017 (fail, usefulness 1/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"

## Consensus

- Top areas:
  - guardrails: 3
  - prompt: 3
  - retrieval: 2
  - ranking: 1
  - qa: 1
- Recurring recommendations:
  - add empty response detection and fallback in post handler (1)
  - fix looksliketopcompaniesrequestwithoutcriteria logic bug (1)
  - persist vendorcandidates in session for continuity (1)
  - add context-carry enforcement for sourcing turns (1)
  - improve beet/vegetable commodity detection for uv017 (1)
  - add proxy_read_timeout 120s to nginx ai endpoint location (1)
  - harden vendorlookupcontext to carry forward product+geo from history on shortlist turns (1)
  - add 502/503 retry logic to qa runner (1)
  - strengthen anti-noise filter for educational institutions in commodity sourcing (1)
  - add explicit 'no-criteria-question' instruction when history contains full sourcing context (1)

## kimi

- Summary: UV017 failed due to 502 Bad Gateway error causing empty assistant response (usefulness=0) and context loss in Turn 2 where assistant asked for product/city despite having complete context (beet, 500kg, Minsk) from Turn 1. The root causes are: (1) Infrastructure instability - nginx/backend communication failure; (2) Session persistence bug - `looksLikeTopCompaniesRequestWithoutCriteria()` fails to detect existing sourcing context when explicit shortlist is requested; (3) Missing robust fallback when LLM provider returns empty/502 response.

### Priority Plan

- P0 — Fix 502 Bad Gateway infrastructure issue
  why: 502 errors cause complete response failure (empty assistant replies), making all other fixes irrelevant. The nginx→app container communication is unstable under load.
  impact: Eliminates 0-usefulness responses due to infrastructure errors. Enables reliable QA testing.
  validate: UV017
- P0 — Fix context loss in multi-turn shortlist requests
  why: The `looksLikeTopCompaniesRequestWithoutCriteria()` function incorrectly returns `buildTopCompaniesCriteriaQuestionReply()` even when history contains complete sourcing context. The explicit shortlist detection logic has a bug where it checks `hasHistoryWithA…
  impact: UV017 Turn 2 will correctly use Turn 1 context (beet, 500kg, Minsk) instead of asking for criteria again. Fixes 'Complete context loss' issue reported by minimax judge.
  validate: UV017, UV001, UV014
- P1 — Add empty response fallback handler
  why: When LLM returns empty/502, the system should fall back to local resilient reply using available context instead of returning empty string to user.
  impact: Even during infrastructure issues, users get useful fallback responses based on catalog data.
  validate: UV017, UV011

### Recommendations

- [R1] (guardrails, effort S) Add empty response detection and fallback in POST handler
  action: In app/src/app/api/ai/request/route.ts, before returning final response, check if assistantMessage is empty after provider call. If empty AND vendorCandidates exist, return buildLocalResilientFallbackReply() instead of empty string.
  hint: Around line 4200-4300 where finalizeAssistantSessionTurn is called. Add: if (!assistantMessage.trim() && vendorCandidates.length > 0) { assistantMessage = buildLocalResilientFallbackReply({...}) }
  impact: Prevents empty responses reaching users during 502 errors. Uses catalog data as fallback.
  risk: Low - only activates when response would be empty anyway
  validate: UV017
- [R2] (prompt, effort S) Fix looksLikeTopCompaniesRequestWithoutCriteria logic bug
  action: The function at line 496-560 has flawed logic: when explicitShortlistRequest is true and hasHistoryWithAnyContent is true, it returns false (correct), but the calling code in buildHardFormattedReply then returns null, allowing the LLM to generate a criteria question. Add early return with forced shortlist when history has sourcing context.
  hint: Modify buildHardFormattedReply (line 679-692) to check: if (looksLikeTopCompaniesRequestWithoutCriteria(message, options) && options?.history?.length > 0 && getLastUserSourcingMessage(options.history)) { return buildForcedShortlistAppendix…
  impact: Multi-turn scenarios with existing context bypass criteria questions and go straight to shortlist generation.
  risk: Low - only affects cases where user explicitly asks for shortlist with history
  validate: UV017, UV001-T3, UV014-T2
- [R3] (retrieval, effort M) Persist vendorCandidates in session for continuity
  action: The continuityCandidates logic (lines 3392-3415) relies on historyVendorCandidates from previous turns, but these aren't reliably persisted. Ensure vendor_candidate_ids are saved to ai_assistant_turns table and retrieved in getAssistantSessionHistory.
  hint: In app/src/lib/ai/conversations.ts getAssistantSessionHistory(), also return vendor_candidate_ids. In route.ts, pass these as historyVendorCandidates to postProcessAssistantReply.
  impact: Turn 2+ reliably has access to Turn 1's candidate companies even if fresh search fails.
  risk: Medium - requires DB schema awareness
  validate: UV017, UV012, UV013
- [R4] (guardrails, effort S) Add context-carry enforcement for sourcing turns
  action: In postProcessAssistantReply, detect when output asks for criteria (contains 'уточните' + 'товар/услуга' + 'город') but history contains sourcing context. Replace with forced shortlist from history candidates.
  hint: Add regex check: if (/уточните.*что.*именно.*нужно.*найти.*товар.*услуга.*город/ui.test(out) && historyOnlyCandidates.length > 0) { out = buildForcedShortlistAppendix({candidates: historyOnlyCandidates, message}); }
  impact: Safety net catches any remaining context loss cases.
  risk: Low - defensive pattern match
  validate: UV017
- [R5] (ranking, effort S) Improve beet/vegetable commodity detection for UV017
  action: The query 'красного буряка' should map to 'beet' commodity tag. Current detectCoreCommodityTag may not catch 'буряк' synonym. Add explicit synonym mapping.
  hint: In commodity detection logic (around line 2390), ensure /буряк/u maps to 'beet' tag same as /свекл/u.
  impact: Better search results for 'буряк' queries, improving candidate quality.
  risk: None
  validate: UV017

## minimax

- Summary: The UV017 run failed entirely due to a 502 Bad Gateway from nginx before any checks could run. This is an infrastructure issue (missing proxy_read_timeout for the long AI request), not a prompt issue. The judge notes from a prior run also reveal a persistent context-loss bug in multi-turn shortlist flows. Two root causes need fixing: (1) nginx proxy timeout too low for the AI endpoint, and (2) the context-carry logic in looksLikeTopCompaniesRequestWithoutCriteria still falls through when the user's Turn 2 message is phrased as a shortlist request without explicit shortlist keywords.

### Priority Plan

- P0 — Fix nginx 502 timeout on /api/ai/request
  why: The entire QA run scores 0% because nginx returns 502 before the upstream Next.js route responds. The default proxy_read_timeout is 60s; the AI route regularly takes 14s+ and can spike to 60s+ on cold LLM calls or multi-tool chains (website scan, internet sea…
  impact: Eliminates 100% of hard-error 502 failures; all scenario turns become evaluable.
  validate: UV017
- P0 — Fix Turn-2 context loss on shortlist requests without explicit shortlist keywords
  why: The minimax judge flagged 'complete context loss in turn 2 — asked for product/city despite having complete context (beet, 500kg, Minsk) from turn 1'. The UV017.T2 user message ('Сделай shortlist 3 релевантных поставщиков. Если точных совпадений нет — честно…
  impact: Fixes context continuity for UV017 and similar multi-turn shortlist-after-sourcing scenarios. Expected to raise usefulness from 1→4+ for this pattern.
  validate: UV017
- P1 — Add proxy_read_timeout / proxy_send_timeout for all AI-heavy endpoints
  why: Even after the basic timeout fix, website-scan and internet-search chains can take 30-90s. A blanket 120s timeout on the AI location block prevents intermittent 502s during heavy multi-tool turns.
  impact: Reduces intermittent 502 rate across all multi-turn scenarios to near zero.
  validate: UV012, UV013, UV019, UV022
- P2 — Add QA-runner retry on 502 with exponential backoff
  why: Even with nginx timeout fixes, transient 502s (container restart, OOM kill) can poison an entire run. The QA runner already has busyRetry and rateLimitRetry logic but no 502-specific retry path.
  impact: Reduces false-negative QA runs from infra blips; improves signal-to-noise of pass rate metric.
  validate: UV017

### Recommendations

- [R1] (retrieval, effort S) Add proxy_read_timeout 120s to nginx AI endpoint location
  action: In nginx/conf.d/default.conf, add a dedicated `location /api/ai/` block (or add directives to the existing `location /`) with `proxy_read_timeout 120s; proxy_connect_timeout 10s; proxy_send_timeout 120s;`. This prevents 502s on long AI calls.
  hint: nginx/conf.d/default.conf — add `proxy_read_timeout 120s;` inside the `location /` block, or better yet create `location /api/ai/ { ... }` with these settings.
  impact: Eliminates 502 hard-errors; unblocks all scenario evaluation.
  risk: Low — only affects timeout thresholds; no functional change to app.
  validate: UV017
- [R2] (prompt, effort M) Harden vendorLookupContext to carry forward product+geo from history on shortlist turns
  action: In the `buildVendorLookupContext` function (route.ts ~line 300-400), when the current message matches shortlist intent AND history contains a sourcing message with product+geo, force `shouldLookup=true`, `searchText` from history's product, and `city`/`region` from history's geo — even if the current message itself has no product/geo tokens. Currently the code only does this for `explicitShortlistRequest` inside `lo…
  hint: route.ts — find `buildVendorLookupContext` function. Add early-return path: if `isShortlistIntent(message) && getLastUserSourcingMessage(history)` → derive searchText/city/region from that history message and return `{shouldLookup:true, de…
  impact: Fixes UV017 Turn 2 context loss; expected to fix similar patterns in UV001.T3, UV004.T3, UV008.T3.
  risk: Medium — over-aggressive carry-forward could produce stale lookups if user changes topic. Mitigate by checking that no explicit topic-change markers exist in the current message.
  validate: UV017, UV001, UV004, UV008
- [R3] (qa, effort S) Add 502/503 retry logic to QA runner
  action: In the QA runner's turn execution loop, treat HTTP 502/503 as retryable (similar to existing busyRetry logic). Add up to 2 retries with 3s/6s backoff before marking the turn as a hard error.
  hint: app/qa/ai-request/ — find the turn execution function that handles `apiError`. Add a retry branch for status 502/503 before recording hardError.
  impact: Prevents transient infra blips from failing entire scenarios; improves QA signal reliability.
  risk: Low — worst case is slightly longer QA runs on genuine downtime.
  validate: UV017
- [R4] (guardrails, effort S) Strengthen anti-noise filter for educational institutions in commodity sourcing
  action: The UV017 scenario specifically checks that educational institutions (колледж, университет, институт, лицей, школа) are not returned as suppliers. The minimax judge noted Turn 1 was clean in a prior run. Ensure the post-retrieval filter in `filterNoisyCandidates` or equivalent explicitly excludes companies whose rubric/name matches educational-institution patterns when the query is commodity-sourcing.
  hint: route.ts — find candidate filtering near `formatVendorShortlistRows`. Add exclusion regex: `/колледж|университет|институт|лицей|школа|академи/iu` on company name and rubric fields.
  impact: Ensures UV017.T1.C3 (excludes_all educational institutions) passes consistently.
  risk: Low — false positives (legitimate companies with 'институт' in name) are rare in commodity sourcing context.
  validate: UV017
- [R5] (prompt, effort S) Add explicit 'no-criteria-question' instruction when history contains full sourcing context
  action: In the system prompt builder, when history already contains product + city + volume, add a directive: 'Пользователь уже указал товар, объем и город в предыдущих сообщениях. НЕ СПРАШИВАЙ повторно эти параметры. Используй контекст из истории.' This prevents the LLM from generating a criteria-question even if the code path doesn't trigger the shortlist bypass.
  hint: route.ts — in the system prompt assembly section (search for 'GUARDRAILS' or system message construction). Add conditional instruction when `vendorLookupContext.derivedFromHistory === true`.
  impact: Belt-and-suspenders fix for context loss. Even if the code path incorrectly asks for criteria, the prompt-level instruction prevents the LLM from doing so.
  risk: Low — instruction is conditional and only fires when history context is confirmed.
  validate: UV017, UV001, UV005

