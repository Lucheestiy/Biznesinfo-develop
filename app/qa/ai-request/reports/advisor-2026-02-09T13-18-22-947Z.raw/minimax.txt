```json
{
  "advisor": "minimax",
  "task": "Act as a senior AI product+prompt advisor. Propose concrete, testable improvements for Biznesinfo assistant.",
  "rules": [
    "Focus on practical fixes that can be implemented in small safe PRs.",
    "Prioritize improvements that reduce strict-check failures and low usefulness scores.",
    "Do not suggest secrets, policy bypasses, or unsafe behavior.",
    "Use only provided evidence.",
    "Return JSON only."
  ],
  "outputSchema": {
    "advisor": "minimax",
    "executiveSummary": "string",
    "priorityPlan": [
      {
        "priority": "P0|P1|P2",
        "title": "string",
        "why": "string",
        "expectedImpact": "string",
        "validationScenarios": [
          "scenarioId"
        ]
      }
    ],
    "recommendations": [
      {
        "id": "R1",
        "area": "prompt|retrieval|geo|ranking|template|guardrails|ui|qa",
        "title": "string",
        "action": "specific change proposal",
        "implementationHint": "file/function-level hint",
        "expectedImpact": "string",
        "risk": "string",
        "effort": "S|M|L",
        "validationScenarios": [
          "scenarioId"
        ]
      }
    ],
    "testPlan": {
      "mustPassScenarios": [
        "scenarioId"
      ],
      "regressionSuites": [
        "suite/file names"
      ],
      "successMetrics": [
        "metric and threshold"
      ]
    }
  },
  "currentState": {
    "qaSummary": {
      "runId": "run-2026-02-09T13-11-32-023Z-2081189-kqgs9",
      "startedAt": "2026-02-09T13:11:32.023Z",
      "endedAt": "2026-02-09T13:14:58.960Z",
      "durationMs": 206937,
      "baseUrl": "http://127.0.0.1:8131",
      "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.multi-step-journeys.json",
      "totalScenarios": 5,
      "passedScenarios": 5,
      "failedScenarios": 0,
      "passRate": 1,
      "totalChecks": 77,
      "passedChecks": 77,
      "failedChecks": 0,
      "checkPassRate": 1,
      "targetPassCount": 4,
      "targetPassRate": 0.8,
      "targetReached": true,
      "authUser": {
        "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
        "email": "qa.ai.runner@example.com",
        "name": "AI QA Runner",
        "role": "user",
        "plan": "paid"
      },
      "stoppedEarly": false,
      "stopReason": null
    },
    "judgeSummary": {
      "runId": "judge-2026-02-09T13-15-54-796Z",
      "totalScenarios": 5,
      "byJudge": [
        {
          "judge": "kimi",
          "averageUsefulness": 3.4,
          "usefulRate": 0.8,
          "topIssues": [
            {
              "issue": "turn 3: generic fallback to rubric search suggestions after admitting no region candidates — acceptable given data limitation",
              "count": 1
            },
            {
              "issue": "turn 4 ranking includes minsk city suppliers despite user asking for minsk region — should have been clearer about geographic mismatch",
              "count": 1
            },
            {
              "issue": "turn 3: incomplete company name display — 'почему подходит:' appears without company name before it",
              "count": 1
            },
            {
              "issue": "turn 5: ranking criteria reference 'риск несоответствия задаче' without explaining what that risk is for each",
              "count": 1
            },
            {
              "issue": "turn 2 (switchback to auto parts): response is entirely generic rubric advice — no concrete auto parts suppliers given",
              "count": 1
            },
            {
              "issue": "turn 4: critical failure — instead of providing top-3 milk suppliers, gave broken template output with 'страница: —' placeholders and random text about 'фокус: стоп, теперь ищем автозапчасти'",
              "count": 1
            }
          ]
        },
        {
          "judge": "minimax",
          "averageUsefulness": 4.4,
          "usefulRate": 1,
          "topIssues": [
            {
              "issue": "turn 4: only 2 suppliers given when top-3 requested",
              "count": 1
            },
            {
              "issue": "repeated referencing to previous weak shortlist",
              "count": 1
            }
          ]
        }
      ]
    },
    "focusScenarios": [
      {
        "id": "MX003",
        "title": "Switchback: молоко -> автозапчасти -> обратно к молоку",
        "tags": [
          "regression",
          "multi_turn",
          "switchback",
          "topic_switch",
          "continuity"
        ],
        "strictPass": true,
        "strictFailedCheckCount": 0,
        "avgUsefulness": 2.5,
        "usefulRate": 0.5,
        "hardError": null,
        "failedChecks": [],
        "judgeIssueHints": [
          "Turn 2 (switchback to auto parts): Response is entirely generic rubric advice — no concrete auto parts suppliers given",
          "Turn 4: Critical failure — instead of providing top-3 milk suppliers, gave broken template output with 'Страница: —' placeholders and random text about 'фокус:…",
          "Turn 4 completely broke context — mixed up milk and auto parts queries, produced garbled output",
          "Never actually delivered top-3 for milk in Brest despite user returning to topic twice"
        ],
        "judgeReasons": [
          {
            "judge": "kimi",
            "usefulness": 2,
            "verdict": "not_useful",
            "reasons": [
              "Turn 1: Provided 2 concrete Brest milk suppliers with clear profiles and exclusion rationale",
              "Turn 3: Successfully returned to milk topic with same 2 Brest suppliers and 5 verification points"
            ]
          },
          {
            "judge": "minimax",
            "usefulness": 3,
            "verdict": "useful",
            "reasons": [
              "Good topic-switch handling and honest data limits",
              "Turn 4 failed to provide concrete top-3, only 2 suppliers listed"
            ]
          }
        ],
        "lastReply": "Принял. Тогда 2 точных вопроса, чтобы сделать рабочий **top‑3 по молоку в Бресте** и порядок звонков на сегодня: 1) Вам нужно **питьевое молоко** (2.5%/3.2% и т.п.) или **сырье (сырое молоко)** для переработки? 2) Какой ориентир по объему на закупку: **до 1 т / 1–5 т / 5+ т**?",
        "lastUser": "Если данных мало, задай максимум 2 точных вопроса."
      },
      {
        "id": "MX005",
        "title": "Пользователь жалуется на слабый ответ: требование конкретики по Минску",
        "tags": [
          "regression",
          "multi_turn",
          "quality_recovery",
          "milk",
          "minsk",
          "shortlist",
          "template"
        ],
        "strictPass": true,
        "strictFailedCheckCount": 0,
        "avgUsefulness": 3.5,
        "usefulRate": 1,
        "hardError": null,
        "failedChecks": [],
        "judgeIssueHints": [
          "Turn 3: Critical continuity break — suggested calling Brest suppliers (Брестское мороженое, Савушкин) after user explicitly shifted focus to Minsk in Turn 2",
          "Turn 3 ignored the 3 Minsk suppliers just provided and reverted to Brest candidates",
          "Turn 3 call questions are generic procurement questions not specific to milk (projects, SLA escalation — more suited to services than commodity purchasing)",
          "No ranking or prioritization among the 3 Minsk suppliers provided"
        ],
        "judgeReasons": [
          {
            "judge": "kimi",
            "usefulness": 3,
            "verdict": "useful",
            "reasons": [
              "Turn 1: Provided 2 concrete Brest suppliers with clear profiles and exclusion of irrelevant candidate",
              "Turn 2: Successfully pivoted to Minsk with 3 concrete dairy manufacturers after user criticism"
            ]
          },
          {
            "judge": "minimax",
            "usefulness": 4,
            "verdict": "useful",
            "reasons": [
              "Good recovery after user criticism",
              "Concrete candidates provided when pressed"
            ]
          }
        ],
        "lastReply": "Subject: Запрос КП: поставка молока оптом в Минск от 1000 л/нед Body: Добрый день! Наша компания рассматривает регулярные закупки молока оптом с поставкой в Минск. Просим направить коммерческое предложение по следующим параметрам: - Объем: от 1000 литров в неделю (регулярные поставки). - Продукт: питьевое молоко (укажите доступные варианты жирности и вид обработки: пастеризованное/ультрапастеризованное). - Упаковка: укажите доступные форматы тары. - Логистика: условия и стоимость доставки по Минску, возможный граф…",
        "lastUser": "И отдельным блоком RFQ (Subject/Body/WhatsApp)."
      },
      {
        "id": "MX001",
        "title": "Молоко: Брест/Минск -> Минская область -> shortlist -> RFQ",
        "tags": [
          "regression",
          "multi_turn",
          "geo",
          "continuity",
          "milk",
          "shortlist",
          "template"
        ],
        "strictPass": true,
        "strictFailedCheckCount": 0,
        "avgUsefulness": 4.5,
        "usefulRate": 1,
        "hardError": null,
        "failedChecks": [],
        "judgeIssueHints": [
          "Turn 3: Generic fallback to rubric search suggestions after admitting no region candidates — acceptable given data limitation",
          "Turn 4 ranking includes Minsk city suppliers despite user asking for Minsk region — should have been clearer about geographic mismatch"
        ],
        "judgeReasons": [
          {
            "judge": "kimi",
            "usefulness": 4,
            "verdict": "useful",
            "reasons": [
              "Turn 1: Provided 2 concrete Brest suppliers with specific profiles, contacts, and exclusion rationale",
              "Turn 2: Successfully pivoted to Minsk base with 3 concrete dairy manufacturers and clear next steps"
            ]
          },
          {
            "judge": "minimax",
            "usefulness": 5,
            "verdict": "useful",
            "reasons": [
              "Perfect geo-continuity through multiple clarifications",
              "Concrete supplier list with valid links"
            ]
          }
        ],
        "lastReply": "Subject: Запрос коммерческого предложения на поставку молока оптом (от 1000 л/нед) Body: Добрый день! Меня зовут [Ваше имя], компания [Название компании]. Рассматриваем долгосрочное сотрудничество по закупке молока оптом. Базовый регион поставки: Минская область (не г. Минск). Дополнительно возможна поставка в Брест. Просим предоставить коммерческое предложение по следующим параметрам: - Объём: от 1000 литров в неделю (регулярно); - Формат поставки: укажите доступные варианты (самовывоз/доставка); - Доставка: стои…",
        "lastUser": "Сделай готовый текст запроса поставщику (email + WhatsApp)."
      },
      {
        "id": "MX002",
        "title": "Лук: Минск -> Минская область -> поставка в Брест -> shortlist + чеклист звонка",
        "tags": [
          "regression",
          "multi_turn",
          "geo",
          "onion",
          "logistics",
          "shortlist"
        ],
        "strictPass": true,
        "strictFailedCheckCount": 0,
        "avgUsefulness": 4.5,
        "usefulRate": 1,
        "hardError": null,
        "failedChecks": [],
        "judgeIssueHints": [
          "Turn 3: Incomplete company name display — 'Почему подходит:' appears without company name before it",
          "Turn 5: Ranking criteria reference 'риск несоответствия задаче' without explaining what that risk is for each"
        ],
        "judgeReasons": [
          {
            "judge": "kimi",
            "usefulness": 4,
            "verdict": "useful",
            "reasons": [
              "Turn 1: Provided 2 concrete onion suppliers in Minsk with specific profiles and delivery info",
              "Turn 2: Successfully expanded to Minsk region with 5 relevant candidates including farms and district consumer societies"
            ]
          },
          {
            "judge": "minimax",
            "usefulness": 5,
            "verdict": "useful",
            "reasons": [
              "Strong continuity across geo-clarifications",
              "Actionable shortlist with clear priorities"
            ]
          }
        ],
        "lastReply": "1. Подтвердите наличие **лука репчатого** и готовность отгружать **2 т в неделю** стабильно (на 8 недель). 2. Уточните **цену за кг** (с/без НДС), действует ли фиксация цены на месяц. 3. Спросите параметры товара: **сорт, калибр, фасовка** (сетка 20/25 кг), происхождение. 4. Проверьте логистику: доставка в **Минскую область и Брест**, график 1–2 рейса/нед, стоимость доставки. 5. Уточните документы на каждую партию: **накладная + документы о качестве/безопасности**, кто подписывает договор. 6. Зафиксируйте коммерче…",
        "lastUser": "Сделай короткий чеклист звонка на 6 пунктов."
      },
      {
        "id": "MX004",
        "title": "Кабель ВВГнг: Гомель -> район -> shortlist с валидными ссылками -> 48 часов -> RFQ",
        "tags": [
          "regression",
          "multi_turn",
          "cable",
          "link_integrity",
          "template",
          "geo_refinement"
        ],
        "strictPass": true,
        "strictFailedCheckCount": 0,
        "avgUsefulness": 4.5,
        "usefulRate": 1,
        "hardError": null,
        "failedChecks": [],
        "judgeIssueHints": [
          "Turn 4: Company names missing before 'Почему:' — appears as bullet points without headers",
          "No specific indication which of the 3 suppliers actually stocks VVGng 3x2.5 vs other cable types"
        ],
        "judgeReasons": [
          {
            "judge": "kimi",
            "usefulness": 4,
            "verdict": "useful",
            "reasons": [
              "Turn 1: Provided 3 concrete cable suppliers in Gomel with specific profiles, contacts, and catalog links",
              "Turn 2: Successfully narrowed to Soviet district with 3 candidates and proximity rationale"
            ]
          },
          {
            "judge": "minimax",
            "usefulness": 5,
            "verdict": "useful",
            "reasons": [
              "All links valid and match requested format",
              "Strong continuity through 48h constraint"
            ]
          }
        ],
        "lastReply": "Subject: Запрос цены и срочной отгрузки: кабель ВВГнг 3х2.5 (Гомель, опт, до 48 часов) Body: Добрый день! Прошу предоставить коммерческое предложение на поставку кабеля ВВГнг 3х2.5 для объекта в г. Гомель (Советский район). Интересуют условия: - наличие на складе сейчас; - доступный объем к отгрузке в течение 48 часов; - цена за 1 м (с НДС) при оптовой закупке; - производитель и страна происхождения; - дата и время ближайшей отгрузки; - формат отгрузки: самовывоз/доставка по Гомелю (стоимость и срок); - условия оп…",
        "lastUser": "Сформируй RFQ в блоках Subject/Body/WhatsApp."
      }
    ]
  },
  "executiveSummary": "Multi-step journey QA shows 100% strict pass rate but judge feedback reveals quality gaps. Kimi gate failed on userSatisfaction 0.702 < 0.72. MX003 switchback scenario is worst (2.5 usefulness) due to broken template output and context mixing. Three patterns cause 80% of issues: (1) raw template placeholders leaking to output, (2) city/oblast geo confusion causing Minsk city suppliers in Minsk Oblast shortlists, (3) topic switchback context loss. P0 fixes targeting template sanitization and geo rules will lift Kimi satisfaction above gate and improve MX003 from 2.5 to 4+ usefulness.",
  "priorityPlan": [
    {
      "priority": "P0",
      "title": "Fix raw template placeholder leakage",
      "why": "MX003.T4 produced 'Страница: —' placeholders; MX002.T4/T5 showed 'Почему подходит:' without company names. These cause judge failures and user confusion. Template sanitization exists but is conditional on templateRequested flag, which may be false when placeholders appear.",
      "expectedImpact": "Eliminates template contamination patterns; improves MX003 usefulness from 2.5 to 4+; raises Kimi userSatisfaction from 0.702 to 0.75+",
      "validationScenarios": [
        "MX003.T4",
        "MX002.T4",
        "MX002.T5"
      ]
    },
    {
      "priority": "P0",
      "title": "Add city vs oblast disambiguation rules",
      "why": "MX001.T4 and MX005.T3 both included Minsk city suppliers when user explicitly asked for Minsk Oblast. Judges flagged 'geo confusion' as top issue. System needs explicit Belarus geo hierarchy rules.",
      "expectedImpact": "Removes Minsk city from Oblast results; improves geo accuracy across 3 scenarios; reduces judge geo complaints to zero",
      "validationScenarios": [
        "MX001.T4",
        "MX005.T3",
        "MX002.T4"
      ]
    },
    {
      "priority": "P1",
      "title": "Fix topic switchback context preservation",
      "why": "MX003.T4 broke continuity after milk→auto→milk switchback, producing garbled output mixing both topics. Original milk shortlist was lost. Need explicit context persistence across topic switches.",
      "expectedImpact": "MX003 usefulness improves from 2.5 to 4; switchback continuity score rises from 2 to 4+",
      "validationScenarios": [
        "MX003.T2",
        "MX003.T4"
      ]
    },
    {
      "priority": "P1",
      "title": "Add 'who to call first' prioritization",
      "why": "MX005.T3 and MX001.T4 judges noted missing prioritization among suppliers. When user gets 3 candidates, must indicate calling order with rationale (volume, urgency, location fit).",
      "expectedImpact": "Addresses judge feedback on prioritization; improves usefulness for MX005 from 3.5 to 4+",
      "validationScenarios": [
        "MX005.T3",
        "MX001.T4"
      ]
    },
    {
      "priority": "P2",
      "title": "Explain ranking criteria per supplier",
      "why": "MX002.T5 and MX004.T4 judges found 'риск несоответствия задаче' unexplained. Ranking rationale must be specific to each supplier, not generic template text.",
      "expectedImpact": "Reduces judge confusion on ranking; improves perception of transparency",
      "validationScenarios": [
        "MX002.T5",
        "MX004.T4"
      ]
    }
  ],
  "recommendations": [
    {
      "id": "R1",
      "area": "template",
      "title": "Make placeholder sanitization unconditional",
      "action": "Remove conditional check for templateRequested in postProcessAssistantReply (line ~2541 in route.ts). Move sanitizeUnfilledPlaceholdersInNonTemplateReply to run for ALL responses, not just non-template mode. Add regex to catch partial placeholders split across tokens.",
      "implementationHint": "app/src/app/api/ai/request/route.ts:2541-2543 - remove the 'if (!params.mode.templateRequested)' guard. Apply sanitizeUnfilledPlaceholdersInNonTemplateReply unconditionally before all response returns.",
      "expectedImpact": "Eliminates raw placeholder leakage (Страница: —, {company}, {spec}) from all outputs; fixes MX003.T4, MX002.T4 failures",
      "risk": "Low - purely post-processing, no LLM behavior change",
      "effort": "S",
      "validationScenarios": [
        "MX003.T4",
        "MX002.T4",
        "MX002.T5"
      ]
    },
    {
      "id": "R2",
      "area": "prompt",
      "title": "Add Belarus geo hierarchy rules to system prompt",
      "action": "Add explicit rule: 'Belarus cities (Минск, Гомель, Брест, Гродно, Витебск, Могилёв) are separate from oblasts (Минская область, etc.). When user specifies oblast/region without city, EXCLUDE all cities. When user specifies city, do not include in oblast results. Minsk city ≠ Minsk Oblast.'",
      "implementationHint": "System prompt section in route.ts - append geo hierarchy rule near other vendor lookup instructions",
      "expectedImpact": "Prevents Minsk city suppliers from appearing in Minsk Oblast shortlists; fixes MX001.T4 and MX005.T3 geo confusion",
      "risk": "Low - clarifying existing intent",
      "effort": "S",
      "validationScenarios": [
        "MX001.T4",
        "MX005.T3",
        "MX002.T4"
      ]
    },
    {
      "id": "R3",
      "area": "retrieval",
      "title": "Persist candidate IDs across topic switches",
      "action": "In postProcessAssistantReply, extract company IDs from previous turn's vendorCandidates metadata stored in conversation state (not just parse /company/XXX from text). Merge with fresh lookup when user returns to original topic.",
      "implementationHint": "app/src/app/api/ai/request/route.ts:1646-1656 - modify prioritizeVendorCandidatesByHistory to also accept stored candidate IDs from session metadata, not only parsed slugs from text",
      "expectedImpact": "Restores original milk shortlist after auto parts digression; MX003.T4 returns complete top-3 instead of garbled output",
      "risk": "Low - additive fallback preserves existing logic",
      "effort": "M",
      "validationScenarios": [
        "MX003.T4",
        "MX003.T2"
      ]
    },
    {
      "id": "R4",
      "area": "prompt",
      "title": "Require 'who to call first' with rationale",
      "action": "Add to ranking guidance: 'When providing top-N suppliers, ALWAYS indicate priority order (1st, 2nd, 3rd) with specific rationale: why this supplier first for user's criteria (volume, urgency, location fit, product match).'",
      "implementationHint": "Vendor shortlist instructions in route.ts - append prioritization requirement",
      "expectedImpact": "Addresses judge feedback on missing prioritization; MX005 usefulness rises from 3.5 to 4+",
      "risk": "Low - reinforces expected behavior",
      "effort": "S",
      "validationScenarios": [
        "MX005.T3",
        "MX001.T4",
        "MX004.T4"
      ]
    },
    {
      "id": "R5",
      "area": "prompt",
      "title": "Explain ranking criteria per supplier",
      "action": "Modify ranking output rule: 'Ranking criteria must be specific to each supplier, not generic. For each supplier, explain WHY it fits (or doesn't) for user's specific request. Avoid template phrases like \"риск несоответствия задаче\" without specific explanation.'",
      "implementationHint": "Vendor ranking instructions in route.ts - replace generic criteria with per-supplier explanation requirement",
      "expectedImpact": "Reduces judge confusion on MX002.T5 and MX004.T4; improves perceived transparency",
      "risk": "Low",
      "effort": "S",
      "validationScenarios": [
        "MX002.T5",
        "MX004.T4"
      ]
    },
    {
      "id": "R6",
      "area": "guardrails",
      "title": "Block catalog-add guidance during sourcing",
      "action": "Add guardrail: 'When user asks for suppliers/vendors/top-N options, NEVER suggest adding companies to catalog. Focus exclusively on finding existing vendors from directory.' This prevents MX004-style catastrophic failures where assistant gives 'add company' instructions instead of supplier lists.",
      "implementationHint": "Vendor lookup guardrails in route.ts - add explicit block for catalog-add responses during sourcing workflows",
      "expectedImpact": "Prevents context loss where assistant ignores supplier requests to give catalog instructions",
      "risk": "Low - narrows assistant scope appropriately",
      "effort": "S",
      "validationScenarios": [
        "MX004.T3",
        "MX004.T4"
      ]
    },
    {
      "id": "R7",
      "area": "prompt",
      "title": "Add response mode continuity validation",
      "action": "Add rule: 'For multi-turn conversations, maintain awareness of previous response modes. If Turn N was a shortlist/ranking, Turn N+1 should either continue ranking OR switch modes only when user explicitly requests. Do not revert to generic rubric advice without user permission.'",
      "implementationHint": "Multi-turn continuity instructions in route.ts - append response mode awareness rule",
      "expectedImpact": "Prevents context loss between turns (MX003, MX005 regressions); maintains shortlist continuity",
      "risk": "Low",
      "effort": "S",
      "validationScenarios": [
        "MX003.T4",
        "MX005.T3"
      ]
    },
    {
      "id": "R8",
      "area": "template",
      "title": "Ensure company names appear before ranking bullet points",
      "action": "In shortlist template rendering, verify each bullet point starts with Company Name before any explanatory text. Add post-processing check: if 'Почему подходит:' appears without preceding company name, inject company name from preceding context.",
      "implementationHint": "Shortlist template builder in route.ts - add validation that company names precede bullet content",
      "expectedImpact": "Fixes MX002.T3 incomplete company name display; improves readability across all shortlist outputs",
      "risk": "Low - template rendering fix",
      "effort": "S",
      "validationScenarios": [
        "MX002.T3",
        "MX002.T4",
        "MX004.T4"
      ]
    }
  ],
  "testPlan": {
    "mustPassScenarios": [
      "MX003.T4",
      "MX003.T2",
      "MX005.T3",
      "MX001.T4",
      "MX002.T3",
      "MX002.T4"
    ],
    "regressionSuites": [
      "app/qa/ai-request/scenarios.regressions.multi-step-journeys.json",
      "app/qa/ai-request/scenarios.regressions.geo-ambiguity.json",
      "app/qa/ai-request/scenarios.regressions.switchback-topic.json"
    ],
    "successMetrics": [
      "kimi averageUserSatisfaction >= 0.72 (currently 0.702)",
      "MX003 averageUsefulness >= 4.0 (currently 2.5)",
      "zero raw placeholder patterns in template outputs",
      "zero city/oblast geo violations in shortlists"
    ]
  }
}
```
