# Advisor Report — advisor-2026-02-07T20-30-58-869Z

- Generated: 2026-02-07T20:32:48.686Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 2
- Advisors: gemini, kimi

## Focus Scenarios

- D001 (pass, usefulness 4.5/5): Dirty query: типография визитки срочно
- D002 (pass, usefulness 5/5): Dirty query: проверка УНП

## Consensus

- Top areas:
  - retrieval: 2
  - geo: 1
  - prompt: 1
  - ranking: 1
  - guardrails: 1
- Recurring recommendations:
  - enhance geo-awareness in company search/retrieval (1)
  - implement address-level location matching for micro-districts (1)
  - cache vendor candidates across turns in session (1)
  - add explicit location-verification instruction to system prompt (1)
  - deduplicate and filter company lists by geo constraints (1)
  - add contradiction detection for vendor availability claims (1)

## gemini

- Summary: The current AI assistant demonstrates strong performance on general information queries like 'проверка УНП'. However, a critical issue has been identified by the 'kimi' judge in geo-specific queries, specifically in scenario D001 ('типография визитки срочно'). Despite acknowledging the 'Malinovka' district, the assistant fails to filter company results by this geographical constraint, providing a generic list instead. This leads to a lower usefulness score and indicates a gap in the system's ability to process and apply nuanced geographical filters during company retrieval.

### Priority Plan

- P0 — Implement robust geographical filtering for company search results
  why: The assistant currently acknowledges geographical constraints (e.g., 'район Малиновка') but fails to apply them as a filter to the search results. This leads to irrelevant recommendations and a reduced usefulness score, as highlighted by the 'kimi' judge in s…
  impact: Significantly improve the relevance and usefulness of company recommendations for geo-specific queries, directly addressing the core issue raised by the judge in D001. This will likely increase user satisfaction for loc…
  validate: D001

### Recommendations

- [R1] (retrieval, effort M) Enhance Geo-Awareness in Company Search/Retrieval
  action: Modify the company search/retrieval logic to incorporate geographical filtering based on identified districts or neighborhoods. This requires ensuring that company data includes sufficient geographical granularity (e.g., district, coordinates) and that the search query construction effectively uses this information to filter results before presentation.
  hint: 1. **Data Enrichment**: Verify that company data indexed by Meilisearch (or any other search backend) contains specific district/neighborhood information. If not, update the data ingestion process (e.g., `app/scripts/index_meilisearch.ts`…
  impact: Directly resolves the 'Malinovka' filtering issue in D001, providing accurate, localized company recommendations. Improves the overall quality and trustworthiness of the assistant's advice for location-sensitive queries…
  risk: Medium. Requires changes to data indexing and search query logic. Careful testing is needed to ensure no regressions in non-geo-specific searches.
  validate: D001

## kimi

- Summary: Current QA run shows 100% pass rate (2/2 scenarios, 23/23 checks) with avg usefulness 4.75/5. However, judge analysis reveals systematic issues: (1) geo-filters don't verify actual company locations against micro-districts (e.g., 'Малиновка'), (2) company lists repeat across turns without location-based filtering, (3) contradiction between turns (finding candidates then claiming none exist). Root cause: retrieval layer lacks address-level geo-validation and cross-turn result consistency.

### Priority Plan

- P0 — Fix micro-district geo-filtering for company results
  why: Judge identified that assistant returns same company list across all 3 turns without filtering by 'Малиновка' district. Users expect location-filtered results when specifying micro-districts.
  impact: Reduces 'repeating same list' complaints; improves usefulness score from 4→5 on geo-constrained queries.
  validate: D001
- P0 — Add cross-turn consistency guard for vendor lookups
  why: Historical issue (UX107): Turn 1 finds 'Белпожохрансервис', Turn 2 claims 'нет релевантных компаний'. Same contradiction pattern risks appearing in current flow.
  impact: Eliminates contradiction failures; maintains user trust in multi-turn conversations.
  validate: D001, UX107
- P1 — Enrich company data with address/location field for filtering
  why: Current `BiznesinfoCompanySummary` has `city` and `region` but no `address` or `district` field. Cannot verify if company is actually in 'Малиновка'.
  impact: Enables accurate micro-district filtering; supports 'near me' queries.
  validate: D001, S005, S006

### Recommendations

- [R1] (geo, effort S) Implement address-level location matching for micro-districts
  action: In `app/src/app/api/ai/request/route.ts`, enhance `filterAndRankVendorCandidates()` to check `company.address` field against district patterns (e.g., /малиновка|каменная\s+горка/i). If user specifies micro-district, filter candidates by address match before returning.
  hint: Add `addressMatch` scoring in `filterAndRankVendorCandidates()` around line 280-295. Use regex pattern from `extractLocationPhrase()` to match against `c.address`.
  impact: Returns only companies actually located in requested micro-district; eliminates 'same list for all turns' issue.
  risk: Low - falls back to city-level if address field empty.
  validate: D001, S005
- [R2] (retrieval, effort M) Cache vendor candidates across turns in session
  action: Store `vendorCandidates` in conversation context (similar to `history`). On follow-up turns with same sourcing topic, reuse cached candidates instead of re-querying, then apply new filters (geo, ranking) on cached set.
  hint: Extend `AssistantSessionRef` in `conversations.ts` to include `lastVendorCandidates: string[]`. In `buildVendorLookupContext()`, check cache before new search when `followUpByLocation || followUpByRanking`.
  impact: Prevents contradiction between turns; ensures consistent company set across multi-turn sourcing conversations.
  risk: Medium - need TTL/cache invalidation on new search terms.
  validate: D001, UX107
- [R3] (prompt, effort S) Add explicit location-verification instruction to system prompt
  action: When `cityRegionHints` contains `phrase` (micro-district), add instruction: 'Verify each recommended company is located in {phrase} district by checking address field. If location uncertain, note this explicitly.'
  hint: In `buildCityRegionHintsBlock()`, when `hint.phrase` exists and differs from city, append verification instruction to returned block.
  impact: LLM self-corrects on location claims; reduces judge complaints about unverified locations.
  risk: Low - instruction-only change.
  validate: D001, S005
- [R4] (ranking, effort S) Deduplicate and filter company lists by geo constraints
  action: In `postProcessAssistantReply()`, when `mode.rankingRequested` and `locationPhrase` exists, strip companies not matching location from response. Use `stripCompanyLinkLines()` pattern but with geo-aware filtering.
  hint: Add geo-filter step before line 954-957 in route.ts. Check each `/company/` link's associated candidate against `locationPhrase` via address match.
  impact: Ensures ranking responses respect geo constraints even when LLM hallucinates extra companies.
  risk: Low - post-processing safeguard.
  validate: D001
- [R5] (guardrails, effort S) Add contradiction detection for vendor availability claims
  action: Track if previous turn mentioned specific companies. If current turn claims 'нет релевантных компаний' but history contains company mentions, trigger consistency fallback.
  hint: In `postProcessAssistantReply()`, check `history` for company slugs via `extractAssistantCompanySlugsFromHistory()`. If `replyClaimsNoRelevantVendors()` true but history has slugs, append: 'В предыдущем ответе упоминались: {list}. Уточните…
  impact: Prevents UX107-style contradictions; improves user trust.
  risk: Low - additive message only.
  validate: UX107, D001

