# Advisor Report — advisor-2026-02-15T05-18-56-776Z

- Generated: 2026-02-15T05:22:38.656Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 1
- Advisors: kimi, minimax

## Focus Scenarios

- UV017 (pass, usefulness 1/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"

## Consensus

- Top areas:
  - prompt: 6
  - retrieval: 3
  - guardrails: 1
  - template: 1
- Recurring recommendations:
  - harden template generation prompt against user input injection (1)
  - add product-to-nace/activity verification filter (1)
  - implement template output sanity checker (1)
  - inject session context into every turn system prompt (1)
  - require explicit product confirmation in shortlist response (1)
  - expand search with alternative product terms when primary yields low confidence (1)
  - add template generation guardrails to prevent self-referential placeholders (1)
  - add mandatory verification step for supplier relevance (1)
  - enforce instruction following for alternative queries (1)
  - implement continuity checkpoint for multi-turn scenarios (1)
  - add template schema validation to reject incomplete templates (1)

## kimi

- Summary: Scenario UV017 reveals critical failure modes: (1) template generation produces garbage output with circular placeholder references ('сформируй сообщение' echoed back), (2) no verification that listed companies actually trade the requested product (beet), (3) continuity breakdown between turns — context (500kg, 3 days) is lost. The system passes strict checks (format compliance) but delivers zero business value. Root causes: weak prompt constraints on template generation, missing product-to-company verification step, no guardrails against echo attacks in user input.

### Priority Plan

- P0 — Fix template generation prompt to prevent echo attacks
  why: Turn 3 output is completely unusable — user input text is being echoed back as template content due to weak prompt boundaries
  impact: Eliminates garbage template generation, restores basic usability for message composition feature
  validate: UV017
- P0 — Add product verification step before company shortlisting
  why: Companies with 'Пчеловодство' and 'Запчасти к сельхозтехнике' are being returned for beet query — no semantic validation
  impact: Reduces false positive rate in supplier matching, increases trust in recommendations
  validate: UV017
- P1 — Implement continuity enforcement across multi-turn sessions
  why: Context (500kg, 3 days, Minsk) is lost between turns 2 and 3, breaking user workflow
  impact: Maintains session coherence, improves multi-turn task completion rate
  validate: UV017
- P1 — Add strict output validation for template format
  why: Current output passes format checks but contains nonsense — validation is too permissive
  impact: Catches garbage output before delivery, triggers retry or fallback
  validate: UV017

### Recommendations

- [R1] (prompt, effort S) Harden template generation prompt against user input injection
  action: Add explicit instruction: 'NEVER copy user instructions into template content. Extract ONLY: product, volume, location, deadline from context. Reject if user input contains meta-commands like "сформируй".' Add negative examples in prompt showing forbidden echo patterns.
  hint: Modify system prompt for template generation tool — likely in src/ai/prompts/templates.ts or similar. Add <forbidden_patterns> section with examples like 'сформируй сообщение', 'уточняется' as placeholders.
  impact: Prevents circular reference garbage in Turn 3 output
  risk: May over-reject legitimate template requests if patterns too broad
  validate: UV017
- [R2] (retrieval, effort M) Add product-to-NACE/activity verification filter
  action: Before returning company shortlist, verify that company's primary_activity or NACE codes semantically match requested product. Use embedding similarity threshold (e.g., >0.6) between 'свекла оптовая продажа' and company activity description. Filter out if below threshold.
  hint: In retrieval pipeline (src/ai/retrieval/companies.ts or similar), add post-filter step after initial search. Compute similarity between query product embedding and each candidate's activity_description embedding.
  impact: Eliminates 'Пчеловодство' and 'Запчасти' results for beet queries
  risk: May filter legitimate diversified traders; add override flag for 'оптовая торговля' broad category
  validate: UV017
- [R3] (guardrails, effort M) Implement template output sanity checker
  action: Add post-generation validation: (1) template must not contain user instruction verbs ('сформируй', 'создай', 'напиши'), (2) placeholders must not be 'уточняется' when context provides values, (3) subject line must be <100 chars and business-relevant. Fail → retry with stronger prompt.
  hint: Create src/ai/guardrails/template-validator.ts with regex patterns for instruction verbs and placeholder audit. Integrate into template generation flow before response delivery.
  impact: Blocks garbage templates at generation time, forces retry
  risk: Adds latency (one extra LLM call on failure)
  validate: UV017
- [R4] (prompt, effort M) Inject session context into every turn system prompt
  action: Modify multi-turn handler to prepend accumulated context (extracted entities: product, volume, location, deadline) to system prompt on each turn. Format: '[Session context] Product: свекла, Volume: 500kg, Location: Минск, Deadline: 3 days'.
  hint: In conversation manager (src/ai/conversation/manager.ts or similar), maintain entity extraction from each turn. Inject into system prompt prefix before LLM call.
  impact: Preserves 500kg/3 days context through Turn 3, maintains continuity
  risk: May confuse if context becomes stale; add timestamp or turn counter
  validate: UV017
- [R5] (prompt, effort S) Require explicit product confirmation in shortlist response
  action: Add mandatory field in shortlist output schema: 'product_confidence' with enum ['confirmed', 'likely', 'unknown']. Model must justify 'confirmed' with evidence from company data. Default to 'unknown' if no evidence.
  hint: Update JSON schema for shortlist tool response. Add validation that 'confirmed' requires citation from company description or product list.
  impact: Forces model to verify beet trading before claiming relevance
  risk: May increase false negatives; tune threshold based on QA feedback
  validate: UV017
- [R6] (retrieval, effort M) Expand search with alternative product terms when primary yields low confidence
  action: When <3 companies have 'confirmed' product match, automatically expand query with synonyms ('свёкла столовая', 'красная свекла', 'овощи оптом') and present alternatives to user with explanation.
  hint: Add query expansion layer in retrieval pipeline. Use predefined synonym map or LLM-generated variants. Return 'alternative_searches' field in response.
  impact: Addresses judge finding: 'zero alternative search queries provided despite explicit request'
  risk: May drift to irrelevant products if expansion too aggressive; keep within same product category
  validate: UV017

## minimax

- Summary: UV017 exposes 4 critical failures: template parsing corruption ('сформируй сообщение' loops), zero supplier verification for red beet, missing alternative queries, and 100% generic fallback rate. All issues stem from weak system prompt constraints and missing validation hooks. Fix requires: (1) template guardrails to prevent self-referential placeholders, (2) mandatory verification step before presenting suppliers, (3) explicit alternative query requirement with fallback, (4) continuity validation to reject context shifts. Expected impact: eliminate garbage templates, improve relevance, recover user trust.

### Priority Plan

- P0 — Fix template generation guardrails - prevent self-referential garbage
  why: Turn 3 generated 'сформируй сообщение' loops instead of actual message. This is a parsing/regeneration corruption where the model echoes user instructions as content. Both judges flagged this as 'полный сбой генерации' (complete generation failure). Current p…
  impact: Eliminate template parsing corruption. Template output should contain actual parameterized content, not instruction echoes. Expected improvement: genericFallbackRate from 100% -> <30%, continuity score from 1-2/5 -> 4+/…
  validate: UV017, Any template generation scenari…
- P0 — Add mandatory supplier verification before presentation
  why: Both judges independently flagged: 'ни в одном turn не подтверждено, что компании реально торгуют свеклой' (no confirmation companies actually sell red beet). Minsk Vegetable Factory listed as 'Beekeeping', Agromashmarket as 'Spare parts for agricultural mach…
  impact: Ensure only relevant suppliers are presented. Expected: elimination of category mismatches (beekeeping for vegetable supplier), improvement in relevance scoring, reduced noise in shortlist.
  validate: UV017, UV005-UV008 (vegetable/food sce…
- P1 — Enforce alternative query generation when explicitly requested
  why: Turn 2 user explicitly asked for 'alternative search queries' - received none. Judge labeled this as 'zero alternative search queries provided despite explicit request'. This is a direct instruction following failure. The system should have a validation hook…
  impact: 100% instruction compliance when alternative queries requested. Expected: usefulRate improvement from 0% to >60% for multi-turn negotiation scenarios.
  validate: UV017, Any scenario with explicit sub-…
- P1 — Add continuity validation to reject context drift
  why: Continuity score: 2/5 (kimi) and 1/5 (minimax) - worst possible. After Turn 2 established context (500 kg, 3 days, Minsk), Turn 3 produced generic 'уточняется' placeholders. The system needs a continuity checkpoint that validates: 'Does Turn N output align wi…
  impact: Prevent context abandonment. Expected: continuity score improvement to 4+/5, reduced generic placeholders, consistent parameter propagation across turns.
  validate: UV017, All multi-turn scenarios (UV001…

### Recommendations

- [R1] (prompt, effort S) Add template generation guardrails to prevent self-referential placeholders
  action: Update system prompt with explicit rule: 'NEVER echo user instructions as template content. If template field contains user's instruction text (e.g., 'сформируй сообщение', 'запрос по...'), treat this as CORRUPTION and regenerate. Template must contain PARAMETERIZED VALUES, not instruction references.'
  hint: File: app/scripts/ai-request-qa-runner.mjs or system prompt file. Add a pre-output validation that checks: if template.text contains patterns matching user instructions, reject and regenerate. Pattern: /(сформир|запрос|сообщени)[а-я]{0,20}…
  impact: Eliminate template corruption. Template output quality: actual parameterized content vs garbage echoes.
  risk: Low - adds validation, doesn't change model behavior, only prevents corrupted output
  validate: UV017, All template generation tests
- [R2] (prompt, effort M) Add mandatory verification step for supplier relevance
  action: Update system prompt with rule: 'Before presenting ANY company, perform verification: Does company profile explicitly mention the requested product (red beet/sвекла)? If company categories are generic (food products, wholesale), ACQUIRE specific evidence from company description OR EXCLUDE company. Never present unverifiable companies. Use format: [COMPANY] - verified: [YES/NO] - evidence: [specific mention or "no e…
  hint: File: app/scripts/ai-request-qa-runner.mjs. Before shortlist generation, add verification pass that requires explicit product mention in company data. Reject companies with no specific evidence.
  impact: Eliminate category mismatches (beekeeping for vegetable supplier). Only verified suppliers in shortlists.
  risk: Medium - may reduce number of presented companies, but improves quality
  validate: UV017, UV005-UV008
- [R3] (prompt, effort S) Enforce instruction following for alternative queries
  action: Update system prompt: 'When user explicitly requests alternative search queries, you MUST provide them. If unable to find alternatives, state: "Alternative queries I considered but cannot find results: [list]". Never ignore explicit sub-requests. Treat ignored instructions as a FAILURE condition.' Add validation: if user asks for X and no X in response, flag as error.
  hint: File: app/scripts/ai-request-qa-runner.mjs or response validator. Parse user request for explicit sub-requests (alternative queries, confirmations, assessments). Validate presence in assistant response.
  impact: 100% compliance with explicit user instructions. Expected: elimination of 'zero alternative queries' failure.
  risk: Low - enforces existing expectations, adds validation
  validate: UV017, UV010-UV012
- [R4] (retrieval, effort M) Implement continuity checkpoint for multi-turn scenarios
  action: Add validation hook between turns that checks: (1) What specific parameters were established in previous turn? (2) Does current turn maintain those parameters? (3) If parameters are dropped (500 kg, 3 days), require explicit justification or treat as continuity violation. Use format: 'CONTINUITY_CHECK: [params preserved/dropped] - [list preserved/dropped params]'
  hint: File: app/scripts/ai-request-qa-runner.mjs. Store Turn N-1 parameters in context. At Turn N, validate parameter preservation. Fail if context is abandoned without justification.
  impact: Continuity score improvement from 1-2/5 to 4+/5. Reduced parameter abandonment.
  risk: Low - adds validation, preserves user context
  validate: UV017, All multi-turn tests
- [R5] (template, effort S) Add template schema validation to reject incomplete templates
  action: Add schema validation for template output: 'Template fields (subject, body, whatsapp) must contain at least 3 actual parameterized values, not placeholders like [уточняется] or repeated instructions. If template contains more than 1 placeholder per field, REJECT and regenerate.'
  hint: File: app/scripts/ai-request-qa-runner.mjs. Add post-generation validator that checks template quality: count placeholders per field, validate parameterized content presence.
  impact: Eliminate templates with 'уточняется' placeholders. Improve template usefulness from 0% to >70%.
  risk: Low - validates output quality, rejects low-quality templates
  validate: UV017, UV005-UV007

