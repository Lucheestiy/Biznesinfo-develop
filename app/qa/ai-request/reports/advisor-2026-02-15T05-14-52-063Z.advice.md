# Advisor Report — advisor-2026-02-15T05-14-52-063Z

- Generated: 2026-02-15T05:17:30.226Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 20
- Advisors: kimi, minimax

## Focus Scenarios

- UV012 (fail, usefulness 0/5): Проверка по сайтам компаний: источник + контакты + честная пометка подтверждения
- UV018 (fail, usefulness 0.5/5): Ирис Интер групп: 20 тегов для GA/Метрики без ложного sourcing-fallback
- UV022 (fail, usefulness 0.5/5): Ирис Интер групп: явный поиск -> последние новости с сайта (без запроса URL)
- UV021 (fail, usefulness 0.5/5): Ирис Интер групп: консистентность между «нашел компанию» и «проверь на карточке»
- UV003 (fail, usefulness 1.5/5): Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка
- UV009 (fail, usefulness 1.5/5): Стоматология с микроскопом в Минске: сложный consumer кейс + полезный fallback
- UV002 (fail, usefulness 2/5): Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist
- UV015 (fail, usefulness 2/5): Вариант по минитракторам: покупка -> сравнение условий -> запрос для звонка
- UV004 (fail, usefulness 2.5/5): Белорусские соковыжималки: заводы -> OEM/ODM -> shortlist -> RFQ
- UV014 (fail, usefulness 3/5): Reverse-buyer вариативный: пищевая тара -> целевые сегменты -> shortlist без общих советов
- UV007 (pass, usefulness 0.5/5): Найти потенциальных заказчиков моей продукции: reverse поиск + shortlist
- UV019 (pass, usefulness 0.5/5): Ирис Интер групп: запрос последних новостей без требования ссылки от пользователя
- UV020 (pass, usefulness 0.5/5): Ирис Интер групп: команда «Найди на карточке компании» без запроса ссылки у пользователя
- UV001 (pass, usefulness 1/5): Производители обуви в Минске: уточнение типа + shortlist + шаблон контакта
- UV008 (pass, usefulness 1/5): Белорусский минитрактор: покупка + критерии + сравнение
- UV011 (pass, usefulness 1/5): No-results ветка: сверхузкий запрос на производителей обуви
- UV006 (pass, usefulness 1.5/5): Лес на экспорт: условия качества + логистика + RFQ
- UV016 (pass, usefulness 1.5/5): Вариативный экспорт муки: shortlist + документная проверка + шаблон запроса
- UV013 (pass, usefulness 2/5): Deep website-scan: внутренняя навигация сайта (контакты/о компании/продукция)
- UV017 (pass, usefulness 2/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"

## Consensus

- Top areas:
  - prompt: 6
  - guardrails: 2
  - template: 2
  - retrieval: 2
  - ranking: 1
  - ui: 1
- Recurring recommendations:
  - inject company context into system prompt for website scan turns (1)
  - block sourcing actions when analytics/tagging intent detected (1)
  - force template hydration before response finalization (1)
  - persist vendor candidates in conversation context for ranking turns (1)
  - extract and apply quality criteria from user constraints (1)
  - add rubric mismatch detection for search results (1)
  - strengthen anti-link-gate system prompt instruction (1)
  - add scenario tag to response metadata for debugging (1)
  - add category validation guardrail (1)
  - continuity checkpoint injection (1)
  - template fill-or-fail enforcement (1)
  - anti-synthetic fallback protocol (1)

## kimi

- Summary: Biznesinfo AI assistant shows critical failures in 3 core areas: (1) Continuity breakdown - assistant loses company context between turns (UV012, UV019-022); (2) Wrong intent detection - analytics/tagging requests trigger sourcing fallbacks (UV018); (3) Template degradation - RFQ/checklist templates fill with placeholders instead of context. 10/22 scenarios fail strict checks. Pass rate 54.5% vs target 80%. Average usefulness 1.43/4. Root cause: context persistence gaps in multi-turn flow, insufficient intent classification guards, and missing template hydration from conversation history.

### Priority Plan

- P0 — Fix context carryover for company identification across turns
  why: UV012, UV019-022 all fail because assistant cannot maintain company context. When user says 'Ирис Интер групп' in Turn 1, Turn 2 requests for 'their website' or 'check on card' fail with 'link gate' or random companies. This is the highest-impact fix.
  impact: Resolves 5 failed scenarios (UV012, UV019-022), reduces hallucination of wrong companies by ~80%
  validate: UV012, UV019, UV020, UV021, UV022
- P0 — Add strict intent guards to prevent sourcing fallback on analytics requests
  why: UV018 fails because tagging/analytics requests trigger supplier-search fallback. The looksLikeAnalyticsTaggingRequest() detection exists but doesn't block the fallback path. Assistant returns rubric categories instead of 20 GA/Metrika tags.
  impact: Resolves UV018, prevents category contamination in non-sourcing contexts
  validate: UV018
- P1 — Implement template hydration from conversation context
  why: UV001, UV003, UV006, UV007, UV016 all show templates with 'уточняется' placeholders instead of extracted values (product, qty, city, deadline). The extractTemplateFillHints() function exists but values aren't being applied.
  impact: Improves usefulness score by ~1.5 points on template scenarios, makes RFQ/checklist outputs actionable
  validate: UV001, UV003, UV006, UV007, UV016
- P1 — Fix ranking fallback to respect multi-turn constraints
  why: UV002, UV004, UV015 fail because ranking fallback ignores quality criteria (whiteness/gluten for flour, OEM/ODM for juicers, 4 criteria for tractors). Assistant returns generic 'check data' instead of structured comparison.
  impact: Resolves 3 scenarios, improves comparison quality across all multi-turn sourcing flows
  validate: UV002, UV004, UV015
- P2 — Add anti-hallucination guard for company type verification
  why: UV012 shows critical hallucination: polyclinics and hospitals returned as shoe manufacturers. Need stronger guardrails when search results don't match requested rubric.
  impact: Prevents dangerous misclassification, improves trust in shortlist outputs
  validate: UV012, UV009, UV011

### Recommendations

- [R1] (prompt, effort S) Inject company context into system prompt for website scan turns
  action: When looksLikeWebsiteResearchIntent() returns true AND history contains company name mentions (extractCompanyNameHintsFromText), prepend to system prompt: 'User previously mentioned company: {name}. Use this company for website checks unless user explicitly requests a different one.'
  hint: app/src/app/api/ai/request/route.ts: collectWebsiteResearchCompanyNameHints() exists but results aren't injected into prompt. Modify buildSystemPrompt() to accept companyHints and include them.
  impact: Fixes UV019-022 context loss, enables proper 'check their website' flow
  risk: Low - additive context, no breaking changes
  validate: UV019, UV020, UV021, UV022
- [R2] (guardrails, effort S) Block sourcing actions when analytics/tagging intent detected
  action: In the main request handler, if looksLikeAnalyticsTaggingRequest() returns true, skip vendor search entirely and return a dedicated tagging response. Never execute biznesinfoSearch() or return rubric hints for tagging requests.
  hint: app/src/app/api/ai/request/route.ts: Add early return guard after intent detection (~line 280). Create buildAnalyticsTagsReply() function that returns structured tags without catalog fallback.
  impact: Fixes UV018, prevents category contamination
  risk: Low - isolated path for specific intent
  validate: UV018
- [R3] (template, effort M) Force template hydration before response finalization
  action: After LLM response received, if templateRequested mode detected, run applyTemplateFillHints() unconditionally and verify no placeholder patterns remain. If placeholders persist, re-prompt LLM with explicit fill instructions.
  hint: app/src/app/api/ai/request/route.ts: In finalize path (~line 2100+), add post-processing step: if mode.templateRequested, text = applyTemplateFillHints(text, hints); if still has {placeholder}, trigger one-shot correction.
  impact: Eliminates 'уточняется' placeholders in UV001, UV003, UV006, UV007, UV016
  risk: Low - post-processing only
  validate: UV001, UV003, UV006, UV007, UV016
- [R4] (retrieval, effort M) Persist vendor candidates in conversation context for ranking turns
  action: When Turn 1 finds companies, store vendorCandidateIds in ai_assistant_turns table. On Turn 2+ ranking requests, retrieve these candidates instead of re-searching. Use existing vendor_candidate_ids column that's already defined but underutilized.
  hint: app/src/lib/ai/conversations.ts: appendAssistantSessionTurn() already accepts vendorCandidateIds. Ensure route.ts passes them. In ranking turn, query previous turn's candidates via getAssistantSessionHistory() or add getLastTurnCandidates(…
  impact: Fixes UV002, UV004, UV015 ranking failures due to context loss
  risk: Medium - requires DB query pattern
  validate: UV002, UV004, UV015
- [R5] (ranking, effort S) Extract and apply quality criteria from user constraints
  action: When user specifies criteria (e.g., 'белизна, клейковина, стабильность' for flour), extract these via pattern matching and include in ranking appendix. Modify buildRankingFallbackAppendix() to accept criteria list and format as comparison matrix.
  hint: app/src/app/api/ai/request/route.ts: Add extractQualityCriteria() function that parses comma-separated criteria from message. Pass to buildRankingFallbackAppendix() and render as 'Сравнение по критериям: 1. {criteria1}...'
  impact: UV002, UV004 pass strict checks for criteria inclusion
  risk: Low - additive to ranking output
  validate: UV002, UV004
- [R6] (guardrails, effort S) Add rubric mismatch detection for search results
  action: After biznesinfoSearch(), verify returned companies match requested rubric. If primary_rubric_name contains 'медицин' but query was for 'обувь', trigger honest fallback instead of returning mismatched results.
  hint: app/src/app/api/ai/request/route.ts: Post-search validation function. Check if candidate.primary_rubric_name contains anti-indicators (медицин, поликлиник, больниц) when query contains target indicators (обувь, производитель).
  impact: Prevents UV012 critical hallucination (polyclinics as shoe manufacturers)
  risk: Low - validation layer only
  validate: UV012, UV009, UV011
- [R7] (prompt, effort S) Strengthen anti-link-gate system prompt instruction
  action: Add explicit system prompt rule: 'NEVER ask user to send links or company cards. If company mentioned in conversation history, assume that company for all subsequent requests. If unsure which company, ask clarifying question about company name, not about links.'
  hint: app/src/app/api/ai/request/route.ts: Add to buildSystemPrompt() guardrails section. Current anti-link-gate exists in checks but not in generation guidance.
  impact: Reduces UV019-022 'пришлите ссылку' responses
  risk: Low - prompt text only
  validate: UV019, UV020, UV021, UV022
- [R8] (ui, effort S) Add scenario tag to response metadata for debugging
  action: Include detected intent tags (analytics, sourcing, ranking, template) in responseMeta for each turn. This enables faster regression identification in QA reports.
  hint: app/src/app/api/ai/request/route.ts: In responseMeta construction, add detectedIntents: { analytics: bool, sourcing: bool, ranking: bool, template: bool }.
  impact: Improves observability, faster debug of misclassified scenarios
  risk: None - metadata only
  validate: UV018, UV001-022

## minimax

- Summary: The QA reveals 4 critical failure modes: (1) catastrophic context/continuity loss between turns, (2) wrong-category hallucination (healthcare→manufacturing), (3) template collapse into placeholder text, and (4) complete task misunderstanding when direct catalog lookup fails. P0 fixes: enforce category validation before output, hardcode continuity checkpoints in system prompt, and kill placeholder templates with explicit fill-instructions.

### Priority Plan

- P0 — Enforce category validation before output
  why: UV012 returned polyclinics/hospitals as shoe manufacturers. System must reject companies whose category doesn't match the task domain.
  impact: Zero wrong-category outputs; strict pass on all website_scan scenarios
  validate: UV012, UV013
- P0 — Hardcode continuity checkpoints in system prompt
  why: UV022, UV019, UV020 all lost company context between turns. System must echo previous context and verify continuity.
  impact: 100% context retention in multi-turn scenarios
  validate: UV022, UV019, UV020
- P0 — Kill placeholder templates with explicit fill-or-fail
  why: UV001, UV003, UV004, UV006, UV007, UV016, UV017 all returned 'уточняется' placeholders. Templates must either be filled or explicitly state inability.
  impact: Zero placeholder-only outputs; all templates either real or honest fallback
  validate: UV001, UV003, UV004, UV006
- P1 — Anti-synthetic fallback: task refusal protocol
  why: UV018 asked for GA tags, got catalog rubrics. UV003 asked for B2B, got fishing/plumbing. System must admit inability and ask for clarification rather than generating synthetic fallback.
  impact: Eliminate synthetic task-avoidance responses
  validate: UV018, UV003, UV009

### Recommendations

- [R1] (prompt, effort M) Add category validation guardrail
  action: In system prompt: after any company lookup, before output, add explicit validation: CHECK: company category must contain at least one keyword from [task_domain]. Reject if mismatch with honest fallback: 'Catalog has no companies matching [task_domain]. Found [N] [actual_category]. Do you want to broaden search?'
  hint: app/src/app/api/ai/request/route.ts or similar AI orchestration layer; add pre-output validation function
  impact: Zero category-mismatch errors like 'polyclinics as shoe manufacturers'
  risk: Low - adds validation, doesn't change model behavior directly
  validate: UV012, UV013, UV009
- [R2] (prompt, effort S) Continuity checkpoint injection
  action: In system prompt: add mandatory turn-start checkpoint: 'CONTINUITY CHECK: Previous turn established: [company_name] / [task_domain] / [constraints]. Current response must reference and build on this. If you cannot find [company_name], state explicitly and ask: "I cannot find [company_name] in current context. Should I search catalog fresh?"'
  hint: System prompt template in AI route handler; add continuity_section variable
  impact: Fixes all context-loss scenarios (UV019, UV020, UV022)
  risk: Low - improves coherence, no behavioral changes
  validate: UV019, UV020, UV022, UV021
- [R3] (template, effort M) Template fill-or-fail enforcement
  action: Replace all template patterns containing 'уточняется', '[проверьте данные]', or empty brackets with explicit instruction: 'OUTPUT TEMPLATE with these fields filled from conversation context: [product], [volume], [location], [timeline]. If any field is missing, ask user: "To complete the template, I need: [missing_fields]. Please provide." NO placeholder-only responses.'
  hint: Template generation function in UI components (AiRequestsClient.tsx, AssistantClient.tsx)
  impact: Eliminates unusable placeholder templates
  risk: Medium - changes user-facing output format
  validate: UV001, UV003, UV004, UV006, UV016, UV017
- [R4] (prompt, effort S) Anti-synthetic fallback protocol
  action: In system prompt: add 'When catalog returns zero relevant results for [task_type=tags|news|analysis|comparison], do NOT generate synthetic content. Instead output: "I cannot find [task_type] in catalog for [company/search_term]. Options: (1) Search web for [term] + news/tags, (2) Broaden catalog search, (3) Describe what you need." NO catalog rubric listings, NO generic advice, NO supplier search unless requested.'
  hint: Zero-results handler in AI route; check for zero_results before template injection
  impact: Fixes UV018 (catalog rubrics→tags), UV009 (wrong categories), UV003 (B2B→fishing suppliers)
  risk: Low - honest fallback is better than wrong output
  validate: UV018, UV009, UV003
- [R5] (retrieval, effort L) Website scan enforcement with honest marking
  action: For any website_scan task: (1) Must report actual URL checked, (2) Must report specific page/section reviewed, (3) If no manufacturer claim found, mark explicitly: '[Company] appears to be [retail/distributor/reseller], NOT manufacturer per [page evidence]. Continue to next candidate?'
  hint: Website scanning function; add evidence_report parameter to output
  impact: Fixes UV013 (incorrect manufacturer claim), UV012 (no actual scan)
  risk: Medium - requires actual website access capability
  validate: UV012, UV013
- [R6] (prompt, effort M) Multi-turn constraint propagation
  action: In system prompt: track constraints explicitly across turns. Add: 'ACTIVE CONSTRAINTS from Turn 1: [list]. These MUST be applied to ALL subsequent results unless user explicitly relaxes them. If filtered results < requested count, report: "Found only [N] of [M] requested matching [constraints]. Continue with [N] or relax constraints?"'
  hint: Constraint tracking in conversation context; pass as system variables
  impact: Fixes UV001 (men's classical shoes ignored), UV002 (quality criteria ignored)
  risk: Low - better constraint enforcement
  validate: UV001, UV002, UV015

