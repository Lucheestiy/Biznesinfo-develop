# Advisor Report — advisor-2026-02-13T22-29-06-838Z

- Generated: 2026-02-13T22:32:36.163Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 2
- Advisors: kimi

## Advisor Warnings

- minimax: advisor minimax returned zero valid recommendations

## Focus Scenarios

- UV013 (pass, usefulness 1/5): Deep website-scan: внутренняя навигация сайта (контакты/о компании/продукция)
- UV012 (pass, usefulness 4/5): Проверка по сайтам компаний: источник + контакты + честная пометка подтверждения

## Consensus

- Top areas:
  - prompt: 2
  - retrieval: 1
  - guardrails: 1
  - template: 1
  - ranking: 1
- Recurring recommendations:
  - add context anchoring to system prompt (1)
  - fix placeholder replacement regex (1)
  - enforce commodity tag lock in continuity (1)
  - add website deep scan trigger (1)
  - hardcode template block validation (1)
  - add per-company analysis requirement (1)

## kimi

- Summary: Critical multi-turn context loss in UV013 (footwear→household goods), garbled placeholder text ('уточняется до уточняется'), and failure to perform deep website scans. The assistant has 37% useful rate with primary failure mode being context reset after user refinements. Root cause: insufficient context anchoring in system prompt and missing commodity tag enforcement in continuity filtering.

### Priority Plan

- P0 — Fix UV013 Critical Context Reset
  why: Turn 3 completely dropped footwear context and returned government agencies, workwear, household goods. This is a catastrophic failure of multi-turn continuity.
  impact: Eliminates 100% of context reset failures in multi-turn refinement scenarios. UV013 usefulness should jump from 1 to 4.
  validate: UV013, UV001, UV002, UV005
- P0 — Fix Template Text Garbling
  why: Multiple scenarios show garbled text like 'уточняется до уточняется' - placeholder replacement logic is broken when multiple placeholders appear consecutively.
  impact: Eliminates garbled output in template generation. Improves perceived quality across all template scenarios.
  validate: UV001.T4, UV004.T4, UV006.T4, D003
- P1 — Enforce Deep Website Navigation
  why: UV013.T2 explicitly requested 'пройди по сайтам глубже' but assistant refused immediately with generic advice instead of navigating to /contacts, /about, /products.
  impact: Enables actual website verification for sourcing scenarios. Critical for B2B trust.
  validate: UV013, UV012
- P1 — Strengthen Category Filtering in Continuity
  why: Assistant returns wrong-category companies (хозяйственные товары instead of обувь) when context is partially lost.
  impact: Prevents category drift in multi-turn conversations. Reduces irrelevant results by ~40%.
  validate: UV013, UV017, D009

### Recommendations

- [R1] (prompt, effort S) Add Context Anchoring to System Prompt
  action: Inject explicit context preservation instruction: 'CRITICAL: Maintain the EXACT product/service context from previous turns. If user asked for "производители обуви" in Turn 1, ALL subsequent turns must return footwear manufacturers only. Never switch to unrelated categories like household goods or government agencies.'
  hint: app/src/app/api/ai/request/route.ts - add to buildSystemPrompt() or prepend to user message in multi-turn scenarios
  impact: Prevents category switches like footwear→household goods in UV013
  risk: Low - additive instruction only
  validate: UV013, UV001, UV005
- [R2] (prompt, effort S) Fix Placeholder Replacement Regex
  action: Replace sequential placeholder replacement with single-pass tokenization. Current regex /\{[^}]+\}/g causes overlapping matches. Use: text.replace(/\{(\w+)\}/g, (match, key) => hints[key] || match) with pre-validation.
  hint: app/src/app/api/ai/request/route.ts - sanitizeUnfilledPlaceholdersInNonTemplateReply() lines 2378-2407
  impact: Eliminates 'уточняется до уточняется' garbled text
  risk: Low - fixes clear bug
  validate: UV001.T4, D003, D009
- [R3] (retrieval, effort M) Enforce Commodity Tag Lock in Continuity
  action: In refineConcreteShortlistCandidates(), when continuity mode is active (lockToHistoryCandidates=true), filter ALL results by the commodity tag detected in Turn 1. If footwear detected, only footwear companies allowed regardless of search drift.
  hint: app/src/app/api/ai/request/route.ts - lines 2907-2999, add strict commodity filter at start of function when params.commodityTag is set
  impact: Prevents wrong-category companies in context carryover
  risk: Medium - may reduce recall in edge cases
  validate: UV013, UV017, D009
- [R4] (guardrails, effort M) Add Website Deep Scan Trigger
  action: When user message contains 'глубже', 'контакты', 'о компании', 'продукция' + website intent, trigger actual page navigation instead of generic fallback. Implement 3-page crawl: /, /contacts, /about or /products.
  hint: app/src/app/api/ai/request/route.ts - looksLikeWebsiteResearchIntent() and buildWebsiteResearchFallbackAppendix()
  impact: Enables actual website verification as requested in UV013
  risk: Medium - increases latency, add timeout handling
  validate: UV013.T2, UV012.T2
- [R5] (template, effort S) Hardcode Template Block Validation
  action: Before returning template response, validate with regex: /Subject:.*\n\nBody:.*\n\nWhatsApp:/s. If missing, regenerate from template scaffold instead of returning partial.
  hint: app/src/app/api/ai/request/route.ts - ensureTemplateBlocks() function lines 1041-1062
  impact: Guarantees complete Subject/Body/WhatsApp structure
  risk: Low - enforces existing contract
  validate: UV001.T4, UV004.T4, UV005.T4
- [R6] (ranking, effort S) Add Per-Company Analysis Requirement
  action: In ranking mode, validate that response contains at least 2 company names with per-company reasoning. If only generic criteria ('Критерии: релевантность...') found, force rebuild with explicit per-company ranking.
  hint: app/src/app/api/ai/request/route.ts - lines 3966-3986, strengthen isGenericRubricWithLinks detection
  impact: Prevents generic rubric responses without actual rankings
  risk: Low - enforces quality standard
  validate: UV001.T3, UV002.T3, UV005.T3

