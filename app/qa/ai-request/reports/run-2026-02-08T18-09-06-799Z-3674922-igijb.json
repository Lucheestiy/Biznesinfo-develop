{
  "meta": {
    "scenarioMeta": {
      "version": "1.0",
      "generatedAt": "2026-02-08T18:05:00Z",
      "source": "manual-regression",
      "description": "Regression for topic switchback: keep correction context, but allow explicit new topic switch"
    },
    "options": {
      "baseUrl": "http://127.0.0.1:8131",
      "email": "qa.ai.runner@example.com",
      "preparePaid": true,
      "paidLimit": 1500,
      "maxScenarios": null,
      "onlyTags": [],
      "maxRateLimitRetries": 4,
      "maxStubRetries": 2,
      "minTurnDelayMs": 120,
      "stubOutageThreshold": 12,
      "targetPassCount": null,
      "targetPassRate": null
    }
  },
  "summary": {
    "runId": "run-2026-02-08T18-09-06-799Z-3674922-igijb",
    "startedAt": "2026-02-08T18:09:06.799Z",
    "endedAt": "2026-02-08T18:09:34.635Z",
    "durationMs": 27836,
    "baseUrl": "http://127.0.0.1:8131",
    "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.switchback-topic.json",
    "totalScenarios": 1,
    "passedScenarios": 1,
    "failedScenarios": 0,
    "passRate": 1,
    "totalChecks": 11,
    "passedChecks": 11,
    "failedChecks": 0,
    "checkPassRate": 1,
    "targetPassCount": 1,
    "targetPassRate": 0.8,
    "targetReached": true,
    "authUser": {
      "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
      "email": "qa.ai.runner@example.com",
      "name": "AI QA Runner",
      "role": "user",
      "plan": "paid"
    },
    "stoppedEarly": false,
    "stopReason": null
  },
  "runStop": null,
  "topFailurePatterns": [],
  "scenarios": [
    {
      "id": "TS001",
      "title": "Жалоба на нерелевант -> явный switch на новую тему -> возврат к исходной теме",
      "tags": [
        "regression",
        "topic_switch",
        "switchback",
        "cross_domain",
        "multi_turn"
      ],
      "personaGoal": "Проверить, что ассистент не залипает на старой теме и не срывается при коррекции",
      "totalTurns": 4,
      "completedTurns": 4,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где купить тонну молока в Бресте?",
          "requestBody": {
            "message": "Где купить тонну молока в Бресте?",
            "history": []
          },
          "latencyMs": 7126,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "ffc82fdf-7887-47cc-a1b0-2f8829b3a42e",
          "isStub": false,
          "reply": "В Бресте по вашему запросу есть **2 явно релевантных варианта**:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), значит это профильный молочный производитель в Бресте.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, включающее предприятия по переработке молока; может направить на нужный завод/поставщика под объём 1 т.\n\n⚠️ Третьего сильного кандидата из текущего списка нет (например, **Брестмаш** — это оборудование, не поставщик молока).\n\nЧто проверить перед заказом:\n- формат: сырое/пастеризованное молоко, жирность;\n- фасовка: налив/еврокуб/танк;\n- документы: вет/качество, срок годности;\n- логистика: самовывоз или доставка по Бресту;\n- цена за кг/л при объёме **1 тонна** и срок поставки.\n\nЕсли хотите, сразу подготовлю короткий текст запроса поставщику (email + WhatsApp) для рассылки этим 2 компаниям.",
          "checks": [
            {
              "id": "TS001.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T1.C2",
              "type": "includes_any",
              "description": "Должен держать молочную тему и Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Указана компания которая продает запчасти в Минске опять!!!",
          "requestBody": {
            "message": "Указана компания которая продает запчасти в Минске опять!!!",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта**:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), значит это профильный молочный производитель в Бресте.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, включающее предприятия по переработке молока; может направить на нужный завод/поставщика под объём 1 т.\n\n⚠️ Третьего сильного кандидата из текущего списка нет (например, **Брестмаш** — это оборудование, не поставщик молока).\n\nЧто проверить перед заказом:\n- формат: сырое/пастеризованное молоко, жирность;\n- фасовка: налив/еврокуб/танк;\n- документы: вет/качество, срок годности;\n- логистика: самовывоз или доставка по Бресту;\n- цена за кг/л при объёме **1 тонна** и срок поставки.\n\nЕсли хотите, сразу подготовлю короткий текст запроса поставщику (email + WhatsApp) для рассылки этим 2 компаниям."
              }
            ]
          },
          "latencyMs": 5676,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "1957f94e-b57e-4dbc-9310-717489212c06",
          "isStub": false,
          "reply": "Верно, спасибо — это ошибка подбора.  \nДля запроса **«1 тонна молока в Бресте»** запчасти и компании из Минска нужно исключить.\n\nОставляем только релевантное по Бресту:\n\n**Исключаем** как нерелевантные:\n- все «запчасти/авто/спецтехника»;\n- компании с локацией **Минск**, если нужна закупка в Бресте.\n\nМогу сразу дать готовый короткий текст запроса, чтобы отправить в эти 2 компании на объем 1 т (с ценой, сроком и доставкой).\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T2.C2",
              "type": "includes_any",
              "description": "Должен удержать коррекцию по исходной локации/контексту",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "локаци"
                ],
                "hits": [
                  "брест",
                  "локаци"
                ]
              }
            },
            {
              "id": "TS001.T2.C3",
              "type": "includes_any",
              "description": "Должен вернуть фокус на исходную товарную тему",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "релевант"
                ],
                "hits": [
                  "молок",
                  "релевант"
                ]
              }
            },
            {
              "id": "TS001.T2.C4",
              "type": "excludes_all",
              "description": "Не должен снова скатываться в выдачу запчастей на шаге коррекции",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "фокус:\\s*\\*\\*запчаст",
                  "/company/avto",
                  "/company/up-18",
                  "/company/avtostim"
                ],
                "hits": []
              }
            }
          ]
        },
        {
          "turn": 3,
          "user": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
          "requestBody": {
            "message": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта**:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), значит это профильный молочный производитель в Бресте.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, включающее предприятия по переработке молока; может направить на нужный завод/поставщика под объём 1 т.\n\n⚠️ Третьего сильного кандидата из текущего списка нет (например, **Брестмаш** — это оборудование, не поставщик молока).\n\nЧто проверить перед заказом:\n- формат: сырое/пастеризованное молоко, жирность;\n- фасовка: налив/еврокуб/танк;\n- документы: вет/качество, срок годности;\n- логистика: самовывоз или доставка по Бресту;\n- цена за кг/л при объёме **1 тонна** и срок поставки.\n\nЕсли хотите, сразу подготовлю короткий текст запроса поставщику (email + WhatsApp) для рассылки этим 2 компаниям."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Верно, спасибо — это ошибка подбора.  \nДля запроса **«1 тонна молока в Бресте»** запчасти и компании из Минска нужно исключить.\n\nОставляем только релевантное по Бресту:\n\n**Исключаем** как нерелевантные:\n- все «запчасти/авто/спецтехника»;\n- компании с локацией **Минск**, если нужна закупка в Бресте.\n\nМогу сразу дать готовый короткий текст запроса, чтобы отправить в эти 2 компании на объем 1 т (с ценой, сроком и доставкой).\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              }
            ]
          },
          "latencyMs": 8869,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "b06df7df-83a8-4310-adf9-30f6ef0cd2a3",
          "isStub": false,
          "reply": "Отлично, теперь по делу: **автозапчасти оптом в Минске**.\n\nСразу отмечу: в текущем списке кандидатов есть только **1 компания**, и она **нерелевантна** (ETHNIKA — мыло/косметика), поэтому честно не могу дать надежный шортлист поставщиков из этого конкретного снимка.\n\nКак быстро искать в Biznesinfo:\n1. Рубрика: **Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. Если нужны запчасти на грузовые: **Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n3. Фильтр по городу: **Минск**.\n4. Ключи для поиска:  \n   - «автозапчасти оптом минск»  \n   - «склад автозапчастей»  \n   - «поставщик автозапчастей»  \n   - «контрактные запчасти» (если б/у)  \n   - «запчасти для грузовой техники оптом»\n\nКак выбрать «надежных»:\n1. Есть ли в карточке телефон + сайт + email.\n2. Указан ли **опт/дилер/склад** прямо в описании.\n3. Ассортимент под ваш сегмент (легковые/грузовые/бренд).\n4. Условия: отсрочка, минимальная партия, гарантия/возврат.\n5. Скорость отгрузки по Минску (со склада или под заказ).\n\nЕсли хотите, подготовлю вам **готовый RFQ-текст** для рассылки 10–20 поставщикам (email + WhatsApp) с полями: по вашему ТЗ, по вашему ТЗ, объем, срок поставки, по вашему ТЗ.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T3.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T3.C2",
              "type": "includes_any",
              "description": "Должен переключиться на новую тему (автозапчасти)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "автозапчаст",
                  "запчаст"
                ],
                "hits": [
                  "автозапчаст",
                  "запчаст"
                ]
              }
            },
            {
              "id": "TS001.T3.C3",
              "type": "includes_any",
              "description": "Должен учитывать новый город (Минск)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "минск",
                  "minsk"
                ],
                "hits": [
                  "минск",
                  "minsk"
                ]
              }
            }
          ]
        },
        {
          "turn": 4,
          "user": "Ок, возвращаемся к молоку в Бресте",
          "requestBody": {
            "message": "Ок, возвращаемся к молоку в Бресте",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта**:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), значит это профильный молочный производитель в Бресте.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, включающее предприятия по переработке молока; может направить на нужный завод/поставщика под объём 1 т.\n\n⚠️ Третьего сильного кандидата из текущего списка нет (например, **Брестмаш** — это оборудование, не поставщик молока).\n\nЧто проверить перед заказом:\n- формат: сырое/пастеризованное молоко, жирность;\n- фасовка: налив/еврокуб/танк;\n- документы: вет/качество, срок годности;\n- логистика: самовывоз или доставка по Бресту;\n- цена за кг/л при объёме **1 тонна** и срок поставки.\n\nЕсли хотите, сразу подготовлю короткий текст запроса поставщику (email + WhatsApp) для рассылки этим 2 компаниям."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Верно, спасибо — это ошибка подбора.  \nДля запроса **«1 тонна молока в Бресте»** запчасти и компании из Минска нужно исключить.\n\nОставляем только релевантное по Бресту:\n\n**Исключаем** как нерелевантные:\n- все «запчасти/авто/спецтехника»;\n- компании с локацией **Минск**, если нужна закупка в Бресте.\n\nМогу сразу дать готовый короткий текст запроса, чтобы отправить в эти 2 компании на объем 1 т (с ценой, сроком и доставкой).\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              },
              {
                "role": "user",
                "content": "Ладно, теперь реально нужны автозапчасти в Минске оптом"
              },
              {
                "role": "assistant",
                "content": "Отлично, теперь по делу: **автозапчасти оптом в Минске**.\n\nСразу отмечу: в текущем списке кандидатов есть только **1 компания**, и она **нерелевантна** (ETHNIKA — мыло/косметика), поэтому честно не могу дать надежный шортлист поставщиков из этого конкретного снимка.\n\nКак быстро искать в Biznesinfo:\n1. Рубрика: **Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. Если нужны запчасти на грузовые: **Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n3. Фильтр по городу: **Минск**.\n4. Ключи для поиска:  \n   - «автозапчасти оптом минск»  \n   - «склад автозапчастей»  \n   - «поставщик автозапчастей»  \n   - «контрактные запчасти» (если б/у)  \n   - «запчасти для грузовой техники оптом»\n\nКак выбрать «надежных»:\n1. Есть ли в карточке телефон + сайт + email.\n2. Указан ли **опт/дилер/склад** прямо в описании.\n3. Ассортимент под ваш сегмент (легковые/грузовые/бренд).\n4. Условия: отсрочка, минимальная партия, гарантия/возврат.\n5. Скорость отгрузки по Минску (со склада или под заказ).\n\nЕсли хотите, подготовлю вам **готовый RFQ-текст** для рассылки 10–20 поставщикам (email + WhatsApp) с полями: по вашему ТЗ, по вашему ТЗ, объем, срок поставки, по вашему ТЗ.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)"
              }
            ]
          },
          "latencyMs": 5856,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "27cfbe8c-14fb-4621-baf5-118dd6731ec5",
          "isStub": false,
          "reply": "Принято, возвращаемся к **молоку в Бресте**.\n\nПо текущим данным у нас 2 рабочих направления:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n2. **Концерн Брестмясомолпром** — `/company/brestmmp` (как точка входа к молокопереработчикам холдинга)\n\nЧтобы быстро закрыть задачу на 1 тонну, рекомендую такой порядок:\n1. Отправить одинаковый запрос в обе компании.\n2. Сравнить: цена за 1 л/кг, жирность, дата выработки, доставка/самовывоз, документы.\n3. Выбрать поставщика с лучшим сочетанием **цена + срок + логистика**.\n\nЕсли хотите, сейчас дам готовый текст запроса для отправки (почта + WhatsApp) с вашими параметрами.  \nУточните только 3 пункта:\n1) молоко **сырое** или **пастеризованное**;  \n2) нужна **доставка по Бресту** или самовывоз;  \n3) дедлайн поставки (дата).",
          "checks": [
            {
              "id": "TS001.T4.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T4.C2",
              "type": "includes_any",
              "description": "Должен вернуться к исходной теме (молоко в Бресте)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        }
      ],
      "durationMs": 27528
    }
  ]
}
