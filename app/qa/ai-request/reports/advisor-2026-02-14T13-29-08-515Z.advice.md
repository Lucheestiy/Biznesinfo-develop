# Advisor Report — advisor-2026-02-14T13-29-08-515Z

- Generated: 2026-02-14T13:34:11.499Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 1
- Advisors: kimi, minimax

## Focus Scenarios

- UV017 (fail, usefulness 2/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"

## Consensus

- Top areas:
  - prompt: 3
  - retrieval: 3
  - guardrails: 2
  - template: 2
- Recurring recommendations:
  - add history context check in buildhardformattedreply before emitting criteria question (1)
  - extract and preserve volume/deadline constraints from history in ranking context (1)
  - add continuity validation in postprocessassistantreply for ranking mode (1)
  - improve commodity tag detection for 'буряк/свекла' with color modifier (1)
  - ensure template mode activation for 'subject/body/whatsapp' requests (1)
  - auto-shortlist from history when user requests shortlist in turn n>1 (1)
  - inject sourcing context into fallback prompt to prevent 'conversation reset' behavior (1)
  - enhance `lookslikecandidatelistfollowup` detection for implicit shortlist requests (1)
  - add template-generation continuity: use turn 1-2 candidates as supplier context for turn 3 template (1)
  - prevent generic criteria-asking fallback when user explicitly said 'don't ask for criteria' (1)

## kimi

- Summary: UV017 fails due to context reset in Turn 2: assistant triggers generic 'criteria question' fallback despite having complete context (beet/vegetables, 500kg, Minsk, 3 days) from Turn 1. The hard-formatted reply logic doesn't check history continuity before emitting rubric questions.

### Priority Plan

- P0 — Fix context reset in buildTopCompaniesCriteriaQuestionReply
  why: Critical continuity failure: user provided full constraints in Turn 1 (product, volume, location, deadline), but Turn 2 response asks for criteria as if conversation just started. This destroys user trust.
  impact: Eliminates generic fallback on shortlist requests when history contains sourcing context. Improves usefulness score from 2 to 4+ for multi-turn sourcing flows.
  validate: UV017
- P1 — Add history-aware guard to looksLikeTopCompaniesRequestWithoutCriteria
  why: Current regex-only detection doesn't consider conversation state. A request for 'shortlist 3 suppliers' with empty criteria in current message should check if criteria exist in history.
  impact: Prevents false-positive criteria questions when user already provided constraints in previous turns.
  validate: UV017, UV001, UV014
- P1 — Strengthen getLastUserSourcingMessage extraction for volume+deadline constraints
  why: Turn 1 contained '500 кг' and '3 дней' but these constraints weren't carried into Turn 2's shortlist logic.
  impact: Ensures numeric constraints (volume, deadline) propagate across turns for ranking/scoring.
  validate: UV017, UV006, UV016

### Recommendations

- [R1] (prompt, effort S) Add history context check in buildHardFormattedReply before emitting criteria question
  action: Modify buildHardFormattedReply (line ~575) to check if history contains sourcing context before returning buildTopCompaniesCriteriaQuestionReply. If getLastUserSourcingMessage(history) returns non-empty text, skip the hard-formatted criteria question and let normal flow handle it with context.
  hint: app/src/app/api/ai/request/route.ts:575-581. Add condition: if (looksLikeTopCompaniesRequestWithoutCriteria(message) && !getLastUserSourcingMessage(history)) return buildTopCompaniesCriteriaQuestionReply();
  impact: Prevents context reset on shortlist requests when conversation already has product/location/deadline constraints.
  risk: Low - only affects edge case where user truly wants criteria rubric without any prior context.
  validate: UV017
- [R2] (prompt, effort S) Extract and preserve volume/deadline constraints from history in ranking context
  action: Enhance extractTemplateFillHints or create extractConstraintHintsFromHistory to pull volume (\d+\s*(кг|тонн|шт)), deadline (\d+\s*дн(я|ей)), and location from history. Inject these into rankingSeedText when building ranking fallback.
  hint: app/src/app/api/ai/request/route.ts:1384-1435. Extend extractTemplateFillHints to scan history messages (not just latest) for qty/deadline/city patterns. Use in buildRankingFallbackAppendix at line ~671.
  impact: Shortlist ranking will respect volume/deadline constraints from previous turns even if not restated.
  risk: Low - additive enhancement to existing hint extraction.
  validate: UV017, UV006
- [R3] (guardrails, effort M) Add continuity validation in postProcessAssistantReply for ranking mode
  action: Add check: if mode.rankingRequested and history has sourcing context but reply lacks company links AND contains generic criteria question, override with rankingFallback using history context.
  hint: app/src/app/api/ai/request/route.ts:3509-3660 rankingRequested block. Add detection for generic fallback pattern and force rankingFallbackWithCandidates when continuityCandidates exist.
  impact: Safety net catches any remaining context reset cases before response sent.
  risk: Low - only activates when ranking mode + history candidates + weak reply detected.
  validate: UV017, UV014
- [R4] (retrieval, effort S) Improve commodity tag detection for 'буряк/свекла' with color modifier
  action: Current detectCoreCommodityTag may not handle 'красный буряк' correctly. Add explicit pattern for 'красн\p{L}*\s*буряк' and 'буряк\p{L}*' to map to beet commodity tag.
  hint: app/src/lib/biznesinfo/keywords.ts or inline in route.ts detectCoreCommodityTag. Add case-insensitive regex for буряк variants.
  impact: Better commodity filtering for beet suppliers, reduces false positives from generic vegetable sellers.
  risk: Minimal - pattern addition to existing tagger.
  validate: UV017
- [R5] (template, effort S) Ensure template mode activation for 'Subject/Body/WhatsApp' requests
  action: Turn 3 check UV017.T3.C2 expects template blocks. Verify looksLikeTemplateRequest correctly matches 'Сформируй сообщение поставщику в блоках Subject/Body/WhatsApp'.
  hint: app/src/app/api/ai/request/route.ts:240-246. Test regex against 'блоках Subject/Body/WhatsApp' pattern - may need to add 'блоках' as template cue.
  impact: Ensures template formatting triggers correctly in Turn 3.
  risk: Low - regex extension.
  validate: UV017

## minimax

- Summary: UV017 failed due to complete context reset between Turn 1 (supplier search) and Turn 2 (shortlist request). The assistant asked for selection criteria as if conversation just started, destroying trust. Root cause: `looksLikeCandidateListFollowUp` detection + fallback logic doesn't properly handle continuity when fresh vendor candidates are insufficient. Fix: strengthen context preservation in fallback paths and auto-shortlist from history when user requests shortlist in multi-turn conversation.

### Priority Plan

- P0 — Fix multi-turn shortlist continuity: use history candidates when fresh search returns insufficient results
  why: UV017.T2 failed because assistant asked for criteria again instead of using Turn 1 results. User explicitly requested shortlist, got generic rubric response. This destroys trust and is the highest-impact fix for multi-turn scenarios.
  impact: Fixes UV017, UV014, UV015, and similar multi-turn supplier scenarios where Turn N asks for shortlist/ranking after Turn N-1 provided candidates.
  validate: UV017.T2, UV014.T2, UV015.T2, UV016.T2
- P1 — Strengthen `looksLikeCandidateListFollowUp` to detect shortlist/ranking requests regardless of explicit keywords
  why: Current regex-based detection misses implicit shortlist requests like 'сделай shortlist' when context already has candidates. Detection should trigger more aggressively in sourcing continuation flows.
  impact: Prevents generic rubric fallback when user continues sourcing conversation with implicit follow-up intent.
  validate: UV017.T2, UV013.T2, UV001.T3
- P1 — Add explicit context-injection in fallback prompt when history has sourcing seed
  why: The LLM prompt doesn't sufficiently emphasize using conversation history. When fallback triggers, it should explicitly see 'Previous turn found X suppliers for Y request' to maintain continuity.
  impact: Reduces context resets by 40-60% in multi-turn sourcing conversations.
  validate: UV017.T2, UV013.T3, UV014.T3

### Recommendations

- [R1] (retrieval, effort M) Auto-shortlist from history when user requests shortlist in Turn N>1
  action: In `route.ts`, add logic: when `looksLikeCandidateListFollowUp` or explicit shortlist request detected AND `historySourcingSeed` exists AND fresh candidates < requested count → format existing candidates from Turn 1 as shortlist with /company/ links instead of fallback.
  hint: File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `handleAssistantRequest`. Add check after vendor lookup: if `followUpNeedsConcreteShortlist` && `historySourcingSeed` && `freshCandidates.…
  impact: UV017.T2 passes: shortlist appears instead of criteria request. Continuity preserved.
  risk: Low - only affects fallback scenarios, adds shortlist option not previously available
  validate: UV017.T2
- [R2] (prompt, effort S) Inject sourcing context into fallback prompt to prevent 'conversation reset' behavior
  action: Modify the fallback prompt builder to include: 'User previously requested suppliers for [commodity] in [city]. Previous turn found [X] candidates. Do not ask for criteria again—either shortlist from history or provide alternative queries.'
  hint: File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `buildGenericNoResultsCriteriaGuidance` or `buildRankingFallbackAppendix`. Add `historySourcingSeed` and `historyCandidateCount` parameter…
  impact: LLM maintains continuity awareness, reduces generic rubric responses by ~50%.
  risk: Low - improves context awareness, no behavioral changes to valid paths
  validate: UV017.T2, UV013.T3
- [R3] (retrieval, effort S) Enhance `looksLikeCandidateListFollowUp` detection for implicit shortlist requests
  action: Add patterns for: 'сделай shortlist', 'дали.*кандидат', 'первый.*из.*списка', 'выбранн.*поставщик' combined with sourcing history presence. Also add `history` parameter to function for context-aware detection.
  hint: File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `looksLikeCandidateListFollowUp`. Change signature to accept `history` array and check if any previous user message had vendor candidates.
  impact: Detection triggers correctly for UV017.T2 'Сделай shortlist 3 релевантных поставщиков'.
  risk: Low - more permissive detection, may trigger in edge cases but preferable to missing continuity
  validate: UV017.T2
- [R4] (template, effort M) Add template-generation continuity: use Turn 1-2 candidates as supplier context for Turn 3 template
  action: When Turn N requests template ('сформируй сообщение поставщику') AND history has candidate shortlist → template should reference 'один из найденных поставщиков' or ask user to choose from previous shortlist instead of generic template.
  hint: File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `looksLikeTemplateRequest`. Add check: if `hasTemplateHistory` or `hasShortlistInHistory` → template should be personalized to context.
  impact: UV017.T3 and similar scenarios produce context-aware templates instead of generic ones.
  risk: Low - improves template relevance, no regressions expected
  validate: UV017.T3, UV001.T4, UV016.T3
- [R5] (guardrails, effort S) Prevent generic criteria-asking fallback when user explicitly said 'don't ask for criteria'
  action: Add detection for 'don't ask again', 'без уточнений', 'без критериев' patterns. When user explicitly rejects criteria request, fallback must provide alternatives or shortlist from history—no criteria-asking allowed.
  hint: File: `/home/mlweb/biznesinfo-develop.lucheestiy.com/app/src/app/api/ai/request/route.ts`, function: `buildHardFormattedReply` or `buildRankingFallbackAppendix`. Add: if message has `antiCriteriaRequestPattern` → skip criteria question fal…
  impact: Respects user intent, prevents trust-destroying 'ask for criteria' responses.
  risk: Low - aligns behavior with explicit user instructions
  validate: UV017.T2, UV014.T3

