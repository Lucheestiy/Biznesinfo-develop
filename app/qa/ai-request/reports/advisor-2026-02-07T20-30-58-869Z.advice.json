{
  "runId": "advisor-2026-02-07T20-30-58-869Z",
  "generatedAt": "2026-02-07T20:32:48.686Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "D001",
      "title": "Dirty query: типография визитки срочно",
      "tags": [
        "dirty_input",
        "real_world",
        "multi_turn",
        "ranking"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 4.5,
      "usefulRate": 1,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Не проверяет, какие из типографий реально находятся в районе Малиновка",
        "Повторяет один и тот же список компаний во всех трёх ответах без фильтрации по району"
      ],
      "judgeReasons": [
        {
          "judge": "gemini",
          "usefulness": 5,
          "verdict": "useful",
          "reasons": [
            "Provides requested 3 options clearly.",
            "Delivers a highly detailed and actionable script of questions for contacting companies."
          ]
        },
        {
          "judge": "kimi",
          "usefulness": 4,
          "verdict": "useful",
          "reasons": [
            "Учитывает гео (Минск) и уточняет район (Малиновка)",
            "Дает конкретные компании с ссылками на карточки"
          ]
        }
      ],
      "lastReply": "Вот 3 варианта в Минске (проверьте адреса/контакты на карточках компании — важно для Малиновки и срочности): 1) **Аврора Принт ООО** — /company/avrora 2) **Золотой Оттиск ЧП (ПОСТПРИНТ)** — /company/postprint 3) **Топпринт ООО** — /company/topprint Что спросить по срокам/тиражу (скрипт вопросов): 1) «Можете сделать визитки **сегодня до 18:00**? Какое **время готовности**?» 2) «Какой **минимальный и максимальный тираж** вы берёте в срочном режиме?» 3) «Если **макет готов**, сколько времени на печать? Если **нужна в…",
      "lastUser": "дай 3 варианта и что спросить по срокам/тиражу"
    },
    {
      "id": "D002",
      "title": "Dirty query: проверка УНП",
      "tags": [
        "dirty_input",
        "real_world",
        "multi_turn",
        "verification"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 5,
      "usefulRate": 1,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [],
      "judgeReasons": [
        {
          "judge": "gemini",
          "usefulness": 5,
          "verdict": "useful",
          "reasons": [
            "Assistant delivers a concise 5-point checklist as requested, effectively removing 'water'.",
            "The checklist is clear, direct, and retains all the essential information from the previous turn."
          ]
        },
        {
          "judge": "kimi",
          "usefulness": 5,
          "verdict": "useful",
          "reasons": [
            "Честно признаёт ограничение (нужен полный УНП) в turn 1",
            "Дает конкретные альтернативные способы поиска в turn 2"
          ]
        }
      ],
      "lastReply": "1. Введите полное название + город в каталоге Biznesinfo. 2. Проверьте 2–3 варианта названия (ООО/ОАО/ЗАО, с/без кавычек). 3. Добавьте ключевую деятельность в поиск (например, «логистика», «стройматериалы»). 4. Найдите УНП в договоре/счёте/сайте компании. 5. Подтвердите статус в ЕГР по названию или УНП.",
      "lastUser": "дай чеклист 5 пунктов без воды"
    }
  ],
  "advice": [
    {
      "advisor": "gemini",
      "executiveSummary": "The current AI assistant demonstrates strong performance on general information queries like 'проверка УНП'. However, a critical issue has been identified by the 'kimi' judge in geo-specific queries, specifically in scenario D001 ('типография визитки срочно'). Despite acknowledging the 'Malinovka' district, the assistant fails to filter company results by this geographical constraint, providing a generic list instead. This leads to a lower usefulness score and indicates a gap in the system's ability to process and apply nuanced geographical filters during company retrieval.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Implement robust geographical filtering for company search results",
          "why": "The assistant currently acknowledges geographical constraints (e.g., 'район Малиновка') but fails to apply them as a filter to the search results. This leads to irrelevant recommendations and a reduced usefulness score, as highlighted by the 'kimi' judge in s…",
          "expectedImpact": "Significantly improve the relevance and usefulness of company recommendations for geo-specific queries, directly addressing the core issue raised by the judge in D001. This will likely increase user satisfaction for loc…",
          "validationScenarios": [
            "D001"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "retrieval",
          "title": "Enhance Geo-Awareness in Company Search/Retrieval",
          "action": "Modify the company search/retrieval logic to incorporate geographical filtering based on identified districts or neighborhoods. This requires ensuring that company data includes sufficient geographical granularity (e.g., district, coordinates) and that the search query construction effectively uses this information to filter results before presentation.",
          "implementationHint": "1. **Data Enrichment**: Verify that company data indexed by Meilisearch (or any other search backend) contains specific district/neighborhood information. If not, update the data ingestion process (e.g., `app/scripts/index_meilisearch.ts`…",
          "expectedImpact": "Directly resolves the 'Malinovka' filtering issue in D001, providing accurate, localized company recommendations. Improves the overall quality and trustworthiness of the assistant's advice for location-sensitive queries…",
          "risk": "Medium. Requires changes to data indexing and search query logic. Careful testing is needed to ensure no regressions in non-geo-specific searches.",
          "effort": "M",
          "validationScenarios": [
            "D001"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "D001",
          "D002"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.dirty.realworld.json"
        ],
        "successMetrics": [
          "Kimi judge average usefulness score for D001 >= 4.5",
          "No new 'judgeIssueHints' related to geo-filtering in D001",
          "Overall pass rate for all scenarios remains 1.0"
        ]
      }
    },
    {
      "advisor": "kimi",
      "executiveSummary": "Current QA run shows 100% pass rate (2/2 scenarios, 23/23 checks) with avg usefulness 4.75/5. However, judge analysis reveals systematic issues: (1) geo-filters don't verify actual company locations against micro-districts (e.g., 'Малиновка'), (2) company lists repeat across turns without location-based filtering, (3) contradiction between turns (finding candidates then claiming none exist). Root cause: retrieval layer lacks address-level geo-validation and cross-turn result consistency.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix micro-district geo-filtering for company results",
          "why": "Judge identified that assistant returns same company list across all 3 turns without filtering by 'Малиновка' district. Users expect location-filtered results when specifying micro-districts.",
          "expectedImpact": "Reduces 'repeating same list' complaints; improves usefulness score from 4→5 on geo-constrained queries.",
          "validationScenarios": [
            "D001"
          ]
        },
        {
          "priority": "P0",
          "title": "Add cross-turn consistency guard for vendor lookups",
          "why": "Historical issue (UX107): Turn 1 finds 'Белпожохрансервис', Turn 2 claims 'нет релевантных компаний'. Same contradiction pattern risks appearing in current flow.",
          "expectedImpact": "Eliminates contradiction failures; maintains user trust in multi-turn conversations.",
          "validationScenarios": [
            "D001",
            "UX107"
          ]
        },
        {
          "priority": "P1",
          "title": "Enrich company data with address/location field for filtering",
          "why": "Current `BiznesinfoCompanySummary` has `city` and `region` but no `address` or `district` field. Cannot verify if company is actually in 'Малиновка'.",
          "expectedImpact": "Enables accurate micro-district filtering; supports 'near me' queries.",
          "validationScenarios": [
            "D001",
            "S005",
            "S006"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "geo",
          "title": "Implement address-level location matching for micro-districts",
          "action": "In `app/src/app/api/ai/request/route.ts`, enhance `filterAndRankVendorCandidates()` to check `company.address` field against district patterns (e.g., /малиновка|каменная\\s+горка/i). If user specifies micro-district, filter candidates by address match before returning.",
          "implementationHint": "Add `addressMatch` scoring in `filterAndRankVendorCandidates()` around line 280-295. Use regex pattern from `extractLocationPhrase()` to match against `c.address`.",
          "expectedImpact": "Returns only companies actually located in requested micro-district; eliminates 'same list for all turns' issue.",
          "risk": "Low - falls back to city-level if address field empty.",
          "effort": "S",
          "validationScenarios": [
            "D001",
            "S005"
          ]
        },
        {
          "id": "R2",
          "area": "retrieval",
          "title": "Cache vendor candidates across turns in session",
          "action": "Store `vendorCandidates` in conversation context (similar to `history`). On follow-up turns with same sourcing topic, reuse cached candidates instead of re-querying, then apply new filters (geo, ranking) on cached set.",
          "implementationHint": "Extend `AssistantSessionRef` in `conversations.ts` to include `lastVendorCandidates: string[]`. In `buildVendorLookupContext()`, check cache before new search when `followUpByLocation || followUpByRanking`.",
          "expectedImpact": "Prevents contradiction between turns; ensures consistent company set across multi-turn sourcing conversations.",
          "risk": "Medium - need TTL/cache invalidation on new search terms.",
          "effort": "M",
          "validationScenarios": [
            "D001",
            "UX107"
          ]
        },
        {
          "id": "R3",
          "area": "prompt",
          "title": "Add explicit location-verification instruction to system prompt",
          "action": "When `cityRegionHints` contains `phrase` (micro-district), add instruction: 'Verify each recommended company is located in {phrase} district by checking address field. If location uncertain, note this explicitly.'",
          "implementationHint": "In `buildCityRegionHintsBlock()`, when `hint.phrase` exists and differs from city, append verification instruction to returned block.",
          "expectedImpact": "LLM self-corrects on location claims; reduces judge complaints about unverified locations.",
          "risk": "Low - instruction-only change.",
          "effort": "S",
          "validationScenarios": [
            "D001",
            "S005"
          ]
        },
        {
          "id": "R4",
          "area": "ranking",
          "title": "Deduplicate and filter company lists by geo constraints",
          "action": "In `postProcessAssistantReply()`, when `mode.rankingRequested` and `locationPhrase` exists, strip companies not matching location from response. Use `stripCompanyLinkLines()` pattern but with geo-aware filtering.",
          "implementationHint": "Add geo-filter step before line 954-957 in route.ts. Check each `/company/` link's associated candidate against `locationPhrase` via address match.",
          "expectedImpact": "Ensures ranking responses respect geo constraints even when LLM hallucinates extra companies.",
          "risk": "Low - post-processing safeguard.",
          "effort": "S",
          "validationScenarios": [
            "D001"
          ]
        },
        {
          "id": "R5",
          "area": "guardrails",
          "title": "Add contradiction detection for vendor availability claims",
          "action": "Track if previous turn mentioned specific companies. If current turn claims 'нет релевантных компаний' but history contains company mentions, trigger consistency fallback.",
          "implementationHint": "In `postProcessAssistantReply()`, check `history` for company slugs via `extractAssistantCompanySlugsFromHistory()`. If `replyClaimsNoRelevantVendors()` true but history has slugs, append: 'В предыдущем ответе упоминались: {list}. Уточните…",
          "expectedImpact": "Prevents UX107-style contradictions; improves user trust.",
          "risk": "Low - additive message only.",
          "effort": "S",
          "validationScenarios": [
            "UX107",
            "D001"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "D001",
          "D002"
        ],
        "regressionSuites": [
          "scenarios.regressions.geo.json",
          "scenarios.regressions.ranking-followups.json",
          "scenarios.dirty.realworld.json"
        ],
        "successMetrics": [
          "usefulRate >= 0.95 (currently 1.0, maintain)",
          "avgUsefulness >= 4.8 (currently 4.75, target +0.05)",
          "zero contradiction issues in judge reports",
          "geo-filtered queries show address-verified companies only"
        ]
      }
    }
  ],
  "consensus": {
    "topAreas": [
      {
        "area": "retrieval",
        "count": 2
      },
      {
        "area": "geo",
        "count": 1
      },
      {
        "area": "prompt",
        "count": 1
      },
      {
        "area": "ranking",
        "count": 1
      },
      {
        "area": "guardrails",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "enhance geo-awareness in company search/retrieval",
        "count": 1
      },
      {
        "title": "implement address-level location matching for micro-districts",
        "count": 1
      },
      {
        "title": "cache vendor candidates across turns in session",
        "count": 1
      },
      {
        "title": "add explicit location-verification instruction to system prompt",
        "count": 1
      },
      {
        "title": "deduplicate and filter company lists by geo constraints",
        "count": 1
      },
      {
        "title": "add contradiction detection for vendor availability claims",
        "count": 1
      }
    ]
  }
}
