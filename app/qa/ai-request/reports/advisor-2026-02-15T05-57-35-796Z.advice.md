# Advisor Report — advisor-2026-02-15T05-57-35-796Z

- Generated: 2026-02-15T06:01:34.168Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 20
- Advisors: kimi, minimax

## Focus Scenarios

- UV021 (fail, usefulness 0/5): Ирис Интер групп: консистентность между «нашел компанию» и «проверь на карточке»
- UV003 (fail, usefulness 0/5): Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка
- UV022 (fail, usefulness 0/5): Ирис Интер групп: явный поиск -> последние новости с сайта (без запроса URL)
- UV018 (fail, usefulness 0.5/5): Ирис Интер групп: 20 тегов для GA/Метрики без ложного sourcing-fallback
- UV012 (fail, usefulness 1/5): Проверка по сайтам компаний: источник + контакты + честная пометка подтверждения
- UV002 (fail, usefulness 1.5/5): Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist
- UV004 (fail, usefulness 1.5/5): Белорусские соковыжималки: заводы -> OEM/ODM -> shortlist -> RFQ
- UV009 (fail, usefulness 2.5/5): Стоматология с микроскопом в Минске: сложный consumer кейс + полезный fallback
- UV015 (fail, usefulness 2.5/5): Вариант по минитракторам: покупка -> сравнение условий -> запрос для звонка
- UV014 (fail, usefulness 3/5): Reverse-buyer вариативный: пищевая тара -> целевые сегменты -> shortlist без общих советов
- UV019 (pass, usefulness 0/5): Ирис Интер групп: запрос последних новостей без требования ссылки от пользователя
- UV020 (pass, usefulness 0/5): Ирис Интер групп: команда «Найди на карточке компании» без запроса ссылки у пользователя
- UV001 (pass, usefulness 1/5): Производители обуви в Минске: уточнение типа + shortlist + шаблон контакта
- UV011 (pass, usefulness 1/5): No-results ветка: сверхузкий запрос на производителей обуви
- UV016 (pass, usefulness 1/5): Вариативный экспорт муки: shortlist + документная проверка + шаблон запроса
- UV007 (pass, usefulness 1.5/5): Найти потенциальных заказчиков моей продукции: reverse поиск + shortlist
- UV008 (pass, usefulness 1.5/5): Белорусский минитрактор: покупка + критерии + сравнение
- UV017 (pass, usefulness 1.5/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"
- UV005 (pass, usefulness 2/5): Экспортеры пищевой промышленности: сегментация по рынкам и продукту
- UV006 (pass, usefulness 2/5): Лес на экспорт: условия качества + логистика + RFQ

## Consensus

- Top areas:
  - prompt: 5
  - guardrails: 3
  - template: 2
  - retrieval: 2
  - ranking: 1
- Recurring recommendations:
  - inject explicit company context into system prompt (1)
  - add company resolution layer before website scan (1)
  - fix placeholder deduplication regex (1)
  - strengthen anti-sourcing-fallback for analytics tasks (1)
  - add company search before website news lookup (1)
  - add conversation topic tracker (1)
  - fix manufacturer detection for footwear queries (1)
  - add template context preservation (1)
  - add explicit template value extraction rules (1)
  - add company name echo checkpoint (1)
  - add anti-sourcing rule for analytics requests (1)
  - add domain-type mismatch detector (1)

## kimi

- Summary: Critical systemic failures in context continuity (UV021, UV022, UV019, UV020), template generation (UV001, UV003, UV004, UV006, UV016, UV017), and company identification (UV021-UV022, UV009, UV012). The assistant loses track of mentioned companies between turns, generates broken templates with placeholder cascades ('уточняется до уточняется'), and fails to maintain conversation state. Root cause: insufficient context window management and missing company entity tracking in conversation state.

### Priority Plan

- P0 — Fix Context Amnesia for Company Names
  why: UV021, UV022, UV019, UV020 all fail because assistant forgets 'Ирис Интер групп' between turns. This is the highest-impact fix.
  impact: Resolves 4 strict-fail scenarios (18% of failures), improves avgUsefulness from 0 to 2+
  validate: UV021, UV022, UV019, UV020
- P0 — Fix Template Placeholder Cascade Bug
  why: UV001, UV003, UV004, UV006, UV016, UV017 show templates with 'уточняется до уточняется' - placeholders are being double-processed
  impact: Fixes 6 scenarios with broken RFQ/outreach templates, improves usefulness scores by 1.5-2 points
  validate: UV001, UV003, UV004, UV006, UV016, UV017
- P1 — Add Company Entity Resolution for Website Lookups
  why: UV012, UV013 fail because assistant cannot resolve company from context to perform website scans
  impact: Enables proper website research flow, fixes 2 strict-fail scenarios
  validate: UV012, UV013
- P1 — Fix Anti-Fallback Logic for Analytics Requests
  why: UV018 fails - assistant ignores explicit 'не нужен поиск поставщиков' and returns sourcing templates
  impact: Respects user intent for non-sourcing tasks, fixes 1 strict-fail with 5 failed checks
  validate: UV018
- P2 — Improve Multi-Turn Document Checklist Generation
  why: UV002.T4 fails - 4-turn conversation loses context for export document checklist
  impact: Better continuity for complex multi-turn workflows
  validate: UV002

### Recommendations

- [R1] (prompt, effort M) Inject explicit company context into system prompt
  action: Add a 'mentionedCompanies' array to conversation state. When user mentions a company name (detect via 'компания называется', 'у меня компания', quoted text), store it with timestamp. Inject into system prompt: 'User previously mentioned companies: {name} (turn {n}). If user refers to 'this company', 'она', 'у них', resolve to this entity.'
  hint: app/src/app/api/ai/request/route.ts: augment AssistantSessionRef to include mentionedCompanies[]; update buildLocalResilientFallbackReply to inject context
  impact: Fixes UV021-022, UV019-020 company amnesia
  risk: Low - additive change, no breaking changes
  validate: UV021, UV022, UV019, UV020
- [R2] (prompt, effort S) Add company resolution layer before website scan
  action: Before triggering website scan tools, explicitly resolve company name from context using collectWebsiteResearchCompanyNameHints() but add fallback: if no explicit company found in current message, check conversation state for last mentioned company within last 3 turns. Never ask 'какая компания' if we have one in state.
  hint: app/src/app/api/ai/request/route.ts: modify website scan trigger logic around line 3400-3500; add resolveCompanyFromContextOrHistory() helper
  impact: Fixes UV012, UV013 website scan failures
  risk: Low - improves UX without changing API
  validate: UV012, UV013
- [R3] (template, effort S) Fix placeholder deduplication regex
  action: The sanitizeUnfilledPlaceholdersInNonTemplateReply() function at line 2540-2581 has aggressive dedup but still allows 'уточняется до уточняется'. Change the regex order: first replace all {placeholders} with 'уточняется', THEN run deduplication. Current code does partial replacements then dedup which creates cascade.
  hint: app/src/app/api/ai/request/route.ts:2540-2581 - restructure to: 1) Replace all {\w+} with 'уточняется', 2) Single pass dedup: /(?:уточняется[\s,;.:-]*){2,}/giu → 'уточняется'
  impact: Fixes broken templates in UV001, UV003, UV004, UV006, UV016, UV017
  risk: Low - pure bugfix
  validate: UV001, UV003, UV004, UV006, UV016, UV017
- [R4] (guardrails, effort S) Strengthen anti-sourcing-fallback for analytics tasks
  action: looksLikeAnalyticsTaggingRequest() at line 280-300 needs stronger negative signals. Add check: if user explicitly says 'не нужен поиск поставщиков' or similar negative sourcing cues, set a flag in conversation state that suppresses ALL sourcing fallbacks for next 2 turns.
  hint: app/src/app/api/ai/request/route.ts:280-300 - add explicitNegativeSourcingCue detection; pass flag through to buildLocalResilientFallbackReply to skip sourcing templates
  impact: Fixes UV018 strict-fail (5 failed checks)
  risk: Low - adds guardrail without changing happy path
  validate: UV018
- [R5] (retrieval, effort M) Add company search before website news lookup
  action: When user asks for 'новости на сайте компании', first search catalog for company by name from context, get website URL from company record, THEN scan. Current flow tries to scan without resolving company first.
  hint: app/src/app/api/ai/request/route.ts: add pre-flight company lookup in handleWebsiteResearchIntent(); use biznesinfoSearch() with company name hints before calling website scanner
  impact: Fixes UV019, UV020, UV021, UV022 news lookup failures
  risk: Medium - adds latency, needs timeout handling
  validate: UV019, UV020, UV021, UV022
- [R6] (prompt, effort M) Add conversation topic tracker
  action: Track conversation 'topic' (sourcing vs analytics vs templates) in session state. When topic is 'analytics' (detected via GA/Метрика/теги keywords), reject ALL attempts to switch to sourcing mode unless user explicitly requests it.
  hint: app/src/lib/ai/conversations.ts: add topic field to AssistantSession; app/src/app/api/ai/request/route.ts: update detectConversationTopic() on each turn
  impact: Prevents UV018-type mode confusion, improves UX for analytics workflows
  risk: Low - state tracking only
  validate: UV018
- [R7] (ranking, effort S) Fix manufacturer detection for footwear queries
  action: UV001, UV011, UV012 fail to find shoe manufacturers. The detectManufacturerSignal() at line 1782-1803 works but refineConcreteShortlistCandidates() filters too aggressively. Add 'обувь' as manufacturer keyword and boost footwear manufacturer signals.
  hint: app/src/app/api/ai/request/route.ts:1782-1803 - add 'обувь', 'обувной', 'швейн' to MANUFACTURER_KEYWORDS; add commodity-specific boost for footwear tag
  impact: Better manufacturer detection for UV001, UV011, UV012
  risk: Low - keyword addition
  validate: UV001, UV011, UV012
- [R8] (template, effort S) Add template context preservation
  action: When generating templates (Subject/Body/WhatsApp), extract and preserve context from previous turns: product name, quantity, location, deadline. Current code extracts hints but doesn't apply them consistently across multi-turn.
  hint: app/src/app/api/ai/request/route.ts:1541-1592 - enhance extractTemplateFillHints() to search deeper in history (6→10 turns); ensure applyTemplateFillHints() is called in ALL template generation paths
  impact: Better template quality for UV001, UV004, UV006, UV016, UV017
  risk: Low - improves existing feature
  validate: UV001, UV004, UV006, UV016, UV017

## minimax

- Summary: Critical failures in 3 areas: (1) 45% pass rate due to company context amnesia and wrong company types; (2) Template placeholders defaulting to 'уточняется' instead of extracting values from conversation history; (3) Sourcing fallback contamination in non-sourcing requests. Fix requires strict context carryover rules and template value extraction from history.

### Priority Plan

- P0 — Force template value extraction from conversation history
  why: All 10+ failed template scenarios show 'уточняется' placeholders despite values being available in prior turns (UV001, UV003, UV004, UV006, UV016, UV017). The model must extract qty/city/product from T1-T3 context before generating templates.
  impact: Increase template usefulness from 0% to 60%+ for scenarios with prior context
  validate: UV001.T4, UV003.T4, UV004.T4, UV016.T4
- P0 — Add strict company name continuity enforcement
  why: UV021, UV022, UV019, UV020 all show complete context loss - assistant returns wrong companies (САВАНА instead of Ирис Интер групп, hospitals instead of shoe manufacturers). Company name from Turn 1 must be preserved in working context.
  impact: Eliminate wrong-company hallucinations in multi-turn company lookup
  validate: UV021, UV022, UV019, UV020
- P1 — Block sourcing/rubric fallback in analytics/tagging requests
  why: UV018 fails all checks because assistant returns rubric navigation instead of requested 20 GA tags. Anti-sourcing rules must be enforced when request explicitly excludes sourcing (без поиска поставщиков).
  impact: UV018 pass rate from 0% to 80%+
  validate: UV018.T1, UV018.T2
- P1 — Add domain-type guardrails for company searches
  why: UV012 returns hospitals/polyclinics for shoe manufacturers, UV009 returns chemical wholesale for dental clinics. Company type must match query domain (medical ≠ footwear, chemicals ≠ dental).
  impact: Reduce wrong-company-type failures by 70%
  validate: UV012, UV009

### Recommendations

- [R1] (prompt, effort M) Add explicit template value extraction rules
  action: Add to system prompt: BEFORE generating any template, scan ALL prior turns for: product/service name, quantity, city, deadline, contact. If found in any prior turn, extract and insert. Only use 'уточняется' if value never appeared in conversation.
  hint: app/src/app/api/ai/request/route.ts - add extractTemplateValuesFromHistory() function, call before ensureTemplateBlocks()
  impact: Templates will contain real values from conversation context instead of placeholders
  risk: Low - extracts existing values, doesn't invent new ones
  validate: UV001.T4, UV003.T4, UV004.T4, UV017.T4
- [R2] (prompt, effort S) Add company name echo checkpoint
  action: Add to system prompt: AFTER any company lookup, BEFORE responding, echo the company name in the response. If you cannot find the company mentioned in user's Turn 1, explicitly state 'Не нашел компанию X в каталоге' instead of returning unrelated companies.
  hint: app/src/app/api/ai/request/route.ts - add companyNameEchoCheckpoint() before response finalization
  impact: Eliminates company context amnesia - assistant will either find correct company or honestly admit failure
  risk: Low - improves honesty, prevents hallucinations
  validate: UV021, UV022, UV019, UV020
- [R3] (guardrails, effort S) Add anti-sourcing rule for analytics requests
  action: When request contains patterns like 'теги|UTM|GA|аналитик' AND excludes sourcing (без поставщиков|не нужен поиск), BLOCK all rubric/catalog/sourcing patterns. Force tag generation only.
  hint: app/src/app/api/ai/request/route.ts - enhance looksLikeAnalyticsTaggingRequest() to return strict mode, add explicit BLOCK for sourcing patterns when analytics requested
  impact: UV018 will generate tags instead of rubric suggestions
  risk: Low - stricter enforcement of user intent
  validate: UV018.T1, UV018.T2
- [R4] (guardrails, effort M) Add domain-type mismatch detector
  action: When searching for companies, verify returned companies match query domain. If query is footwear → reject medical/chemical companies. If query is dentistry → reject chemical wholesale. Add explicit domain whitelist/blacklist based on core commodity detection.
  hint: app/src/app/api/ai/request/route.ts - add companyTypeDomainMatch() check in ranking fallback, reject candidates where detectCoreCommodity(query) ≠ candidate.primary_rubric
  impact: Prevents hospitals for shoes, chemicals for dental failures
  risk: Medium - may reject valid companies if domain mapping is incomplete
  validate: UV012.T2, UV009.T1
- [R5] (retrieval, effort S) Fix vendorCandidates reuse in multi-turn
  action: When user says 'Сделай shortlist' in Turn 2+, use vendorCandidates from Turn 1 history. Do NOT re-query unless user changes criteria. Add explicit 'reuseExistingCandidates' flag.
  hint: app/src/app/api/ai/request/route.ts - in looksLikeTopCompaniesRequestWithoutCriteria(), always return false when history contains vendorCandidates, forcing reuse path
  impact: Fixes UV017 duplicate-company bug where same company repeated 4 times
  risk: Low - improves efficiency and consistency
  validate: UV017.T2, UV016.T2

