# Advisor Report — advisor-2026-02-14T18-20-37-174Z

- Generated: 2026-02-14T18:22:37.231Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 3
- Advisors: kimi, minimax

## Focus Scenarios

- UV001 (pass, usefulness 2/5): Производители обуви в Минске: уточнение типа + shortlist + шаблон контакта
- UV003 (pass, usefulness 2.5/5): Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка
- UV002 (pass, usefulness 3.5/5): Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist

## Consensus

- Top areas:
  - retrieval: 3
  - ranking: 2
  - template: 2
  - prompt: 2
  - guardrails: 1
- Recurring recommendations:
  - boost manufacturer signals in company scoring (1)
  - add conversation context filtering to vendor candidates (1)
  - add export readiness checklist to shortlist format (1)
  - strengthen shortlist count enforcement in system prompt (1)
  - expand search synonyms for niche manufacturing (1)
  - add anti-noise filter for educational institutions (1)
  - implement constraint pass-through validation before shortlist generation (1)
  - add domain relevance filter for b2b candidate queries (1)
  - add explicit turn 3 minimum count enforcement in system prompt (1)
  - generate context-aware templates using actual found candidates (1)

## kimi

- Summary: QA reveals 3 critical failure patterns: (1) Generic shortlist fallback on UV001 - only 1 questionable company returned instead of 3-5 concrete manufacturers; (2) Nonsensical company injection on UV003 - car dealer/fishing shop appearing in cafe equipment context; (3) Incomplete export readiness assessment on UV002. Root causes: search ranking doesn't sufficiently boost manufacturers over retailers, company confidence scoring allows low-quality matches, and the ranking fallback in buildRankingFallbackAppendix generates placeholder profiles instead of using actual search results. Fix priority: P0 for manufacturer detection, P1 for context-aware filtering, P2 for shortlist enrichment.

### Priority Plan

- P0 — Fix manufacturer vs retailer ranking in footwear queries
  why: UV001 shows 0% useful rate - the most critical user journey (finding manufacturers) fails completely. The system returns 'ПЛЭЙ МОДА ООО' with disclaimer 'possibly not a manufacturer' instead of actual manufacturers.
  impact: Increase UV001 usefulness from 0% to >60%, reduce generic fallback rate by 40%
  validate: UV001
- P1 — Add context-aware noise filtering for B2B pivots
  why: UV003 turn 3 injected completely irrelevant companies (Автоцентр, Рыболов, Сантехника) into cafe equipment context. The ranking algorithm is not filtering by semantic relevance to the conversation topic.
  impact: Eliminate nonsensical recommendations, improve UV003 usefulness from 50% to >80%
  validate: UV003
- P2 — Enrich shortlist with export readiness signals
  why: UV002 turn 3 shortlist lacks explicit export readiness per factory as requested. The buildRankingFallbackAppendix function doesn't extract/present export-specific signals from company data.
  impact: Increase UV002 usefulness from current levels, add structured export indicators to shortlist format
  validate: UV002

### Recommendations

- [R1] (ranking, effort S) Boost manufacturer signals in company scoring
  action: In buildRankingFallbackAppendix (line ~782), add manufacturer-specific scoring: check company name for 'производство', 'завод', 'фабрика' and boost score by 0.3; penalize names containing 'магазин', 'торговля', 'розница' by 0.2. Also check description/about fields for manufacturing keywords.
  hint: app/src/app/api/ai/request/route.ts: filterAndRankVendorCandidates function around line 800, add manufacturer intent detection using detectCoreCommodityTag and boost matching candidates
  impact: Prioritize actual manufacturers over retailers in footwear/flour queries
  risk: May over-boost if company names are misleading; mitigate by capping boost at 0.3
  validate: UV001, UV002
- [R2] (retrieval, effort M) Add conversation context filtering to vendor candidates
  action: In detectAssistantResponseMode and buildRankingFallbackAppendix, pass conversation topic (extracted from history) and filter candidates by semantic relevance. If topic is 'cafe/food supplies', exclude companies with rubrics containing 'авто', 'рыбалка', 'сантехника'.
  hint: app/src/app/api/ai/request/route.ts: add topic extraction from history using keyword matching, then filter commodityScopedRows by topic relevance before ranking
  impact: Prevent UV003-style irrelevant company injection
  risk: Over-filtering may reduce recall; use soft filtering (deprioritize vs exclude)
  validate: UV003
- [R3] (template, effort S) Add export readiness checklist to shortlist format
  action: Modify formatVendorShortlistRows (line ~1741) to include export indicators when export intent detected: add '✓' badge if description contains 'экспорт', 'ВЭД', 'export', or if company has website with .com domain. Add explicit 'Экспортная готовность' column to shortlist output.
  hint: app/src/app/api/ai/request/route.ts: formatVendorShortlistRows function, add export signal detection and conditional badge rendering in output format
  impact: UV002-style export queries get explicit readiness indicators per company
  risk: False positives if companies mention export casually; verify with website data when available
  validate: UV002, UV005, UV016
- [R4] (prompt, effort S) Strengthen shortlist count enforcement in system prompt
  action: In the system prompt construction (around line 2400+), add explicit instruction: 'When user requests N companies in shortlist, you MUST return exactly N companies if any exist in catalog. Never return fewer than requested without explicit explanation. If fewer than N exist, state 'Found only X confirmed companies' and list all found.'
  hint: app/src/app/api/ai/request/route.ts: buildAssistantSystemPrompt function, add shortlist count enforcement rule to prompt instructions
  impact: UV001 '3-5' request won't get 1-company fallback; system will search more aggressively
  risk: May increase hallucination if model invents companies; mitigate by requiring /company/ links
  validate: UV001, UV014
- [R5] (retrieval, effort S) Expand search synonyms for niche manufacturing
  action: In suggestSourcingSynonyms (app/src/lib/biznesinfo/keywords.ts), add footwear-specific expansions: 'обувь' → ['обувная фабрика', 'производство обуви', 'обувное производство', 'швейное производство обуви']. Add similar for flour: 'мука' → ['мукомольный завод', 'производство муки', 'мельница'].
  hint: app/src/lib/biznesinfo/keywords.ts: expand B2B_SYNONYMS or add commodity-specific synonym maps
  impact: Better recall for UV001 footwear manufacturers, UV002 flour mills
  risk: Minimal - synonym expansion is low-risk
  validate: UV001, UV002
- [R6] (guardrails, effort S) Add anti-noise filter for educational institutions
  action: In UV017-style queries (vegetables/food sourcing), add explicit filter to exclude companies with rubrics matching 'колледж', 'университет', 'институт', 'лицей', 'школа'. This is already in checks but not in retrieval logic.
  hint: app/src/app/api/ai/request/route.ts: in filterAndRankVendorCandidates, add education rubric exclusion when commodity tag is 'beet', 'vegetables', 'food'
  impact: Prevent educational institutions appearing as suppliers in food queries
  risk: None - educational institutions should never be food suppliers in this context
  validate: UV017

## minimax

- Summary: Analysis of UV001, UV003, UV002 reveals two critical failure patterns: (1) retrieval/recommendation engine generating nonsensical results (UV003 car dealer, fishing shop for cafe supplies) indicating broken relevance scoring or constraint propagation; (2) shortlist aggregation logic failing to honor explicit user constraints (UV001 received 1 instead of 3-5, UV002 received 2 instead of 3). Both failures occur in Turn 3 when system attempts to synthesize multi-turn context into actionable output. Priority fix: validate candidate filtering pipeline before aggregation to ensure candidates meet all stated constraints from prior turns.

### Priority Plan

- P0 — Fix candidate constraint propagation in multi-turn shortlist generation
  why: UV001 and UV003 both fail at Turn 3 synthesis despite valid Turn 1-2 candidates, indicating constraint loss during aggregation. UV001: user explicitly requested 3-5 in shortlist, got 1. UV003: user asked for cafe suppliers, got automotive/plumbing. This is a…
  impact: Eliminate generic fallback and placeholder shortlists; ensure Turn 3 output respects all prior constraints.
  validate: UV001, UV003
- P1 — Add relevance validation before candidate recommendation
  why: UV003 retrieved completely irrelevant companies (car dealer, fishing shop, plumbing) for a cafe supplies query. This indicates the retrieval/re-ranking pipeline lacks domain constraint enforcement. A simple keyword/domain filter would catch this before candid…
  impact: Reduce nonsensical recommendations; improve candidate relevance scoring accuracy.
  validate: UV003

### Recommendations

- [R1] (retrieval, effort M) Implement constraint pass-through validation before shortlist generation
  action: Before constructing the shortlist array in buildHardFormattedReply, verify that: (a) candidate count >= user-specified minimum; (b) each candidate passes ALL prior turn constraints (location, product type, export readiness, etc.); (c) if candidates fail validation, emit specific 'missing_constraint' flag instead of placeholder. Modify the aggregation layer to preserve constraints from turns 1-2 into Turn 3 shortlist…
  hint: Locate the shortlist construction logic in app/src/app/api/ai/request/route.ts, specifically around 'shortlist' or 'candidates' aggregation. Add a pre-validation step that checks each candidate against a constraints registry populated from…
  impact: Prevents '1 of 3-5' failures and enforces user constraints through final output
  risk: Low - defensive validation, reduces incorrect output
  validate: UV001
- [R2] (ranking, effort S) Add domain relevance filter for B2B candidate queries
  action: Implement a lightweight domain classifier that verifies candidate company categories match the query intent before ranking. For queries involving 'cafe', 'supplies', 'food', filter out candidates whose primary category is unrelated (e.g., automotive, fishing, plumbing unless explicitly requested). Can use existing catalog taxonomy for fast reject.
  hint: In the candidate retrieval pipeline, after initial fetch but before ranking, add domain_match = candidate.category_tags ∩ query_intent_tags non-empty check. Reject or downrank candidates with zero intersection.
  impact: Eliminates absurd recommendations like car dealers for cafe supplies
  risk: Low - adds filtering, cannot make things worse
  validate: UV003
- [R3] (prompt, effort S) Add explicit Turn 3 minimum count enforcement in system prompt
  action: Add to the Turn 3-4 system prompt: 'When user requests N candidates, you MUST output exactly N valid candidates with complete data. If insufficient valid candidates exist, explicitly state 'Found X of Y requested candidates' and ask for constraint relaxation. Never output placeholder data or truncated lists.'
  hint: Update app/src/app/api/ai/request/route.ts system prompt section for Turn 3-4 handling, specifically the shortlist construction instructions.
  impact: Creates a hard constraint in LLM behavior to honor count requirements
  risk: Low - prompt-only change
  validate: UV001, UV002
- [R4] (template, effort M) Generate context-aware templates using actual found candidates
  action: Turn 4 message templates should reference SPECIFIC companies found in Turns 1-3, not generic placeholders. Modify template generation to accept a 'found_companies' parameter and interpolate real company names, products, and verified attributes into Subject/Body templates.
  hint: In the message template generation function, pass the actual candidate list and extract company_name, product_focus, location for template interpolation. Avoid generic '[Название компании]' when real data exists.
  impact: Turn 4 templates become useful instead of generic
  risk: Low - improves template quality
  validate: UV001, UV003

