{
  "meta": {
    "scenarioMeta": {
      "version": "1.0",
      "generatedAt": "2026-02-08T18:05:00Z",
      "source": "manual-regression",
      "description": "Regression for topic switchback: keep correction context, but allow explicit new topic switch"
    },
    "options": {
      "baseUrl": "http://127.0.0.1:8131",
      "email": "qa.ai.runner@example.com",
      "preparePaid": true,
      "paidLimit": 1500,
      "maxScenarios": null,
      "onlyTags": [],
      "maxRateLimitRetries": 4,
      "maxStubRetries": 2,
      "minTurnDelayMs": 120,
      "stubOutageThreshold": 12,
      "targetPassCount": null,
      "targetPassRate": null
    }
  },
  "summary": {
    "runId": "run-2026-02-08T17-48-12-050Z-3628159-q0uoy",
    "startedAt": "2026-02-08T17:48:12.050Z",
    "endedAt": "2026-02-08T17:48:44.028Z",
    "durationMs": 31978,
    "baseUrl": "http://127.0.0.1:8131",
    "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.switchback-topic.json",
    "totalScenarios": 1,
    "passedScenarios": 1,
    "failedScenarios": 0,
    "passRate": 1,
    "totalChecks": 10,
    "passedChecks": 10,
    "failedChecks": 0,
    "checkPassRate": 1,
    "targetPassCount": 1,
    "targetPassRate": 0.8,
    "targetReached": true,
    "authUser": {
      "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
      "email": "qa.ai.runner@example.com",
      "name": "AI QA Runner",
      "role": "user",
      "plan": "paid"
    },
    "stoppedEarly": false,
    "stopReason": null
  },
  "runStop": null,
  "topFailurePatterns": [],
  "scenarios": [
    {
      "id": "TS001",
      "title": "Жалоба на нерелевант -> явный switch на новую тему -> возврат к исходной теме",
      "tags": [
        "regression",
        "topic_switch",
        "switchback",
        "cross_domain",
        "multi_turn"
      ],
      "personaGoal": "Проверить, что ассистент не залипает на старой теме и не срывается при коррекции",
      "totalTurns": 4,
      "completedTurns": 4,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где купить тонну молока в Бресте?",
          "requestBody": {
            "message": "Где купить тонну молока в Бресте?",
            "history": []
          },
          "latencyMs": 7125,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "723f067e-5531-4cba-afc8-3c20d305bd54",
          "isStub": false,
          "reply": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из каталога:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), то есть профиль молпереработки и поставок молочки.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, в составе есть предприятия по переработке молока — хороший вход для запроса объема **1 тонна** и перенаправления на нужный завод.\n\n⚠️ **Третьего сильного поставщика в текущем списке нет** (есть «Брестмаш», но это производитель оборудования, не продавец молока).\n\nКак действовать быстро:\n- Свяжитесь с обоими и запросите:  \n  **вид молока** (сырое/питьевое, жирность), **форма** (налив/пакет), **цена за кг/л**, **минимальная партия**, **доставка по Бресту**, **срок отгрузки**, **документы качества**.\n- Для 1 т лучше сразу отправлять **коммерческий запрос (RFQ)** с четкими параметрами.\n\nЕсли хотите, подготовлю вам готовый текст запроса (email + WhatsApp) с подстановками под ваш объем и требования.",
          "checks": [
            {
              "id": "TS001.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T1.C2",
              "type": "includes_any",
              "description": "Должен держать молочную тему и Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Указана компания которая продает запчасти в Минске опять!!!",
          "requestBody": {
            "message": "Указана компания которая продает запчасти в Минске опять!!!",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из каталога:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), то есть профиль молпереработки и поставок молочки.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, в составе есть предприятия по переработке молока — хороший вход для запроса объема **1 тонна** и перенаправления на нужный завод.\n\n⚠️ **Третьего сильного поставщика в текущем списке нет** (есть «Брестмаш», но это производитель оборудования, не продавец молока).\n\nКак действовать быстро:\n- Свяжитесь с обоими и запросите:  \n  **вид молока** (сырое/питьевое, жирность), **форма** (налив/пакет), **цена за кг/л**, **минимальная партия**, **доставка по Бресту**, **срок отгрузки**, **документы качества**.\n- Для 1 т лучше сразу отправлять **коммерческий запрос (RFQ)** с четкими параметрами.\n\nЕсли хотите, подготовлю вам готовый текст запроса (email + WhatsApp) с подстановками под ваш объем и требования."
              }
            ]
          },
          "latencyMs": 7705,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "da65854e-fd2f-4d71-8edc-8339b47cbc3f",
          "isStub": false,
          "reply": "Вы правы — это ошибка подбора. Для запроса **«тонна молока в Бресте»** компании по запчастям/агротехнике (особенно из Минска) не подходят.\n\nИсправляю shortlist только по релевантным в Бресте:\n\n   Релевантно: молочная отрасль, профильная продукция.\n\n   Релевантно: объединяет мясомолочные предприятия, подходит для запроса крупного объема 1 т.\n\nСильных 3+ кандидатов в текущем срезе нет — лучше добрать через рубрики:\n- **Молочная промышленность**\n- **Продукты питания → молоко и молочная продукция**\n- Фильтр: **Брест / Брестская область**\n\nЕсли хотите, сразу дам короткий чек-лист, как отсеять неподходящих поставщиков за 5 минут.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T2.C2",
              "type": "includes_any",
              "description": "Должен удержать коррекцию по исходной локации/контексту",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "локаци"
                ],
                "hits": [
                  "брест"
                ]
              }
            },
            {
              "id": "TS001.T2.C3",
              "type": "includes_any",
              "description": "Должен вернуть фокус на исходную товарную тему",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "релевант"
                ],
                "hits": [
                  "молок",
                  "релевант"
                ]
              }
            }
          ]
        },
        {
          "turn": 3,
          "user": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
          "requestBody": {
            "message": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из каталога:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), то есть профиль молпереработки и поставок молочки.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, в составе есть предприятия по переработке молока — хороший вход для запроса объема **1 тонна** и перенаправления на нужный завод.\n\n⚠️ **Третьего сильного поставщика в текущем списке нет** (есть «Брестмаш», но это производитель оборудования, не продавец молока).\n\nКак действовать быстро:\n- Свяжитесь с обоими и запросите:  \n  **вид молока** (сырое/питьевое, жирность), **форма** (налив/пакет), **цена за кг/л**, **минимальная партия**, **доставка по Бресту**, **срок отгрузки**, **документы качества**.\n- Для 1 т лучше сразу отправлять **коммерческий запрос (RFQ)** с четкими параметрами.\n\nЕсли хотите, подготовлю вам готовый текст запроса (email + WhatsApp) с подстановками под ваш объем и требования."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Вы правы — это ошибка подбора. Для запроса **«тонна молока в Бресте»** компании по запчастям/агротехнике (особенно из Минска) не подходят.\n\nИсправляю shortlist только по релевантным в Бресте:\n\n   Релевантно: молочная отрасль, профильная продукция.\n\n   Релевантно: объединяет мясомолочные предприятия, подходит для запроса крупного объема 1 т.\n\nСильных 3+ кандидатов в текущем срезе нет — лучше добрать через рубрики:\n- **Молочная промышленность**\n- **Продукты питания → молоко и молочная продукция**\n- Фильтр: **Брест / Брестская область**\n\nЕсли хотите, сразу дам короткий чек-лист, как отсеять неподходящих поставщиков за 5 минут.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              }
            ]
          },
          "latencyMs": 10009,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "e1baeabf-135e-42e5-b2e2-720f941d7830",
          "isStub": false,
          "reply": "Отлично, понял: **автозапчасти оптом в Минске**.\n\nСразу важно: в текущем списке кандидатов вижу только **1 карточку**, и она **нерелевантна** (ETHNIKA — мыло, не автозапчасти). Поэтому даю рабочий маршрут, как быстро собрать релевантных поставщиков в каталоге.\n\n1. Ищите в рубриках:\n   - **Автозапчасти и принадлежности**  \n     `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n   - **Автозапчасти и принадлежности для грузовой техники** (если нужны грузовые)  \n     `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n\n2. Ключевые запросы (по очереди):\n   - «автозапчасти оптом минск»\n   - «склад автозапчастей»\n   - «дистрибьютор автозапчастей»\n   - «запчасти для грузовой техники оптом»\n   - по брендам: «по вашему ТЗ дистрибьютор беларусь»\n\n3. Фильтры:\n   - Город: **Минск**\n   - Проверяйте в карточке: наличие **опта/дилерства**, юр. лица, телефона отдела продаж, email, сайта.\n\n4. Быстрый чек-лист отбора (чтобы не тратить время):\n   1) Есть явное упоминание «опт/дистрибьютор/склад».  \n   2) Есть прайс/каталог или интеграция (Excel/API/1С).  \n   3) Условия: MOQ, отсрочка, доставка по РБ, гарантия/возврат.  \n   4) Ассортимент под ваш сегмент (легковые/грузовые/СТО).\n\nЕсли хотите, в следующем сообщении сделаю вам **готовый шаблон запроса поставщику** (email + WhatsApp) под опт автозапчастей.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T3.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T3.C2",
              "type": "includes_any",
              "description": "Должен переключиться на новую тему (автозапчасти)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "автозапчаст",
                  "запчаст"
                ],
                "hits": [
                  "автозапчаст",
                  "запчаст"
                ]
              }
            },
            {
              "id": "TS001.T3.C3",
              "type": "includes_any",
              "description": "Должен учитывать новый город (Минск)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "минск",
                  "minsk"
                ],
                "hits": [
                  "минск",
                  "minsk"
                ]
              }
            }
          ]
        },
        {
          "turn": 4,
          "user": "Ок, возвращаемся к молоку в Бресте",
          "requestBody": {
            "message": "Ок, возвращаемся к молоку в Бресте",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "В Бресте по вашему запросу есть **2 явно релевантных варианта** из каталога:\n\n1. **Брестское мороженое ОАО** — `/company/brestmoroj`  \n   Почему подходит: в карточке указана **молочная продукция** (в т.ч. сметана, творог, сыры), то есть профиль молпереработки и поставок молочки.\n\n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — `/company/brestmmp`  \n   Почему подходит: это **крупное объединение мясомолочной промышленности**, в составе есть предприятия по переработке молока — хороший вход для запроса объема **1 тонна** и перенаправления на нужный завод.\n\n⚠️ **Третьего сильного поставщика в текущем списке нет** (есть «Брестмаш», но это производитель оборудования, не продавец молока).\n\nКак действовать быстро:\n- Свяжитесь с обоими и запросите:  \n  **вид молока** (сырое/питьевое, жирность), **форма** (налив/пакет), **цена за кг/л**, **минимальная партия**, **доставка по Бресту**, **срок отгрузки**, **документы качества**.\n- Для 1 т лучше сразу отправлять **коммерческий запрос (RFQ)** с четкими параметрами.\n\nЕсли хотите, подготовлю вам готовый текст запроса (email + WhatsApp) с подстановками под ваш объем и требования."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Вы правы — это ошибка подбора. Для запроса **«тонна молока в Бресте»** компании по запчастям/агротехнике (особенно из Минска) не подходят.\n\nИсправляю shortlist только по релевантным в Бресте:\n\n   Релевантно: молочная отрасль, профильная продукция.\n\n   Релевантно: объединяет мясомолочные предприятия, подходит для запроса крупного объема 1 т.\n\nСильных 3+ кандидатов в текущем срезе нет — лучше добрать через рубрики:\n- **Молочная промышленность**\n- **Продукты питания → молоко и молочная продукция**\n- Фильтр: **Брест / Брестская область**\n\nЕсли хотите, сразу дам короткий чек-лист, как отсеять неподходящих поставщиков за 5 минут.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              },
              {
                "role": "user",
                "content": "Ладно, теперь реально нужны автозапчасти в Минске оптом"
              },
              {
                "role": "assistant",
                "content": "Отлично, понял: **автозапчасти оптом в Минске**.\n\nСразу важно: в текущем списке кандидатов вижу только **1 карточку**, и она **нерелевантна** (ETHNIKA — мыло, не автозапчасти). Поэтому даю рабочий маршрут, как быстро собрать релевантных поставщиков в каталоге.\n\n1. Ищите в рубриках:\n   - **Автозапчасти и принадлежности**  \n     `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n   - **Автозапчасти и принадлежности для грузовой техники** (если нужны грузовые)  \n     `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n\n2. Ключевые запросы (по очереди):\n   - «автозапчасти оптом минск»\n   - «склад автозапчастей»\n   - «дистрибьютор автозапчастей»\n   - «запчасти для грузовой техники оптом»\n   - по брендам: «по вашему ТЗ дистрибьютор беларусь»\n\n3. Фильтры:\n   - Город: **Минск**\n   - Проверяйте в карточке: наличие **опта/дилерства**, юр. лица, телефона отдела продаж, email, сайта.\n\n4. Быстрый чек-лист отбора (чтобы не тратить время):\n   1) Есть явное упоминание «опт/дистрибьютор/склад».  \n   2) Есть прайс/каталог или интеграция (Excel/API/1С).  \n   3) Условия: MOQ, отсрочка, доставка по РБ, гарантия/возврат.  \n   4) Ассортимент под ваш сегмент (легковые/грузовые/СТО).\n\nЕсли хотите, в следующем сообщении сделаю вам **готовый шаблон запроса поставщику** (email + WhatsApp) под опт автозапчастей.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)"
              }
            ]
          },
          "latencyMs": 6848,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "586a0cbd-82ef-4e60-88ab-0bc089598a93",
          "isStub": false,
          "reply": "Принято, возвращаемся к **молоку в Бресте (объём 1 тонна)**.\n\nВот практичный план:\n\n1. Кому писать в первую очередь (из доступных релевантных):\n   - **Брестское мороженое ОАО** (`/company/brestmoroj`)\n   - **УК холдинга «Концерн Брестмясомолпром»** (`/company/brestmmp`) — как точка входа на профильные молзаводы.\n\n2. Что сразу уточнить, чтобы получить предметное КП:\n   1) Тип: **сырое** или **питьевое пастеризованное**.  \n   2) Жирность: например **2.5% / 3.2% / иная**.  \n   3) Формат: **налив** или **упаковка** (1 л / 0.9 л и т.д.).  \n   4) Условие: **самовывоз Брест** или **доставка**.  \n   5) Срок: дата, когда нужна партия 1 т.  \n   6) Документы: декларация/ветдокументы/удостоверение качества.\n\n3. Где добрать ещё поставщиков в каталоге:\n   - Рубрики: **Молочная промышленность**, **Молоко и молочная продукция**  \n   - Фильтр: **Брест / Брестская область**\n   - Ключи: «молокозавод», «молочная продукция оптом», «поставка молока».\n\nЕсли хотите, подготовлю готовый текст запроса поставщику (email + WhatsApp) под ваш объём 1 т.",
          "checks": [
            {
              "id": "TS001.T4.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T4.C2",
              "type": "includes_any",
              "description": "Должен вернуться к исходной теме (молоко в Бресте)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        }
      ],
      "durationMs": 31689
    }
  ]
}
