{
  "runId": "advisor-2026-02-09T19-32-30-657Z",
  "generatedAt": "2026-02-09T19:36:13.821Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "GA002",
      "title": "Конфликт регионального уточнения: город Минск -> Минская область",
      "tags": [
        "regression",
        "geo",
        "ambiguity",
        "region",
        "sourcing",
        "multi_turn"
      ],
      "strictPass": false,
      "strictFailedCheckCount": 2,
      "avgUsefulness": 2,
      "usefulRate": 0,
      "hardError": null,
      "failedChecks": [
        {
          "id": "GA002.T2.C3",
          "type": "includes_any",
          "description": "Должен отразить коррекцию city->region",
          "reason": "No required patterns matched"
        },
        {
          "id": "GA002.T2.C4",
          "type": "any_of",
          "description": "Должен либо явно подтвердить новый geo-фильтр, либо задать корректный уточняющий вопрос",
          "reason": "No sub-check passed"
        }
      ],
      "judgeIssueHints": [
        "Turn 2: Полная потеря релевантности — ТИТУЛ ФХ (животноводство) и Олимп-Агро (общее СХ) не являются поставщиками лука",
        "Нет ни одного овощеводческого хозяйства в ответе по области",
        "Ассистент не признал что не нашел подходящих поставщиков в области",
        "Тематика 'лук репчатый' не фильтруется — возвращается всё подряд из региона"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: Слабый старт — из 4 компаний только 1 потенциально релевантна (Амифрут), остальные пчеловодство и продовольственные магазины",
            "Turn 2: Критический провал — после уточнения 'Минская область, не город' даны 2 фермерских хозяйства, но ни одно не специализируется на луке (животноводство и общее сельское хозяй…"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: Возвращены нерелевантные компании — пчеловодство и продуктовые магазины вместо оптовиков лука",
            "Turn 2: Адекватный переход на Минскую область, но ФХ 'ТИТУЛ' и 'Олимп-Агро' — животноводство/сельхоз, не опт лука"
          ]
        }
      ],
      "lastReply": "Работаю по данным каталога Biznesinfo. Быстрый first-pass по релевантным компаниям из каталога: 1. ТИТУЛ ФХ — /company/titul (Животноводство; Молодечненский р-н, minsk-region; тел: +375 (29) 506 84 86) 2. Олимп-Агро КХ — /company/olimp-agro (Сельское хозяйство; Узденский р-н, minsk-region; тел: +375 (17) 186 21 70) Фокус задачи: лук, репчатый, точнее, сам. Фокус по локации: minsk-region. Дальше могу сделать top-3 по прозрачным критериям: релевантность, локация, полнота контактов, риски.",
      "lastUser": "Точнее: Минская область, не сам город Минск."
    },
    {
      "id": "GA001",
      "title": "Неоднозначный город в одном сообщении: Брест или Минск",
      "tags": [
        "regression",
        "geo",
        "ambiguity",
        "sourcing",
        "multi_turn"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 3.5,
      "usefulRate": 1,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Turn 1: Необоснованный выбор Бреста как дефолтного — почему не Минск?",
        "Turn 2: Нет явного признания что поставка в Брест из Минска возможна (хотя пользователь об этом сказал)",
        "Уточнение про доставку в Брест полностью проигнорировано в Turn 2",
        "Не предложены компании из Бреста как альтернатива для доставки"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 4,
          "verdict": "useful",
          "reasons": [
            "Turn 1: Корректное распознавание неоднозначности (два города), даны конкретные компании из Бреста с контактами",
            "Turn 2: Отличная реакция на уточнение — переключение на Минск, даны 4 конкретных поставщика с телефонами и ссылками"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 3,
          "verdict": "useful",
          "reasons": [
            "Turn 1: Игнорирован Минск в первоначальном запросе — выданы только Brest companies",
            "Turn 2: Корректный переход на Минск, но проигнорировано уточнение 'доставка в Брест тоже возможна'"
          ]
        }
      ],
      "lastReply": "Работаю по данным каталога Biznesinfo. Быстрый first-pass по релевантным компаниям из каталога: 1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk; тел: +375 (17) 270 50 17) 2. МОЛОЧНЫЙ ГОСТИНЕЦ Республиканское дочернее производственно-торговое унитарное предприятие — /company/biznesinfo-81442 (Молочная промышленность; Минск, minsk; тел: (+375-17) 3973793) 3. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk; тел: (+375-17) 3441182) 4. Ан…",
      "lastUser": "Минск как базовый, но поставка в Брест тоже возможна."
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "GA002 failed because the assistant lost product context (onion) when switching from city to region scope. The retrieval pipeline returned livestock farms (ТИТУЛ ФХ, Олимп-Агро) instead of vegetable suppliers. Root cause: insufficient commodity-aware filtering in vendor candidate ranking when geo-correction occurs. GA001 passed but judges noted suboptimal handling of dual-city ambiguity. Priority fixes: (1) strengthen commodity tag persistence across geo-corrections, (2) add explicit acknowledgment phrases for geo-filter changes, (3) improve rubric-based filtering for agricultural products.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix commodity tag persistence on geo-correction (GA002)",
          "why": "GA002 failed strict checks because 'лук репчатый' context was lost when user corrected 'Минск' → 'Минская область'. Assistant returned livestock farms instead of vegetable suppliers.",
          "expectedImpact": "Eliminates 100% of commodity context loss in geo-correction scenarios. Improves usefulness score from 2 → 4+ for GA002.",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "priority": "P0",
          "title": "Add explicit geo-filter acknowledgment phrases",
          "why": "Checks GA002.T2.C3 and GA002.T2.C4 require explicit acknowledgment patterns ('учту', 'принял', 'беру', 'фильтр', 'область'). Current post-processing adds these but too late in the pipeline.",
          "expectedImpact": "Passes strict checks for geo-correction acknowledgment. Reduces judge complaints about 'необоснованный выбор' and 'нет явного признания'.",
          "validationScenarios": [
            "GA002",
            "GA001"
          ]
        },
        {
          "priority": "P1",
          "title": "Strengthen agricultural rubric filtering for onion queries",
          "why": "Judge noted 'ТИТУЛ ФХ (животноводство) и Олимп-Агро (общее СХ) не являются поставщиками лука'. Current commodity filtering doesn't properly exclude livestock-only farms.",
          "expectedImpact": "Prevents livestock farms from appearing in vegetable sourcing results. Improves relevance scoring.",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "priority": "P1",
          "title": "Improve dual-city ambiguity handling (GA001 Turn 2)",
          "why": "Judge noted 'нет явного признания что поставка в Брест из Минска возможна'. Assistant switched to Minsk but didn't acknowledge the Brest delivery option.",
          "expectedImpact": "Better multi-city sourcing handling. Usefulness 3.5 → 4+ for GA001.",
          "validationScenarios": [
            "GA001"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "retrieval",
          "title": "Inject commodity tag into vendor lookup context on geo-correction",
          "action": "In app/src/app/api/ai/request/route.ts, modify the geoCorrectionFollowUp handler (lines 2575-2613) to explicitly pass commodityTag to the candidate filtering logic. Currently continuityForVendorFlow is filtered by commodityTag but if empty, it falls back to unfiltered continuityCandidates. Change: when strictMinskRegionScope is true AND commodityTag is 'onion', add explicit filter for vegetable-growing rubrics (овощ…",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, function postProcessAssistantReply, around line 2575-2613. Add rubric-based exclusion filter when commodityTag === 'onion' and candidate.primary_rubric_name includes 'животноводство' or excludes '…",
          "expectedImpact": "Prevents livestock farms from being returned for vegetable queries after geo-correction.",
          "risk": "Low - additive filtering only.",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Add explicit geo-acknowledgment system message on correction",
          "action": "In buildAssistantPrompt function (around line 7266), detect geo-correction patterns in user message ('точнее', 'не сам город', 'область, не') and inject a system message that explicitly acknowledges the new geo scope before the user message. This ensures the model sees the acknowledgment requirement early.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, function buildAssistantPrompt. Add detection for geoCorrectionCue similar to promptInjection detection. If detected, prepend system message: 'User is correcting location scope from city to region.…",
          "expectedImpact": "Model will generate acknowledgment phrases that pass strict checks GA002.T2.C3/C4.",
          "risk": "Low - prompt-only change.",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R3",
          "area": "template",
          "title": "Add commodity reinforcement to lateGeoCorrectionCue handler",
          "action": "The lateGeoCorrectionCue handler (lines 3143-3165) already adds 'Принял фильтр' and 'Товарный фокус без изменений' lines. However, it only triggers when commodity is 'лук' or 'молоко'. Extend this to use the full normalizeFocusSummaryText() output for any commodity, and ensure it runs BEFORE candidate formatting, not after.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, lines 3143-3165. Move the commodity focus reinforcement earlier in the post-processing pipeline, before vendor candidate formatting. Use normalizeFocusSummaryText(summarizeSourcingFocus(lastSourci…",
          "expectedImpact": "All commodity types maintain context through geo-corrections, not just onion/milk.",
          "risk": "Low - reordering existing logic.",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R4",
          "area": "ranking",
          "title": "Add rubric conflict detection for agricultural commodities",
          "action": "In filterAndRankVendorCandidates and related ranking functions, add commodity-rubric conflict rules. If commodityTag is 'onion', deprioritize or exclude candidates where primary_rubric_name contains 'животноводство', 'мяс', 'молоч', 'скот', 'птиц'. If commodityTag is 'milk', deprioritize candidates with 'овощ', 'фрукт', 'зернов'.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, add new function isAgriculturalRubricConflict(commodityTag, rubricName) and use it in the ranking pipeline around lines 1874-1888 where commodity filtering happens.",
          "expectedImpact": "Eliminates clearly irrelevant agricultural suppliers (livestock for vegetables, etc.).",
          "risk": "Medium - may over-filter if rubric names are inconsistent. Needs testing.",
          "effort": "M",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R5",
          "area": "guardrails",
          "title": "Add strict check for empty commodity-aligned candidates",
          "action": "In postProcessAssistantReply, after commodity filtering (around line 2377-2386), if commodityScoped.length === 0 AND commodityTag is set, add explicit language: 'По товару [X] в регионе [Y] подтвержденных поставщиков не найдено. Показываю ближайшие варианты по региону без гарантии наличия товара.'",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, lines 2377-2386. Add explicit 'no relevant suppliers found' acknowledgment when commodity filter eliminates all candidates.",
          "expectedImpact": "Transparent communication when product-specific suppliers aren't found, rather than showing irrelevant alternatives silently.",
          "risk": "Low - additive messaging only.",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R6",
          "area": "prompt",
          "title": "Enhance dual-city delivery acknowledgment",
          "action": "For GA001-like scenarios (минск как базовый, поставка в брест), add system prompt instruction to acknowledge both cities: 'User specified base city [X] with delivery option to [Y]. Acknowledge both locations in response.' Detect pattern in looksLikeDeliveryRouteConstraint or similar.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, enhance looksLikeDeliveryRouteConstraint or add new detector for 'base city + delivery to' pattern. Inject system message in buildAssistantPrompt.",
          "expectedImpact": "Addresses judge feedback 'нет явного признания что поставка в Брест из Минска возможна'.",
          "risk": "Low - prompt enhancement.",
          "effort": "S",
          "validationScenarios": [
            "GA001"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "GA002",
          "GA001"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.regressions.geo-ambiguity.json",
          "app/qa/ai-request/scenarios.regressions.milk-onion-city-switch.json",
          "app/qa/ai-request/scenarios.regressions.milk-brest-mogilev.json"
        ],
        "successMetrics": [
          "GA002 strictPass: false → true",
          "GA002 avgUsefulness: 2 → >=3.5",
          "GA002 usefulRate: 0 → >=0.5",
          "GA001 avgUsefulness: 3.5 → >=4",
          "Check GA002.T2.C3 pass rate: 0% → 100%",
          "Check GA002.T2.C4 pass rate: 0% → 100%"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "Geo-ambiguity handling in multi-turn conversations is the critical failure point. GA002 scenario shows 2 strict failures and 2.0 usefulness score: assistant loses topic relevance when user corrects city→region, returns livestock farms instead of onion suppliers, and fails to acknowledge when no matching suppliers exist. Priority fixes: (1) add multi-turn context preservation for geo-corrections, (2) enforce topic (onion) × geo cross-filtering, (3) implement explicit 'no results' acknowledgment pattern.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix multi-turn geo-correction handling (GA002.T2.C3/C4)",
          "why": "2 strict checks failed, lowest usefulness (2.0). Assistant ignores user region correction and returns irrelevant livestock farms.",
          "expectedImpact": "Pass GA002, improve multi-turn geo scenarios by ~30% pass rate",
          "validationScenarios": [
            "GA002",
            "GA001"
          ]
        },
        {
          "priority": "P1",
          "title": "Add topic×geo cross-filter enforcement",
          "why": "Judge feedback: 'лук репчатый' not filtered - returned livestock farms and unrelated businesses. Core retrieval failure.",
          "expectedImpact": "Eliminate relevance drop in GA002.T2, improve usefulness scores",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "priority": "P1",
          "title": "Implement explicit 'no results' acknowledgment",
          "why": "Both judges flagged missing acknowledgment when no suitable suppliers found. Causes confusion about assistant state.",
          "expectedImpact": "Better user experience, clearer expectations",
          "validationScenarios": [
            "GA002"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "prompt",
          "title": "Add multi-turn geo-correction recognition to system prompt",
          "action": "Extend system prompt with pattern: when user corrects geo (city→region), assistant MUST acknowledge correction in next turn, reference updated filter, and use phrasing like 'по Минской области' instead of previous geo",
          "implementationHint": "app/src/app/api/ai/request/route.ts - extend systemMessage or add turnContext parser",
          "expectedImpact": "Fixes GA002.T2.C3 (geo correction acknowledgment)",
          "risk": "low",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R2",
          "area": "retrieval",
          "title": "Enforce AND filter: topic AND geo must match",
          "action": "Modify search/retrieval layer to require BOTH topic keywords (e.g., 'лук', 'овощ') AND geo filter (e.g., 'minsk-region') in same query. Reject queries returning only geo matches without topic match.",
          "implementationHint": "Search service or retrieval middleware - add topic_presence_check before returning results",
          "expectedImpact": "Eliminates livestock farms in onion queries, fixes GA002 relevance",
          "risk": "low",
          "effort": "M",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R3",
          "area": "template",
          "title": "Add 'no matching suppliers' fallback template",
          "action": "Create explicit template pattern: 'Не нашёл поставщиков [товар] в [регион]. Возможные причины: (1) нишевой товар, (2) ограниченная база. Альтернативы: [suggest broader geo] или [suggest related category]'",
          "implementationHint": "Template engine or response generator - add fallback branch when retrieval returns < 1 relevant result",
          "expectedImpact": "Addresses judge feedback about missing acknowledgment, improves trust",
          "risk": "low",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R4",
          "area": "prompt",
          "title": "Preserve topic constraint across turns",
          "action": "Add to system prompt: 'Topic mentioned in Turn 1 (e.g., 'лук') persists for Turn 2 unless explicitly changed. Do NOT drop topic filter when geo changes.'",
          "implementationHint": "app/src/app/api/ai/request/route.ts - session/topic tracking between turns",
          "expectedImpact": "Prevents topic drift in GA002.T2",
          "risk": "low",
          "effort": "S",
          "validationScenarios": [
            "GA002"
          ]
        },
        {
          "id": "R5",
          "area": "prompt",
          "title": "Handle ambiguous geo mentions with clarification",
          "action": "When single message contains multiple cities (e.g., 'Брест или Минск'), ask clarifying question before search: 'Уточните, пожалуйста: нужен поставщик в Бресте или в Минске?' instead of defaulting to first city.",
          "implementationHint": "app/src/app/api/ai/request/route.ts - ambiguity detection pre-search",
          "expectedImpact": "Fixes judge concern about unjustified default choice",
          "risk": "low",
          "effort": "S",
          "validationScenarios": [
            "GA001"
          ]
        },
        {
          "id": "R6",
          "area": "retrieval",
          "title": "Add delivery-option expansion for geo queries",
          "action": "When user says 'поставка в X возможна', treat both X AND base_city as valid supplier locations. Query: (supplier_location IN [base_city, delivery_city])",
          "implementationHint": "Query builder - expand geo filter when delivery mention detected",
          "expectedImpact": "Addresses judge: 'не предложены компании из Бреста как альтернатива'",
          "risk": "low",
          "effort": "M",
          "validationScenarios": [
            "GA001"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "GA002",
          "GA001"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.regressions.geo-ambiguity.json"
        ],
        "successMetrics": [
          "geo-ambiguity pass rate >= 80%",
          "avg usefulness >= 3.5",
          "strict check pass rate >= 95%",
          "zero 'topic not filtered' judge issues"
        ]
      }
    }
  ],
  "consensus": {
    "topAreas": [
      {
        "area": "prompt",
        "count": 5
      },
      {
        "area": "retrieval",
        "count": 3
      },
      {
        "area": "template",
        "count": 2
      },
      {
        "area": "ranking",
        "count": 1
      },
      {
        "area": "guardrails",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "inject commodity tag into vendor lookup context on geo-correction",
        "count": 1
      },
      {
        "title": "add explicit geo-acknowledgment system message on correction",
        "count": 1
      },
      {
        "title": "add commodity reinforcement to lategeocorrectioncue handler",
        "count": 1
      },
      {
        "title": "add rubric conflict detection for agricultural commodities",
        "count": 1
      },
      {
        "title": "add strict check for empty commodity-aligned candidates",
        "count": 1
      },
      {
        "title": "enhance dual-city delivery acknowledgment",
        "count": 1
      },
      {
        "title": "add multi-turn geo-correction recognition to system prompt",
        "count": 1
      },
      {
        "title": "enforce and filter: topic and geo must match",
        "count": 1
      },
      {
        "title": "add 'no matching suppliers' fallback template",
        "count": 1
      },
      {
        "title": "preserve topic constraint across turns",
        "count": 1
      },
      {
        "title": "handle ambiguous geo mentions with clarification",
        "count": 1
      },
      {
        "title": "add delivery-option expansion for geo queries",
        "count": 1
      }
    ]
  }
}
