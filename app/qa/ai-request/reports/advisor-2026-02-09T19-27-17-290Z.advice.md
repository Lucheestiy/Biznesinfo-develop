# Advisor Report — advisor-2026-02-09T19-27-17-290Z

- Generated: 2026-02-09T19:31:21.189Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 5
- Advisors: kimi, minimax

## Focus Scenarios

- MX002 (fail, usefulness 1/5): Лук: Минск -> Минская область -> поставка в Брест -> shortlist + чеклист звонка
- MX001 (fail, usefulness 1.5/5): Молоко: Брест/Минск -> Минская область -> shortlist -> RFQ
- MX004 (fail, usefulness 2/5): Кабель ВВГнг: Гомель -> район -> shortlist с валидными ссылками -> 48 часов -> RFQ
- MX005 (fail, usefulness 3/5): Пользователь жалуется на слабый ответ: требование конкретики по Минску
- MX003 (pass, usefulness 2.5/5): Switchback: молоко -> автозапчасти -> обратно к молоку

## Consensus

- Top areas:
  - prompt: 7
  - retrieval: 3
  - template: 2
  - guardrails: 2
- Recurring recommendations:
  - add explicit product context anchoring in system prompt (1)
  - add vendor lookup failure handling instruction (1)
  - fix template block extraction and placeholder filling (1)
  - broaden geo lookup when strict filter returns empty (1)
  - add post-processing validation for product context retention (1)
  - strengthen checklist mode instructions (1)
  - add topic persistence clause in system prompt (1)
  - enforce geo constraint as supplemental, not dominant (1)
  - implement rfq variable extraction and validation (1)
  - add 48-hour temporal filter to search pipeline (1)
  - block generic fallback on checklist requests (1)
  - add switchback topic recovery pattern (1)

## kimi

- Summary: Critical failure pattern identified: assistant loses product context (молоко/лук) during geo-refinement turns, causing generic rubric fallbacks ('Недвижимость', 'Химия'). Root cause is insufficient context anchoring in system prompt when vendor lookup returns empty results for narrow geo filters. Template generation also fails with placeholder leakage ('уточняется').

### Priority Plan

- P0 — Fix context loss during geo-refinement
  why: MX001 and MX002 both fail when user refines location (Минская область instead of Минск). Assistant drops product context and returns generic rubrics. This is the highest-impact failure affecting 40% of multi-turn scenarios.
  impact: Reduces generic fallback rate from 60% to <10% for geo-refinement turns. Improves avg usefulness from 1.5 to 3+.
  validate: MX001, MX002
- P0 — Fix template placeholder leakage
  why: RFQ templates contain raw placeholders like 'уточняется' instead of inferred values from dialog context. Template blocks (Subject/Body/WhatsApp) are malformed or missing.
  impact: Template compliance rate increases from 20% to >80%. Eliminates 'уточняется' leakage.
  validate: MX001, MX004, MX005
- P1 — Strengthen continuity for logistics constraints
  why: When user adds delivery constraints (поставка в Брест), assistant fails to adapt existing shortlist and falls back to generic response.
  impact: Maintains context continuity through 90%+ of constraint refinements.
  validate: MX002, MX003

### Recommendations

- [R1] (prompt, effort S) Add explicit product context anchoring in system prompt
  action: Modify buildAssistantSystemPrompt() to include: 'When geo-filter returns no results, NEVER drop the product context. Always preserve the original product/service from the conversation and suggest adjacent regions or broader filters while maintaining the product focus.'
  hint: app/src/app/api/ai/request/route.ts lines 7212-7250. Add rule after line 7247.
  impact: Prevents 'Недвижимость/Химия' fallbacks when geo-filter narrows too much.
  risk: Low - additive rule, no breaking changes.
  validate: MX001, MX002
- [R2] (prompt, effort S) Add vendor lookup failure handling instruction
  action: In buildAssistantPrompt() around line 7302, change the 'no confirmed vendor candidates' message to: 'If vendor lookup returns empty for the current geo filter, DO NOT switch to generic rubrics. Instead: 1) Acknowledge the filter, 2) Preserve the product context, 3) Suggest either broadening the geo or checking adjacent regions, 4) If history contains relevant vendors, reference them with a note about geo mismatch.'
  hint: app/src/app/api/ai/request/route.ts line 7302-7306
  impact: Eliminates generic rubric fallback on empty geo-filtered lookups.
  risk: Low - improves fallback behavior only.
  validate: MX001, MX002
- [R3] (template, effort M) Fix template block extraction and placeholder filling
  action: The ensureTemplateBlocks() function (line 679) fails to properly format templates. Fix: 1) Ensure Subject/Body/WhatsApp headers are always on separate lines, 2) Apply applyTemplateFillHints() BEFORE sanitizeUnfilledPlaceholdersInNonTemplateReply(), 3) Add validation that template contains no 'уточняется' or {placeholder} patterns before returning.
  hint: app/src/app/api/ai/request/route.ts lines 679-714 and 826-847. Reorder calls in postProcessAssistantReply around line 1808-1813.
  impact: Template blocks properly formatted, placeholders filled from context, no 'уточняется' leakage.
  risk: Medium - touches core template pipeline.
  validate: MX001, MX004, MX005
- [R4] (retrieval, effort S) Broaden geo lookup when strict filter returns empty
  action: In the vendor lookup logic, when a strict geo filter (e.g., Минская область без города) returns empty, automatically retry with broader geo (Минск + Минская область) and annotate results with 'ближайший резерв'. Currently this fallback exists but doesn't trigger properly.
  hint: app/src/app/api/ai/request/route.ts around line 2575-2613 (geoCorrectionFollowUp handler). Ensure fallback pool is populated even when initial strict filter fails.
  impact: Provides relevant candidates instead of empty results for strict geo filters.
  risk: Low - improves fallback only.
  validate: MX001, MX002
- [R5] (guardrails, effort M) Add post-processing validation for product context retention
  action: Add a final validation step in postProcessAssistantReply that checks: if the original query had strong product signals (молоко, лук, кабель) and the response contains generic rubrics (Недвижимость, Химия, Строительство) without the product, trigger a rewrite using buildForcedShortlistAppendix with history candidates.
  hint: app/src/app/api/ai/request/route.ts near line 3818, add validation before return.
  impact: Catches and fixes context loss before response is sent.
  risk: Low - safety net only.
  validate: MX001, MX002, MX003
- [R6] (prompt, effort S) Strengthen checklist mode instructions
  action: Current checklist prompt (line 7323-7327) is too weak. Change to: 'Response mode: checklist/questions. Provide EXACTLY the requested number of numbered items. Each item must be actionable and specific to the context. Never respond with generic filler like Работаю по данным каталога.'
  hint: app/src/app/api/ai/request/route.ts lines 7323-7327
  impact: Fixes MX002.T5 where assistant returned stub instead of 6-point checklist.
  risk: Low - improves specific mode.
  validate: MX002

## minimax

- Summary: Critical multi-turn continuity failures detected: geo refinements trigger complete context loss and generic fallbacks (real estate/chemistry rubrics). RFQ templates contain unfilled placeholders. P0 fix: enforce topic persistence in prompt. P1 fix: validate template variables before output. P2 fix: add geo constraint state machine.

### Priority Plan

- P0 — Fix geo refinement → generic fallback collapse
  why: 100% of geo-refinement scenarios (MX001, MX002) fail with complete topic substitution. Assistant outputs 'недвижимость/химия' instead of milk/onions when user adds 'Минская область' clarification.
  impact: Recover 40-60% pass rate on geo scenarios. Eliminate generic rubric fallbacks on refined queries.
  validate: MX001.T2, MX002.T2, MX004.T2
- P0 — Eliminate RFQ template placeholders
  why: All RFQ outputs contain 'уточняется' placeholders instead of extracted dialogue values. Violates 'template_blocks' check in MX001, MX004, MX005.
  impact: 100% template validation pass rate. RFQ contains actual extracted quantities, locations, dates from conversation.
  validate: MX001.T5, MX004.T5, MX005.T4
- P1 — Enforce 48-hour temporal filter application
  why: MX004.T4 fails - '48 часов' requirement completely ignored. No filtering comment or acknowledgement.
  impact: Pass 'includes_any' check for time constraints. Either filter results or explain why not applicable.
  validate: MX004.T4
- P1 — Fix checklist generation on refusal fallback
  why: MX002.T5: assistant outputs 'Работаю по данным каталога' instead of checklist. Complete refusal to generate requested output.
  impact: Checklist generation succeeds after any user request. No silent fallbacks to generic messages.
  validate: MX002.T5
- P2 — Implement switchback recovery pattern
  why: MX003.T2: auto parts request outputs generic A/B/C priorities instead of parts search. Return-to-original-topic pattern fails.
  impact: Topic switch requests generate appropriate new-topic responses, not generic templates.
  validate: MX003.T2, MX003.T3

### Recommendations

- [R1] (prompt, effort S) Add topic persistence clause in system prompt
  action: Modify system prompt: ADD 'TOPIC LOCK RULE: Once product category is established (e.g., 'молоко', 'лук', 'кабель'), ALL subsequent turns MUST search within that category. Geo refinements (regions, districts, delivery locations) are SUPPLEMENTS, not replacements. Never output generic rubrics when a specific product was already named.'
  hint: app/src/app/api/ai/request/route.ts - systemPrompt constant or dynamicPromptBuilder function. Line ~45-80 contains prompt assembly logic.
  impact: Prevents 'недвижимость/химия' fallback in MX001.T2, MX002.T3. Forces category-constrained search.
  risk: Low - prompt-only change, no code logic modification
  validate: MX001.T2, MX002.T3
- [R2] (prompt, effort S) Enforce geo constraint as supplemental, not dominant
  action: ADD to retrieval prompt: 'GEO_MODE=SUPPLEMENT. If user provides delivery destination DIFFERENT from supplier location, BOTH constraints apply: find suppliers in SOURCE region who DELIVER to DESTINATION. Never drop product search when adding delivery constraint.'
  hint: app/src/lib/ai/prompts.ts or similar - retrievalPromptBuilder. Look for geoConstraint handling in query construction.
  impact: MX002.T3: Brest delivery constraint supplements Minsk region suppliers, doesn't replace onion search.
  risk: Low
  validate: MX002.T3, MX001.T3
- [R3] (template, effort M) Implement RFQ variable extraction and validation
  action: ADD pre-output validation: Before rendering RFQ template, extract values from conversationContext. If 'quantity', 'location', 'delivery', 'product' are empty/null, FAIL with explicit 'MISSING_DATA' error instead of outputting placeholder. Example: if user said '1000 литров' and 'Минск', template must contain these exact values, not 'уточняется'.
  hint: app/src/app/api/ai/request/route.ts - rfqTemplateRenderer or outputGenerator. Add validation step before template render. Check conversationHistory for extracted entities.
  impact: Eliminates 'уточняется' placeholders in MX001.T5, MX004.T5, MX005.T4. Template blocks contain actual dialogue data.
  risk: Medium - adds validation logic that could block some responses
  validate: MX001.T5, MX004.T5, MX005.T4
- [R4] (retrieval, effort M) Add 48-hour temporal filter to search pipeline
  action: ADD to search query builder: When user specifies time constraint (N hours/days), apply temporal filter to company results. If filter unavailable in current index, ADD to response: '[TIME_FILTER: 48ч not applied - companies shown may have older availability]'. Never silently ignore.
  hint: app/src/lib/ai/search.ts or meilisearch integration. Look for filterBuilder function. Add temporal filter branch.
  impact: MX004.T4 passes 'includes_any' check. Either filtered results or explicit acknowledgment of unavailability.
  risk: Low
  validate: MX004.T4
- [R5] (guardrails, effort S) Block generic fallback on checklist requests
  action: ADD refusal detector: If user requests 'чеклист', 'checklist', 'список вопросов', assistant MUST output structured list. Remove 'Работаю по данным каталога' escape path. If data insufficient, output partial checklist with available fields rather than generic refusal.
  hint: app/src/app/api/ai/request/route.ts - responseGenerator. Detect checklist intent in userMessage. Route to checklistBuilder instead of genericTemplate.
  impact: MX002.T5 generates checklist instead of refusal message. Checklist contains 5+ items as required.
  risk: Low - improves response quality
  validate: MX002.T5
- [R6] (prompt, effort S) Add switchback topic recovery pattern
  action: ADD to system prompt: 'TOPIC SWITCH HANDLING: When user changes topic (e.g., молоко → автозапчасти), search NEW topic. When returning to previous topic (автозапчасти → молоко), treat as RESET with accumulated context. Do not output generic priorities (A/B/C) - always search specific category.'
  hint: app/src/app/api/ai/request/route.ts - conversationContextBuilder. Track topic changes. Reset search but preserve geo/supplier context from earlier turns.
  impact: MX003.T2 generates actual auto parts suppliers, not generic rubric. Return-to-milk produces specific companies.
  risk: Low
  validate: MX003.T2, MX003.T3
- [R7] (retrieval, effort M) Validate link integrity in shortlist output
  action: ADD post-retrieval validation: Before outputting company links, verify URLs are accessible (HTTP 200). If invalid, either replace with alternative or add '[LINK_MAY_BE_INVALID]' annotation. Track broken link rate.
  hint: app/src/lib/ai/shortlistBuilder.ts or outputGenerator. Add linkValidator function before render. Use fetch with timeout.
  impact: Reduces link integrity failures. Users see valid company profile links.
  risk: Low - validation only
  validate: MX001.T1, MX004.T1
- [R8] (prompt, effort S) Prioritize companies in shortlist with ranking rationale
  action: MODIFY shortlist output: Each company entry MUST include ranking rationale (why this company is recommended). Example: 'Приоритет 1: Компания X - единственный поставщик в Советском районе (близость к указанной локации)'. Output generic list without rationale = FAIL.
  hint: app/src/app/api/ai/request/route.ts - shortlistRenderer. Add rankingRationale field to company data structure.
  impact: MX004.T3 provides actual ranking, not repeated list. User understands selection logic.
  risk: Low
  validate: MX004.T3

