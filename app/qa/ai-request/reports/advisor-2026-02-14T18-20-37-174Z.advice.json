{
  "runId": "advisor-2026-02-14T18-20-37-174Z",
  "generatedAt": "2026-02-14T18:22:37.231Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "UV001",
      "title": "Производители обуви в Минске: уточнение типа + shortlist + шаблон контакта",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "footwear",
        "minsk",
        "manufacturers",
        "template"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 2,
      "usefulRate": 0,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Generic fallback на Turn 3: вместо конкретных производителей дает абстрактный 'shortlist' с 1 сомнительной компанией",
        "Нет ни одного подтвержденного производителя обуви в Минске за 4 хода",
        "Пользователь просил 3-5 в shortlist — получил 1 с пометкой 'проверьте данные'",
        "No concrete candidates delivered despite multiple requests"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: Дает только 1 сомнительную компанию (ПЛЭЙ МОДА ООО) с оговоркой что это возможно не производитель — честно но слабо",
            "Turn 3: Критический провал — вместо shortlist из 3-5 производителей дает шаблон-заглушку с 1 компанией и списком рубрик каталога"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 3 critical failure: requested 3-5 candidates, got 1 with placeholder 'expand search yourself'",
            "Message template in turn 4 completely generic, no connection to actual company found"
          ]
        }
      ],
      "lastReply": "Subject: Запрос на производство мужской классической обуви (опт, Беларусь) Body: Добрый день! Меня зовут [Ваше имя], компания [Название компании], г. [Город]. Рассматриваем сотрудничество с производителем мужской классической обуви на рынке Беларуси. Просим уточнить: 1) Производите ли вы мужскую классическую обувь (модели, материалы, сезонность)? 2) Работаете ли в формате опта и/или контрактного производства (СТМ/private label)? 3) Минимальная партия (MOQ), базовые цены/диапазон цен и сроки производства. 4) Возмож…",
      "lastUser": "Сделай первое сообщение поставщику в блоках Subject/Body/WhatsApp."
    },
    {
      "id": "UV003",
      "title": "Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "consumer_to_b2b",
        "restaurants",
        "reframing"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 2.5,
      "usefulRate": 0.5,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Turn 2: Не дает конкретных компаний даже в формате 'возможно есть' — слишком осторожно",
        "Turn 3: В конце ответа идет список совершенно нерелевантных компаний (Автоцентр, Рыболов, Сантехника) — мусор в контексте",
        "Nonsensical company recommendations in turn 3 with no relevance to cafe equipment/supplies",
        "No actual B2B suppliers identified despite turn 2 guidance"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 3,
          "verdict": "useful",
          "reasons": [
            "Turn 1: Дает 5 вариантов где поесть, но без привязки к локации пользователя — запрашивает уточнение",
            "Turn 2: Хороший pivot к b2b-формату — предлагает искать через кейтеринг/корпоративное питание"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 2,
          "verdict": "not_useful",
          "reasons": [
            "Turn 3 company list completely unrelated to cafe/supplier queries (car dealer, fishing shop, plumbing)",
            "Message template in turn 4 generic, not tailored to B2B food supplier context"
          ]
        }
      ],
      "lastReply": "Subject: Запрос на поставку продуктов для кафе (Минск, Уручье) Body: Добрый день! Ищем поставщика продуктов для кафе в Минске (район Уручье). Просьба направить прайс, минимальный заказ, условия и сроки доставки, график поставок, а также условия оплаты (в т.ч. безнал). Готовы рассмотреть долгосрочное сотрудничество. Спасибо! WhatsApp: Здравствуйте! Нужны поставки продуктов для кафе (Минск, Уручье). Пришлите, пожалуйста, прайс, мин. заказ, условия/сроки доставки и варианты оплаты. Рассматриваем постоянное сотрудниче…",
      "lastUser": "Сформируй короткое сообщение поставщику продуктов в блоках Subject/Body/WhatsApp."
    },
    {
      "id": "UV002",
      "title": "Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "flour",
        "factories",
        "export",
        "quality"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 3.5,
      "usefulRate": 1,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Turn 3: Shortlist слишком короткий и формальный, не добавляет ценности к Turn 1-2",
        "Не указал явно экспортную готовность по каждому заводу как требовалось в запросе",
        "Shortlist has placeholder data instead of real export readiness assessment"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 4,
          "verdict": "useful",
          "reasons": [
            "Turn 1: Дает 3 конкретных завода с профилями, честно указывает что только Пинский КХП явно подтвержден по высшему сорту",
            "Turn 2: Отличная continuity — добавляет критерии белизны, клейковины, стабильности к существующему списку"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 3,
          "verdict": "useful",
          "reasons": [
            "Turn 3 provides incomplete shortlist (2 instead of 3) with placeholder data '[проверьте данные]'",
            "Excellent document checklist in turn 4 provides real value"
          ]
        }
      ],
      "lastReply": "1. **Регистрационные документы компании** - Выписка/свидетельство о госрегистрации, УНП, данные о руководителе и подписанте. 2. **Документ о качестве на конкретную партию муки** - Удостоверение качества (паспорт партии) с ключевыми показателями: сорт, белизна, клейковина, влажность, зольность. 3. **Протоколы лабораторных испытаний** - Свежие протоколы (внутренняя/аккредитованная лаборатория) по последним партиям для проверки стабильности. 4. **Декларация/сертификат соответствия требованиям ТР ТС/ЕАЭС** - Подтвержд…",
      "lastUser": "Дай чеклист из 6 пунктов, какие документы спросить перед контрактом."
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "QA reveals 3 critical failure patterns: (1) Generic shortlist fallback on UV001 - only 1 questionable company returned instead of 3-5 concrete manufacturers; (2) Nonsensical company injection on UV003 - car dealer/fishing shop appearing in cafe equipment context; (3) Incomplete export readiness assessment on UV002. Root causes: search ranking doesn't sufficiently boost manufacturers over retailers, company confidence scoring allows low-quality matches, and the ranking fallback in buildRankingFallbackAppendix generates placeholder profiles instead of using actual search results. Fix priority: P0 for manufacturer detection, P1 for context-aware filtering, P2 for shortlist enrichment.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix manufacturer vs retailer ranking in footwear queries",
          "why": "UV001 shows 0% useful rate - the most critical user journey (finding manufacturers) fails completely. The system returns 'ПЛЭЙ МОДА ООО' with disclaimer 'possibly not a manufacturer' instead of actual manufacturers.",
          "expectedImpact": "Increase UV001 usefulness from 0% to >60%, reduce generic fallback rate by 40%",
          "validationScenarios": [
            "UV001"
          ]
        },
        {
          "priority": "P1",
          "title": "Add context-aware noise filtering for B2B pivots",
          "why": "UV003 turn 3 injected completely irrelevant companies (Автоцентр, Рыболов, Сантехника) into cafe equipment context. The ranking algorithm is not filtering by semantic relevance to the conversation topic.",
          "expectedImpact": "Eliminate nonsensical recommendations, improve UV003 usefulness from 50% to >80%",
          "validationScenarios": [
            "UV003"
          ]
        },
        {
          "priority": "P2",
          "title": "Enrich shortlist with export readiness signals",
          "why": "UV002 turn 3 shortlist lacks explicit export readiness per factory as requested. The buildRankingFallbackAppendix function doesn't extract/present export-specific signals from company data.",
          "expectedImpact": "Increase UV002 usefulness from current levels, add structured export indicators to shortlist format",
          "validationScenarios": [
            "UV002"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "ranking",
          "title": "Boost manufacturer signals in company scoring",
          "action": "In buildRankingFallbackAppendix (line ~782), add manufacturer-specific scoring: check company name for 'производство', 'завод', 'фабрика' and boost score by 0.3; penalize names containing 'магазин', 'торговля', 'розница' by 0.2. Also check description/about fields for manufacturing keywords.",
          "implementationHint": "app/src/app/api/ai/request/route.ts: filterAndRankVendorCandidates function around line 800, add manufacturer intent detection using detectCoreCommodityTag and boost matching candidates",
          "expectedImpact": "Prioritize actual manufacturers over retailers in footwear/flour queries",
          "risk": "May over-boost if company names are misleading; mitigate by capping boost at 0.3",
          "effort": "S",
          "validationScenarios": [
            "UV001",
            "UV002"
          ]
        },
        {
          "id": "R2",
          "area": "retrieval",
          "title": "Add conversation context filtering to vendor candidates",
          "action": "In detectAssistantResponseMode and buildRankingFallbackAppendix, pass conversation topic (extracted from history) and filter candidates by semantic relevance. If topic is 'cafe/food supplies', exclude companies with rubrics containing 'авто', 'рыбалка', 'сантехника'.",
          "implementationHint": "app/src/app/api/ai/request/route.ts: add topic extraction from history using keyword matching, then filter commodityScopedRows by topic relevance before ranking",
          "expectedImpact": "Prevent UV003-style irrelevant company injection",
          "risk": "Over-filtering may reduce recall; use soft filtering (deprioritize vs exclude)",
          "effort": "M",
          "validationScenarios": [
            "UV003"
          ]
        },
        {
          "id": "R3",
          "area": "template",
          "title": "Add export readiness checklist to shortlist format",
          "action": "Modify formatVendorShortlistRows (line ~1741) to include export indicators when export intent detected: add '✓' badge if description contains 'экспорт', 'ВЭД', 'export', or if company has website with .com domain. Add explicit 'Экспортная готовность' column to shortlist output.",
          "implementationHint": "app/src/app/api/ai/request/route.ts: formatVendorShortlistRows function, add export signal detection and conditional badge rendering in output format",
          "expectedImpact": "UV002-style export queries get explicit readiness indicators per company",
          "risk": "False positives if companies mention export casually; verify with website data when available",
          "effort": "S",
          "validationScenarios": [
            "UV002",
            "UV005",
            "UV016"
          ]
        },
        {
          "id": "R4",
          "area": "prompt",
          "title": "Strengthen shortlist count enforcement in system prompt",
          "action": "In the system prompt construction (around line 2400+), add explicit instruction: 'When user requests N companies in shortlist, you MUST return exactly N companies if any exist in catalog. Never return fewer than requested without explicit explanation. If fewer than N exist, state 'Found only X confirmed companies' and list all found.'",
          "implementationHint": "app/src/app/api/ai/request/route.ts: buildAssistantSystemPrompt function, add shortlist count enforcement rule to prompt instructions",
          "expectedImpact": "UV001 '3-5' request won't get 1-company fallback; system will search more aggressively",
          "risk": "May increase hallucination if model invents companies; mitigate by requiring /company/ links",
          "effort": "S",
          "validationScenarios": [
            "UV001",
            "UV014"
          ]
        },
        {
          "id": "R5",
          "area": "retrieval",
          "title": "Expand search synonyms for niche manufacturing",
          "action": "In suggestSourcingSynonyms (app/src/lib/biznesinfo/keywords.ts), add footwear-specific expansions: 'обувь' → ['обувная фабрика', 'производство обуви', 'обувное производство', 'швейное производство обуви']. Add similar for flour: 'мука' → ['мукомольный завод', 'производство муки', 'мельница'].",
          "implementationHint": "app/src/lib/biznesinfo/keywords.ts: expand B2B_SYNONYMS or add commodity-specific synonym maps",
          "expectedImpact": "Better recall for UV001 footwear manufacturers, UV002 flour mills",
          "risk": "Minimal - synonym expansion is low-risk",
          "effort": "S",
          "validationScenarios": [
            "UV001",
            "UV002"
          ]
        },
        {
          "id": "R6",
          "area": "guardrails",
          "title": "Add anti-noise filter for educational institutions",
          "action": "In UV017-style queries (vegetables/food sourcing), add explicit filter to exclude companies with rubrics matching 'колледж', 'университет', 'институт', 'лицей', 'школа'. This is already in checks but not in retrieval logic.",
          "implementationHint": "app/src/app/api/ai/request/route.ts: in filterAndRankVendorCandidates, add education rubric exclusion when commodity tag is 'beet', 'vegetables', 'food'",
          "expectedImpact": "Prevent educational institutions appearing as suppliers in food queries",
          "risk": "None - educational institutions should never be food suppliers in this context",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV001",
          "UV002",
          "UV003"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json",
          "qa_judge_uv001_005.json"
        ],
        "successMetrics": [
          "UV001 usefulness >= 3.0 (was 2.0)",
          "UV003 usefulness >= 3.5 (was 2.5)",
          "UV002 usefulness >= 4.0 (was 3.5)",
          "Zero nonsensical company recommendations in all scenarios",
          "Shortlist count matches requested count in >= 90% of cases"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "Analysis of UV001, UV003, UV002 reveals two critical failure patterns: (1) retrieval/recommendation engine generating nonsensical results (UV003 car dealer, fishing shop for cafe supplies) indicating broken relevance scoring or constraint propagation; (2) shortlist aggregation logic failing to honor explicit user constraints (UV001 received 1 instead of 3-5, UV002 received 2 instead of 3). Both failures occur in Turn 3 when system attempts to synthesize multi-turn context into actionable output. Priority fix: validate candidate filtering pipeline before aggregation to ensure candidates meet all stated constraints from prior turns.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix candidate constraint propagation in multi-turn shortlist generation",
          "why": "UV001 and UV003 both fail at Turn 3 synthesis despite valid Turn 1-2 candidates, indicating constraint loss during aggregation. UV001: user explicitly requested 3-5 in shortlist, got 1. UV003: user asked for cafe suppliers, got automotive/plumbing. This is a…",
          "expectedImpact": "Eliminate generic fallback and placeholder shortlists; ensure Turn 3 output respects all prior constraints.",
          "validationScenarios": [
            "UV001",
            "UV003"
          ]
        },
        {
          "priority": "P1",
          "title": "Add relevance validation before candidate recommendation",
          "why": "UV003 retrieved completely irrelevant companies (car dealer, fishing shop, plumbing) for a cafe supplies query. This indicates the retrieval/re-ranking pipeline lacks domain constraint enforcement. A simple keyword/domain filter would catch this before candid…",
          "expectedImpact": "Reduce nonsensical recommendations; improve candidate relevance scoring accuracy.",
          "validationScenarios": [
            "UV003"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "retrieval",
          "title": "Implement constraint pass-through validation before shortlist generation",
          "action": "Before constructing the shortlist array in buildHardFormattedReply, verify that: (a) candidate count >= user-specified minimum; (b) each candidate passes ALL prior turn constraints (location, product type, export readiness, etc.); (c) if candidates fail validation, emit specific 'missing_constraint' flag instead of placeholder. Modify the aggregation layer to preserve constraints from turns 1-2 into Turn 3 shortlist…",
          "implementationHint": "Locate the shortlist construction logic in app/src/app/api/ai/request/route.ts, specifically around 'shortlist' or 'candidates' aggregation. Add a pre-validation step that checks each candidate against a constraints registry populated from…",
          "expectedImpact": "Prevents '1 of 3-5' failures and enforces user constraints through final output",
          "risk": "Low - defensive validation, reduces incorrect output",
          "effort": "M",
          "validationScenarios": [
            "UV001"
          ]
        },
        {
          "id": "R2",
          "area": "ranking",
          "title": "Add domain relevance filter for B2B candidate queries",
          "action": "Implement a lightweight domain classifier that verifies candidate company categories match the query intent before ranking. For queries involving 'cafe', 'supplies', 'food', filter out candidates whose primary category is unrelated (e.g., automotive, fishing, plumbing unless explicitly requested). Can use existing catalog taxonomy for fast reject.",
          "implementationHint": "In the candidate retrieval pipeline, after initial fetch but before ranking, add domain_match = candidate.category_tags ∩ query_intent_tags non-empty check. Reject or downrank candidates with zero intersection.",
          "expectedImpact": "Eliminates absurd recommendations like car dealers for cafe supplies",
          "risk": "Low - adds filtering, cannot make things worse",
          "effort": "S",
          "validationScenarios": [
            "UV003"
          ]
        },
        {
          "id": "R3",
          "area": "prompt",
          "title": "Add explicit Turn 3 minimum count enforcement in system prompt",
          "action": "Add to the Turn 3-4 system prompt: 'When user requests N candidates, you MUST output exactly N valid candidates with complete data. If insufficient valid candidates exist, explicitly state 'Found X of Y requested candidates' and ask for constraint relaxation. Never output placeholder data or truncated lists.'",
          "implementationHint": "Update app/src/app/api/ai/request/route.ts system prompt section for Turn 3-4 handling, specifically the shortlist construction instructions.",
          "expectedImpact": "Creates a hard constraint in LLM behavior to honor count requirements",
          "risk": "Low - prompt-only change",
          "effort": "S",
          "validationScenarios": [
            "UV001",
            "UV002"
          ]
        },
        {
          "id": "R4",
          "area": "template",
          "title": "Generate context-aware templates using actual found candidates",
          "action": "Turn 4 message templates should reference SPECIFIC companies found in Turns 1-3, not generic placeholders. Modify template generation to accept a 'found_companies' parameter and interpolate real company names, products, and verified attributes into Subject/Body templates.",
          "implementationHint": "In the message template generation function, pass the actual candidate list and extract company_name, product_focus, location for template interpolation. Avoid generic '[Название компании]' when real data exists.",
          "expectedImpact": "Turn 4 templates become useful instead of generic",
          "risk": "Low - improves template quality",
          "effort": "M",
          "validationScenarios": [
            "UV001",
            "UV003"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV001: shortlist must contain 3…",
          "UV003: candidate recommendation…",
          "UV002: shortlist must contain e…"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.regressions.user-ideas-multistep-variants.json"
        ],
        "successMetrics": [
          "Average usefulness score >= 3.5 across multi-turn scenarios",
          "Useful rate >= 0.8 (80% of scenarios rated 'useful' by both judges)",
          "Zero 'generic fallback' or 'placeholder data' occurrences in Turn 3 shortlists",
          "Zero domain-irrelevant candidate recommendations"
        ]
      }
    }
  ],
  "advisorWarnings": [],
  "consensus": {
    "topAreas": [
      {
        "area": "retrieval",
        "count": 3
      },
      {
        "area": "ranking",
        "count": 2
      },
      {
        "area": "template",
        "count": 2
      },
      {
        "area": "prompt",
        "count": 2
      },
      {
        "area": "guardrails",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "boost manufacturer signals in company scoring",
        "count": 1
      },
      {
        "title": "add conversation context filtering to vendor candidates",
        "count": 1
      },
      {
        "title": "add export readiness checklist to shortlist format",
        "count": 1
      },
      {
        "title": "strengthen shortlist count enforcement in system prompt",
        "count": 1
      },
      {
        "title": "expand search synonyms for niche manufacturing",
        "count": 1
      },
      {
        "title": "add anti-noise filter for educational institutions",
        "count": 1
      },
      {
        "title": "implement constraint pass-through validation before shortlist generation",
        "count": 1
      },
      {
        "title": "add domain relevance filter for b2b candidate queries",
        "count": 1
      },
      {
        "title": "add explicit turn 3 minimum count enforcement in system prompt",
        "count": 1
      },
      {
        "title": "generate context-aware templates using actual found candidates",
        "count": 1
      }
    ]
  }
}
