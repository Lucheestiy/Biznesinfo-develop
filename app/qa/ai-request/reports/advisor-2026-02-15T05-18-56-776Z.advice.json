{
  "runId": "advisor-2026-02-15T05-18-56-776Z",
  "generatedAt": "2026-02-15T05:22:38.656Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "UV017",
      "title": "Свекла 500 кг в Минске: защита от нерелевантных \"не-поставщиков\"",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "beet",
        "vegetables",
        "anti_noise",
        "supplier_quality"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 1,
      "usefulRate": 0,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Turn 3: Полный сбой генерации — шаблон содержит мусор 'Subject: Запрос по сформируй сообщение', 'Нам нужно сформируй сообщение в Минск' — это не шаблон, а арте…",
        "Ни в одном turn не подтверждено, что компании реально торгуют свеклой — только общие 'продукты питания' и 'оптовая торговля'",
        "Turn 3 полностью проигнорировал контекст запроса (свекла 500 кг) и сгенерировал бессмысленный шаблон с placeholder-замыканиями на сам запрос пользователя",
        "Нарушение continuity: после запроса shortlist 'релевантных поставщиков' и шаблона с конкретными параметрами (500 кг, 3 дня) — выдан полный мусор вместо actiona…"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 1,
          "verdict": "not_useful",
          "reasons": [
            "Turn 1: Нерелевантные кандидаты — Минская овощная фабрика КУП указана как 'Пчеловодство', Агромашмаркет ООО — 'Запчасти к сельхозтехнике', что не имеет отношения к свекле",
            "Turn 2: Shortlist повторяет те же нерелевантные компании без фильтрации, Турпродплюс и Амифрут — общие оптовики без подтверждения работы со свеклой"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 1,
          "verdict": "not_useful",
          "reasons": [
            "Turn 2: Explicit request for honest assessment and alternative queries was ignored",
            "Turn 3: Generated generic template with 'уточняется' placeholders instead of actionable messages"
          ]
        }
      ],
      "lastReply": "Работаю по данным каталога Biznesinfo. Subject: Запрос по сформируй сообщение — Сформируй сообщение поставщику в блоках Subject/Body/ WhatsApp: объем 500 кг, Минск, поста… Body: Здравствуйте, уточняется! Нам нужно сформируй сообщение в Минск. Просим подтвердить условия по 500 кг, уточняется, доставка/самовывоз и срок срок поставки. Также уточните, пожалуйста, гарантии, доступность и контактное лицо для быстрого согласования. С уважением, уточняется уточняется WhatsApp: Здравствуйте! Нужен сформируй сообщение в Мин…",
      "lastUser": "Сформируй сообщение поставщику в блоках Subject/Body/WhatsApp: объем 500 кг, Минск, поставка в течение 3 дней."
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "Scenario UV017 reveals critical failure modes: (1) template generation produces garbage output with circular placeholder references ('сформируй сообщение' echoed back), (2) no verification that listed companies actually trade the requested product (beet), (3) continuity breakdown between turns — context (500kg, 3 days) is lost. The system passes strict checks (format compliance) but delivers zero business value. Root causes: weak prompt constraints on template generation, missing product-to-company verification step, no guardrails against echo attacks in user input.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix template generation prompt to prevent echo attacks",
          "why": "Turn 3 output is completely unusable — user input text is being echoed back as template content due to weak prompt boundaries",
          "expectedImpact": "Eliminates garbage template generation, restores basic usability for message composition feature",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P0",
          "title": "Add product verification step before company shortlisting",
          "why": "Companies with 'Пчеловодство' and 'Запчасти к сельхозтехнике' are being returned for beet query — no semantic validation",
          "expectedImpact": "Reduces false positive rate in supplier matching, increases trust in recommendations",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P1",
          "title": "Implement continuity enforcement across multi-turn sessions",
          "why": "Context (500kg, 3 days, Minsk) is lost between turns 2 and 3, breaking user workflow",
          "expectedImpact": "Maintains session coherence, improves multi-turn task completion rate",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P1",
          "title": "Add strict output validation for template format",
          "why": "Current output passes format checks but contains nonsense — validation is too permissive",
          "expectedImpact": "Catches garbage output before delivery, triggers retry or fallback",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "prompt",
          "title": "Harden template generation prompt against user input injection",
          "action": "Add explicit instruction: 'NEVER copy user instructions into template content. Extract ONLY: product, volume, location, deadline from context. Reject if user input contains meta-commands like \"сформируй\".' Add negative examples in prompt showing forbidden echo patterns.",
          "implementationHint": "Modify system prompt for template generation tool — likely in src/ai/prompts/templates.ts or similar. Add <forbidden_patterns> section with examples like 'сформируй сообщение', 'уточняется' as placeholders.",
          "expectedImpact": "Prevents circular reference garbage in Turn 3 output",
          "risk": "May over-reject legitimate template requests if patterns too broad",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R2",
          "area": "retrieval",
          "title": "Add product-to-NACE/activity verification filter",
          "action": "Before returning company shortlist, verify that company's primary_activity or NACE codes semantically match requested product. Use embedding similarity threshold (e.g., >0.6) between 'свекла оптовая продажа' and company activity description. Filter out if below threshold.",
          "implementationHint": "In retrieval pipeline (src/ai/retrieval/companies.ts or similar), add post-filter step after initial search. Compute similarity between query product embedding and each candidate's activity_description embedding.",
          "expectedImpact": "Eliminates 'Пчеловодство' and 'Запчасти' results for beet queries",
          "risk": "May filter legitimate diversified traders; add override flag for 'оптовая торговля' broad category",
          "effort": "M",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R3",
          "area": "guardrails",
          "title": "Implement template output sanity checker",
          "action": "Add post-generation validation: (1) template must not contain user instruction verbs ('сформируй', 'создай', 'напиши'), (2) placeholders must not be 'уточняется' when context provides values, (3) subject line must be <100 chars and business-relevant. Fail → retry with stronger prompt.",
          "implementationHint": "Create src/ai/guardrails/template-validator.ts with regex patterns for instruction verbs and placeholder audit. Integrate into template generation flow before response delivery.",
          "expectedImpact": "Blocks garbage templates at generation time, forces retry",
          "risk": "Adds latency (one extra LLM call on failure)",
          "effort": "M",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R4",
          "area": "prompt",
          "title": "Inject session context into every turn system prompt",
          "action": "Modify multi-turn handler to prepend accumulated context (extracted entities: product, volume, location, deadline) to system prompt on each turn. Format: '[Session context] Product: свекла, Volume: 500kg, Location: Минск, Deadline: 3 days'.",
          "implementationHint": "In conversation manager (src/ai/conversation/manager.ts or similar), maintain entity extraction from each turn. Inject into system prompt prefix before LLM call.",
          "expectedImpact": "Preserves 500kg/3 days context through Turn 3, maintains continuity",
          "risk": "May confuse if context becomes stale; add timestamp or turn counter",
          "effort": "M",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R5",
          "area": "prompt",
          "title": "Require explicit product confirmation in shortlist response",
          "action": "Add mandatory field in shortlist output schema: 'product_confidence' with enum ['confirmed', 'likely', 'unknown']. Model must justify 'confirmed' with evidence from company data. Default to 'unknown' if no evidence.",
          "implementationHint": "Update JSON schema for shortlist tool response. Add validation that 'confirmed' requires citation from company description or product list.",
          "expectedImpact": "Forces model to verify beet trading before claiming relevance",
          "risk": "May increase false negatives; tune threshold based on QA feedback",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R6",
          "area": "retrieval",
          "title": "Expand search with alternative product terms when primary yields low confidence",
          "action": "When <3 companies have 'confirmed' product match, automatically expand query with synonyms ('свёкла столовая', 'красная свекла', 'овощи оптом') and present alternatives to user with explanation.",
          "implementationHint": "Add query expansion layer in retrieval pipeline. Use predefined synonym map or LLM-generated variants. Return 'alternative_searches' field in response.",
          "expectedImpact": "Addresses judge finding: 'zero alternative search queries provided despite explicit request'",
          "risk": "May drift to irrelevant products if expansion too aggressive; keep within same product category",
          "effort": "M",
          "validationScenarios": [
            "UV017"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json",
          "template generation suite",
          "multi-turn continuity suite",
          "supplier verification suite"
        ],
        "successMetrics": [
          "Usefulness score ≥3 for UV017 (currently 1)",
          "Zero templates containing instruction verbs ('сформируй', 'создай')",
          "Product confidence 'confirmed' or 'likely' for ≥80% of shortlisted companies",
          "Context preservation: 500kg, 3 days, Minsk present in Turn 3 output",
          "Pass rate for multi-turn scenarios ≥90%"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "UV017 exposes 4 critical failures: template parsing corruption ('сформируй сообщение' loops), zero supplier verification for red beet, missing alternative queries, and 100% generic fallback rate. All issues stem from weak system prompt constraints and missing validation hooks. Fix requires: (1) template guardrails to prevent self-referential placeholders, (2) mandatory verification step before presenting suppliers, (3) explicit alternative query requirement with fallback, (4) continuity validation to reject context shifts. Expected impact: eliminate garbage templates, improve relevance, recover user trust.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix template generation guardrails - prevent self-referential garbage",
          "why": "Turn 3 generated 'сформируй сообщение' loops instead of actual message. This is a parsing/regeneration corruption where the model echoes user instructions as content. Both judges flagged this as 'полный сбой генерации' (complete generation failure). Current p…",
          "expectedImpact": "Eliminate template parsing corruption. Template output should contain actual parameterized content, not instruction echoes. Expected improvement: genericFallbackRate from 100% -> <30%, continuity score from 1-2/5 -> 4+/…",
          "validationScenarios": [
            "UV017",
            "Any template generation scenari…"
          ]
        },
        {
          "priority": "P0",
          "title": "Add mandatory supplier verification before presentation",
          "why": "Both judges independently flagged: 'ни в одном turn не подтверждено, что компании реально торгуют свеклой' (no confirmation companies actually sell red beet). Minsk Vegetable Factory listed as 'Beekeeping', Agromashmarket as 'Spare parts for agricultural mach…",
          "expectedImpact": "Ensure only relevant suppliers are presented. Expected: elimination of category mismatches (beekeeping for vegetable supplier), improvement in relevance scoring, reduced noise in shortlist.",
          "validationScenarios": [
            "UV017",
            "UV005-UV008 (vegetable/food sce…"
          ]
        },
        {
          "priority": "P1",
          "title": "Enforce alternative query generation when explicitly requested",
          "why": "Turn 2 user explicitly asked for 'alternative search queries' - received none. Judge labeled this as 'zero alternative search queries provided despite explicit request'. This is a direct instruction following failure. The system should have a validation hook…",
          "expectedImpact": "100% instruction compliance when alternative queries requested. Expected: usefulRate improvement from 0% to >60% for multi-turn negotiation scenarios.",
          "validationScenarios": [
            "UV017",
            "Any scenario with explicit sub-…"
          ]
        },
        {
          "priority": "P1",
          "title": "Add continuity validation to reject context drift",
          "why": "Continuity score: 2/5 (kimi) and 1/5 (minimax) - worst possible. After Turn 2 established context (500 kg, 3 days, Minsk), Turn 3 produced generic 'уточняется' placeholders. The system needs a continuity checkpoint that validates: 'Does Turn N output align wi…",
          "expectedImpact": "Prevent context abandonment. Expected: continuity score improvement to 4+/5, reduced generic placeholders, consistent parameter propagation across turns.",
          "validationScenarios": [
            "UV017",
            "All multi-turn scenarios (UV001…"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "prompt",
          "title": "Add template generation guardrails to prevent self-referential placeholders",
          "action": "Update system prompt with explicit rule: 'NEVER echo user instructions as template content. If template field contains user's instruction text (e.g., 'сформируй сообщение', 'запрос по...'), treat this as CORRUPTION and regenerate. Template must contain PARAMETERIZED VALUES, not instruction references.'",
          "implementationHint": "File: app/scripts/ai-request-qa-runner.mjs or system prompt file. Add a pre-output validation that checks: if template.text contains patterns matching user instructions, reject and regenerate. Pattern: /(сформир|запрос|сообщени)[а-я]{0,20}…",
          "expectedImpact": "Eliminate template corruption. Template output quality: actual parameterized content vs garbage echoes.",
          "risk": "Low - adds validation, doesn't change model behavior, only prevents corrupted output",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "All template generation tests"
          ]
        },
        {
          "id": "R2",
          "area": "prompt",
          "title": "Add mandatory verification step for supplier relevance",
          "action": "Update system prompt with rule: 'Before presenting ANY company, perform verification: Does company profile explicitly mention the requested product (red beet/sвекла)? If company categories are generic (food products, wholesale), ACQUIRE specific evidence from company description OR EXCLUDE company. Never present unverifiable companies. Use format: [COMPANY] - verified: [YES/NO] - evidence: [specific mention or \"no e…",
          "implementationHint": "File: app/scripts/ai-request-qa-runner.mjs. Before shortlist generation, add verification pass that requires explicit product mention in company data. Reject companies with no specific evidence.",
          "expectedImpact": "Eliminate category mismatches (beekeeping for vegetable supplier). Only verified suppliers in shortlists.",
          "risk": "Medium - may reduce number of presented companies, but improves quality",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV005-UV008"
          ]
        },
        {
          "id": "R3",
          "area": "prompt",
          "title": "Enforce instruction following for alternative queries",
          "action": "Update system prompt: 'When user explicitly requests alternative search queries, you MUST provide them. If unable to find alternatives, state: \"Alternative queries I considered but cannot find results: [list]\". Never ignore explicit sub-requests. Treat ignored instructions as a FAILURE condition.' Add validation: if user asks for X and no X in response, flag as error.",
          "implementationHint": "File: app/scripts/ai-request-qa-runner.mjs or response validator. Parse user request for explicit sub-requests (alternative queries, confirmations, assessments). Validate presence in assistant response.",
          "expectedImpact": "100% compliance with explicit user instructions. Expected: elimination of 'zero alternative queries' failure.",
          "risk": "Low - enforces existing expectations, adds validation",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV010-UV012"
          ]
        },
        {
          "id": "R4",
          "area": "retrieval",
          "title": "Implement continuity checkpoint for multi-turn scenarios",
          "action": "Add validation hook between turns that checks: (1) What specific parameters were established in previous turn? (2) Does current turn maintain those parameters? (3) If parameters are dropped (500 kg, 3 days), require explicit justification or treat as continuity violation. Use format: 'CONTINUITY_CHECK: [params preserved/dropped] - [list preserved/dropped params]'",
          "implementationHint": "File: app/scripts/ai-request-qa-runner.mjs. Store Turn N-1 parameters in context. At Turn N, validate parameter preservation. Fail if context is abandoned without justification.",
          "expectedImpact": "Continuity score improvement from 1-2/5 to 4+/5. Reduced parameter abandonment.",
          "risk": "Low - adds validation, preserves user context",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "All multi-turn tests"
          ]
        },
        {
          "id": "R5",
          "area": "template",
          "title": "Add template schema validation to reject incomplete templates",
          "action": "Add schema validation for template output: 'Template fields (subject, body, whatsapp) must contain at least 3 actual parameterized values, not placeholders like [уточняется] or repeated instructions. If template contains more than 1 placeholder per field, REJECT and regenerate.'",
          "implementationHint": "File: app/scripts/ai-request-qa-runner.mjs. Add post-generation validator that checks template quality: count placeholders per field, validate parameterized content presence.",
          "expectedImpact": "Eliminate templates with 'уточняется' placeholders. Improve template usefulness from 0% to >70%.",
          "risk": "Low - validates output quality, rejects low-quality templates",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV005-UV007"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017",
          "UV005-UV008 (vegetable/food sup…",
          "UV010-UV012 (explicit sub-reque…",
          "UV001-UV004 (single-turn templa…"
        ],
        "regressionSuites": [
          "app/qa/ai-request/scenarios.regressions.user-ideas-multistep-variants.json",
          "app/qa/ai-request/scenarios.uv001-uv020.json"
        ],
        "successMetrics": [
          "genericFallbackRate: <35% (currently 100%)",
          "continuityScore: >4/5 (currently 1-2/5)",
          "alternativeQueryCompliance: 100% when requested (currently 0%)",
          "supplierVerificationRate: >90% (currently ~0%)",
          "usefulRate: >50% (currently 0%)"
        ]
      }
    }
  ],
  "advisorWarnings": [],
  "consensus": {
    "topAreas": [
      {
        "area": "prompt",
        "count": 6
      },
      {
        "area": "retrieval",
        "count": 3
      },
      {
        "area": "guardrails",
        "count": 1
      },
      {
        "area": "template",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "harden template generation prompt against user input injection",
        "count": 1
      },
      {
        "title": "add product-to-nace/activity verification filter",
        "count": 1
      },
      {
        "title": "implement template output sanity checker",
        "count": 1
      },
      {
        "title": "inject session context into every turn system prompt",
        "count": 1
      },
      {
        "title": "require explicit product confirmation in shortlist response",
        "count": 1
      },
      {
        "title": "expand search with alternative product terms when primary yields low confidence",
        "count": 1
      },
      {
        "title": "add template generation guardrails to prevent self-referential placeholders",
        "count": 1
      },
      {
        "title": "add mandatory verification step for supplier relevance",
        "count": 1
      },
      {
        "title": "enforce instruction following for alternative queries",
        "count": 1
      },
      {
        "title": "implement continuity checkpoint for multi-turn scenarios",
        "count": 1
      },
      {
        "title": "add template schema validation to reject incomplete templates",
        "count": 1
      }
    ]
  }
}
