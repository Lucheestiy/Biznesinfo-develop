# Advisor Report — advisor-2026-02-13T21-49-27-576Z

- Generated: 2026-02-13T21:52:40.123Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 20
- Advisors: kimi, minimax

## Focus Scenarios

- UV027 (fail, usefulness 0.5/5): Удержание контекста: не подменять компании между turn 2 и turn 3
- UV003 (fail, usefulness 0.5/5): Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка
- UV026 (fail, usefulness 0.5/5): Конкретный рейтинг с причинами + сертификаты + сроки доставки
- UV021 (fail, usefulness 1/5): Ирис Интер групп: консистентность между «нашел компанию» и «проверь на карточке»
- UV011 (fail, usefulness 1.5/5): No-results ветка: сверхузкий запрос на производителей обуви
- UV008 (fail, usefulness 1.5/5): Белорусский минитрактор: покупка + критерии + сравнение
- UV023 (fail, usefulness 1.5/5): Удержание контекста локации: Сухарево -> конкретный рейтинг с причинами
- UV002 (fail, usefulness 2/5): Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist
- UV006 (fail, usefulness 2/5): Лес на экспорт: условия качества + логистика + RFQ
- UV007 (fail, usefulness 2/5): Найти потенциальных заказчиков моей продукции: reverse поиск + shortlist
- UV015 (fail, usefulness 2/5): Вариант по минитракторам: покупка -> сравнение условий -> запрос для звонка
- UV017 (fail, usefulness 2/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"
- UV022 (fail, usefulness 2/5): Компания из shortlist: автономный поиск новостей и контактов на сайте без запроса URL
- UV024 (fail, usefulness 2.5/5): Concrete ranking с сертификатами: топ-3 по надежности + конкретные риски + документы
- UV025 (fail, usefulness 2.5/5): Concrete delivery constraints: топ-3 с учетом сроков доставки 2-3 дня
- UV018 (fail, usefulness 3.5/5): Ирис Интер групп: 20 тегов для GA/Метрики без ложного sourcing-fallback
- UV009 (fail, usefulness 4/5): Стоматология с микроскопом в Минске: сложный consumer кейс + полезный fallback
- UV020 (pass, usefulness 0.5/5): Ирис Интер групп: команда «Найди на карточке компании» без запроса ссылки у пользователя
- UV013 (pass, usefulness 1/5): Deep website-scan: внутренняя навигация сайта (контакты/о компании/продукция)
- UV014 (pass, usefulness 1/5): Reverse-buyer вариативный: пищевая тара -> целевые сегменты -> shortlist без общих советов

## Consensus

- Top areas:
  - prompt: 5
  - retrieval: 3
  - guardrails: 3
  - template: 2
  - geo: 1
  - ui: 1
  - qa: 1
- Recurring recommendations:
  - inject conversation memory into system prompt (1)
  - cache and reuse previous search results within session (1)
  - block generic fallback patterns on constrained queries (1)
  - add ranking instruction override for specific query patterns (1)
  - persist location constraints across turns (1)
  - create structured rfq/template output parser (1)
  - implement company disambiguation memory (1)
  - add no-results honesty enforcement (1)
  - add session continuity indicator in ui (1)
  - add automated continuity regression tests (1)
  - add continuity check to buildhardformattedreply (1)
  - prevent empty response 502 errors (1)

## kimi

- Summary: Critical multi-turn context preservation failures dominate the failure modes (63% of failures). The assistant repeatedly drops conversation context between turns, triggering generic fallback templates ('Какие критерии учитывать?', 'Напишите что нужно найти') instead of continuing the established workflow. Hard errors (502 Bad Gateway) in UV003 and UV026 indicate infrastructure instability. Primary fix: implement context persistence layer with company/location/rubric memory across turns.

### Priority Plan

- P0 — Fix context persistence layer for multi-turn continuity
  why: 17/27 scenarios failed, with context loss being the root cause in 12 cases. UV027, UV023, UV017 all show catastrophic context drops between turn 2→3.
  impact: Reduce failure rate from 63% to ~30%, improve avg usefulness from 2.0 to 3.5+
  validate: UV027, UV023, UV017, UV026, UV021
- P0 — Resolve 502 Bad Gateway errors on consumer queries
  why: UV003 and UV026 show hard 502 errors - infrastructure/backend instability on specific query patterns
  impact: Eliminate hard failures, improve pass rate by 7.4%
  validate: UV003, UV026
- P1 — Implement anti-template guardrails for ranking requests
  why: UV024, UV025, UV027 fail on 'excludes_all' checks for abstract templates - assistant gives generic criteria instead of concrete rankings
  impact: Improve strict check pass rate, reduce 'not_useful' verdicts by ~25%
  validate: UV024, UV025, UV008, UV015
- P1 — Add company context carryover for 'Ирис Интер групп' scenarios
  why: UV020, UV021 show severe company swap errors - wrong company referenced after context switch
  impact: Fix consistency failures in company-specific workflows
  validate: UV020, UV021, UV022
- P2 — Improve no-results fallback quality
  why: UV011 shows inappropriate fallback to random companies when no manufacturers found
  impact: Better user experience on edge queries, reduced hallucination risk
  validate: UV011, UV014, UV007

### Recommendations

- [R1] (prompt, effort M) Inject conversation memory into system prompt
  action: Add explicit 'PREVIOUS_CONTEXT' section to system prompt containing: companies mentioned in last turn, active location filter, active rubric/category, user intent classification. Format: 'Previously discussed: [company list with IDs], Location: [district], Intent: [sourcing/comparison/rfq]'
  hint: Modify prompt construction in app/src/lib/ai/requests.ts or upstream LLM service. Pass vendor_candidate_ids and ranking_seed_text from previous turn via requestMeta.
  impact: Prevents 'new conversation' template triggers, maintains continuity
  risk: May increase token usage by ~15%
  validate: UV027, UV023, UV017
- [R2] (retrieval, effort S) Cache and reuse previous search results within session
  action: Store last search results (company IDs, rubrics, locations) in ai_assistant_turns.response_meta and inject into next turn's context. If user asks for 'top-3 from these', use cached IDs instead of re-querying.
  hint: Extend conversations.ts appendAssistantSessionTurn to persist vendor_candidate_ids. In route handler, check for previous turn's candidates when query implies filtering/ranking.
  impact: Eliminates company swap errors, enables proper ranking workflows
  risk: Stale data if companies updated between turns
  validate: UV027, UV026, UV024, UV025
- [R3] (guardrails, effort S) Block generic fallback patterns on constrained queries
  action: Add regex guardrails: if user message contains 'топ-3', 'рейтинг', 'сравни', 'почему именно эти' AND previous turn had companies/location → reject responses containing 'Какие критерии', 'Напишите что нужно найти', 'товар/услуга' patterns.
  hint: Add post-processing filter in app/src/app/api/ai/request/route.ts or LLM response validator. Return 400/stub if pattern match detected.
  impact: Forces concrete analysis instead of template fallbacks
  risk: May block legitimate clarification requests
  validate: UV023, UV024, UV025, UV017
- [R4] (prompt, effort S) Add ranking instruction override for specific query patterns
  action: When query matches 'топ-N' or 'сравни' or 'почему именно эти', append system instruction: 'You MUST provide a numbered list with specific reasoning for each item. Use available data from previous turns. Do NOT ask for criteria.'
  hint: Pattern match in request handler, conditionally append instruction to system prompt before LLM call.
  impact: Directs LLM to produce required output format
  risk: None - additive only
  validate: UV024, UV025, UV008, UV015
- [R5] (geo, effort M) Persist location constraints across turns
  action: Store active_location (city, district) in session context. When user mentions district in turn 2, lock it for turn 3 unless explicitly changed. Include in prompt: 'Active location filter: [district] - maintain unless user changes.'
  hint: Extend ai_assistant_sessions.context JSONB to include active_location. Update on each turn if location mentioned.
  impact: Fixes UV027 (Фрунзенский district dropped), UV023 (Сухарево dropped)
  risk: May over-constrain if user wants to expand search
  validate: UV027, UV023, UV026
- [R6] (template, effort M) Create structured RFQ/template output parser
  action: For template requests (Subject/Body/WhatsApp), enforce structured output via function calling or JSON schema. Validate blocks present before returning to user.
  hint: Use OpenAI/compatible function calling with strict schema for template outputs. Fallback to regex validation if function calling unavailable.
  impact: Ensures UV002.T4, UV006.T4, UV017.T3 template checks pass
  risk: May increase latency slightly
  validate: UV002, UV006, UV017, UV009
- [R7] (retrieval, effort S) Implement company disambiguation memory
  action: When company name mentioned (e.g., 'Ирис Интер групп'), store company_id in session context. On 'Найди на карточке' commands, use stored ID instead of search.
  hint: Add company_resolution table or extend session context with resolved_company_id. Update when company mentioned explicitly.
  impact: Fixes UV020, UV021 company swap errors
  risk: Wrong resolution if multiple companies with similar names
  validate: UV020, UV021, UV022
- [R8] (guardrails, effort S) Add no-results honesty enforcement
  action: When search returns 0 results, force response pattern: 'По запросу [X] в [location] не найдено подходящих компаний. Рекомендации: 1) [alternative query] 2) [broader category]'. Block random company injection.
  hint: Post-process search results in API route. If empty, bypass LLM or force specific prompt template for no-results case.
  impact: Fixes UV011 inappropriate fallback to 'Дом офицеров'
  risk: May be overly restrictive
  validate: UV011, UV014, UV007
- [R9] (ui, effort S) Add session continuity indicator in UI
  action: Display 'Continuing conversation about: [topic/location]' indicator in assistant UI when session has previous turns. Helps users understand context is preserved.
  hint: Modify AIAssistant.tsx to fetch session history on open, show context chips if previous turns exist.
  impact: Improves UX, reduces user confusion about context
  risk: None
  validate: UV027, UV023, UV021
- [R10] (qa, effort M) Add automated continuity regression tests
  action: Create test suite that specifically validates: 1) Company IDs persist across turns, 2) Location filters persist, 3) No template fallbacks on constrained queries.
  hint: Extend existing QA runner with 'continuity' check type that compares entity IDs between turns.
  impact: Prevents regression on fixed issues
  risk: Maintenance overhead
  validate: UV027, UV023, UV017, UV021

## minimax

- Summary: The main failure pattern is generic fallback responses when continuity candidates already exist in context. The function `buildHardFormattedReply` (line 644-649) triggers criteria-asking fallback WITHOUT checking if companies from previous turns exist. This causes 37% pass rate (target 80%). Fixing this single code path will address UV027, UV023, UV017, UV006 failures. Secondary issues: 502 empty responses, wrong company context, and template-for-analysis patterns.

### Priority Plan

- P0 — Fix generic fallback when continuity candidates exist
  why: The function `buildHardFormattedReply` (line 644-649) triggers 'Какие критерии?' without checking if vendor candidates exist in conversation history. This causes 6 of 17 failed scenarios (UV027, UV023, UV017, UV006, UV024, UV025).
  impact: Increase pass rate from 37% to ~55% by preventing inappropriate fallback to criteria questions when companies are already available in context.
  validate: UV027, UV023, UV017, UV006
- P0 — Fix 502 empty responses for UV003 and UV026
  why: Two scenarios return completely empty responses due to nginx 502 errors. This is a complete failure mode - user gets no answer.
  impact: Increase pass rate by +7% (2/27 scenarios).
  validate: UV003, UV026
- P1 — Fix wrong company context (Ирис Интер групп → Деловые Медиа)
  why: UV021 and UV020 lose the original company context and work with wrong companies. This breaks multi-turn company-specific workflows.
  impact: Improve usefulness scores for company card lookup scenarios.
  validate: UV021, UV020
- P1 — Improve no-results handling for narrow queries
  why: UV011 returns irrelevant companies (Дом офицеров) instead of proper no-results message with alternatives.
  impact: Better user experience when no matches found.
  validate: UV011

### Recommendations

- [R1] (prompt, effort S) Add continuity check to buildHardFormattedReply
  action: Modify function `buildHardFormattedReply` (line 644) to accept `continuityCandidates` array as second parameter. Before returning `buildTopCompaniesCriteriaQuestionReply()`, check if candidates exist. If they do, return null to allow normal flow with available companies.
  hint: File: app/src/app/api/ai/request/route.ts, function buildHardFormattedReply (line 644). Add second param `vendorCandidates?: BiznesinfoCompanySummary[]` and check `vendorCandidates?.length > 0` before falling back.
  impact: Fixes UV027 (context preservation), UV023 (location continuity), UV017 (specific criteria), UV006 (FSC constraints)
  risk: Low - defensive check, won't break existing flows
  validate: UV027, UV023, UV017, UV006
- [R2] (guardrails, effort M) Prevent empty response 502 errors
  action: Add timeout wrapper and graceful degradation for async operations that cause nginx 502. Ensure minimum response even on timeout.
  hint: Check async handlers in route.ts that may cause upstream timeout. Add try-catch with fallback response for UV003/UV026 patterns (consumer queries like 'Где поесть').
  impact: Fixes complete failure modes for UV003, UV026
  risk: Medium - may affect latency
  validate: UV003, UV026
- [R3] (prompt, effort S) Strengthen company context preservation in multi-turn
  action: Add explicit instruction in system prompt: 'CRITICAL: When user references a specific company from previous turns (e.g., "Ирис Интер групп"), you MUST continue working with that exact company, not switch to different companies.'
  hint: File: app/src/app/api/ai/request/route.ts, search for system prompt section around line 13700. Add rule after line 13742.
  impact: Fixes UV021, UV020 context switching failures
  risk: Low - adds clarity to existing behavior
  validate: UV021, UV020
- [R4] (template, effort S) Remove template placeholders from shortlist fallback
  action: The shortlist fallback in `buildRankingFallbackAppendix` returns generic '[⛔ Проверьте перед контактом]' for ALL companies without differentiation. Add at least one concrete differentiator per company (e.g., location, rubric, years active).
  hint: File: route.ts, function buildRankingFallbackAppendix around line 770. Modify loop to add at least one concrete fact per company before the warning.
  impact: Improves UV024, UV025 usefulness scores
  risk: Low
  validate: UV024, UV025
- [R5] (retrieval, effort M) Fix no-results handling for narrow queries
  action: When search returns 0 results AND query contains specific constraints (e.g., 'мужская классическая обувь'), return explicit 'No results for exact query' with alternative suggestions, NOT random irrelevant companies.
  hint: File: route.ts, search for no-results handling. Ensure function that returns company candidates checks result count and applies stricter fallback when count=0 vs count>0.
  impact: Fixes UV011
  risk: Low
  validate: UV011
- [R6] (prompt, effort M) Add consumer query handling path
  action: UV003 fails because 'Где поблизости вкусно поесть?' (consumer query) has no B2B reframing path. Add explicit handling for consumer intents with B2B alternatives or clarification request.
  hint: File: route.ts, detect consumer intents (restaurants, cafes, clinics without B2B context) and either reframe to B2B (e.g., 'для офиса') or ask for clarification.
  impact: Fixes UV003, improves consumer query handling
  risk: Low
  validate: UV003

