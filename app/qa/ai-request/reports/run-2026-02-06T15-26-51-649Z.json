{
  "meta": {
    "scenarioMeta": {
      "version": "1.0",
      "generatedAt": "2026-02-06T10:10:00Z",
      "source": "manual-regression",
      "description": "Regression scenarios for geo mismatch in multi-turn sourcing"
    },
    "options": {
      "baseUrl": "http://127.0.0.1:8131",
      "email": "qa.ai.runner@example.com",
      "preparePaid": true,
      "paidLimit": 1000,
      "maxScenarios": 2,
      "onlyTags": [],
      "maxRateLimitRetries": 4,
      "maxStubRetries": 2,
      "minTurnDelayMs": 120,
      "stubOutageThreshold": 12
    }
  },
  "summary": {
    "runId": "run-2026-02-06T15-26-51-649Z",
    "startedAt": "2026-02-06T15:26:51.649Z",
    "endedAt": "2026-02-06T15:27:25.920Z",
    "durationMs": 34271,
    "baseUrl": "http://127.0.0.1:8131",
    "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.geo.json",
    "totalScenarios": 2,
    "passedScenarios": 2,
    "failedScenarios": 0,
    "passRate": 1,
    "totalChecks": 18,
    "passedChecks": 18,
    "failedChecks": 0,
    "checkPassRate": 1,
    "targetPassCount": 45,
    "targetReached": false,
    "authUser": {
      "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
      "email": "qa.ai.runner@example.com",
      "name": "AI QA Runner",
      "role": "user",
      "plan": "paid"
    },
    "stoppedEarly": false,
    "stopReason": null
  },
  "runStop": null,
  "topFailurePatterns": [],
  "scenarios": [
    {
      "id": "R001",
      "title": "Молоко в Бресте: запрет на дрейф в Минск",
      "tags": [
        "regression",
        "geo",
        "sourcing",
        "multi_turn"
      ],
      "personaGoal": "Закупщик ищет поставщиков молока в Бресте, проверяет устойчивость к geo-correction",
      "totalTurns": 4,
      "completedTurns": 4,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где можно купить тонну молока в Бресте?",
          "requestBody": {
            "message": "Где можно купить тонну молока в Бресте?",
            "history": []
          },
          "latencyMs": 6714,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "1850ba48-3a27-48fa-a59d-f5c906a40781",
          "isStub": false,
          "reply": "Ниже есть несколько вариантов в Бресте, которые могут подойти для закупки молока (проверьте профиль компании на Biznesinfo и уточните ассортимент):\n\n1. Брестское мороженое ОАО — молочная промышленность, вероятный производитель/переработчик молока. /company/brestmoroj  \n2. Управляющая компания холдинга Концерн Брестмясомолпром ГО — пищевая промышленность (молочный холдинг). /company/brestmmp  \n3. Брестмаш ОАО — автомобильное производство (скорее не по профилю, но указан в Бресте; проверьте профиль). /company/bmz  \n\nЧтобы сузить поиск и дать более точные варианты, уточните, пожалуйста:  \n1) Нужна пастеризованная/сырьевая (сырое) молочная продукция?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Требуется доставка по Бресту/области или самовывоз?  \n\nТакже можно искать по рубрикам: **«Молочная промышленность»**, **«Пищевая промышленность»**, ключевые слова: *молоко оптом, молокозавод, молочный комбинат, сырье молоко*.",
          "checks": [
            {
              "id": "R001.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R001.T1.C2",
              "type": "includes_any",
              "description": "Должна учитываться локация Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "brest"
                ],
                "hits": [
                  "брест",
                  "brest"
                ]
              }
            },
            {
              "id": "R001.T1.C3",
              "type": "excludes_all",
              "description": "Не должно уходить в медицинские нерелевантные компании",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "поликлиник",
                  "больниц",
                  "медицинск"
                ],
                "hits": []
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Я указал Брест - в ответе Минск? Почему? В Бресте есть компании которые продают молоко",
          "requestBody": {
            "message": "Я указал Брест - в ответе Минск? Почему? В Бресте есть компании которые продают молоко",
            "history": [
              {
                "role": "user",
                "content": "Где можно купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Ниже есть несколько вариантов в Бресте, которые могут подойти для закупки молока (проверьте профиль компании на Biznesinfo и уточните ассортимент):\n\n1. Брестское мороженое ОАО — молочная промышленность, вероятный производитель/переработчик молока. /company/brestmoroj  \n2. Управляющая компания холдинга Концерн Брестмясомолпром ГО — пищевая промышленность (молочный холдинг). /company/brestmmp  \n3. Брестмаш ОАО — автомобильное производство (скорее не по профилю, но указан в Бресте; проверьте профиль). /company/bmz  \n\nЧтобы сузить поиск и дать более точные варианты, уточните, пожалуйста:  \n1) Нужна пастеризованная/сырьевая (сырое) молочная продукция?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Требуется доставка по Бресту/области или самовывоз?  \n\nТакже можно искать по рубрикам: **«Молочная промышленность»**, **«Пищевая промышленность»**, ключевые слова: *молоко оптом, молокозавод, молочный комбинат, сырье молоко*."
              }
            ]
          },
          "latencyMs": 4857,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "a24347e2-2d63-4b34-a90f-ec019cb17df1",
          "isStub": false,
          "reply": "Извините за неудобство. В моём ответе не было Минска — я ориентировался на Брест. Вот брестские варианты из каталога, которые ближе всего к молочной теме:\n\n1. **Брестское мороженое ОАО** — молочная промышленность, вероятный производитель/переработчик. /company/brestmoroj  \n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — пищевая промышленность (молочный холдинг). /company/brestmmp  \n\nЕсли нужно, подготовлю уточнённый поиск или черновик запроса поставщикам. Уточните, пожалуйста: сырое или пастеризованное молоко? разовая тонна или регулярные поставки? нужна доставка?",
          "checks": [
            {
              "id": "R001.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R001.T2.C2",
              "type": "includes_any",
              "description": "Ассистент должен зафиксировать Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "brest"
                ],
                "hits": [
                  "брест",
                  "brest"
                ]
              }
            },
            {
              "id": "R001.T2.C3",
              "type": "excludes_all",
              "description": "Нельзя переопределять локацию на Минск",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "локация из запроса:\\s*минск",
                  "фокус по локации:\\s*минск"
                ],
                "hits": []
              }
            }
          ]
        },
        {
          "turn": 3,
          "user": "Где список поставщиков?",
          "requestBody": {
            "message": "Где список поставщиков?",
            "history": [
              {
                "role": "user",
                "content": "Где можно купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Ниже есть несколько вариантов в Бресте, которые могут подойти для закупки молока (проверьте профиль компании на Biznesinfo и уточните ассортимент):\n\n1. Брестское мороженое ОАО — молочная промышленность, вероятный производитель/переработчик молока. /company/brestmoroj  \n2. Управляющая компания холдинга Концерн Брестмясомолпром ГО — пищевая промышленность (молочный холдинг). /company/brestmmp  \n3. Брестмаш ОАО — автомобильное производство (скорее не по профилю, но указан в Бресте; проверьте профиль). /company/bmz  \n\nЧтобы сузить поиск и дать более точные варианты, уточните, пожалуйста:  \n1) Нужна пастеризованная/сырьевая (сырое) молочная продукция?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Требуется доставка по Бресту/области или самовывоз?  \n\nТакже можно искать по рубрикам: **«Молочная промышленность»**, **«Пищевая промышленность»**, ключевые слова: *молоко оптом, молокозавод, молочный комбинат, сырье молоко*."
              },
              {
                "role": "user",
                "content": "Я указал Брест - в ответе Минск? Почему? В Бресте есть компании которые продают молоко"
              },
              {
                "role": "assistant",
                "content": "Извините за неудобство. В моём ответе не было Минска — я ориентировался на Брест. Вот брестские варианты из каталога, которые ближе всего к молочной теме:\n\n1. **Брестское мороженое ОАО** — молочная промышленность, вероятный производитель/переработчик. /company/brestmoroj  \n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — пищевая промышленность (молочный холдинг). /company/brestmmp  \n\nЕсли нужно, подготовлю уточнённый поиск или черновик запроса поставщикам. Уточните, пожалуйста: сырое или пастеризованное молоко? разовая тонна или регулярные поставки? нужна доставка?"
              }
            ]
          },
          "latencyMs": 6045,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "f35e8336-5232-4e3c-8e8d-b46dd89690fb",
          "isStub": false,
          "reply": "Списка поставщиков «готовым перечнем» здесь нет — его нужно сформировать через поиск в каталоге Biznesinfo. Вот как быстро получить список по Бресту:\n\n**Как искать:**\n1. Откройте рубрикатор → **«Молочная промышленность»** или **«Пищевая промышленность»**.  \n2. Поставьте фильтр **Регион: Брестская область**, **Город: Брест**.  \n3. В поиске используйте ключевые слова:  \n   - *молоко оптом*  \n   - *молочный комбинат*  \n   - *молокозавод*  \n   - *сырье молоко*  \n\n**Если результатов мало — расширьте:**\n- Регион: **вся Брестская область** (не только город),  \n- Добавьте синонимы: *молочная продукция*, *переработка молока*.\n\nУточните, пожалуйста, чтобы я сузил список:  \n1) Нужно сырое или пастеризованное молоко?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Нужна доставка или самовывоз?",
          "checks": [
            {
              "id": "R001.T3.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R001.T3.C2",
              "type": "includes_any",
              "description": "Должен быть список кандидатов или полезный fallback без галлюцинаций",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "/company/",
                  "рубрик",
                  "не подставляю"
                ],
                "hits": [
                  "рубрик"
                ]
              }
            },
            {
              "id": "R001.T3.C3",
              "type": "excludes_all",
              "description": "Без нерелевантной медицины",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "поликлиник",
                  "больниц",
                  "медицинск"
                ],
                "hits": []
              }
            }
          ]
        },
        {
          "turn": 4,
          "user": "Указана компания которая продает запчасти в Минске опять!!!",
          "requestBody": {
            "message": "Указана компания которая продает запчасти в Минске опять!!!",
            "history": [
              {
                "role": "user",
                "content": "Где можно купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Ниже есть несколько вариантов в Бресте, которые могут подойти для закупки молока (проверьте профиль компании на Biznesinfo и уточните ассортимент):\n\n1. Брестское мороженое ОАО — молочная промышленность, вероятный производитель/переработчик молока. /company/brestmoroj  \n2. Управляющая компания холдинга Концерн Брестмясомолпром ГО — пищевая промышленность (молочный холдинг). /company/brestmmp  \n3. Брестмаш ОАО — автомобильное производство (скорее не по профилю, но указан в Бресте; проверьте профиль). /company/bmz  \n\nЧтобы сузить поиск и дать более точные варианты, уточните, пожалуйста:  \n1) Нужна пастеризованная/сырьевая (сырое) молочная продукция?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Требуется доставка по Бресту/области или самовывоз?  \n\nТакже можно искать по рубрикам: **«Молочная промышленность»**, **«Пищевая промышленность»**, ключевые слова: *молоко оптом, молокозавод, молочный комбинат, сырье молоко*."
              },
              {
                "role": "user",
                "content": "Я указал Брест - в ответе Минск? Почему? В Бресте есть компании которые продают молоко"
              },
              {
                "role": "assistant",
                "content": "Извините за неудобство. В моём ответе не было Минска — я ориентировался на Брест. Вот брестские варианты из каталога, которые ближе всего к молочной теме:\n\n1. **Брестское мороженое ОАО** — молочная промышленность, вероятный производитель/переработчик. /company/brestmoroj  \n2. **Управляющая компания холдинга Концерн Брестмясомолпром ГО** — пищевая промышленность (молочный холдинг). /company/brestmmp  \n\nЕсли нужно, подготовлю уточнённый поиск или черновик запроса поставщикам. Уточните, пожалуйста: сырое или пастеризованное молоко? разовая тонна или регулярные поставки? нужна доставка?"
              },
              {
                "role": "user",
                "content": "Где список поставщиков?"
              },
              {
                "role": "assistant",
                "content": "Списка поставщиков «готовым перечнем» здесь нет — его нужно сформировать через поиск в каталоге Biznesinfo. Вот как быстро получить список по Бресту:\n\n**Как искать:**\n1. Откройте рубрикатор → **«Молочная промышленность»** или **«Пищевая промышленность»**.  \n2. Поставьте фильтр **Регион: Брестская область**, **Город: Брест**.  \n3. В поиске используйте ключевые слова:  \n   - *молоко оптом*  \n   - *молочный комбинат*  \n   - *молокозавод*  \n   - *сырье молоко*  \n\n**Если результатов мало — расширьте:**\n- Регион: **вся Брестская область** (не только город),  \n- Добавьте синонимы: *молочная продукция*, *переработка молока*.\n\nУточните, пожалуйста, чтобы я сузил список:  \n1) Нужно сырое или пастеризованное молоко?  \n2) Разовая закупка 1 т или регулярные поставки?  \n3) Нужна доставка или самовывоз?"
              }
            ]
          },
          "latencyMs": 5019,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "314ad589-5525-4991-9ed5-ccca2bea103f",
          "isStub": false,
          "reply": "Понимаю ваше недовольство — вы правы. В контексте был старый список кандидатов по Минску, и его нельзя использовать для Бреста. Я не буду предлагать минские компании.\n\nЧтобы дать корректный список по Бресту, мне нужно заново сформировать поиск в каталоге. Подскажите, пожалуйста:  \n1) Нужно **сырое** или **пастеризованное** молоко?  \n2) Разовая тонна или **регулярные поставки**?  \n3) **Доставка** по Бресту нужна или самовывоз?  \n\nПараллельно вы можете найти поставщиков так:  \n- Рубрики: **«Молочная промышленность»**, **«Пищевая промышленность»**  \n- Фильтры: **Брестская область → Брест**  \n- Ключевые слова: *молоко оптом*, *молокозавод*, *молочный комбинат*, *сырье молоко*\n\nДайте ответы — и я сразу сформирую точный список именно по Бресту.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Галерея концепт СООО — /company/galleria (Торговые центры, универмаги; Минск, minsk)\n2. МотоВелоЗавод ООО — /company/aist-bike (Мото-, велотехника, запчасти; Минск, minsk)\n3. СОЛ МИНСК ООО — /company/sol (Центры детского развития; Минск, minsk)\n4. ТОПСЭТ ООО — /company/topset-minsk (Компьютеры и оргтехника; Минск, minsk)",
          "checks": [
            {
              "id": "R001.T4.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R001.T4.C2",
              "type": "includes_any",
              "description": "Должна быть гео-коррекция и удержание контекста",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "локаци"
                ],
                "hits": [
                  "брест"
                ]
              }
            },
            {
              "id": "R001.T4.C3",
              "type": "not_refusal_only",
              "description": "Не отказ, а практичные next steps",
              "passed": true,
              "reason": "No refusal markers",
              "details": {
                "refusal": false
              }
            }
          ]
        }
      ],
      "durationMs": 22639
    },
    {
      "id": "R002",
      "title": "Картошка в Витебске: не подставлять нерелевантные карточки",
      "tags": [
        "regression",
        "geo",
        "sourcing",
        "multi_turn",
        "relevance"
      ],
      "personaGoal": "Закупщик ищет тонну картошки, ожидает либо релевантный shortlist, либо честный fallback без случайных компаний",
      "totalTurns": 2,
      "completedTurns": 2,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где купить тонну картошки в витебске?",
          "requestBody": {
            "message": "Где купить тонну картошки в витебске?",
            "history": []
          },
          "latencyMs": 6035,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "8846aed4-7318-448c-bb42-efd323cfaea3",
          "isStub": false,
          "reply": "Вот подходящий вариант из списка (проверьте актуальность на странице компании):\n\n1. Беккер Бис ООО — Витебск. Профиль: семена/рассада/посадочный материал (можно уточнить наличие товарного картофеля). /company/abekker\n\nЧтобы быстрее найти поставщиков именно картофеля оптом по Витебску, используйте:\n**Рубрики:** Овощи оптом; Сельхозпродукция; Продукты питания оптом; Складские/логистические услуги (если нужен самовывоз/доставка).  \n**Ключевые слова:** картофель оптом, картошка оптом, овощи оптом, товарный картофель, картофель продовольственный.  \n**Фильтр:** регион Витебская обл., город Витебск.\n\nЧтобы сузить подбор:  \n1) Нужен картофель **продовольственный или семенной**?  \n2) Нужна **доставка** или возможен **самовывоз** в Витебске?  \n3) Какой **калибр/сорт** и **срок поставки**?",
          "checks": [
            {
              "id": "R002.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R002.T1.C2",
              "type": "includes_any",
              "description": "Должна фиксироваться локация Витебск",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "витеб",
                  "vitebsk"
                ],
                "hits": [
                  "витеб"
                ]
              }
            },
            {
              "id": "R002.T1.C3",
              "type": "any_of",
              "description": "Нужен shortlist из каталога или честный практичный fallback",
              "passed": true,
              "reason": "At least one sub-check passed",
              "details": {
                "sub": [
                  {
                    "type": "company_path_min_count",
                    "passed": true,
                    "reason": "Enough /company links"
                  },
                  {
                    "type": "includes_any",
                    "passed": true,
                    "reason": "Matched at least one pattern"
                  }
                ]
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Любую картошку. Где купить?",
          "requestBody": {
            "message": "Любую картошку. Где купить?",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну картошки в витебске?"
              },
              {
                "role": "assistant",
                "content": "Вот подходящий вариант из списка (проверьте актуальность на странице компании):\n\n1. Беккер Бис ООО — Витебск. Профиль: семена/рассада/посадочный материал (можно уточнить наличие товарного картофеля). /company/abekker\n\nЧтобы быстрее найти поставщиков именно картофеля оптом по Витебску, используйте:\n**Рубрики:** Овощи оптом; Сельхозпродукция; Продукты питания оптом; Складские/логистические услуги (если нужен самовывоз/доставка).  \n**Ключевые слова:** картофель оптом, картошка оптом, овощи оптом, товарный картофель, картофель продовольственный.  \n**Фильтр:** регион Витебская обл., город Витебск.\n\nЧтобы сузить подбор:  \n1) Нужен картофель **продовольственный или семенной**?  \n2) Нужна **доставка** или возможен **самовывоз** в Витебске?  \n3) Какой **калибр/сорт** и **срок поставки**?"
              }
            ]
          },
          "latencyMs": 5359,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "31fd1326-4538-4b0f-be4f-5157b0de8209",
          "isStub": false,
          "reply": "Подходящий вариант из списка (проверьте актуальность на странице компании):\n\n1. **Беккер Бис ООО** — Витебск. Профиль: семена/рассада/посадочный материал (можно уточнить наличие товарного картофеля). **/company/abekker**\n\nДля поиска поставщиков картофеля оптом в Витебске используйте:\n- **Рубрики:** Овощи оптом; Сельхозпродукция; Продукты питания оптом.  \n- **Ключевые слова:** картофель оптом, картошка оптом, овощи оптом, товарный картофель.  \n- **Фильтр:** Витебская обл., г. Витебск.\n\nЧтобы быстрее подобрать варианты, уточните:\n1) Нужна **доставка** или **самовывоз**?  \n2) Срок поставки?  \n3) Есть требования к **калибру/сорту**?",
          "checks": [
            {
              "id": "R002.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "R002.T2.C2",
              "type": "includes_any",
              "description": "Должно сохраняться гео-уточнение из истории",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "витеб",
                  "локаци"
                ],
                "hits": [
                  "витеб"
                ]
              }
            },
            {
              "id": "R002.T2.C3",
              "type": "excludes_all",
              "description": "Не показывать явно нерелевантные компании как candidates",
              "passed": true,
              "reason": "No forbidden patterns found",
              "details": {
                "patterns": [
                  "не по теме",
                  "автолайт",
                  "жалюзи",
                  "электрооборуд"
                ],
                "hits": []
              }
            }
          ]
        }
      ],
      "durationMs": 11395
    }
  ]
}
