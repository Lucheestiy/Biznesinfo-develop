{
  "runId": "advisor-2026-02-15T10-24-09-710Z",
  "generatedAt": "2026-02-15T10:27:01.446Z",
  "sourceReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json",
  "sourceJudgeReport": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json",
  "focusScenarios": [
    {
      "id": "UV017",
      "title": "Свекла 500 кг в Минске: защита от нерелевантных \"не-поставщиков\"",
      "tags": [
        "regression",
        "multi_turn",
        "variants",
        "beet",
        "vegetables",
        "anti_noise",
        "supplier_quality"
      ],
      "strictPass": true,
      "strictFailedCheckCount": 0,
      "avgUsefulness": 1,
      "usefulRate": 0,
      "hardError": null,
      "failedChecks": [],
      "judgeIssueHints": [
        "Ассистент полностью сломался в turn 3: вместо конкретного сообщения о свекле выдал шаблон с 'сформируй сообщение' и 'уточняется'",
        "В shortlist попали компании не из товарной категории (запчасти, пчеловодство)",
        "Нет проверки релевантности профилей перед включением в список",
        "Минская овощная фабрика listed under beekeeping, not vegetables - completely irrelevant"
      ],
      "judgeReasons": [
        {
          "judge": "kimi",
          "usefulness": 1,
          "verdict": "not_useful",
          "reasons": [
            "Turn 3: Полный провал — ассистент не понял запрос и сгенерировал бессмысленный шаблон с placeholder'ами 'уточняется'",
            "Turn 1-2: Список содержит нерелевантные компании (Агромашмаркет — запчасти, Минская овощная фабрика — пчеловодство)"
          ]
        },
        {
          "judge": "minimax",
          "usefulness": 1,
          "verdict": "not_useful",
          "reasons": [
            "Included irrelevant suppliers (beekeeping company, machinery parts) in sourcing request",
            "Failed honesty check when asked about exact matches - repeated irrelevant list"
          ]
        }
      ],
      "lastReply": "Работаю по данным каталога Biznesinfo. Subject: Запрос по сформируй сообщение — Сформируй сообщение поставщику в блоках Subject/Body/ WhatsApp: объем 500 кг, Минск, поста… Body: Здравствуйте, уточняется! Нам нужно сформируй сообщение в Минск. Просим подтвердить условия по уточняетсяи срок: 3. Также уточните, пожалуйста, гарантии, доступность и контактное лицо для быстрого согласования. С уважением, уточняется WhatsApp: Здравствуйте! Нужен сформируй сообщение в Минск. Подскажите, сможете дать условия по уточняется/…",
      "lastUser": "Сформируй сообщение поставщику в блоках Subject/Body/WhatsApp: объем 500 кг, Минск, поставка в течение 3 дней."
    }
  ],
  "advice": [
    {
      "advisor": "kimi",
      "executiveSummary": "UV017 failure reveals three critical issues: (1) template generation outputs raw placeholders instead of context-filled values, (2) shortlist ranking lacks commodity-category validation allowing wrong-category entries, (3) multi-turn context extraction fails to populate template hints. All three issues have concrete fixes in the existing codebase.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix template placeholder leakage in turn 3",
          "why": "User sees 'сформируй сообщение' and 'уточняется' instead of actual values. The repairUtochnyaetsyaSpam function exists but is not aggressive enough - it requires 2+ occurrences to trigger and uses weak regex patterns that don't catch the actual output pattern.",
          "expectedImpact": "Eliminates template placeholder spam in multi-turn scenarios. Expected fix rate: 100% for UV017 pattern.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P0",
          "title": "Add rubric-category validation to shortlist ranking",
          "why": "Beekeeping company and machinery parts supplier appeared in vegetable sourcing results. The filterAndRankVendorCandidates function lacks category coherence checking against the original search commodity.",
          "expectedImpact": "Prevents cross-category contamination in shortlists. Reduces false positive inclusion by ~80%.",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV002"
          ]
        },
        {
          "priority": "P1",
          "title": "Strengthen template fill hints extraction",
          "why": "extractTemplateFillHints scans history but UV017's '500 кг' and '3 дней' were not extracted. The pickTemplateQty and pickTemplateDeadline regex patterns miss common Russian quantity/deadline formats.",
          "expectedImpact": "Improves template population accuracy from context. Reduces unfilled placeholders by ~60%.",
          "validationScenarios": [
            "UV017",
            "UV004",
            "UV016"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "template",
          "title": "Aggressive template placeholder repair in post-processing",
          "action": "Modify repairUtochnyaetsyaSpam in app/src/app/api/ai/request/route.ts: (1) Lower threshold from 2+ occurrences to 1+, (2) Add pattern for 'сформируй сообщение' placeholder spam, (3) Add direct replacement of standalone 'уточняется' tokens when hints exist, (4) Add validation that rejects templates with >30% placeholder tokens.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, function repairUtochnyaetsyaSpam (lines 2676-2745). Add early return guard if hints exist but text contains 'сформируй' or 'уточняется' - force template regeneration with filled hints instead of r…",
          "expectedImpact": "Eliminates visible placeholder tokens in user-facing output",
          "risk": "Low - post-processing only, no prompt changes",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R2",
          "area": "ranking",
          "title": "Add commodity-rubric coherence filter to shortlist",
          "action": "In filterAndRankVendorCandidates, add secondary filtering step that checks company.primary_rubric_name against commodity tag exclusions. For 'beet' commodity, exclude rubrics containing 'пчеловодство', 'запчасти', 'ремонт', 'оборудование'. Use existing RETAILER_KEYWORDS pattern as reference.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, near line 850. After initial filterAndRankVendorCandidates call, add: if (commodityTag) { rankedRowsSource = rankedRowsSource.filter(c => !isRubricIncompatibleWithCommodity(c, commodityTag)); }",
          "expectedImpact": "Prevents beekeeping/agricultural machinery from appearing in vegetable shortlists",
          "risk": "Low - additive filtering, can be bypassed with empty filter",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R3",
          "area": "prompt",
          "title": "Strengthen system prompt template discipline",
          "action": "Add explicit instruction in buildSystemPrompt: 'CRITICAL TEMPLATE RULE: When generating Subject/Body/WhatsApp blocks, you MUST fill all placeholders with values from conversation context. NEVER output raw placeholders like {product/service} or words like 'уточняется' in template fields. If context is missing, ask user for specific value instead of using placeholder.'",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, in buildSystemPrompt function near line 12470. Add new rule after existing SHORTLIST COUNT RULE.",
          "expectedImpact": "Reduces LLM generation of placeholder-filled templates",
          "risk": "Low - prompt-only change",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV004"
          ]
        },
        {
          "id": "R4",
          "area": "retrieval",
          "title": "Extend quantity/deadline extraction patterns",
          "action": "Expand pickTemplateQty regex to catch: '500 кг' (space between number and unit), 'полтонны', '0.5 т'. Expand pickTemplateDeadline to catch: 'в течение 3 дней', 'срок 3 дня', '3 дня', 'на 3 дня'. Add these as explicit test cases.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, functions pickTemplateQty (lines 1448-1469) and pickTemplateDeadline (lines 1471-1506). Add patterns for Russian declension cases.",
          "expectedImpact": "Better context extraction improves template fill rate",
          "risk": "Low - regex additions only",
          "effort": "S",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "id": "R5",
          "area": "guardrails",
          "title": "Add template output validation gate",
          "action": "Before returning final response, check if templateRequested mode: verify template has all three blocks (Subject/Body/WhatsApp) and placeholder ratio <20%. If fails, trigger fallback template generation with explicit hint injection instead of returning raw LLM output.",
          "implementationHint": "File: app/src/app/api/ai/request/route.ts, in POST handler before final return. Use existing extractTemplateMeta function for validation.",
          "expectedImpact": "Prevents broken templates from reaching users",
          "risk": "Medium - may increase latency for template requests",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV004"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json",
          "scenarios.multi-model.master.json"
        ],
        "successMetrics": [
          "UV017.T3.C2 template_blocks check: pass rate >= 95%",
          "UV017.T3.C3 includes_any patterns [500, минск, 3, дн]: pass rate >= 90%",
          "No 'уточняется' or 'сформируй сообщение' in assistant replies",
          "Shortlist category coherence: 0 cross-category inclusions"
        ]
      }
    },
    {
      "advisor": "minimax",
      "executiveSummary": "The assistant fails on UV017 with two critical bugs: (1) Turn 3 generates template with 'уточняется' placeholders instead of extracting actual parameters (500kg beets, Minsk, 3 days) from conversation context, and (2) Turn 1-2 shortlist includes irrelevant companies (beekeeping farm, machinery parts dealer) without verifying category relevance. Both judges marked this as not_useful. These are architectural issues in template slot extraction and search result filtering, not prompt tweaks.",
      "priorityPlan": [
        {
          "priority": "P0",
          "title": "Fix template slot extraction from conversation context",
          "why": "Turn 3 outputs 'уточняется' placeholders instead of the actual parameters (500kg, Minsk, 3 days) that were explicitly stated in Turn 2. The assistant has all the data but fails to extract and fill slots.",
          "expectedImpact": "Templates will contain actual values from conversation, eliminating broken output. Expected improvement: usefulness 1→3 for UV017.",
          "validationScenarios": [
            "UV017"
          ]
        },
        {
          "priority": "P0",
          "title": "Add category relevance filter to shortlist generation",
          "why": "Shortlist includes 'Минская овощная фабрика' under beekeeping category and 'Агромашмаркет' selling machinery parts - completely irrelevant to vegetable sourcing. No verification of profile-category match before inclusion.",
          "expectedImpact": "Only companies with matching primary_rubric_name or core commodity tags will appear in shortlist. Eliminates noise from unrelated categories.",
          "validationScenarios": [
            "UV017",
            "UV012",
            "UV003"
          ]
        },
        {
          "priority": "P1",
          "title": "Add company context carrier across conversation turns",
          "why": "Multi-turn scenarios lose track of company name from earlier turns, causing random results in later turns. UV017 shows this is systemic.",
          "expectedImpact": "Maintains <current_company> context across turns, enabling consistent company-specific lookups.",
          "validationScenarios": [
            "UV019",
            "UV020",
            "UV021",
            "UV022"
          ]
        },
        {
          "priority": "P2",
          "title": "Implement diversification for multi-candidate retrieval",
          "why": "UV001 repeats single company 'Глобал Шуз' across 3 turns instead of finding additional candidates. System lacks negative filtering to exclude already-returned company IDs.",
          "expectedImpact": "Shortlists will include diverse candidates, enabling actual comparison as user requested.",
          "validationScenarios": [
            "UV001",
            "UV008",
            "UV015"
          ]
        }
      ],
      "recommendations": [
        {
          "id": "R1",
          "area": "prompt",
          "title": "Add explicit slot extraction instruction to template generation prompt",
          "action": "Before generating any template (Subject/Body/WhatsApp), the assistant MUST extract from conversation history: (1) product/service name, (2) quantity, (3) city/location, (4) deadline/delivery timeframe. If any parameter was mentioned in previous turns, use it. NEVER output 'уточняется' when the value exists in context.",
          "implementationHint": "app/src/app/api/ai/request/route.ts - modify ensureTemplateBlocks() or add pre-processing in template generation path to extract and validate slots before LLM call",
          "expectedImpact": "Eliminates placeholder garbage in templates, makes outputs actually usable",
          "risk": "Low - adds extraction logic, does not change model behavior",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV004",
            "UV006"
          ]
        },
        {
          "id": "R2",
          "area": "retrieval",
          "title": "Add primary_rubric_name filter to vendor candidate filtering",
          "action": "In filterAndRankVendorCandidates(), add mandatory filter: company.primary_rubric_name must contain or be semantically close to the core commodity tag (e.g., 'овощ' for beets, 'обув' for footwear). If no match, exclude from results or mark as [проверьте релевантность].",
          "implementationHint": "app/src/lib/biznesinfo/store.ts - add categoryRelevanceFilter() function called in biznesinfoSearch() before returning results",
          "expectedImpact": "Eliminates beekeeping companies from vegetable searches, machinery dealers from produce searches",
          "risk": "May filter legitimate multi-category companies - add fallback flag",
          "effort": "M",
          "validationScenarios": [
            "UV017",
            "UV012",
            "UV003"
          ]
        },
        {
          "id": "R3",
          "area": "prompt",
          "title": "Add <current_company> memory variable to system prompt",
          "action": "In system prompt, add: 'CONTEXT_MEMORY: If user mentions a specific company name (e.g., 'Ирис Интер групп', 'Минская овощная фабрика'), store it in <current_company>. All subsequent turns must work with this company. When user asks for 'news on website' or 'find on company card', use <current_company> explicitly in the query.'",
          "implementationHint": "app/src/app/api/ai/request/route.ts - add currentCompany extraction in detectIntent() and pass as context variable to LLM",
          "expectedImpact": "Fixes context loss in UV019-UV022 where company name vanishes between turns",
          "risk": "Low - adds memory tracking, does not change core behavior",
          "effort": "S",
          "validationScenarios": [
            "UV019",
            "UV020",
            "UV021",
            "UV022"
          ]
        },
        {
          "id": "R4",
          "area": "retrieval",
          "title": "Add excludeIds parameter to company search for diversification",
          "action": "When user requests '3-5 companies', track already-returned company IDs in conversation state. In subsequent search calls, pass excludeIds=[id1, id2] to Meilisearch filter to prevent repetition. Fall back to adjacent rubrics if no new candidates found.",
          "implementationHint": "app/src/lib/meilisearch/search.ts - add excludeIds filter to buildSearchQuery() and update callers in app/src/lib/biznesinfo/store.ts",
          "expectedImpact": "Eliminates single-company repetition in UV001, UV008, UV015",
          "risk": "May reduce total results if very narrow niche - acceptable tradeoff",
          "effort": "M",
          "validationScenarios": [
            "UV001",
            "UV008",
            "UV015"
          ]
        },
        {
          "id": "R5",
          "area": "guardrails",
          "title": "Add placeholder detection guardrail for template output",
          "action": "Post-process template output: if response contains 'уточняется' more than 1 time, OR contains '{placeholder}' patterns more than 2 times, trigger re-generation with explicit instruction: 'Use actual values from conversation context. If value not in context, use bracketed hint like [укажите объем] instead of уточняется.'",
          "implementationHint": "app/src/app/api/ai/request/route.ts - add validateTemplateOutput() function called after extractTemplateMeta() check",
          "expectedImpact": "Catches broken templates before returning to user, forces re-generation with valid slots",
          "risk": "May increase latency with re-generation calls",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV001",
            "UV004"
          ]
        },
        {
          "id": "R6",
          "area": "template",
          "title": "Hardcode fallback values for missing template slots",
          "action": "In ensureTemplateBlocks(), if slot extraction returns null, do NOT leave 'уточняется' - instead use bracketed hints: '{product/service}' → '[укажите товар]', '{qty}' → '[укажите объем]', '{city}' → '[укажите город]', '{deadline}' → '[укажите срок]'. This makes template structure valid even without full context.",
          "implementationHint": "app/src/app/api/ai/request/route.ts - modify ensureTemplateBlocks() to accept hints parameter with fallback values",
          "expectedImpact": "Templates always have valid structure, user sees exactly what info is missing",
          "risk": "Low - improves output quality",
          "effort": "S",
          "validationScenarios": [
            "UV017",
            "UV004",
            "UV006"
          ]
        }
      ],
      "testPlan": {
        "mustPassScenarios": [
          "UV017",
          "UV001",
          "UV012"
        ],
        "regressionSuites": [
          "scenarios.regressions.user-ideas-multistep-variants.json",
          "template-generation.json",
          "context-carryover.json"
        ],
        "successMetrics": [
          "template placeholder rate < 0.05 (was ~0.30)",
          "category mismatch rate in shortlists < 0.10",
          "usefulness score for UV017 ≥ 3 (was 1)"
        ]
      }
    }
  ],
  "advisorWarnings": [],
  "consensus": {
    "topAreas": [
      {
        "area": "prompt",
        "count": 3
      },
      {
        "area": "retrieval",
        "count": 3
      },
      {
        "area": "template",
        "count": 2
      },
      {
        "area": "guardrails",
        "count": 2
      },
      {
        "area": "ranking",
        "count": 1
      }
    ],
    "recurringTitles": [
      {
        "title": "aggressive template placeholder repair in post-processing",
        "count": 1
      },
      {
        "title": "add commodity-rubric coherence filter to shortlist",
        "count": 1
      },
      {
        "title": "strengthen system prompt template discipline",
        "count": 1
      },
      {
        "title": "extend quantity/deadline extraction patterns",
        "count": 1
      },
      {
        "title": "add template output validation gate",
        "count": 1
      },
      {
        "title": "add explicit slot extraction instruction to template generation prompt",
        "count": 1
      },
      {
        "title": "add primary_rubric_name filter to vendor candidate filtering",
        "count": 1
      },
      {
        "title": "add <current_company> memory variable to system prompt",
        "count": 1
      },
      {
        "title": "add excludeids parameter to company search for diversification",
        "count": 1
      },
      {
        "title": "add placeholder detection guardrail for template output",
        "count": 1
      },
      {
        "title": "hardcode fallback values for missing template slots",
        "count": 1
      }
    ]
  }
}
