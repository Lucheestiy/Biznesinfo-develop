{
  "meta": {
    "scenarioMeta": {
      "version": "1.0",
      "generatedAt": "2026-02-08T18:05:00Z",
      "source": "manual-regression",
      "description": "Regression for topic switchback: keep correction context, but allow explicit new topic switch"
    },
    "options": {
      "baseUrl": "http://127.0.0.1:8131",
      "email": "qa.ai.runner@example.com",
      "preparePaid": true,
      "paidLimit": 1500,
      "maxScenarios": null,
      "onlyTags": [],
      "maxRateLimitRetries": 4,
      "maxStubRetries": 2,
      "minTurnDelayMs": 120,
      "stubOutageThreshold": 12,
      "targetPassCount": null,
      "targetPassRate": null
    }
  },
  "summary": {
    "runId": "run-2026-02-08T17-51-23-502Z-3636073-dc783",
    "startedAt": "2026-02-08T17:51:23.502Z",
    "endedAt": "2026-02-08T17:51:55.682Z",
    "durationMs": 32180,
    "baseUrl": "http://127.0.0.1:8131",
    "scenarioFile": "/home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/scenarios.regressions.switchback-topic.json",
    "totalScenarios": 1,
    "passedScenarios": 1,
    "failedScenarios": 0,
    "passRate": 1,
    "totalChecks": 10,
    "passedChecks": 10,
    "failedChecks": 0,
    "checkPassRate": 1,
    "targetPassCount": 1,
    "targetPassRate": 0.8,
    "targetReached": true,
    "authUser": {
      "id": "bb1de8c3-658c-46cc-9fa4-c8629b43f3d7",
      "email": "qa.ai.runner@example.com",
      "name": "AI QA Runner",
      "role": "user",
      "plan": "paid"
    },
    "stoppedEarly": false,
    "stopReason": null
  },
  "runStop": null,
  "topFailurePatterns": [],
  "scenarios": [
    {
      "id": "TS001",
      "title": "Жалоба на нерелевант -> явный switch на новую тему -> возврат к исходной теме",
      "tags": [
        "regression",
        "topic_switch",
        "switchback",
        "cross_domain",
        "multi_turn"
      ],
      "personaGoal": "Проверить, что ассистент не залипает на старой теме и не срывается при коррекции",
      "totalTurns": 4,
      "completedTurns": 4,
      "pass": true,
      "hardError": null,
      "failedChecks": [],
      "turns": [
        {
          "turn": 1,
          "user": "Где купить тонну молока в Бресте?",
          "requestBody": {
            "message": "Где купить тонну молока в Бресте?",
            "history": []
          },
          "latencyMs": 13821,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "20d04b92-96cf-4856-9b4e-39ae7d9e28a0",
          "isStub": false,
          "reply": "Вот самые релевантные варианты в Бресте из доступного списка:\n\n1. **Управляющая компания холдинга «Концерн Брестмясомолпром»** — `/company/brestmmp`  \n   **Почему подходит:** это крупное объединение мясо-молочной промышленности, в составе есть предприятия по переработке молока. Для объёма **1 тонна** это самый логичный старт (опт/производственный уровень).\n\n2. **ОАО «Брестское мороженое»** — `/company/brestmoroj`  \n   **Почему подходит:** в профиле указана молочная продукция (в т.ч. сметана, творог, сыры), то есть компания работает с молочным сырьём и может подсказать продажу/канал поставки молока или переадресовать на партнёра.\n\n⚠️ **Сильных прямых кандидатов именно “продажа молока оптом” в этом фрагменте базы немного (2 шт.)**, поэтому лучше сразу уточнять условия у обоих.\n\nЧто уточнить при звонке/запросе (чтобы быстро получить КП):\n- объём: **1000 кг (1 т)**;  \n- тип: сырое/пастеризованное, жирность;  \n- тара: налив/канистры/еврокуб;  \n- доставка: нужна ли в Бресте, адрес и окно приёмки;  \n- сроки: дата первой отгрузки и регулярность.\n\nЕсли хотите, подготовлю короткий текст запроса (email + WhatsApp), который можно сразу отправить этим двум компаниям.",
          "checks": [
            {
              "id": "TS001.T1.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T1.C2",
              "type": "includes_any",
              "description": "Должен держать молочную тему и Брест",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        },
        {
          "turn": 2,
          "user": "Указана компания которая продает запчасти в Минске опять!!!",
          "requestBody": {
            "message": "Указана компания которая продает запчасти в Минске опять!!!",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Вот самые релевантные варианты в Бресте из доступного списка:\n\n1. **Управляющая компания холдинга «Концерн Брестмясомолпром»** — `/company/brestmmp`  \n   **Почему подходит:** это крупное объединение мясо-молочной промышленности, в составе есть предприятия по переработке молока. Для объёма **1 тонна** это самый логичный старт (опт/производственный уровень).\n\n2. **ОАО «Брестское мороженое»** — `/company/brestmoroj`  \n   **Почему подходит:** в профиле указана молочная продукция (в т.ч. сметана, творог, сыры), то есть компания работает с молочным сырьём и может подсказать продажу/канал поставки молока или переадресовать на партнёра.\n\n⚠️ **Сильных прямых кандидатов именно “продажа молока оптом” в этом фрагменте базы немного (2 шт.)**, поэтому лучше сразу уточнять условия у обоих.\n\nЧто уточнить при звонке/запросе (чтобы быстро получить КП):\n- объём: **1000 кг (1 т)**;  \n- тип: сырое/пастеризованное, жирность;  \n- тара: налив/канистры/еврокуб;  \n- доставка: нужна ли в Бресте, адрес и окно приёмки;  \n- сроки: дата первой отгрузки и регулярность.\n\nЕсли хотите, подготовлю короткий текст запроса (email + WhatsApp), который можно сразу отправить этим двум компаниям."
              }
            ]
          },
          "latencyMs": 5323,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "ced56e95-8a40-4f4b-a448-b2f87bc1c419",
          "isStub": false,
          "reply": "Понял, это ошибка в подборе.  \nВы ищете **молоко в Бресте**, поэтому варианты из **запчастей/Минска** исключаем.\n\nКорректно оставляем только релевантных по молочной теме и локации:\n\n   Причина: профиль мясо-молочной отрасли, подходит под запрос на опт (1 тонна).\n\n   Причина: работает с молочной продукцией, может продать/сориентировать по каналу поставки молока.\n\nСейчас сильных кандидатов в этом фрагменте выдачи немного.  \nЧтобы быстро закрыть задачу, рекомендую: сначала звонок в **brestmmp**, затем параллельно запрос в **brestmoroj**.\n\nЕсли хотите, сразу дам готовый короткий скрипт звонка и текст запроса на 1 тонну молока.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T2.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T2.C2",
              "type": "includes_any",
              "description": "Должен удержать коррекцию по исходной локации/контексту",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "брест",
                  "локаци"
                ],
                "hits": [
                  "брест",
                  "локаци"
                ]
              }
            },
            {
              "id": "TS001.T2.C3",
              "type": "includes_any",
              "description": "Должен вернуть фокус на исходную товарную тему",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "релевант"
                ],
                "hits": [
                  "молок",
                  "релевант"
                ]
              }
            }
          ]
        },
        {
          "turn": 3,
          "user": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
          "requestBody": {
            "message": "Ладно, теперь реально нужны автозапчасти в Минске оптом",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Вот самые релевантные варианты в Бресте из доступного списка:\n\n1. **Управляющая компания холдинга «Концерн Брестмясомолпром»** — `/company/brestmmp`  \n   **Почему подходит:** это крупное объединение мясо-молочной промышленности, в составе есть предприятия по переработке молока. Для объёма **1 тонна** это самый логичный старт (опт/производственный уровень).\n\n2. **ОАО «Брестское мороженое»** — `/company/brestmoroj`  \n   **Почему подходит:** в профиле указана молочная продукция (в т.ч. сметана, творог, сыры), то есть компания работает с молочным сырьём и может подсказать продажу/канал поставки молока или переадресовать на партнёра.\n\n⚠️ **Сильных прямых кандидатов именно “продажа молока оптом” в этом фрагменте базы немного (2 шт.)**, поэтому лучше сразу уточнять условия у обоих.\n\nЧто уточнить при звонке/запросе (чтобы быстро получить КП):\n- объём: **1000 кг (1 т)**;  \n- тип: сырое/пастеризованное, жирность;  \n- тара: налив/канистры/еврокуб;  \n- доставка: нужна ли в Бресте, адрес и окно приёмки;  \n- сроки: дата первой отгрузки и регулярность.\n\nЕсли хотите, подготовлю короткий текст запроса (email + WhatsApp), который можно сразу отправить этим двум компаниям."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Понял, это ошибка в подборе.  \nВы ищете **молоко в Бресте**, поэтому варианты из **запчастей/Минска** исключаем.\n\nКорректно оставляем только релевантных по молочной теме и локации:\n\n   Причина: профиль мясо-молочной отрасли, подходит под запрос на опт (1 тонна).\n\n   Причина: работает с молочной продукцией, может продать/сориентировать по каналу поставки молока.\n\nСейчас сильных кандидатов в этом фрагменте выдачи немного.  \nЧтобы быстро закрыть задачу, рекомендую: сначала звонок в **brestmmp**, затем параллельно запрос в **brestmoroj**.\n\nЕсли хотите, сразу дам готовый короткий скрипт звонка и текст запроса на 1 тонну молока.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              }
            ]
          },
          "latencyMs": 8151,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "0c064ae9-f90b-4b93-8a48-409ebf85ca06",
          "isStub": false,
          "reply": "Отлично, понял: нужны **автозапчасти оптом в Минске**.\n\nПо текущему списку кандидатов есть только 1 явно видимая компания, и она **не подходит**:\n   **Почему не подходит:** категория *косметика и парфюмерия*, не автозапчасти.\n\nИтого: **сильных релевантных поставщиков автозапчастей в данном фрагменте выдачи сейчас 0**.  \nЧтобы быстро получить целевые компании, ищите в рубриках:\n\n1. **Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. **Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n\nКлючи для поиска (добавляйте “Минск”, “опт”):\n- автозапчасти оптом  \n- поставщик автозапчастей  \n- запчасти для легковых / для грузовых  \n- OEM, aftermarket  \n- склад Минск, отгрузка день-в-день\n\nЧтобы я сразу собрал приоритетный шорт‑лист, уточните 2 пункта:\n1) Нужны запчасти для **легковых, грузовых или спецтехники**?  \n2) Нужны **оригинал, аналоги или оба варианта**?\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)",
          "checks": [
            {
              "id": "TS001.T3.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T3.C2",
              "type": "includes_any",
              "description": "Должен переключиться на новую тему (автозапчасти)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "автозапчаст",
                  "запчаст"
                ],
                "hits": [
                  "автозапчаст",
                  "запчаст"
                ]
              }
            },
            {
              "id": "TS001.T3.C3",
              "type": "includes_any",
              "description": "Должен учитывать новый город (Минск)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "минск",
                  "minsk"
                ],
                "hits": [
                  "минск",
                  "minsk"
                ]
              }
            }
          ]
        },
        {
          "turn": 4,
          "user": "Ок, возвращаемся к молоку в Бресте",
          "requestBody": {
            "message": "Ок, возвращаемся к молоку в Бресте",
            "history": [
              {
                "role": "user",
                "content": "Где купить тонну молока в Бресте?"
              },
              {
                "role": "assistant",
                "content": "Вот самые релевантные варианты в Бресте из доступного списка:\n\n1. **Управляющая компания холдинга «Концерн Брестмясомолпром»** — `/company/brestmmp`  \n   **Почему подходит:** это крупное объединение мясо-молочной промышленности, в составе есть предприятия по переработке молока. Для объёма **1 тонна** это самый логичный старт (опт/производственный уровень).\n\n2. **ОАО «Брестское мороженое»** — `/company/brestmoroj`  \n   **Почему подходит:** в профиле указана молочная продукция (в т.ч. сметана, творог, сыры), то есть компания работает с молочным сырьём и может подсказать продажу/канал поставки молока или переадресовать на партнёра.\n\n⚠️ **Сильных прямых кандидатов именно “продажа молока оптом” в этом фрагменте базы немного (2 шт.)**, поэтому лучше сразу уточнять условия у обоих.\n\nЧто уточнить при звонке/запросе (чтобы быстро получить КП):\n- объём: **1000 кг (1 т)**;  \n- тип: сырое/пастеризованное, жирность;  \n- тара: налив/канистры/еврокуб;  \n- доставка: нужна ли в Бресте, адрес и окно приёмки;  \n- сроки: дата первой отгрузки и регулярность.\n\nЕсли хотите, подготовлю короткий текст запроса (email + WhatsApp), который можно сразу отправить этим двум компаниям."
              },
              {
                "role": "user",
                "content": "Указана компания которая продает запчасти в Минске опять!!!"
              },
              {
                "role": "assistant",
                "content": "Понял, это ошибка в подборе.  \nВы ищете **молоко в Бресте**, поэтому варианты из **запчастей/Минска** исключаем.\n\nКорректно оставляем только релевантных по молочной теме и локации:\n\n   Причина: профиль мясо-молочной отрасли, подходит под запрос на опт (1 тонна).\n\n   Причина: работает с молочной продукцией, может продать/сориентировать по каналу поставки молока.\n\nСейчас сильных кандидатов в этом фрагменте выдачи немного.  \nЧтобы быстро закрыть задачу, рекомендую: сначала звонок в **brestmmp**, затем параллельно запрос в **brestmoroj**.\n\nЕсли хотите, сразу дам готовый короткий скрипт звонка и текст запроса на 1 тонну молока.\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Молочная промышленность; Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Молочная промышленность; Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Молочная промышленность; Минск, minsk)\n4. Компания Айсберг ООО — /company/biznesinfo-89297 (Молочная промышленность; Минск, minsk)"
              },
              {
                "role": "user",
                "content": "Ладно, теперь реально нужны автозапчасти в Минске оптом"
              },
              {
                "role": "assistant",
                "content": "Отлично, понял: нужны **автозапчасти оптом в Минске**.\n\nПо текущему списку кандидатов есть только 1 явно видимая компания, и она **не подходит**:\n   **Почему не подходит:** категория *косметика и парфюмерия*, не автозапчасти.\n\nИтого: **сильных релевантных поставщиков автозапчастей в данном фрагменте выдачи сейчас 0**.  \nЧтобы быстро получить целевые компании, ищите в рубриках:\n\n1. **Автозапчасти и принадлежности**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti`\n2. **Автозапчасти и принадлежности для грузовой техники**  \n   `/catalog/avtomobilnaya-tehnika-uslugi-transport/avtozapchasti-i-prinadlejnosti-dlya-gruzovoy-tehniki`\n\nКлючи для поиска (добавляйте “Минск”, “опт”):\n- автозапчасти оптом  \n- поставщик автозапчастей  \n- запчасти для легковых / для грузовых  \n- OEM, aftermarket  \n- склад Минск, отгрузка день-в-день\n\nЧтобы я сразу собрал приоритетный шорт‑лист, уточните 2 пункта:\n1) Нужны запчасти для **легковых, грузовых или спецтехники**?  \n2) Нужны **оригинал, аналоги или оба варианта**?\n\nБыстрый first-pass по релевантным компаниям из каталога:\n1. Минский молочный завод №1 ОАО — /company/belmilk (Минск, minsk)\n2. ГОРМОЛЗАВОД № 2 ОАО — /company/biznesinfo-21355 (Минск, minsk)\n3. Витерфуд СООО — /company/viterfud-s (Минск, minsk)\n4. Айсберг ООО — /company/biznesinfo-89297 (Минск, minsk)"
              }
            ]
          },
          "latencyMs": 4437,
          "apiOk": true,
          "status": 200,
          "retryMeta": {
            "quota": 0,
            "busy": 0,
            "rateLimited": 0,
            "stub": 0
          },
          "requestId": "18593a4a-7fbe-4cfd-b325-90c7a82c3e9b",
          "isStub": false,
          "reply": "Отлично, возвращаемся к молоку в Бресте.\n\nРелевантные варианты для запроса **1 тонна молока**:\n1. **УКХ «Концерн Брестмясомолпром»** — `/company/brestmmp`  \n2. **ОАО «Брестское мороженое»** — `/company/brestmoroj`\n\nКак действовать быстро:\n1. Сначала отправить запрос в **brestmmp** (наиболее вероятный оптовый канал).  \n2. Параллельно — в **brestmoroj** (как альтернатива/переадресация на поставщика).  \n3. В запросе сразу указать: **1000 кг, жирность, тип (сырое/пастеризованное), тара, доставка по Бресту, дата**.\n\nЕсли хотите, подготовлю готовый текст запроса для отправки (email + WhatsApp) с вашими параметрами.",
          "checks": [
            {
              "id": "TS001.T4.C1",
              "type": "not_stub",
              "description": "Ответ не должен быть stub",
              "passed": true,
              "reason": "Reply is non-stub",
              "details": {
                "isStub": false
              }
            },
            {
              "id": "TS001.T4.C2",
              "type": "includes_any",
              "description": "Должен вернуться к исходной теме (молоко в Бресте)",
              "passed": true,
              "reason": "Matched at least one pattern",
              "details": {
                "patterns": [
                  "молок",
                  "брест"
                ],
                "hits": [
                  "молок",
                  "брест"
                ]
              }
            }
          ]
        }
      ],
      "durationMs": 31733
    }
  ]
}
