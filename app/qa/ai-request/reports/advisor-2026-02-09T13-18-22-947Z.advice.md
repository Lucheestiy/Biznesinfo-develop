# Advisor Report — advisor-2026-02-09T13-18-22-947Z

- Generated: 2026-02-09T13:21:30.319Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 5
- Advisors: kimi, minimax

## Focus Scenarios

- MX003 (pass, usefulness 2.5/5): Switchback: молоко -> автозапчасти -> обратно к молоку
- MX005 (pass, usefulness 3.5/5): Пользователь жалуется на слабый ответ: требование конкретики по Минску
- MX001 (pass, usefulness 4.5/5): Молоко: Брест/Минск -> Минская область -> shortlist -> RFQ
- MX002 (pass, usefulness 4.5/5): Лук: Минск -> Минская область -> поставка в Брест -> shortlist + чеклист звонка
- MX004 (pass, usefulness 4.5/5): Кабель ВВГнг: Гомель -> район -> shortlist с валидными ссылками -> 48 часов -> RFQ

## Consensus

- Top areas:
  - prompt: 6
  - template: 3
  - guardrails: 2
  - retrieval: 2
  - geo: 1
  - qa: 1
- Recurring recommendations:
  - isolate template rendering context per turn (1)
  - explicit city vs region disambiguation in retrieval (1)
  - post-generation format validator (1)
  - strengthen topic switch instructions (1)
  - add continuity checkpoint for geo shifts (1)
  - require per-supplier risk explanation (1)
  - add template integrity check to qa suite (1)
  - make placeholder sanitization unconditional (1)
  - add belarus geo hierarchy rules to system prompt (1)
  - persist candidate ids across topic switches (1)
  - require 'who to call first' with rationale (1)
  - explain ranking criteria per supplier (1)

## kimi

- Summary: QA shows 100% strict pass rate but usefulness scores reveal critical failures in topic-switch handling (MX003 avg 2.5), template rendering (broken 'Страница: —' placeholders), and geo-continuity (Minsk city vs region confusion). The assistant fails hardest when context shifts—either via user topic switchback or internal template state corruption. Priority fixes: (1) harden template rendering against context pollution, (2) add geo-disambiguation layer before supplier selection, (3) implement turn-level context validation to detect mixed-topic outputs.

### Priority Plan

- P0 — Fix template rendering context pollution
  why: MX003 Turn 4 shows garbled output mixing milk and auto parts queries with broken placeholders—this is a template engine or prompt context leak, not a data issue
  impact: Eliminates critical 'broken output' failures that drop usefulness to 2/5; prevents mixed-topic pollution on switchback scenarios
  validate: MX003
- P0 — Add geo-disambiguation pre-filter
  why: MX001 Turn 4 ranked Minsk city suppliers for 'Minsk region' query; MX005 Turn 3 reverted to Brest after user shifted to Minsk—geo parsing conflates city vs region
  impact: Reduces geographic mismatch errors; improves continuity score in multi-turn geo refinements
  validate: MX001, MX005
- P1 — Implement turn-level output validation
  why: MX003 Turn 4 and MX002 Turn 3 had malformed outputs (missing company names, incomplete headers) that should be caught before returning to user
  impact: Catches template/rendering errors at generation time; prevents broken placeholders from reaching users
  validate: MX002, MX003, MX004
- P1 — Harden topic switchback handling
  why: MX003 Turn 2 (switch to auto parts) returned generic rubric advice with zero concrete suppliers—topic switch triggers fallback mode incorrectly
  impact: Maintains usefulness during topic switches; prevents generic fallback when data exists
  validate: MX003
- P2 — Add ranking criteria explanation
  why: MX002 Turn 5 referenced 'риск несоответствия задаче' without per-supplier explanation—users need transparency on why rankings differ
  impact: Improves trust and actionability of shortlists; minor usefulness bump
  validate: MX002

### Recommendations

- [R1] (template, effort M) Isolate template rendering context per turn
  action: Modify template engine to clear/reset all placeholder variables at turn start; implement strict mode that throws on unfilled placeholders instead of rendering '—' or partial text
  hint: app/ai/templates/ or src/prompts/ — add context.reset() at turn boundary; wrap render() with placeholder validation regex
  impact: Eliminates 'Страница: —' and mixed-topic pollution in MX003-type scenarios
  risk: May break intentional partial renders; test all template types
  validate: MX003
- [R2] (geo, effort M) Explicit city vs region disambiguation in retrieval
  action: Add geo-classifier step before supplier query: parse user intent for 'city only', 'region only', 'city + region', or 'region excluding city'; pass as explicit filter to retrieval
  hint: src/retrieval/geo-filter.ts or similar — add classifyGeoIntent(query, history) returning {city?: string, region?: string, excludeCity?: boolean}
  impact: Fixes Minsk city vs region mismatches in MX001/MX005
  risk: Classifier errors may over-constrain results; add fallback to broader search if zero results
  validate: MX001, MX005
- [R3] (guardrails, effort S) Post-generation format validator
  action: Add lightweight validator that checks output for: (a) placeholder patterns like '—' or '...', (b) mixed topic keywords from conversation history, (c) missing headers before 'Почему подходит:' blocks
  hint: src/guardrails/output-validator.ts — integrate as middleware before response streaming; on fail, trigger retry with sanitized context
  impact: Catches MX003/MX002/MX004 formatting errors before user sees them
  risk: False positives on legitimate dash usage; tune regex carefully
  validate: MX002, MX003, MX004
- [R4] (prompt, effort S) Strengthen topic switch instructions
  action: Update system prompt: when detecting topic change (via intent classifier or explicit user shift), explicitly instruct model to run fresh retrieval for new topic rather than reusing cached context; prohibit generic rubric-only responses when supplier data exists
  hint: src/prompts/system.md or equivalent — add 'Topic Switch Protocol' section with explicit retrieval trigger and ban on generic fallback for concrete product queries
  impact: Prevents MX003 Turn 2 generic response; ensures concrete suppliers on switchback
  risk: May increase latency due to extra retrieval calls
  validate: MX003
- [R5] (retrieval, effort M) Add continuity checkpoint for geo shifts
  action: Before returning suppliers after geo-clarification, verify that returned locations match the most recent explicit geo intent in conversation history; if mismatch detected, flag for re-retrieval or add explicit disclaimer
  hint: src/retrieval/continuity-check.ts — compare retrieved supplier locations against last geo entity in user messages; implement as post-filter
  impact: Prevents MX005 Turn 3 regression to Brest after Minsk shift
  risk: Over-aggressive filtering may reduce recall; tune threshold
  validate: MX005
- [R6] (prompt, effort S) Require per-supplier risk explanation
  action: Modify ranking prompt to require explicit 1-sentence justification for 'риск несоответствия задаче' per supplier, not just criterion mention
  hint: src/prompts/ranking.md — update output format to include 'Риск: [specific reason]' for each ranked supplier
  impact: Addresses MX002 Turn 5 opacity; improves actionability
  risk: Increases output length; may hit token limits with long lists
  validate: MX002
- [R7] (qa, effort S) Add template integrity check to QA suite
  action: Extend scenario checks to validate: no placeholder patterns ('—', '...', '[', ']'), no mixed topic keywords from earlier turns, proper header structure before explanation blocks
  hint: app/qa/ai-request/strict-checks.js or similar — add regex-based template integrity assertions
  impact: Prevents regression of fixed template issues; catches R1/R3 failures in CI
  risk: May need maintenance as output format evolves
  validate: MX002, MX003, MX004

## minimax

- Summary: Multi-step journey QA shows 100% strict pass rate but judge feedback reveals quality gaps. Kimi gate failed on userSatisfaction 0.702 < 0.72. MX003 switchback scenario is worst (2.5 usefulness) due to broken template output and context mixing. Three patterns cause 80% of issues: (1) raw template placeholders leaking to output, (2) city/oblast geo confusion causing Minsk city suppliers in Minsk Oblast shortlists, (3) topic switchback context loss. P0 fixes targeting template sanitization and geo rules will lift Kimi satisfaction above gate and improve MX003 from 2.5 to 4+ usefulness.

### Priority Plan

- P0 — Fix raw template placeholder leakage
  why: MX003.T4 produced 'Страница: —' placeholders; MX002.T4/T5 showed 'Почему подходит:' without company names. These cause judge failures and user confusion. Template sanitization exists but is conditional on templateRequested flag, which may be false when placeh…
  impact: Eliminates template contamination patterns; improves MX003 usefulness from 2.5 to 4+; raises Kimi userSatisfaction from 0.702 to 0.75+
  validate: MX003.T4, MX002.T4, MX002.T5
- P0 — Add city vs oblast disambiguation rules
  why: MX001.T4 and MX005.T3 both included Minsk city suppliers when user explicitly asked for Minsk Oblast. Judges flagged 'geo confusion' as top issue. System needs explicit Belarus geo hierarchy rules.
  impact: Removes Minsk city from Oblast results; improves geo accuracy across 3 scenarios; reduces judge geo complaints to zero
  validate: MX001.T4, MX005.T3, MX002.T4
- P1 — Fix topic switchback context preservation
  why: MX003.T4 broke continuity after milk→auto→milk switchback, producing garbled output mixing both topics. Original milk shortlist was lost. Need explicit context persistence across topic switches.
  impact: MX003 usefulness improves from 2.5 to 4; switchback continuity score rises from 2 to 4+
  validate: MX003.T2, MX003.T4
- P1 — Add 'who to call first' prioritization
  why: MX005.T3 and MX001.T4 judges noted missing prioritization among suppliers. When user gets 3 candidates, must indicate calling order with rationale (volume, urgency, location fit).
  impact: Addresses judge feedback on prioritization; improves usefulness for MX005 from 3.5 to 4+
  validate: MX005.T3, MX001.T4
- P2 — Explain ranking criteria per supplier
  why: MX002.T5 and MX004.T4 judges found 'риск несоответствия задаче' unexplained. Ranking rationale must be specific to each supplier, not generic template text.
  impact: Reduces judge confusion on ranking; improves perception of transparency
  validate: MX002.T5, MX004.T4

### Recommendations

- [R1] (template, effort S) Make placeholder sanitization unconditional
  action: Remove conditional check for templateRequested in postProcessAssistantReply (line ~2541 in route.ts). Move sanitizeUnfilledPlaceholdersInNonTemplateReply to run for ALL responses, not just non-template mode. Add regex to catch partial placeholders split across tokens.
  hint: app/src/app/api/ai/request/route.ts:2541-2543 - remove the 'if (!params.mode.templateRequested)' guard. Apply sanitizeUnfilledPlaceholdersInNonTemplateReply unconditionally before all response returns.
  impact: Eliminates raw placeholder leakage (Страница: —, {company}, {spec}) from all outputs; fixes MX003.T4, MX002.T4 failures
  risk: Low - purely post-processing, no LLM behavior change
  validate: MX003.T4, MX002.T4, MX002.T5
- [R2] (prompt, effort S) Add Belarus geo hierarchy rules to system prompt
  action: Add explicit rule: 'Belarus cities (Минск, Гомель, Брест, Гродно, Витебск, Могилёв) are separate from oblasts (Минская область, etc.). When user specifies oblast/region without city, EXCLUDE all cities. When user specifies city, do not include in oblast results. Minsk city ≠ Minsk Oblast.'
  hint: System prompt section in route.ts - append geo hierarchy rule near other vendor lookup instructions
  impact: Prevents Minsk city suppliers from appearing in Minsk Oblast shortlists; fixes MX001.T4 and MX005.T3 geo confusion
  risk: Low - clarifying existing intent
  validate: MX001.T4, MX005.T3, MX002.T4
- [R3] (retrieval, effort M) Persist candidate IDs across topic switches
  action: In postProcessAssistantReply, extract company IDs from previous turn's vendorCandidates metadata stored in conversation state (not just parse /company/XXX from text). Merge with fresh lookup when user returns to original topic.
  hint: app/src/app/api/ai/request/route.ts:1646-1656 - modify prioritizeVendorCandidatesByHistory to also accept stored candidate IDs from session metadata, not only parsed slugs from text
  impact: Restores original milk shortlist after auto parts digression; MX003.T4 returns complete top-3 instead of garbled output
  risk: Low - additive fallback preserves existing logic
  validate: MX003.T4, MX003.T2
- [R4] (prompt, effort S) Require 'who to call first' with rationale
  action: Add to ranking guidance: 'When providing top-N suppliers, ALWAYS indicate priority order (1st, 2nd, 3rd) with specific rationale: why this supplier first for user's criteria (volume, urgency, location fit, product match).'
  hint: Vendor shortlist instructions in route.ts - append prioritization requirement
  impact: Addresses judge feedback on missing prioritization; MX005 usefulness rises from 3.5 to 4+
  risk: Low - reinforces expected behavior
  validate: MX005.T3, MX001.T4, MX004.T4
- [R5] (prompt, effort S) Explain ranking criteria per supplier
  action: Modify ranking output rule: 'Ranking criteria must be specific to each supplier, not generic. For each supplier, explain WHY it fits (or doesn't) for user's specific request. Avoid template phrases like "риск несоответствия задаче" without specific explanation.'
  hint: Vendor ranking instructions in route.ts - replace generic criteria with per-supplier explanation requirement
  impact: Reduces judge confusion on MX002.T5 and MX004.T4; improves perceived transparency
  risk: Low
  validate: MX002.T5, MX004.T4
- [R6] (guardrails, effort S) Block catalog-add guidance during sourcing
  action: Add guardrail: 'When user asks for suppliers/vendors/top-N options, NEVER suggest adding companies to catalog. Focus exclusively on finding existing vendors from directory.' This prevents MX004-style catastrophic failures where assistant gives 'add company' instructions instead of supplier lists.
  hint: Vendor lookup guardrails in route.ts - add explicit block for catalog-add responses during sourcing workflows
  impact: Prevents context loss where assistant ignores supplier requests to give catalog instructions
  risk: Low - narrows assistant scope appropriately
  validate: MX004.T3, MX004.T4
- [R7] (prompt, effort S) Add response mode continuity validation
  action: Add rule: 'For multi-turn conversations, maintain awareness of previous response modes. If Turn N was a shortlist/ranking, Turn N+1 should either continue ranking OR switch modes only when user explicitly requests. Do not revert to generic rubric advice without user permission.'
  hint: Multi-turn continuity instructions in route.ts - append response mode awareness rule
  impact: Prevents context loss between turns (MX003, MX005 regressions); maintains shortlist continuity
  risk: Low
  validate: MX003.T4, MX005.T3
- [R8] (template, effort S) Ensure company names appear before ranking bullet points
  action: In shortlist template rendering, verify each bullet point starts with Company Name before any explanatory text. Add post-processing check: if 'Почему подходит:' appears without preceding company name, inject company name from preceding context.
  hint: Shortlist template builder in route.ts - add validation that company names precede bullet content
  impact: Fixes MX002.T3 incomplete company name display; improves readability across all shortlist outputs
  risk: Low - template rendering fix
  validate: MX002.T3, MX002.T4, MX004.T4

