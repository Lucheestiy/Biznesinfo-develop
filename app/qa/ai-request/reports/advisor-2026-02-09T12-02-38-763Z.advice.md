# Advisor Report — advisor-2026-02-09T12-02-38-763Z

- Generated: 2026-02-09T12:06:51.137Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 5
- Advisors: kimi, minimax

## Focus Scenarios

- MX004 (fail, usefulness 2/5): Кабель ВВГнг: Гомель -> район -> shortlist с валидными ссылками -> 48 часов -> RFQ
- MX005 (fail, usefulness 2.5/5): Пользователь жалуется на слабый ответ: требование конкретики по Минску
- MX001 (fail, usefulness 4/5): Молоко: Брест/Минск -> Минская область -> shortlist -> RFQ
- MX002 (pass, usefulness 2.5/5): Лук: Минск -> Минская область -> поставка в Брест -> shortlist + чеклист звонка
- MX003 (pass, usefulness 3/5): Switchback: молоко -> автозапчасти -> обратно к молоку

## Consensus

- Top areas:
  - prompt: 6
  - template: 2
  - geo: 1
  - retrieval: 1
  - ranking: 1
  - guardrails: 1
- Recurring recommendations:
  - add aggressive placeholder sanitization before response return (1)
  - fix geo-correction to preserve candidate list (1)
  - persist candidate ids across topic switches (1)
  - strict geo filtering in ranking fallback (1)
  - add system prompt guard for template generation (1)
  - add content coherence check for repeated segments (1)
  - add explicit city/oblast disambiguation rules (1)
  - block catalog-add guidance during supplier sourcing (1)
  - add response mode continuity validation (1)
  - implement placeholder validation in template output (1)
  - strengthen shortlist continuity requirements (1)
  - add 'who to call first' prioritization requirement (1)

## kimi

- Summary: Multi-turn regressions reveal three critical failure modes: (1) template generation leaves raw placeholders like {qty} unfilled when LLM output is truncated or malformed (MX001, MX004, MX005); (2) geo-correction turns ("не город, а область") trigger context loss, causing the assistant to return generic catalog-search advice instead of shortlist with /company links (MX001, MX002); (3) topic switchback (молоко→автозапчасти→молоко) fails to rehydrate prior candidate list, resulting in incomplete shortlists (MX003). Fix: tighten post-processing guards for template placeholders, harden geo-correction continuity logic, and persist candidate IDs across topic switches in conversation state.

### Priority Plan

- P0 — Fix raw placeholder leakage in template output
  why: MX001, MX004, MX005 all fail strict check 'excludes_all' for patterns like \{qty\}, \{city\}. This is a deterministic post-processing bug, not an LLM quality issue.
  impact: Eliminates 3/8 strict check failures immediately; improves usefulness score for template-heavy scenarios.
  validate: MX001, MX004, MX005
- P0 — Harden geo-correction continuity (city→region)
  why: MX001.T3 and MX002.T2 show that 'Минская область, не сам город' triggers generic fallback instead of shortlist. The lockToHistoryCandidates logic fails when geo hints change but sourcing intent persists.
  impact: Restores shortlist with /company links after geo corrections; fixes 2/8 strict failures.
  validate: MX001, MX002
- P1 — Fix switchback context rehydration
  why: MX003.T4 returns only 2 companies for top-3 request after returning to milk topic. History candidate extraction fails to merge with fresh lookup after topic switch.
  impact: Improves usefulness from 2.5 to 4+ on switchback scenarios; maintains continuity.
  validate: MX003
- P1 — Prevent ranking template hallucination
  why: MX002.T4 shows garbled output mixing Brest candidates into 'Minsk region' shortlist. Geo filtering in ranking fallback is too permissive.
  impact: Reduces geo confusion errors by ~50% in multi-turn journeys.
  validate: MX002, MX001

### Recommendations

- [R1] (template, effort S) Add aggressive placeholder sanitization before response return
  action: In postProcessAssistantReply (line ~2541), move sanitizeUnfilledPlaceholdersInNonTemplateReply to run unconditionally for ALL modes, not just when !params.mode.templateRequested. Add additional regex to catch partial placeholders like '{product/service}' split across tokens.
  hint: app/src/app/api/ai/request/route.ts:2541-2543 - remove the conditional check for templateRequested. Add line: out = sanitizeUnfilledPlaceholdersInNonTemplateReply(out).trim() before all returns.
  impact: Eliminates raw placeholder strict-check failures (MX001.T5.C3, MX004.T5.C3, MX005.T4.C3).
  risk: Low - purely post-processing, no LLM behavior change.
  validate: MX001, MX004, MX005
- [R2] (geo, effort M) Fix geo-correction to preserve candidate list
  action: In buildVendorLookupContext (line ~3888), when detectPreferredGeoFromCorrection returns non-null geo, ensure followUpByCorrection flag is set even if message doesn't match explicit correction regex. Currently 'точнее: Минская область' fails to trigger followUpByCorrection.
  hint: app/src/app/api/ai/request/route.ts:3948-3953 - add condition: const geoCorrectionDetected = Boolean(correctedGeo.city || correctedGeo.region); then include geoCorrectionDetected in followUpByCorrection calculation.
  impact: Fixes MX001.T3 and MX002.T2 context loss after geo refinement.
  risk: Medium - may increase false positives for correction detection; test with negation patterns.
  validate: MX001, MX002
- [R3] (retrieval, effort M) Persist candidate IDs across topic switches
  action: In postProcessAssistantReply (line ~1646), historySlugCandidates extraction uses extractAssistantCompanySlugsFromHistory which only parses /company/XXX patterns. Add fallback to extract company IDs from previous turn's vendorCandidates metadata stored in conversation state.
  hint: app/src/app/api/ai/request/route.ts:1646-1656 - modify prioritizeVendorCandidatesByHistory to also accept stored candidate IDs from session metadata, not just parsed slugs from text.
  impact: Fixes MX003.T4 incomplete shortlist after switchback.
  risk: Low - additive fallback, doesn't change existing logic.
  validate: MX003
- [R4] (ranking, effort S) Strict geo filtering in ranking fallback
  action: In buildRankingFallbackAppendix (line ~465), the filterAndRankVendorCandidates function doesn't enforce strict city/region matching when candidates exist. Add explicit geo filter before ranking when user explicitly corrected geo in previous turn.
  hint: app/src/app/api/ai/request/route.ts:480-487 - after filterAndRankVendorCandidates, add: if (params.region || params.city) { rankedRowsSource = rankedRowsSource.filter(c => geoMatches(c, params.region, params.city)); }
  impact: Prevents MX002.T4 issue where Brest candidates appeared in Minsk region shortlist.
  risk: Low - stricter filtering reduces false positives.
  validate: MX002
- [R5] (prompt, effort S) Add system prompt guard for template generation
  action: In generateCodexReply/generateOpenAiReply calls, add explicit instruction: 'When generating RFQ templates, ALWAYS replace all placeholders like {qty}, {city}, {deadline} with inferred values or remove them. Never output raw curly-brace placeholders.'
  hint: app/src/app/api/ai/request/route.ts:2788-2794 (Codex) and 2729-2734 (OpenAI) - append to instructions string.
  impact: Reduces placeholder leakage at source before post-processing.
  risk: Low - prompt engineering only.
  validate: MX001, MX004, MX005
- [R6] (guardrails, effort M) Add content coherence check for repeated segments
  action: In postProcessAssistantReply, detect repeated paragraph patterns (indicating LLM loop/hallucination) and trigger fallback to local resilient reply. MX002.T4 shows 'turn 4-5 includes repeated/duplicated content'.
  hint: app/src/app/api/ai/request/route.ts:2621 - add function hasRepeatedSegments(text) that checks for 20+ character substrings appearing >2 times. If detected, log and return buildLocalResilientFallbackReply.
  impact: Catches garbled/repeated output before it reaches user.
  risk: Low - safety guardrail, only triggers on obvious pathology.
  validate: MX002

## minimax

- Summary: Multi-step journey QA (40% pass rate) reveals 3 critical failure modes: (1) catastrophic context loss where assistant ignores supplier requests to give 'add company' instructions (MX004), (2) geo-boundary confusion where city/oblast filters are ignored (MX001, MX005), (3) template output contamination with raw placeholders. Fixing these requires adding explicit geodisambiguation rules, blocking 'add company' instructions during sourcing, and implementing placeholder validation. P0 improvements can target 80%+ pass rate in multi-step scenarios.

### Priority Plan

- P0 — Add geodisambiguation rules for city vs oblast/region
  why: 3 of 5 scenarios fail strict checks due to Minsk city candidates appearing in Minsk Oblast shortlists. Judges consistently report 'geo confusion' across scenarios MX001, MX002, MX005.
  impact: Reduces strict failures by 3-5 checks, improves judge usefulness from 2.4 avg to 3.2+
  validate: MX001.T4, MX002.T3, MX005.T3
- P0 — Block 'add company to catalog' responses during sourcing workflows
  why: MX004 completely fails when turns 3-4 give 'add company' instructions instead of supplier shortlists. This is a categorical error - never suggest adding companies when user requests suppliers.
  impact: Fixes 5 strict check failures in MX004, prevents future regressions
  validate: MX004.T3, MX004.T4
- P1 — Implement template placeholder validation before response
  why: Failed checks MX001.T5, MX005.T4, MX003.T4 all show raw placeholders ({company}, {spec}, {deadline}) in final output. Template blocks should not emit unresolved placeholders.
  impact: Eliminates template placeholder contamination, passes 3-4 currently failed checks
  validate: MX001.T5, MX005.T4

### Recommendations

- [R1] (prompt, effort S) Add explicit city/oblast disambiguation rules
  action: Add to system prompt: 'Belarus geo hierarchy: cities (Минск, Гомель, Брест, Гродно, Витебск, Могилёв) are separate from oblasts (Минская область, Гомельская область, etc.). When user specifies oblast/region without city, exclude all cities. When user specifies city, do not include in oblast results. Minsk city ≠ Minsk Oblast.'
  impact: Prevents Minsk city companies from appearing in Minsk Oblast shortlists
  risk: Low - clarifying existing intent
  validate: MX001.T4, MX005.T3
- [R2] (prompt, effort S) Block catalog-add guidance during supplier sourcing
  action: Add vendor lookup guardrail: 'When user asks for suppliers/vendors/top-N options, never suggest adding companies to catalog. Focus exclusively on finding existing vendors from directory.'
  impact: Prevents MX004-style catastrophic failures
  risk: Low - narrows assistant scope appropriately
  validate: MX004.T3, MX004.T4
- [R3] (prompt, effort S) Add response mode continuity validation
  action: Add rule: 'For multi-turn conversations, maintain awareness of previous response modes. If Turn N was a shortlist/ranking, Turn N+1 should either continue ranking OR switch modes explicitly requested by user. Do not revert to generic rubric advice without user permission.'
  impact: Prevents context loss between turns (MX003, MX005 regressions)
  risk: Low - reinforces expected behavior
  validate: MX003.T4, MX005.T3
- [R4] (template, effort M) Implement placeholder validation in template output
  action: Before emitting Subject/Body/WhatsApp blocks, validate no raw template variables remain. If placeholders detected, either fill with reasonable defaults or return error with specific missing fields.
  impact: Eliminates template contamination (raw {company}, {spec} in output)
  risk: Medium - requires code change in response generation
  validate: MX001.T5, MX005.T4
- [R5] (prompt, effort S) Strengthen shortlist continuity requirements
  action: Add to vendor guidance: 'If user previously received a shortlist of N companies and requests refinements, preserve the original list structure. Explain any changes or drops. Do not silently replace with different companies.'
  impact: Prevents content coherence issues (MX002.T4 duplicate rankings)
  risk: Low
  validate: MX002.T4, MX002.T5
- [R6] (prompt, effort S) Add 'who to call first' prioritization requirement
  action: When user requests top-N suppliers with phone/contact info, always indicate priority order (1st, 2nd, 3rd) with rationale based on their criteria (volume, urgency, location fit).
  impact: Addresses judge feedback about missing prioritization
  risk: Low
  validate: MX005.T3

