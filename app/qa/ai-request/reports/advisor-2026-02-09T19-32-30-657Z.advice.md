# Advisor Report — advisor-2026-02-09T19-32-30-657Z

- Generated: 2026-02-09T19:36:13.821Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 2
- Advisors: kimi, minimax

## Focus Scenarios

- GA002 (fail, usefulness 2/5): Конфликт регионального уточнения: город Минск -> Минская область
- GA001 (pass, usefulness 3.5/5): Неоднозначный город в одном сообщении: Брест или Минск

## Consensus

- Top areas:
  - prompt: 5
  - retrieval: 3
  - template: 2
  - ranking: 1
  - guardrails: 1
- Recurring recommendations:
  - inject commodity tag into vendor lookup context on geo-correction (1)
  - add explicit geo-acknowledgment system message on correction (1)
  - add commodity reinforcement to lategeocorrectioncue handler (1)
  - add rubric conflict detection for agricultural commodities (1)
  - add strict check for empty commodity-aligned candidates (1)
  - enhance dual-city delivery acknowledgment (1)
  - add multi-turn geo-correction recognition to system prompt (1)
  - enforce and filter: topic and geo must match (1)
  - add 'no matching suppliers' fallback template (1)
  - preserve topic constraint across turns (1)
  - handle ambiguous geo mentions with clarification (1)
  - add delivery-option expansion for geo queries (1)

## kimi

- Summary: GA002 failed because the assistant lost product context (onion) when switching from city to region scope. The retrieval pipeline returned livestock farms (ТИТУЛ ФХ, Олимп-Агро) instead of vegetable suppliers. Root cause: insufficient commodity-aware filtering in vendor candidate ranking when geo-correction occurs. GA001 passed but judges noted suboptimal handling of dual-city ambiguity. Priority fixes: (1) strengthen commodity tag persistence across geo-corrections, (2) add explicit acknowledgment phrases for geo-filter changes, (3) improve rubric-based filtering for agricultural products.

### Priority Plan

- P0 — Fix commodity tag persistence on geo-correction (GA002)
  why: GA002 failed strict checks because 'лук репчатый' context was lost when user corrected 'Минск' → 'Минская область'. Assistant returned livestock farms instead of vegetable suppliers.
  impact: Eliminates 100% of commodity context loss in geo-correction scenarios. Improves usefulness score from 2 → 4+ for GA002.
  validate: GA002
- P0 — Add explicit geo-filter acknowledgment phrases
  why: Checks GA002.T2.C3 and GA002.T2.C4 require explicit acknowledgment patterns ('учту', 'принял', 'беру', 'фильтр', 'область'). Current post-processing adds these but too late in the pipeline.
  impact: Passes strict checks for geo-correction acknowledgment. Reduces judge complaints about 'необоснованный выбор' and 'нет явного признания'.
  validate: GA002, GA001
- P1 — Strengthen agricultural rubric filtering for onion queries
  why: Judge noted 'ТИТУЛ ФХ (животноводство) и Олимп-Агро (общее СХ) не являются поставщиками лука'. Current commodity filtering doesn't properly exclude livestock-only farms.
  impact: Prevents livestock farms from appearing in vegetable sourcing results. Improves relevance scoring.
  validate: GA002
- P1 — Improve dual-city ambiguity handling (GA001 Turn 2)
  why: Judge noted 'нет явного признания что поставка в Брест из Минска возможна'. Assistant switched to Minsk but didn't acknowledge the Brest delivery option.
  impact: Better multi-city sourcing handling. Usefulness 3.5 → 4+ for GA001.
  validate: GA001

### Recommendations

- [R1] (retrieval, effort S) Inject commodity tag into vendor lookup context on geo-correction
  action: In app/src/app/api/ai/request/route.ts, modify the geoCorrectionFollowUp handler (lines 2575-2613) to explicitly pass commodityTag to the candidate filtering logic. Currently continuityForVendorFlow is filtered by commodityTag but if empty, it falls back to unfiltered continuityCandidates. Change: when strictMinskRegionScope is true AND commodityTag is 'onion', add explicit filter for vegetable-growing rubrics (овощ…
  hint: File: app/src/app/api/ai/request/route.ts, function postProcessAssistantReply, around line 2575-2613. Add rubric-based exclusion filter when commodityTag === 'onion' and candidate.primary_rubric_name includes 'животноводство' or excludes '…
  impact: Prevents livestock farms from being returned for vegetable queries after geo-correction.
  risk: Low - additive filtering only.
  validate: GA002
- [R2] (prompt, effort S) Add explicit geo-acknowledgment system message on correction
  action: In buildAssistantPrompt function (around line 7266), detect geo-correction patterns in user message ('точнее', 'не сам город', 'область, не') and inject a system message that explicitly acknowledges the new geo scope before the user message. This ensures the model sees the acknowledgment requirement early.
  hint: File: app/src/app/api/ai/request/route.ts, function buildAssistantPrompt. Add detection for geoCorrectionCue similar to promptInjection detection. If detected, prepend system message: 'User is correcting location scope from city to region.…
  impact: Model will generate acknowledgment phrases that pass strict checks GA002.T2.C3/C4.
  risk: Low - prompt-only change.
  validate: GA002
- [R3] (template, effort S) Add commodity reinforcement to lateGeoCorrectionCue handler
  action: The lateGeoCorrectionCue handler (lines 3143-3165) already adds 'Принял фильтр' and 'Товарный фокус без изменений' lines. However, it only triggers when commodity is 'лук' or 'молоко'. Extend this to use the full normalizeFocusSummaryText() output for any commodity, and ensure it runs BEFORE candidate formatting, not after.
  hint: File: app/src/app/api/ai/request/route.ts, lines 3143-3165. Move the commodity focus reinforcement earlier in the post-processing pipeline, before vendor candidate formatting. Use normalizeFocusSummaryText(summarizeSourcingFocus(lastSourci…
  impact: All commodity types maintain context through geo-corrections, not just onion/milk.
  risk: Low - reordering existing logic.
  validate: GA002
- [R4] (ranking, effort M) Add rubric conflict detection for agricultural commodities
  action: In filterAndRankVendorCandidates and related ranking functions, add commodity-rubric conflict rules. If commodityTag is 'onion', deprioritize or exclude candidates where primary_rubric_name contains 'животноводство', 'мяс', 'молоч', 'скот', 'птиц'. If commodityTag is 'milk', deprioritize candidates with 'овощ', 'фрукт', 'зернов'.
  hint: File: app/src/app/api/ai/request/route.ts, add new function isAgriculturalRubricConflict(commodityTag, rubricName) and use it in the ranking pipeline around lines 1874-1888 where commodity filtering happens.
  impact: Eliminates clearly irrelevant agricultural suppliers (livestock for vegetables, etc.).
  risk: Medium - may over-filter if rubric names are inconsistent. Needs testing.
  validate: GA002
- [R5] (guardrails, effort S) Add strict check for empty commodity-aligned candidates
  action: In postProcessAssistantReply, after commodity filtering (around line 2377-2386), if commodityScoped.length === 0 AND commodityTag is set, add explicit language: 'По товару [X] в регионе [Y] подтвержденных поставщиков не найдено. Показываю ближайшие варианты по региону без гарантии наличия товара.'
  hint: File: app/src/app/api/ai/request/route.ts, lines 2377-2386. Add explicit 'no relevant suppliers found' acknowledgment when commodity filter eliminates all candidates.
  impact: Transparent communication when product-specific suppliers aren't found, rather than showing irrelevant alternatives silently.
  risk: Low - additive messaging only.
  validate: GA002
- [R6] (prompt, effort S) Enhance dual-city delivery acknowledgment
  action: For GA001-like scenarios (минск как базовый, поставка в брест), add system prompt instruction to acknowledge both cities: 'User specified base city [X] with delivery option to [Y]. Acknowledge both locations in response.' Detect pattern in looksLikeDeliveryRouteConstraint or similar.
  hint: File: app/src/app/api/ai/request/route.ts, enhance looksLikeDeliveryRouteConstraint or add new detector for 'base city + delivery to' pattern. Inject system message in buildAssistantPrompt.
  impact: Addresses judge feedback 'нет явного признания что поставка в Брест из Минска возможна'.
  risk: Low - prompt enhancement.
  validate: GA001

## minimax

- Summary: Geo-ambiguity handling in multi-turn conversations is the critical failure point. GA002 scenario shows 2 strict failures and 2.0 usefulness score: assistant loses topic relevance when user corrects city→region, returns livestock farms instead of onion suppliers, and fails to acknowledge when no matching suppliers exist. Priority fixes: (1) add multi-turn context preservation for geo-corrections, (2) enforce topic (onion) × geo cross-filtering, (3) implement explicit 'no results' acknowledgment pattern.

### Priority Plan

- P0 — Fix multi-turn geo-correction handling (GA002.T2.C3/C4)
  why: 2 strict checks failed, lowest usefulness (2.0). Assistant ignores user region correction and returns irrelevant livestock farms.
  impact: Pass GA002, improve multi-turn geo scenarios by ~30% pass rate
  validate: GA002, GA001
- P1 — Add topic×geo cross-filter enforcement
  why: Judge feedback: 'лук репчатый' not filtered - returned livestock farms and unrelated businesses. Core retrieval failure.
  impact: Eliminate relevance drop in GA002.T2, improve usefulness scores
  validate: GA002
- P1 — Implement explicit 'no results' acknowledgment
  why: Both judges flagged missing acknowledgment when no suitable suppliers found. Causes confusion about assistant state.
  impact: Better user experience, clearer expectations
  validate: GA002

### Recommendations

- [R1] (prompt, effort S) Add multi-turn geo-correction recognition to system prompt
  action: Extend system prompt with pattern: when user corrects geo (city→region), assistant MUST acknowledge correction in next turn, reference updated filter, and use phrasing like 'по Минской области' instead of previous geo
  hint: app/src/app/api/ai/request/route.ts - extend systemMessage or add turnContext parser
  impact: Fixes GA002.T2.C3 (geo correction acknowledgment)
  risk: low
  validate: GA002
- [R2] (retrieval, effort M) Enforce AND filter: topic AND geo must match
  action: Modify search/retrieval layer to require BOTH topic keywords (e.g., 'лук', 'овощ') AND geo filter (e.g., 'minsk-region') in same query. Reject queries returning only geo matches without topic match.
  hint: Search service or retrieval middleware - add topic_presence_check before returning results
  impact: Eliminates livestock farms in onion queries, fixes GA002 relevance
  risk: low
  validate: GA002
- [R3] (template, effort S) Add 'no matching suppliers' fallback template
  action: Create explicit template pattern: 'Не нашёл поставщиков [товар] в [регион]. Возможные причины: (1) нишевой товар, (2) ограниченная база. Альтернативы: [suggest broader geo] или [suggest related category]'
  hint: Template engine or response generator - add fallback branch when retrieval returns < 1 relevant result
  impact: Addresses judge feedback about missing acknowledgment, improves trust
  risk: low
  validate: GA002
- [R4] (prompt, effort S) Preserve topic constraint across turns
  action: Add to system prompt: 'Topic mentioned in Turn 1 (e.g., 'лук') persists for Turn 2 unless explicitly changed. Do NOT drop topic filter when geo changes.'
  hint: app/src/app/api/ai/request/route.ts - session/topic tracking between turns
  impact: Prevents topic drift in GA002.T2
  risk: low
  validate: GA002
- [R5] (prompt, effort S) Handle ambiguous geo mentions with clarification
  action: When single message contains multiple cities (e.g., 'Брест или Минск'), ask clarifying question before search: 'Уточните, пожалуйста: нужен поставщик в Бресте или в Минске?' instead of defaulting to first city.
  hint: app/src/app/api/ai/request/route.ts - ambiguity detection pre-search
  impact: Fixes judge concern about unjustified default choice
  risk: low
  validate: GA001
- [R6] (retrieval, effort M) Add delivery-option expansion for geo queries
  action: When user says 'поставка в X возможна', treat both X AND base_city as valid supplier locations. Query: (supplier_location IN [base_city, delivery_city])
  hint: Query builder - expand geo filter when delivery mention detected
  impact: Addresses judge: 'не предложены компании из Бреста как альтернатива'
  risk: low
  validate: GA001

