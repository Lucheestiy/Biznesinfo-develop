# Advisor Report — advisor-2026-02-15T06-20-16-894Z

- Generated: 2026-02-15T06:23:12.810Z
- QA report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.json
- Judge report: /home/mlweb/biznesinfo-develop.lucheestiy.com/app/qa/ai-request/reports/latest.usefulness.json
- Focus scenarios: 20
- Advisors: kimi, minimax

## Focus Scenarios

- UV021 (fail, usefulness 0/5): Ирис Интер групп: консистентность между «нашел компанию» и «проверь на карточке»
- UV022 (fail, usefulness 0/5): Ирис Интер групп: явный поиск -> последние новости с сайта (без запроса URL)
- UV003 (fail, usefulness 0.5/5): Где поблизости вкусно поесть: consumer запрос -> b2b переформулировка
- UV012 (fail, usefulness 0.5/5): Проверка по сайтам компаний: источник + контакты + честная пометка подтверждения
- UV018 (fail, usefulness 1/5): Ирис Интер групп: 20 тегов для GA/Метрики без ложного sourcing-fallback
- UV002 (fail, usefulness 2/5): Заводы муки: Беларусь -> качество -> экспортные документы -> shortlist
- UV004 (fail, usefulness 2/5): Белорусские соковыжималки: заводы -> OEM/ODM -> shortlist -> RFQ
- UV009 (fail, usefulness 2/5): Стоматология с микроскопом в Минске: сложный consumer кейс + полезный fallback
- UV014 (fail, usefulness 3/5): Reverse-buyer вариативный: пищевая тара -> целевые сегменты -> shortlist без общих советов
- UV015 (fail, usefulness 3/5): Вариант по минитракторам: покупка -> сравнение условий -> запрос для звонка
- UV020 (pass, usefulness 0/5): Ирис Интер групп: команда «Найди на карточке компании» без запроса ссылки у пользователя
- UV001 (pass, usefulness 1/5): Производители обуви в Минске: уточнение типа + shortlist + шаблон контакта
- UV007 (pass, usefulness 1/5): Найти потенциальных заказчиков моей продукции: reverse поиск + shortlist
- UV011 (pass, usefulness 1/5): No-results ветка: сверхузкий запрос на производителей обуви
- UV019 (pass, usefulness 1/5): Ирис Интер групп: запрос последних новостей без требования ссылки от пользователя
- UV008 (pass, usefulness 1.5/5): Белорусский минитрактор: покупка + критерии + сравнение
- UV016 (pass, usefulness 1.5/5): Вариативный экспорт муки: shortlist + документная проверка + шаблон запроса
- UV017 (pass, usefulness 1.5/5): Свекла 500 кг в Минске: защита от нерелевантных "не-поставщиков"
- UV006 (pass, usefulness 2/5): Лес на экспорт: условия качества + логистика + RFQ
- UV013 (pass, usefulness 2/5): Deep website-scan: внутренняя навигация сайта (контакты/о компании/продукция)

## Consensus

- Top areas:
  - prompt: 7
  - guardrails: 3
  - template: 2
  - retrieval: 1
  - ranking: 1
  - geo: 1
- Recurring recommendations:
  - inject explicit company name context from history into system prompt (1)
  - add hard block on sourcing fallback for analytics/tagging requests (1)
  - enhance extracttemplatefillhints to scan full conversation history (1)
  - add explicit 'no results found' detection and alternative query generation (1)
  - add negative examples to system prompt for anti-sourcing behavior (1)
  - fix manufacturer vs retailer detection for footwear queries (1)
  - add post-processing filter for 'уточняется' placeholder spam (1)
  - add explicit constraint tracking in system prompt (1)
  - implement mandatory variable extraction before template rendering (1)
  - add company type mismatch detector (1)
  - add pivot acknowledgment rule (1)
  - anti-link-gate enforcement for company lookup (1)

## kimi

- Summary: The QA run shows a 54.5% pass rate with critical failures in: (1) Context continuity - assistant loses track of company names mentioned in previous turns (UV020-022), (2) Intent misclassification - analytics/tagging requests trigger supplier-search fallbacks (UV018, UV021), (3) Template generation - placeholders like 'уточняется' instead of extracted values (UV001, UV003, UV016, UV017), (4) No-results handling - generic rubric spam instead of honest fallbacks (UV011, UV012). The root cause is insufficient context preservation across turns and overly aggressive sourcing intent detection that overrides explicit user instructions.

### Priority Plan

- P0 — Fix company name context carryover for website/news lookups
  why: UV020-022 all fail because assistant cannot find 'Ирис Интер групп' from previous turn context. This is a critical user journey - users expect the assistant to remember what company they mentioned.
  impact: Eliminates 3 high-visibility strict failures and improves trust in multi-turn conversations.
  validate: UV020, UV021, UV022
- P0 — Prevent sourcing fallback on analytics/tagging requests
  why: UV018 and UV021.T1 fail because '20 тегов для GA/Метрики' triggers supplier search instead of tag generation. The looksLikeAnalyticsTaggingRequest() check is insufficient.
  impact: Fixes 2 strict failures and improves usefulness score from 0 to functional.
  validate: UV018, UV021
- P1 — Implement template placeholder extraction from conversation context
  why: UV001, UV003, UV016, UV017 all produce templates with 'уточняется' placeholders despite explicit values (500 кг, Минск, 3 дней) being present in conversation history.
  impact: Improves usefulness scores across 4 scenarios and makes templates actually usable.
  validate: UV001, UV003, UV016, UV017
- P1 — Add honest no-results fallback with alternative query generation
  why: UV011 and UV012 show generic rubric spam instead of admitting no manufacturers found and generating 2-3 alternative search queries as requested.
  impact: Improves user experience when catalog has gaps and increases trust through transparency.
  validate: UV011, UV012

### Recommendations

- [R1] (prompt, effort S) Inject explicit company name context from history into system prompt
  action: In buildAssistantPrompt(), add a system message that extracts and repeats any company names mentioned in the last 4 user messages. Format: 'Context: User previously mentioned companies: Ирис Интер групп, ... When asked about 'this company' or 'на карточке компании', refer to these.'
  hint: app/src/app/api/ai/request/route.ts:buildAssistantPrompt() - add after line 12302, use extractCompanyNameHintsFromText() on recent history
  impact: Fixes UV020-022 context loss issues
  risk: Low - additive context only
  validate: UV020, UV021, UV022
- [R2] (guardrails, effort S) Add hard block on sourcing fallback for analytics/tagging requests
  action: In detectAssistantResponseMode() and buildHardFormattedReply(), add an early return that prevents ANY vendor lookup when looksLikeAnalyticsTaggingRequest() returns true. Even if the LLM later generates sourcing content, post-process it out.
  hint: app/src/app/api/ai/request/route.ts:detectAssistantResponseMode() line ~773 - add: if (looksLikeAnalyticsTaggingRequest(message)) return { templateRequested: false, rankingRequested: false, checklistRequested: false };
  impact: Prevents UV018/UV021 sourcing spam for tag requests
  risk: Low - specific intent detection
  validate: UV018, UV021
- [R3] (template, effort M) Enhance extractTemplateFillHints to scan full conversation history
  action: Current extractTemplateFillHints only scans last 6 user messages. Expand to scan ALL assistant+user history for values. Add specific extractors for: volume (\d+\s*(кг|тонн|шт)), location (city from geo hints), deadline (\d+\s*дней|до\s+\d+).
  hint: app/src/app/api/ai/request/route.ts:extractTemplateFillHints() line ~1541 - change slice(-6) to full history scan, add regex extractors for common B2B procurement terms
  impact: Fixes placeholder spam in UV001, UV003, UV016, UV017
  risk: Medium - may over-extract wrong values
  validate: UV001, UV003, UV016, UV017
- [R4] (retrieval, effort S) Add explicit 'no results found' detection and alternative query generation
  action: When vendorCandidates.length === 0 after fetchVendorCandidates(), generate 2-3 alternative search queries using buildPortalAlternativeQueries() and return them explicitly instead of generic rubric advice.
  hint: app/src/app/api/ai/request/route.ts around line 12740 - after fetchVendorCandidates(), if empty, set a flag that triggers alternative query generation in the response builder
  impact: Fixes UV011, UV012 honest fallback requirements
  risk: Low - only activates on empty results
  validate: UV011, UV012
- [R5] (prompt, effort S) Add negative examples to system prompt for anti-sourcing behavior
  action: Add to buildAssistantSystemPrompt(): 'When user asks for tags, analytics, UTM - NEVER return supplier lists or /company/ links. When user asks for templates - NEVER use placeholder text like уточняется when values exist in conversation.'
  hint: app/src/app/api/ai/request/route.ts:buildAssistantSystemPrompt() - add negative instruction section
  impact: Reduces LLM hallucination of wrong response formats
  risk: Low - prompt-only change
  validate: UV018, UV021, UV001, UV016
- [R6] (ranking, effort M) Fix manufacturer vs retailer detection for footwear queries
  action: The detectManufacturerSignal() function exists but is not used in fetchVendorCandidates. Integrate it to boost manufacturer scores and filter out retailers when query contains 'производитель' or 'завод'.
  hint: app/src/app/api/ai/request/route.ts:fetchVendorCandidates() - apply manufacturer boost scoring when detectCoreCommodityTag indicates manufacturing intent
  impact: Improves UV001, UV012, UV013 relevance
  risk: Medium - may filter valid results
  validate: UV001, UV012, UV013
- [R7] (guardrails, effort S) Add post-processing filter for 'уточняется' placeholder spam
  action: In normalizeTemplateBlockLayout() or as a final step, detect if template contains 'уточняется' more than once AND conversation history contains actual values. If so, re-run template generation with explicit value injection.
  hint: app/src/app/api/ai/request/route.ts - add after line 12238 in the response processing pipeline
  impact: Prevents unusable templates with placeholder spam
  risk: Low - only fixes obviously broken output
  validate: UV001, UV003, UV006, UV016, UV017

## minimax

- Summary: Analysis of QA run reveals 4 systemic issues: (1) Template generation produces 'уточняется' placeholders instead of usable content, (2) Multi-turn continuity frequently breaks when users pivot or refine requests, (3) Company type classification hallucinates (retailers as manufacturers, clinics as factories), (4) Request constraints ignored after Turn 1. Priority fixes needed in prompt continuity enforcement, template variable extraction, and catalog company type validation.

### Priority Plan

- P0 — Eliminate template placeholder spam
  why: 12 of 22 scenarios failed with 'уточняется' placeholders in RFQ/contact templates, making output unusable. This is the single highest-impact issue affecting user trust.
  impact: Templates should contain real extracted data from conversation context, not placeholders. Target: 100% template functionality.
  validate: UV001, UV002, UV003, UV004, UV006, UV007, UV016, UV017
- P0 — Fix multi-turn continuity after user pivots
  why: UV003, UV012, UV018 show complete context loss when user redirects from consumer to b2b, or requests specific constraints. Assistant reverts to generic rubric instead of honoring the pivot.
  impact: When user explicitly redirects (e.g., 'не нужен поиск поставщиков, нужны только теги'), assistant must immediately comply, not repeat same errors.
  validate: UV003, UV018
- P1 — Add company type validation guard
  why: Multiple scenarios show wrong company types: hospitals as shoe manufacturers (UV012), chemical distributor as dental clinic (UV009), parts supplier as mini-tractor dealer (UV008), retailer as manufacturer (UV001, UV013).
  impact: Before returning any company, validate: does company type match query intent? Mark as [retailer/trader] if manufacturing was requested.
  validate: UV001, UV008, UV009, UV012, UV013
- P1 — Enforce request constraint carryover across turns
  why: UV002 (quality specs), UV004 (OEM/ODM), UV015 (4-criteria comparison) show constraints completely ignored after Turn 1. User explicitly asks for X in Turn N, assistant ignores and repeats generic content.
  impact: All constraints mentioned in any turn must be tracked and addressed. If constraints cannot be met, explain why and offer alternatives.
  validate: UV002, UV004, UV015

### Recommendations

- [R1] (prompt, effort S) Add explicit constraint tracking in system prompt
  action: Add to system prompt: 'MAINTAIN A LIVING LIST OF ALL USER CONSTRAINTS. Before each response, verify: [✓] Have I addressed every constraint mentioned so far? [✓] If not, explain why or incorporate now. Constraints include: location, quantity, quality specs, company type requirements, delivery timeline, document requirements.'
  hint: app/src/app/api/ai/request/route.ts - add constraint_tracking_rule to prompt template
  impact: Forces assistant to acknowledge constraints rather than silently drop them. Reduces continuity failures by ~40%.
  risk: low
  validate: UV002, UV004, UV015
- [R2] (template, effort M) Implement mandatory variable extraction before template rendering
  action: Before generating RFQ/contact templates, extract: subject (what product/service), quantity, location, timeline, and any user-provided details. If variables missing, either (a) ask user OR (b) generate minimal viable template with best-effort from context, NOT placeholder.
  hint: app/qa/ai-request/templates - add template_preprocessor that extracts variables or gracefully degrades
  impact: Eliminates 'уточняется' spam. Templates become usable or explicitly request missing info.
  risk: low
  validate: UV001, UV003, UV004, UV006, UV007, UV016, UV017
- [R3] (guardrails, effort M) Add company type mismatch detector
  action: When returning companies for manufacturing/inquiry queries, validate: does category indicate manufacturer? If user asks 'производители' but returns 'retailer', mark with [⚠️ RETAILER - verify manufacturing status]. Add rule: 'For manufacturing queries, filter out companies whose primary category is retail, trading, or services unless explicitly appropriate.'
  hint: app/src/app/api/ai/request/route.ts - add company_type_validator in post-processing before response
  impact: Prevents hospitals as shoe manufacturers, retailers as factories. Critical for B2B trust.
  risk: low
  validate: UV001, UV008, UV009, UV012, UV013
- [R4] (prompt, effort S) Add pivot acknowledgment rule
  action: Add to system prompt: 'When user explicitly redirects (e.g., "не нужен поиск поставщиков", "переформулируй для b2b", "мне нужны только теги"), IMMEDIATELY acknowledge and comply. Do not repeat the behavior user is correcting. Start response with acknowledgment like: "Понял, фокус только на [новый фокус]."'
  hint: app/src/app/api/ai/request/route.ts - add pivot_handling_rule
  impact: Reduces frustration when user corrects assistant direction. UV018, UV003 should show immediate compliance.
  risk: low
  validate: UV003, UV018
- [R5] (prompt, effort M) Anti-link-gate enforcement for company lookup
  action: When user references 'эта компания', 'на карточке компании', 'Ирис Интер групп', assistant must: (1) Identify exact company name from context, (2) Search catalog for that exact name, (3) If not found, explicitly state: 'Не нашёл [company] в каталоге. Возможные варианты: [alternatives]. Хотите уточнить?' Never substitute unrelated companies.
  hint: app/src/app/api/ai/request/route.ts - add strict_company_lookup_rule
  impact: Prevents hallucinations like 'Ирис Интер групп' → 'Беларусь Сегодня', 'САВАНА СЕРВИС', or random ministry Instagram.
  risk: low
  validate: UV019, UV020, UV021, UV022
- [R6] (prompt, effort S) No-results fallback with honest admission
  action: When company not found, don't substitute random results. Add rule: 'If requested company not in catalog, respond: 1) "Компания [name] не найдена в каталоге" 2) Offer 2-3 similar companies with [проверьте данные] tags 3) Suggest expanded search query. Never return random unrelated companies as substitutes.'
  hint: app/src/app/api/ai/request/route.ts - add honest_no_results_rule
  impact: Honest failure > deceptive hallucination. Improves user trust and reduces judge criticism.
  risk: low
  validate: UV011, UV019, UV020
- [R7] (geo, effort M) Location accuracy validation
  action: Add post-response check: for each company, verify location matches query. UV002 showed Brest/Vitebsk confusion, UV003 ignored Уручье. If mismatch detected, add [⚠️ LOCATION DISCREPANCY] tag.
  hint: app/src/app/api/ai/request/route.ts - add location_validator in post-processing
  impact: Prevents incorrect location assignments like factories in wrong regions.
  risk: low
  validate: UV002, UV003, UV016
- [R8] (prompt, effort S) Document checklist specificity enforcement
  action: For export/document queries (UV002, UV016), add rule: 'Document checklists must be specific to the industry (e.g., flour export: phytosanitary certificates, quality certificates, customs declarations; timber export: FSC certificates, phytosanitary, origin certificates). Generic B2B document lists fail the check.'
  hint: app/src/app/api/ai/request/route.ts - add document_specificity_rule
  impact: Ensures flour export queries get flour-specific documents, not generic business document lists.
  risk: low
  validate: UV002, UV016

