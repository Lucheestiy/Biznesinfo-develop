#!/usr/bin/env bash
set -euo pipefail

SELF="$(basename "$0")"

log() {
  echo "[$(date -u '+%Y-%m-%dT%H:%M:%SZ')] ${*}" >&2
}

die() {
  echo "${SELF}: ${*}" >&2
  exit 1
}

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
RUNS_DIR="${REPO_DIR}/devloop/runs"
LATEST_DIR="${REPO_DIR}/devloop/latest"
SESSION_FILE="${REPO_DIR}/devloop/session_id.txt"
SESSION_MAP_FILE="${REPO_DIR}/devloop/session_ids.json"
LOCAL_ENV_FILE="${REPO_DIR}/devloop/local.env"

LOCK_DIR="${REPO_DIR}/devloop"
LOCK_FILE="${LOCK_DIR}/devloop.lock"

mkdir -p "${RUNS_DIR}" "${LOCK_DIR}"

exec 9>"${LOCK_FILE}"
if ! flock -n 9; then
  log "Another devloop run is in progress; exiting."
  exit 0
fi

TS="$(date -u '+%Y%m%dT%H%M%SZ')"
RUN_DIR="${RUNS_DIR}/${TS}"
mkdir -p "${RUN_DIR}"

ln -sfn "${RUN_DIR}" "${LATEST_DIR}"

cd "${REPO_DIR}"

log "Repo: ${REPO_DIR}"
log "Run:  ${RUN_DIR}"

git config --global --add safe.directory "${REPO_DIR}" >/dev/null 2>&1 || true

# Optional local config (gitignored): devloop/local.env
# Example:
#   DEVLOOP_USE_GEMINI=1
#   DEVLOOP_GEMINI_MODEL=gemini-2.5-pro
#   DEVLOOP_USE_KIMI=1
if [[ -f "${LOCAL_ENV_FILE}" ]]; then
  # shellcheck disable=SC1090
  source "${LOCAL_ENV_FILE}"
fi

if [[ -n "$(git status --porcelain)" ]]; then
  msg="Biznesinfo develop devloop aborted: working tree is dirty in ${REPO_DIR}. Commit/stash changes and retry."
  log "${msg}"
  "${REPO_DIR}/bin/telegram-send" "${msg}" || true
  git status -sb > "${RUN_DIR}/git_status_dirty.txt" || true
  exit 2
fi

git fetch origin > "${RUN_DIR}/git_fetch.txt" 2>&1 || true

if git show-ref --verify --quiet refs/heads/main; then
  git checkout main > "${RUN_DIR}/git_checkout_main.txt" 2>&1 || true
else
  git checkout -B main > "${RUN_DIR}/git_checkout_main.txt" 2>&1 || true
fi

git pull --ff-only origin main > "${RUN_DIR}/git_pull.txt" 2>&1 || true

BRANCH="ai/devloop/${TS}"
git checkout -b "${BRANCH}" > "${RUN_DIR}/git_checkout_branch.txt" 2>&1 || true

git status -sb > "${RUN_DIR}/git_status_before.txt" || true
git log -1 --oneline > "${RUN_DIR}/git_head_before.txt" || true

# Make sure codex-auth-switcher had a chance to run recently.
systemctl start codex-auth-switcher.service >/dev/null 2>&1 || true

CODEX_SWITCH_LOCK="/root/.codex/codex-auth-switcher.lock"
exec 8>"${CODEX_SWITCH_LOCK}"
if flock -w 30 8; then
  log "Acquired codex-auth switch lock."
else
  log "WARNING: could not acquire codex-auth switch lock; continuing without it."
fi

CODEX_ACCOUNT="$(cat /root/.codex/current 2>/dev/null || true)"
CODEX_ACCOUNT="${CODEX_ACCOUNT//$'\n'/}"
if [[ -z "${CODEX_ACCOUNT}" ]]; then
  CODEX_ACCOUNT="(unknown)"
fi
CODEX_ACCOUNT_START="${CODEX_ACCOUNT}"
echo "${CODEX_ACCOUNT_START}" > "${RUN_DIR}/codex_account.txt"

load_session_id_for_account() {
  local account="${1}"
  python3 - <<'PY' "${SESSION_MAP_FILE}" "${SESSION_FILE}" "${account}" 2>/dev/null || true
import json
import re
import sys
from pathlib import Path

map_path = Path(sys.argv[1])
legacy_path = Path(sys.argv[2])
account = sys.argv[3]

uuid_re = re.compile(r"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}", re.I)

def pick_uuid(text: str) -> str | None:
    m = uuid_re.search(text or "")
    return m.group(0) if m else None

if map_path.is_file():
    try:
        data = json.loads(map_path.read_text(encoding="utf-8"))
    except Exception:
        data = None
    if isinstance(data, dict):
        by = data.get("byAccount")
        if isinstance(by, dict):
            value = by.get(account)
            if isinstance(value, str):
                u = pick_uuid(value)
                if u:
                    print(u)
                    raise SystemExit(0)

if legacy_path.is_file():
    u = pick_uuid(legacy_path.read_text(encoding="utf-8", errors="replace"))
    if u:
        print(u)
PY
}

save_session_id_for_account() {
  local account="${1}"
  local session_id="${2}"
  umask 077
  python3 - <<'PY' "${SESSION_MAP_FILE}" "${account}" "${session_id}"
import json
import sys
from pathlib import Path

path = Path(sys.argv[1])
account = sys.argv[2]
session_id = sys.argv[3]

data = {}
if path.is_file():
    try:
        data = json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        data = {}
if not isinstance(data, dict):
    data = {}

by = data.get("byAccount")
if not isinstance(by, dict):
    by = {}
by[account] = session_id
data["byAccount"] = by

tmp = path.with_suffix(path.suffix + ".tmp")
tmp.parent.mkdir(parents=True, exist_ok=True)
tmp.write_text(json.dumps(data, ensure_ascii=True, indent=2, sort_keys=False) + "\n", encoding="utf-8")
tmp.replace(path)
PY
}

TODO_TEXT=""
if [[ -f "${REPO_DIR}/devloop/TODO.md" ]]; then
  TODO_TEXT="$(cat "${REPO_DIR}/devloop/TODO.md")"
fi

GEMINI_OK=0
KIMI_OK=0
GEMINI_ADVICE_FILE="${RUN_DIR}/gemini_advice.txt"
KIMI_ADVICE_FILE="${RUN_DIR}/kimi_advice.txt"

run_gemini_advice() {
  [[ "${DEVLOOP_USE_GEMINI:-1}" == "1" ]] || return 1
  command -v gemini >/dev/null 2>&1 || return 1

  local model="${DEVLOOP_GEMINI_MODEL:-gemini-2.5-pro}"
  local ctx_file="${RUN_DIR}/gemini_context.txt"

  {
    echo "You are an expert engineer and product thinker."
    echo
    echo "Task: propose ONE small, safe, reviewable improvement to implement next in this repo."
    echo
    echo "Constraints:"
    echo "- Dev only (biznesinfo-develop). Do NOT touch production."
    echo "- Do NOT include secrets or datasets."
    echo "- Keep scope minimal; prefer UI polish or small bugfix."
    echo
    echo "Output format (use bullets):"
    echo "- Goal"
    echo "- Why it matters"
    echo "- Files to change (paths)"
    echo "- Suggested edits (concrete)"
    echo "- Acceptance criteria"
    echo
    echo "TODO list:"
    echo "${TODO_TEXT}"
  } > "${ctx_file}"

  log "Gemini advice (model=${model})..."
  if timeout 10m gemini --output-format text --model "${model}" "Read the context and propose one concrete improvement." < "${ctx_file}" > "${GEMINI_ADVICE_FILE}" 2>&1; then
    return 0
  fi
  return 1
}

run_kimi_advice() {
  [[ "${DEVLOOP_USE_KIMI:-1}" == "1" ]] || return 1
  command -v kimi >/dev/null 2>&1 || return 1

  local model="${DEVLOOP_KIMI_MODEL:-}"
  local ctx_file="${RUN_DIR}/kimi_context.txt"

  {
    echo "You are a UI/UX designer focused on aesthetics and small polish improvements."
    echo
    echo "Task: propose ONE small, safe, reviewable UI/UX improvement for this site."
    echo
    echo "Constraints:"
    echo "- Dev only (biznesinfo-develop). Do NOT touch production."
    echo "- No redesigns; prefer spacing/typography/contrast/microcopy improvements."
    echo "- Keep it implementable in <1 hour."
    echo
    echo "Output format (use bullets):"
    echo "- Goal"
    echo "- What to change (high level)"
    echo "- Specific CSS/components likely involved"
    echo "- A few concrete suggestions"
    echo
    echo "TODO list:"
    echo "${TODO_TEXT}"
  } > "${ctx_file}"

  log "Kimi advice${model:+ (model=${model})}..."
  if [[ -n "${model}" ]]; then
    timeout 10m kimi --print --final-message-only --input-format text --output-format text --model "${model}" < "${ctx_file}" > "${KIMI_ADVICE_FILE}" 2>&1
  else
    timeout 10m kimi --print --final-message-only --input-format text --output-format text < "${ctx_file}" > "${KIMI_ADVICE_FILE}" 2>&1
  fi
}

if run_gemini_advice; then
  GEMINI_OK=1
else
  rm -f "${GEMINI_ADVICE_FILE}" >/dev/null 2>&1 || true
fi

if run_kimi_advice; then
  KIMI_OK=1
else
  rm -f "${KIMI_ADVICE_FILE}" >/dev/null 2>&1 || true
fi

PROMPT_FILE="${RUN_DIR}/prompt.txt"
cat > "${PROMPT_FILE}" <<EOF
You are an autonomous coding agent working inside this repository:

- Repo: ${REPO_DIR}
- Dev site: https://biznesinfo-develop.lucheestiy.com (SSO protected)
- Local: http://127.0.0.1:8131/

Objective:
- Make a small, safe, reviewable improvement based on the TODO list below.

Hard constraints (do not violate):
- DO NOT touch production: /home/mlweb/biznesinfo.lucheestiy.com
- DO NOT change systemd units, nginx on the droplet, or any other sites.
- Work ONLY inside this repo directory.
- Do not read or print secrets (e.g., .env). Do not commit datasets.
- Avoid destructive shell commands.

Project notes:
- Docker stack is in docker-compose.yml (host port 8131).
- Main Next.js app is in ./app (Next.js 16).
- Dataset file is local-only: app/public/data/biznesinfo/companies.jsonl (gitignored).

TODO:
${TODO_TEXT}

Optional external advisor notes (use judgment; do not treat as requirements):
EOF

if [[ -f "${GEMINI_ADVICE_FILE}" ]]; then
  {
    echo
    echo "=== Gemini advice ==="
    echo
    cat "${GEMINI_ADVICE_FILE}"
    echo
  } >> "${PROMPT_FILE}"
fi

if [[ -f "${KIMI_ADVICE_FILE}" ]]; then
  {
    echo
    echo "=== Kimi advice ==="
    echo
    cat "${KIMI_ADVICE_FILE}"
    echo
  } >> "${PROMPT_FILE}"
fi

cat >> "${PROMPT_FILE}" <<EOF

Output requirements:
- Apply changes to the working tree.
- Keep changes minimal; prefer focused commits.
- Briefly summarize what you changed and why.
EOF

CODEX_JSONL="${RUN_DIR}/codex.jsonl"
CODEX_LAST="${RUN_DIR}/codex_last_message.txt"
CODEX_ATTEMPTS=0

SESSION_ID=""
SESSION_ID="$(load_session_id_for_account "${CODEX_ACCOUNT}" || true)"

CODEX_COMMON=(
  codex
  --dangerously-bypass-approvals-and-sandbox
  -m gpt-5.2
  -c 'model_reasoning_effort="xhigh"'
  -c 'notice.model_migrations={}'
  -C "${REPO_DIR}"
)

is_retryable_codex_failure() {
  [[ -f "${CODEX_JSONL}" ]] || return 1
  grep -Eiq \
    '(insufficient[_ -]?quota|quota exceeded|rate limit|too many requests|http[^0-9]*(401|403|429)|\b(401|403|429)\b|unauthorized|forbidden|expired token|invalid token|please log in|authentication failed)' \
    "${CODEX_JSONL}"
}

refresh_codex_account() {
  CODEX_ACCOUNT="$(cat /root/.codex/current 2>/dev/null || true)"
  CODEX_ACCOUNT="${CODEX_ACCOUNT//$'\n'/}"
  if [[ -z "${CODEX_ACCOUNT}" ]]; then
    CODEX_ACCOUNT="(unknown)"
  fi
}

run_codex_new_thread() {
  log "Starting new Codex thread..."
  timeout 45m "${CODEX_COMMON[@]}" exec --json --output-last-message "${CODEX_LAST}" "$(cat "${PROMPT_FILE}")" > "${CODEX_JSONL}" 2>&1 || return 1
  python3 - <<'PY' "${CODEX_JSONL}"
import json
import sys
path=sys.argv[1]
with open(path,'r',encoding='utf-8',errors='replace') as f:
    for line in f:
        try:
            obj=json.loads(line)
        except Exception:
            continue
        if obj.get('type')=='thread.started' and obj.get('thread_id'):
            print(obj['thread_id'])
            raise SystemExit(0)
raise SystemExit(2)
PY
}

run_codex_resume_thread() {
  local session_id="${1}"
  log "Resuming Codex thread ${session_id}..."
  timeout 45m "${CODEX_COMMON[@]}" exec resume --json "${session_id}" "$(cat "${PROMPT_FILE}")" > "${CODEX_JSONL}" 2>&1
}

resume_failure_maybe_wrong_account() {
  [[ -f "${CODEX_JSONL}" ]] || return 1
  grep -Eiq \
    '(thread[^\\n]*not found|not found|http[^0-9]*(401|403|404)|\\b(401|403|404)\\b|unauthorized|forbidden)' \
    "${CODEX_JSONL}"
}

extract_last_agent_message() {
  python3 - <<'PY' "${CODEX_JSONL}" "${CODEX_LAST}" || true
import json
import sys

in_path = sys.argv[1]
out_path = sys.argv[2]
last_text = None

with open(in_path, "r", encoding="utf-8", errors="replace") as f:
    for line in f:
        try:
            obj = json.loads(line)
        except Exception:
            continue
        if obj.get("type") != "item.completed":
            continue
        item = obj.get("item") or {}
        if item.get("type") != "agent_message":
            continue
        text = item.get("text")
        if isinstance(text, str) and text.strip():
            last_text = text.strip()

if last_text:
    with open(out_path, "w", encoding="utf-8") as f:
        f.write(last_text + "\n")
PY
}

CODEX_OK=1
run_codex_attempt() {
  CODEX_ATTEMPTS=$((CODEX_ATTEMPTS + 1))
  if [[ -z "${SESSION_ID}" ]]; then
    if SESSION_ID="$(run_codex_new_thread)"; then
      umask 077
      printf '%s\n' "${SESSION_ID}" > "${SESSION_FILE}"
      save_session_id_for_account "${CODEX_ACCOUNT}" "${SESSION_ID}"
      log "Saved session id: ${SESSION_ID}"
      return 0
    fi
    return 1
  fi
  if run_codex_resume_thread "${SESSION_ID}"; then
    return 0
  fi
  # If the thread can't be resumed under this account, start a new thread for this account.
  if resume_failure_maybe_wrong_account; then
    log "Codex resume failed (thread/account mismatch). Starting a new thread for ${CODEX_ACCOUNT}..."
    SESSION_ID=""
    if SESSION_ID="$(run_codex_new_thread)"; then
      umask 077
      printf '%s\n' "${SESSION_ID}" > "${SESSION_FILE}"
      save_session_id_for_account "${CODEX_ACCOUNT}" "${SESSION_ID}"
      log "Saved session id: ${SESSION_ID}"
      return 0
    fi
  fi
  return 1
}

if ! run_codex_attempt; then
  CODEX_OK=0
fi

if [[ "${CODEX_OK}" -eq 0 ]] && is_retryable_codex_failure; then
  log "Codex failed (auth/quota). Switching codex-auth and retrying once..."
  mv -f "${CODEX_JSONL}" "${RUN_DIR}/codex_attempt1.txt" 2>/dev/null || true
  mv -f "${CODEX_LAST}" "${RUN_DIR}/codex_last_message_attempt1.txt" 2>/dev/null || true

  flock -u 8 || true
  exec 8>&- || true
  systemctl start codex-auth-switcher.service >/dev/null 2>&1 || true
  exec 8>"${CODEX_SWITCH_LOCK}"
  if flock -w 30 8; then
    log "Re-acquired codex-auth switch lock."
  else
    log "WARNING: could not re-acquire codex-auth switch lock; continuing without it."
  fi

  refresh_codex_account
  SESSION_ID="$(load_session_id_for_account "${CODEX_ACCOUNT}" || true)"
  echo "${CODEX_ACCOUNT}" > "${RUN_DIR}/codex_account_retry.txt"

  CODEX_OK=1
  if ! run_codex_attempt; then
    CODEX_OK=0
  fi
fi

extract_last_agent_message

flock -u 8 || true
exec 8>&- || true

git status -sb > "${RUN_DIR}/git_status_after_codex.txt" || true
git diff --stat > "${RUN_DIR}/git_diff_stat_after_codex.txt" || true

CHANGED=0
if [[ -n "$(git status --porcelain)" ]]; then
  CHANGED=1
fi

BUILD_OK=0
log "Building docker image (gate)..."
if timeout 45m docker compose build app > "${RUN_DIR}/docker_build.txt" 2>&1; then
  BUILD_OK=1
else
  BUILD_OK=0
fi

PUSH_OK=0
COMMIT_SHA=""
if [[ "${CHANGED}" -eq 1 ]]; then
  log "Changes detected; committing..."
  git add -A
  git commit -m "AI devloop: ${TS}" > "${RUN_DIR}/git_commit.txt" 2>&1 || true
  COMMIT_SHA="$(git rev-parse HEAD 2>/dev/null || true)"
  if git push -u origin "${BRANCH}" > "${RUN_DIR}/git_push.txt" 2>&1; then
    PUSH_OK=1
  fi
else
  log "No changes detected."
fi

DEPLOY_OK=0
if [[ "${BUILD_OK}" -eq 1 ]]; then
  log "Build OK; deploying dev stack..."
  if timeout 20m docker compose up -d --build > "${RUN_DIR}/docker_up.txt" 2>&1; then
    DEPLOY_OK=1
  fi
else
  log "Build failed; skipping deploy."
fi

docker compose ps > "${RUN_DIR}/docker_ps.txt" 2>&1 || true

SUMMARY="${RUN_DIR}/SUMMARY.md"
{
  echo "# Biznesinfo Develop â€“ AI Devloop Run"
  echo
  echo "- Time (UTC): ${TS}"
  echo "- Branch: ${BRANCH}"
  echo "- Codex account (start): ${CODEX_ACCOUNT_START}"
  if [[ -f "${RUN_DIR}/codex_account_retry.txt" ]]; then
    echo "- Codex account (retry): $(cat "${RUN_DIR}/codex_account_retry.txt" 2>/dev/null || true)"
  fi
  echo "- Codex session: ${SESSION_ID:-'(none)'}"
  echo "- Codex attempts: ${CODEX_ATTEMPTS}"
  echo "- Codex ok: ${CODEX_OK}"
  echo "- Gemini advice ok: ${GEMINI_OK}"
  echo "- Kimi advice ok: ${KIMI_OK}"
  echo "- Changed: ${CHANGED}"
  echo "- Build ok: ${BUILD_OK}"
  echo "- Push ok: ${PUSH_OK}"
  echo "- Deploy ok: ${DEPLOY_OK}"
  if [[ -n "${COMMIT_SHA}" ]]; then
    echo "- Commit: ${COMMIT_SHA}"
  fi
  echo
  echo "## Links"
  echo
  echo "- Dev: https://biznesinfo-develop.lucheestiy.com/"
  echo "- Local: http://127.0.0.1:8131/"
  echo
  echo "## Artifacts"
  echo
  echo "- ${RUN_DIR}/prompt.txt"
  echo "- ${RUN_DIR}/codex.jsonl"
  echo "- ${RUN_DIR}/codex_last_message.txt"
  if [[ -f "${GEMINI_ADVICE_FILE}" ]]; then
    echo "- ${RUN_DIR}/gemini_advice.txt"
  fi
  if [[ -f "${KIMI_ADVICE_FILE}" ]]; then
    echo "- ${RUN_DIR}/kimi_advice.txt"
  fi
  echo "- ${RUN_DIR}/docker_build.txt"
  echo "- ${RUN_DIR}/docker_up.txt"
  echo "- ${RUN_DIR}/docker_ps.txt"
  echo
  echo "## Notes"
  echo
  echo "If the branch looks good, open a PR from \`${BRANCH}\` into \`main\`."
} > "${SUMMARY}"

SHORT_STATUS="CODEX=${CODEX_OK} GEMINI=${GEMINI_OK} KIMI=${KIMI_OK} CHANGED=${CHANGED} BUILD=${BUILD_OK} PUSH=${PUSH_OK} DEPLOY=${DEPLOY_OK}"
MSG="Biznesinfo develop devloop ${TS}\n${SHORT_STATUS}\nbranch: ${BRANCH}\nreport: ${SUMMARY}"
log "Telegram notify..."
if ! "${REPO_DIR}/bin/telegram-send" "${MSG}"; then
  log "Telegram send failed (non-fatal)."
fi

log "Done: ${SHORT_STATUS}"

# Keep the working tree on main for the next run (only if clean).
if [[ -z "$(git status --porcelain)" ]]; then
  git checkout main >/dev/null 2>&1 || true
fi
